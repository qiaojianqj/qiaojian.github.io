<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Caddyä»£æ›¿Nginx</title>
    <url>/article/Caddy%E4%BB%A3%E6%9B%BFNginx/</url>
    <content><![CDATA[<ol>
<li>å®‰è£…</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl https://getcaddy.com | bash -s personal</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>caddy serviceå¯åŠ¨è„šæœ¬ä¸‹è½½ï¼Œæ³¨æ„ä¿®æ”¹user + group</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -s https://raw.githubusercontent.com/mholt/caddy/master/dist/init/linux-systemd/caddy.service -o /etc/systemd/system/caddy.service</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>é…ç½®Caddyfileè¯»å–é…ç½®ç›®å½•ï¼ˆè¿™äº›ç›®å½•éƒ½æ˜¯æ ¹æ®serviceå¯åŠ¨è„šæœ¬æ¥é…ç½®çš„ï¼‰</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir /etc/caddy</span><br><span class="line">mkdir /etc/caddy/conf</span><br><span class="line">echo &apos;import ./conf/*&apos; &gt;&gt; /etc/caddy/Caddyfile #å¯¼å…¥./confç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä½œä¸ºcaddyçš„é…ç½®æ–‡ä»¶</span><br><span class="line">mkdir /etc/ssl/caddy</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>é…ç½®æ–‡ä»¶æ”¾/etc/caddy/confç›®å½•ä¸‹ï¼Œæ¯”å¦‚ï¼š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /etc/caddy/conf/v2r.conf</span><br><span class="line">#é…ç½®åå‘ä»£ç†</span><br><span class="line">:80 &#123;</span><br><span class="line">        proxy / 127.0.0.1:9090 &#123;</span><br><span class="line">                transparent</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šåŸŸåæ—¶ï¼Œcaddyä¼šè‡ªåŠ¨ä»Letâ€™s Encryptç”³è¯·å…è´¹httpsè¯ä¹¦</p>
<ol start="5">
<li>å¯åŠ¨caddyæœåŠ¡</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#centos7</span><br><span class="line">systemctl start caddy</span><br><span class="line">#æŸ¥çœ‹å¯åŠ¨æ˜¯å¦æˆåŠŸ</span><br><span class="line">systemctl status caddy</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>è®¿é—®æœåŠ¡ï¼ŒéªŒè¯ä»£ç†æ˜¯å¦ç”Ÿæ•ˆï¼ˆæœ¬åœ°é…ç½®äº†hosts: 1.2.3.4 <a href="http://qj.com" target="_blank" rel="noopener">qj.com</a>ï¼‰</li>
</ol>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/caddy-check.jpg" alt=""></p>
<h2 id="vpså…‹éš†githubåšå®¢">vpså…‹éš†githubåšå®¢</h2>
<ol>
<li>
<p>git clone <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:qiaojianqj/qiaojianqj.github.io.git åˆ°æœ¬åœ°ç›®å½•</p>
</li>
<li>
<p>é…ç½®caddyï¼Œhttpsè¯ä¹¦ç”³è¯·è€æ˜¯å¤±è´¥</p>
</li>
<li>
<p>æ”¹ä¸ºnginxï¼Œé…ç½®ä¸€æ¬¡æ€§æˆåŠŸ</p>
</li>
<li>
<p>çœ‹æ¥ä¸ªäººåšå®¢ç”¨caddyä¼šè‡ªåŠ¨å‘letâ€™s encryptå…è´¹è¯ä¹¦ç”³è¯·è¯ä¹¦ï¼Œä½†æ˜¯å¤±è´¥æœºä¼šå¤§ï¼Œnginxè¿˜æ˜¯é€‚åˆä¼ä¸šçº§ä½¿ç”¨</p>
</li>
</ol>
]]></content>
      <tags>
        <tag>caddy</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello-World</title>
    <url>/article/Hello-World/</url>
    <content><![CDATA[<p>æ¬¢è¿æ¥åˆ°æˆ‘çš„å°ç«™ï¼</p>
]]></content>
  </entry>
  <entry>
    <title>Linux-è¿›ç¨‹æ›¿æ¢</title>
    <url>/article/Linux-%E8%BF%9B%E7%A8%8B%E6%9B%BF%E6%8D%A2/</url>
    <content><![CDATA[<p>Linux è¿›ç¨‹æ›¿æ¢å’Œç®¡é“ç±»ä¼¼ï¼Œæ˜¯è¾“å…¥è¾“å‡ºé‡å®šå‘çš„ä¸€ç§ï¼Œ å®ƒçš„è¯­æ³•å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">command &lt;(list)</span><br><span class="line">or</span><br><span class="line">command &gt;(list)</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„è¿™å„¿ () ä¸ &lt; å’Œ &gt; ä¹‹é—´æ²¡æœ‰ç©ºæ ¼ã€‚listå¯ä»¥æ˜¯ä¸€ä¸ªå•ç‹¬çš„å‘½ä»¤æˆ–è€…æ˜¯ç”±ç®¡é“è¿èµ·æ¥çš„ä¸€ç»„å‘½ä»¤ã€‚è¿›ç¨‹æ›¿æ¢çš„ä½œç”¨æ˜¯å°†&lt;(list)æ›¿æ¢ä¸ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ/dev/fd/xxï¼‰ï¼Œæ–‡ä»¶çš„å†…å®¹å³æ˜¯listçš„å‘½ä»¤è¾“å‡ºã€‚</p>
<p>ä¾‹å¦‚ç½—åˆ—å½“å‰ç›®å½•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat &lt;(ls)		#æŠŠ&lt;(ls)æ›¿æ¢ä¸ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹æ˜¯lsçš„ç»“æœï¼Œæœ€åcatè¿™ä¸ªä¸´æ—¶æ–‡ä»¶</span><br><span class="line"> </span><br><span class="line">ls &gt; &gt;(cat)	#æŠŠ&gt;(cat)æ›¿æ¢ä¸ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œlsçš„ç»“æœé‡å®šå‘åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œæœ€åè¿™ä¸ªæ–‡ä»¶è¢«cat</span><br></pre></td></tr></table></figure>
<p>å†ä¾‹å¦‚æ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶çš„å¼‚åŒï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/linux-process-substitution.jpg" alt=""></p>
]]></content>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxæ’æŸ¥é—®é¢˜å‘½ä»¤</title>
    <url>/article/Linux%E6%8E%92%E6%9F%A5%E9%97%AE%E9%A2%98%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<p>çº¿ä¸Šé—®é¢˜æ’æŸ¥æ—¶éœ€è¦ä»å„ä¸ªæ–¹é¢æŸ¥çœ‹ç³»ç»Ÿçš„æƒ…å†µï¼Œåœ¨æ­¤åˆ—ä¸¾å¸¸ç”¨çš„æ’æŸ¥å‘½ä»¤ï¼ŒæŒ‰ç±»åˆ«åŒºåˆ†å¦‚ä¸‹</p>
<h3 id="ç³»ç»Ÿä¿¡æ¯">ç³»ç»Ÿä¿¡æ¯</h3>
<p>å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat /proc/version</span><br><span class="line">uname -a</span><br></pre></td></tr></table></figure>
<p>ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lsb_release -a</span><br><span class="line">cat /etc/redhat-release</span><br><span class="line">cat /etc/issue</span><br></pre></td></tr></table></figure>
<p>ç¡¬ç›˜ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># æŸ¥çœ‹å„åˆ†åŒºä½¿ç”¨æƒ…å†µ</span><br><span class="line">df -ah</span><br><span class="line"># æŸ¥çœ‹æŒ‡å®šç›®å½•çš„å¤§å°</span><br><span class="line">du -sh &lt;ç›®å½•å&gt; </span><br><span class="line"># æŸ¥çœ‹æŒ‚æ¥çš„åˆ†åŒºçŠ¶æ€</span><br><span class="line">mount | column -t   </span><br><span class="line"># æŸ¥çœ‹ç›®å½•æ‰€åœ¨çš„æŒ‚è½½åˆ†åŒº</span><br><span class="line">df &lt;ç›®å½•ç»å¯¹è·¯å¾„&gt;				 </span><br><span class="line">fdisk -l               # æŸ¥çœ‹æ‰€æœ‰åˆ†åŒº</span><br><span class="line">swapon -s              # æŸ¥çœ‹æ‰€æœ‰äº¤æ¢åˆ†åŒº</span><br></pre></td></tr></table></figure>
<p>CPUä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># æ€»æ ¸æ•° = ç‰©ç†CPUä¸ªæ•° X æ¯é¢—ç‰©ç†CPUçš„æ ¸æ•° </span><br><span class="line"># æ€»é€»è¾‘CPUæ•° = ç‰©ç†CPUä¸ªæ•° X æ¯é¢—ç‰©ç†CPUçš„æ ¸æ•° X è¶…çº¿ç¨‹æ•°</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹ç‰©ç†CPUä¸ªæ•°</span><br><span class="line">cat /proc/cpuinfo| grep &quot;physical id&quot;| sort| uniq| wc -l</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æ¯ä¸ªç‰©ç†CPUä¸­coreçš„ä¸ªæ•°(å³æ ¸æ•°)</span><br><span class="line">cat /proc/cpuinfo| grep &quot;cpu cores&quot;| uniq</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹é€»è¾‘CPUçš„ä¸ªæ•°</span><br><span class="line">cat /proc/cpuinfo| grep &quot;processor&quot;| wc -l</span><br></pre></td></tr></table></figure>
<p>å†…å­˜ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">free -h</span><br><span class="line">cat /proc/meminfo</span><br></pre></td></tr></table></figure>
<p>ç³»ç»Ÿè´Ÿè½½ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">uptime</span><br><span class="line">cat /proc/loadavg</span><br><span class="line">tload -d 1 ï¼ˆæŒ‡å®šé—´éš”1ç§’é‡‡é›†ä¸€æ¬¡ï¼‰</span><br><span class="line">top -c</span><br></pre></td></tr></table></figure>
<p>ç”¨æˆ·ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat /etc/password</span><br><span class="line"># æ–‡ä»¶ç›®å½•æƒé™</span><br><span class="line">ls -al &lt;æ–‡ä»¶æˆ–ç›®å½•&gt;</span><br><span class="line">#ä¿®æ”¹æ–‡ä»¶æˆ–ç›®å½•æƒé™</span><br><span class="line">#rwx-æƒé™</span><br><span class="line">chmod</span><br><span class="line">#æ–‡ä»¶æ‰€å±ç”¨æˆ·</span><br><span class="line">chown</span><br><span class="line">#æ–‡ä»¶æ‰€å±ç”¨æˆ·ç»„</span><br><span class="line">chgrp</span><br></pre></td></tr></table></figure>
<p>è¿›ç¨‹ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -ef | grep &lt;pidæˆ–è€…è¿›ç¨‹åå…³é”®å­—&gt;</span><br><span class="line">ps -ef | grep &lt;pidæˆ–è€…è¿›ç¨‹åå…³é”®å­—&gt;</span><br><span class="line">top -c</span><br></pre></td></tr></table></figure>
<h3 id="é—®é¢˜æ’æŸ¥">é—®é¢˜æ’æŸ¥</h3>
<ol>
<li>æŸ¥çœ‹æœ¬æœºhosté…ç½®</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat /etc/hosts</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>æŸ¥çœ‹æœåŠ¡å™¨ä¸»æœºæ˜¯å¦ç½‘ç»œå¯è¾¾</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ping ip</span><br><span class="line">pingonlineç½‘å€ï¼Œé˜²æ­¢dnsæ±¡æŸ“</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>è¿½è¸ªè·¯ç”±ä¿¡æ¯</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">traceroute</span><br><span class="line">tracepathï¼ˆä¸éœ€è¦rootï¼‰</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>æŸ¥çœ‹åŸŸåè§£æ</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dig</span><br><span class="line">nslookup</span><br><span class="line">host</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>telnetç«¯å£è¿é€šæ€§</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">telnet åŸŸå/IP port</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>æŸ¥çœ‹å½“å‰è¿è¡Œç¨‹åº</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps -ef | grep &lt;pidæˆ–è€…è¿›ç¨‹åå…³é”®å­—&gt;</span><br><span class="line">ps -ef | grep &lt;pidæˆ–è€…è¿›ç¨‹åå…³é”®å­—&gt;</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>æŸ¥çœ‹ç½‘ç»œè¿æ¥çŠ¶æ€</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">netstat -ntlp</span><br><span class="line">-a: æ˜¾ç¤ºæ‰€æœ‰listeningå’Œélisteningä¸­çš„socketè¿æ¥</span><br><span class="line">-t: tcp</span><br><span class="line">-n: æ˜¾ç¤ºæ•°å­—åœ°å€</span><br><span class="line">-l: ç›‘å¬ä¸­listening</span><br><span class="line">-p: æ˜¾ç¤ºè¿›ç¨‹åç§°å’ŒPID</span><br><span class="line"></span><br><span class="line">netstat -anp | grep port/app #å› ä¸ºæœåŠ¡å™¨å¯èƒ½æ˜¯å¤šç½‘å¡é…ç½®ï¼Œç»‘å®šåœ°å€ 127.0.0.1ï¼ˆæœ¬æœºåœ°å€ï¼‰ å’Œ 0.0.0.0ï¼ˆæ— é™åˆ¶ï¼‰ åŒºåˆ«ï¼‰</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>æŸ¥çœ‹ç³»ç»Ÿæ‰“å¼€æ–‡ä»¶</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lsof -i :port</span><br></pre></td></tr></table></figure>
<ol start="9">
<li>æŸ¥çœ‹é˜²ç«å¢™é…ç½®</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables</span><br><span class="line">firewall</span><br><span class="line">#selinuxæ˜¯å¦å…³é—­</span><br><span class="line">getenforce/sestatus -v:æŸ¥çœ‹selinuxçŠ¶æ€</span><br><span class="line">setenforce 0:ä¸´æ—¶å…³é—­selinux</span><br><span class="line">vi /etc/selinux/config: æ°¸ä¹…å…³é—­ï¼Œ éœ€è¦é‡å¯æœåŠ¡å™¨</span><br></pre></td></tr></table></figure>
<ol start="10">
<li>
<p>æŸ¥çœ‹nginxé…ç½®å’Œæ—¥å¿—</p>
</li>
<li>
<p>æŸ¥çœ‹webå®¹å™¨ - access log</p>
</li>
<li>
<p>æŸ¥çœ‹åº”ç”¨æ—¥å¿—</p>
</li>
<li>
<p>æŠ“åŒ…å·¥å…·ï¼šcharlesã€wireshark</p>
</li>
</ol>
<h3 id="cpuæ»¡è´Ÿè½½é—®é¢˜">CPUæ»¡è´Ÿè½½é—®é¢˜</h3>
<ol>
<li>æ‰¾å‡ºæ¶ˆè€—cpuæœ€é«˜çš„è¿›ç¨‹PID<br>
top -c	ï¼ˆæ˜¾ç¤ºè¿›ç¨‹è¿è¡Œä¿¡æ¯åˆ—è¡¨ï¼Œé»˜è®¤CPUä½¿ç”¨ç‡æ’åºï¼‰</li>
<li>æ ¹æ®PIDæŸ¥å‡ºæ¶ˆè€—cpuæœ€é«˜çš„çº¿ç¨‹å·<br>
top -Hp pid ï¼ˆæ˜¾ç¤ºä¸€ä¸ªè¿›ç¨‹çš„çº¿ç¨‹è¿è¡Œä¿¡æ¯åˆ—è¡¨ï¼Œé»˜è®¤CPUä½¿ç”¨ç‡æ’åºï¼‰<br>
2.1 çº¿ç¨‹idåè¿›åˆ¶è½¬16è¿›åˆ¶ï¼š<br>
printf â€œ%x\nâ€ xxoo</li>
<li>å¯¼å‡ºè¿›ç¨‹å¿«ç…§<br>
jstack -l pid &gt; pid.stack</li>
<li>æ ¹æ®çº¿ç¨‹å·æŸ¥å‡ºå¯¹åº”çš„javaçº¿ç¨‹ï¼Œè¿›è¡Œå¤„ç†<br>
cat pid.stack | grep â€˜åå…­è¿›åˆ¶çº¿ç¨‹å·â€™ -C 10</li>
</ol>
<p>jps -l è¾“å‡ºjavaè¿›ç¨‹pid-è¿›ç¨‹åä¿¡æ¯<br>
top -Hp pid è¾“å‡ºæŒ‡å®šjavaè¿›ç¨‹çº¿ç¨‹æ¶ˆè€—cpuæ’è¡Œ<br>
jstack -l pid å¯¼å‡ºjavaè¿›ç¨‹çš„å †æ ˆä¿¡æ¯</p>
]]></content>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Redisç¬”è®°</title>
    <url>/article/Redis%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h3 id="sds">SDS</h3>
<p>SDSæ˜¯Redisé‡Œçš„åŠ¨æ€å­—ç¬¦ä¸²è¡¨ç¤ºæ–¹å¼ï¼Œä½†æ˜¯ï¼ŒæŸ¥çœ‹Redis6.0.5æºç SDSå®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">typedef char *sds;</span><br></pre></td></tr></table></figure>
<p>whatï¼Ÿè¿™ä¸å°±æ˜¯ç®€å•çš„å­—ç¬¦ä¸²æŒ‡é’ˆå—ï¼Ÿæ€ä¹ˆå°±åŠ¨æ€äº†ï¼Ÿä¸”æ…¢ï¼Œå¾€åçœ‹ã€‚</p>
<p>Redisé‡Œé¢å®šä¹‰äº”ç§ç±»å‹çš„SDSï¼Œä»–ä»¬çš„åŒºåˆ«æ˜¯headerå¤§å°ä¸ä¸€æ ·ï¼Œå­—ç¬¦ä¸²æŒ‡é’ˆsdså§‹ç»ˆæŒ‡å‘bufçš„ä½ç½®ï¼Œç„¶åé€šè¿‡æŒ‡é’ˆç§»ä½æ¥æ“ä½œheaderé‡Œçš„å­—æ®µã€‚è¿™é‡Œæœ‰ä¸ªgcc cè¯­è¨€çš„å±æ€§<code>__attribute__ ((__packed__))</code>è®¾ç½®ï¼Œè¡¨ç¤ºç»“æ„ä½“å†…å­˜å¸ƒå±€ç´§å‡‘æ’åˆ—ï¼ŒæŒ‰1å­—èŠ‚å¯¹é½ï¼Œä»¥èŠ‚çœå†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Note: sdshdr5 is never used, we just access the flags byte directly.</span></span><br><span class="line"><span class="comment"> * However is here to document the layout of type 5 SDS strings. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr5</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr8</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint8_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr16</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint16_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr32</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">attribute__</span> ((__<span class="title">packed__</span>)) <span class="title">sdshdr64</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> len; <span class="comment">/* used */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> alloc; <span class="comment">/* excluding the header and null terminator */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags; <span class="comment">/* 3 lsb of type, 5 unused bits */</span></span><br><span class="line">    <span class="keyword">char</span> buf[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/redis-sds.jpg" alt=""></p>
<p>Redisé‡Œé¢çš„sdså§‹ç»ˆæŒ‡å‘åŠ¨æ€å­—ç¬¦ä¸²bufä½ç½®ï¼Œåœ¨åˆ›å»ºå­—ç¬¦ä¸²ç±»å‹çš„redisObjectæ—¶ï¼Œä¼šåˆ†é…å®é™…bufé•¿åº¦çš„å†…å­˜åŠ ä¸Šsds headerçš„å†…å­˜å’Œä¸€ä¸ªå­—ç¬¦ä¸²ç»“æŸç¬¦ä½ç½®çš„å†…å­˜ã€‚ç„¶ååœ¨åˆ›å»ºredisObjectä¹‹å‰ä¼šæ ¹æ®å®é™…å­—ç¬¦ä¸²å¤§å°æ¥é€‰æ‹©éœ€è¦æ·»åŠ çš„sds header</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®å­—ç¬¦ä¸²å¤§å°ï¼Œé€‰æ‹©sdsç±»å‹ï¼ˆåŒºåˆ«åœ¨headerå¤§å°ä¸ä¸€æ ·ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">char</span> <span class="title">sdsReqType</span><span class="params">(<span class="keyword">size_t</span> string_size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1</span>&lt;&lt;<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_5;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1</span>&lt;&lt;<span class="number">8</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_8;</span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1</span>&lt;&lt;<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_16;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (LONG_MAX == LLONG_MAX)</span></span><br><span class="line">    <span class="keyword">if</span> (string_size &lt; <span class="number">1l</span>l&lt;&lt;<span class="number">32</span>)</span><br><span class="line">        <span class="keyword">return</span> SDS_TYPE_32;</span><br><span class="line">    <span class="keyword">return</span> SDS_TYPE_64;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> SDS_TYPE_32;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ç±»å‹SDS_TYPE_8ä¸ºä¾‹ï¼Œå°†ä¸ºè¿™ç§å­—ç¬¦ä¸²ç±»å‹çš„redisObjectåˆ†é…sizeof(redisObject) + sdshdr8 + len +1å¤§å°çš„å†…å­˜ï¼Œå¹¶è®¾ç½®sdsçš„headeræŒ‡é’ˆä½ç½®ï¼Œç„¶åè®¾ç½®headerå±æ€§ï¼Œè®¾ç½®bufçš„å€¼ï¼Œæœ€åæ·»åŠ å­—ç¬¦ä¸²ç»“æŸç¬¦â€™\0â€™</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Create a string object with encoding OBJ_ENCODING_EMBSTR, that is</span></span><br><span class="line"><span class="comment"> * an object where the sds string is actually an unmodifiable string</span></span><br><span class="line"><span class="comment"> * allocated in the same chunk as the object itself. */</span></span><br><span class="line"><span class="function">robj *<span class="title">createEmbeddedStringObject</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *ptr, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">  	<span class="comment">// åˆ†é…sizeof(robj)+sizeof(struct sdshdr8)+len+1å¤§å°çš„å†…å­˜</span></span><br><span class="line">    robj *o = zmalloc(<span class="keyword">sizeof</span>(robj)+<span class="keyword">sizeof</span>(struct sdshdr8)+len+<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®sds headeræŒ‡é’ˆä½ç½®ï¼Œè·³è¿‡redisObjectå¤§å°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sdshdr8</span> *<span class="title">sh</span> = (<span class="title">void</span>*)(<span class="title">o</span>+1);</span></span><br><span class="line">		<span class="comment">// è®¾ç½®redisObjectå±æ€§</span></span><br><span class="line">    o-&gt;type = OBJ_STRING;</span><br><span class="line">    o-&gt;encoding = OBJ_ENCODING_EMBSTR;</span><br><span class="line">   <span class="comment">// redisObject-&gt;ptr æŒ‡å‘bufä½ç½® </span></span><br><span class="line">    o-&gt;ptr = sh+<span class="number">1</span>;</span><br><span class="line">    o-&gt;refcount = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (server.maxmemory_policy &amp; MAXMEMORY_FLAG_LFU) &#123;</span><br><span class="line">        o-&gt;lru = (LFUGetTimeInMinutes()&lt;&lt;<span class="number">8</span>) | LFU_INIT_VAL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        o-&gt;lru = LRU_CLOCK();</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// è®¾ç½®sds headerå±æ€§</span></span><br><span class="line">    sh-&gt;len = len;</span><br><span class="line">    sh-&gt;alloc = len;</span><br><span class="line">    sh-&gt;flags = SDS_TYPE_8;</span><br><span class="line">    <span class="comment">// æ·»åŠ å­—ç¬¦ä¸²ç»“æŸç¬¦</span></span><br><span class="line">    <span class="keyword">if</span> (ptr == SDS_NOINIT)</span><br><span class="line">        sh-&gt;buf[len] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(sh-&gt;buf,ptr,len);</span><br><span class="line">        sh-&gt;buf[len] = <span class="string">'\0'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">memset</span>(sh-&gt;buf,<span class="number">0</span>,len+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="redisæ•°æ®ç±»å‹">Redisæ•°æ®ç±»å‹</h3>
<p>å­—ç¬¦ä¸²String</p>
<p>Hashè¡¨</p>
<p>Liståˆ—è¡¨ï¼š</p>
<p>LPUSH + BRPOP å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¿è¯æ¶ˆæ¯é¡ºåºæ€§ï¼›ä¸è¶³çš„åœ°æ–¹ï¼šä¸æ”¯æŒæ¶ˆæ¯çš„æ¶ˆè´¹ç¡®è®¤ï¼Œä¸èƒ½åšå¹¿æ’­æ¨¡å¼ï¼Œä¸èƒ½é‡å¤æ¶ˆè´¹ï¼Œä¸æ”¯æŒåˆ†ç»„æ¶ˆè´¹</p>
<p>LPUSH + LPOP å®ç°æ ˆï¼Œå…ˆè¿›åå‡º</p>
<p>LPUSH + RPOP å®ç°é˜Ÿåˆ—ï¼Œå…ˆè¿›å…ˆå‡º</p>
<p>LPUSH + LTRIM å®ç°æœ‰é™é˜Ÿåˆ—</p>
<p>Seté›†åˆï¼š</p>
<p>æ•°æ®å»é‡ï¼Œäº¤é›†ã€å¹¶é›†æ“ä½œï¼Œå®ç°å…±åŒå…³æ³¨ç­‰åŠŸèƒ½</p>
<p>Sorted Setæœ‰åºé›†åˆï¼š</p>
<p>å„ç±»æ’è¡Œæ¦œï¼ŒèŒƒå›´æŸ¥æ‰¾</p>
<p>HyperLogLogï¼š</p>
<p>ä¸ç²¾ç¡®ï¼ˆ0.81%çš„é”™è¯¯ç‡ï¼‰çš„å»é‡ç»Ÿè®¡ï¼Œæ¯”å¦‚ï¼šç½‘ç«™UVæ•°ã€è®¿é—®IPæ•°ç­‰</p>
<p>Geoï¼š</p>
<p>Streamï¼šç”¨äºå®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæ”¯æŒæ¶ˆæ¯IDè‡ªåŠ¨ç”Ÿæˆï¼Œæ¶ˆæ¯éå†ï¼Œæ¶ˆæ¯çš„é˜»å¡å’Œéé˜»å¡è¯»å–ï¼Œæ¶ˆæ¯çš„åˆ†ç»„æ¶ˆè´¹ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹ç¡®è®¤ï¼Œæœªå®Œæˆæ¶ˆæ¯çš„å¤„ç†ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç›‘æ§ï¼‰å‚è€ƒ <a href="http://www.hellokang.net/redis/stream.html#_10-%E5%91%BD%E4%BB%A4%E4%B8%80%E8%A7%88" target="_blank" rel="noopener">http://www.hellokang.net/redis/stream.html#_10-%E5%91%BD%E4%BB%A4%E4%B8%80%E8%A7%88</a></p>
<p>Streamåº•å±‚æ•°æ®ç»“æ„Radixæ ‘ï¼ˆåŸºæ•°æ ‘ï¼‰ï¼Œå¯ä»¥çœ‹ä½œæ˜¯Trieæ ‘ï¼ˆå­—å…¸æ ‘ï¼‰çš„å˜ç§</p>
<p>åŸºæ•°æ ‘ï¼ˆé•¿æ•´å‹åˆ°å¯¹è±¡çš„æ˜ å°„ï¼‰</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E5%9F%BA%E6%95%B0%E6%A0%91.jpg" alt=""></p>
<p>å­—å…¸æ ‘ï¼ˆå­—ç¬¦ä¸²åˆ°å¯¹è±¡çš„æ˜ å°„ï¼‰</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E5%AD%97%E5%85%B8%E6%A0%91.jpg" alt=""></p>
<p>PUB/SUB è®¢é˜…/å‘å¸ƒ ï¼ˆç”¨ä½œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ”¯æŒå¹¿æ’­æ¨¡å¼ï¼Œæ”¯æŒæ¶ˆæ¯å³æ—¶æ¨é€ï¼Œæ”¯æŒæ¶ˆè´¹è€…åŒæ—¶è®¢é˜…å¤šä¸ªä¿¡é“ä»è€Œæ¥å—å¤šç±»æ¶ˆæ¯ï¼Œä¸è¶³çš„åœ°æ–¹ï¼šä¸æ”¯æŒæ¶ˆæ¯çš„æ¶ˆè´¹ç¡®è®¤ï¼Œä¸èƒ½é‡å¤æ¶ˆè´¹ï¼‰</p>
<p><strong>Redisæ¯ç§æ•°ç»„ç±»å‹åœ¨åº•å±‚éƒ½æ˜¯åŠ¨æ€ç¼–ç çš„ï¼Œæ¯”å¦‚é»˜è®¤zsetæ˜¯ä»¥ziplistç¼–ç çš„ï¼Œå½“zsetä¸ªæ•°è¶…è¿‡128æ—¶ï¼Œzsetè½¬æ¢ç¼–ç ä¸ºskiplistã€‚ä½†æ˜¯è¿™ç§ç¼–ç è½¬æ¢æ˜¯ä¸å¯é€†çš„ã€‚æ¯”å¦‚å†å°†zsetå…ƒç´ å‡å°‘åˆ°å°äº128æ—¶ï¼Œzsetç¼–ç ä¾ç„¶æ˜¯skiplist</strong></p>
<h3 id="redisæŸ¥çœ‹å¸®åŠ©">RedisæŸ¥çœ‹å¸®åŠ©</h3>
<p>å‘½ä»¤è¡Œä¸‹è¾“å…¥help @ï¼Œå†æŒ‰tabé”®ä¼šæç¤ºå¯ä»¥æŸ¥çœ‹helpçš„æ•°æ®ç±»å‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; help @string</span><br><span class="line">127.0.0.1:6379&gt; help @hash</span><br><span class="line">127.0.0.1:6379&gt; help @list</span><br><span class="line">127.0.0.1:6379&gt; help @set</span><br><span class="line">127.0.0.1:6379&gt; help @sorted_set</span><br><span class="line">127.0.0.1:6379&gt; help @geo</span><br><span class="line">127.0.0.1:6379&gt; help @pubsub</span><br><span class="line">127.0.0.1:6379&gt; help @transactions</span><br><span class="line">127.0.0.1:6379&gt; help @connection</span><br><span class="line">127.0.0.1:6379&gt; help @generic</span><br></pre></td></tr></table></figure>
<h3 id="redisé…ç½®ä¿¡æ¯å†…å­˜å ç”¨æŸ¥çœ‹">Redisé…ç½®ä¿¡æ¯å†…å­˜å ç”¨æŸ¥çœ‹</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INFO</span><br><span class="line"></span><br><span class="line">MEMORY HELPã€MEMORY USAGE keyã€redis-cli --bigkeysã€DEBUG OBJECT key</span><br><span class="line"></span><br><span class="line">CONFIG HELPã€CONFIG GET *ã€INFO Commandstatså‘½ä»¤è·å–ï¼ŒåŒ…å«æ¯ä¸ªå‘½ä»¤è°ƒç”¨æ¬¡æ•°ï¼Œæ€»è€—æ—¶ï¼Œå¹³å‡è€—æ—¶ï¼Œå•ä½å¾®ç§’</span><br><span class="line"></span><br><span class="line">CONFIG GET zset-max-ziplist-value</span><br><span class="line"></span><br><span class="line">CONFIG GET zset-max-ziplist-entries</span><br><span class="line"></span><br><span class="line">å½“æ»¡è¶³ä»»æ„æ¡ä»¶:</span><br><span class="line">valueæœ€å¤§ç©ºé—´(å­—èŠ‚)&gt;zset-max-ziplist-value</span><br><span class="line">æœ‰åºé›†åˆé•¿åº¦&gt;zset-max-ziplist-entries</span><br><span class="line"></span><br><span class="line">zsetä½¿ç”¨skiplistï¼Œå¦åˆ™ä½¿ç”¨ziplist</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-é›†æˆWEBå®¹å™¨AccessLogé…ç½®</title>
    <url>/article/SpringBoot-%E9%9B%86%E6%88%90WEB%E5%AE%B9%E5%99%A8AccessLog%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>SpringBooté¡¹ç›®é›†æˆWEBå®¹å™¨tomcatã€undertowï¼Œaccess logé…ç½®ï¼Œæ³¨æ„ä¸¤è€…çš„å¾®å°å·®åˆ«ï¼Œtomcatçš„æ—¥å¿—ç›®å½•å…³é”®å­—æ˜¯basedirï¼Œundertowæ˜¯directoryã€‚tomcatçš„æ‰©å±•æ‰“å°httpå¤´æ—¥å¿—æ ¼å¼æ˜¯%{xxx}iï¼Œundertowçš„æ‰©å±•æ‰“å°httpå¤´æ—¥å¿—æ ¼å¼æ˜¯%{i,xxx}</p>
<ol>
<li>é›†æˆtomcat</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server.tomcat.basedir=$&#123;log.path&#125;</span><br><span class="line">server.tomcat.accesslog.enabled=true</span><br><span class="line">server.tomcat.accesslog.pattern=%t %a &quot;%r&quot; %s (%D ms)</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­pattern å¸¸ç”¨æ¨¡å¼ï¼šcommonã€combined</p>
<ul>
<li><strong>common</strong> - <code>%h %l %u %t &quot;%r&quot; %s %b</code></li>
<li><strong>combined</strong> - <code>%h %l %u %t &quot;%r&quot; %s %b &quot;%{Referer}i&quot; &quot;%{User-Agent}i&quot;</code></li>
</ul>
<p>è‡ªå®šä¹‰patternï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/tomcat-access-log-pattern.jpg" alt=""></p>
<ol>
<li>é›†æˆundertow</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server.undertow.accesslog.directory=$&#123;log.path&#125;</span><br><span class="line">server.undertow.accesslog.enabled=true</span><br><span class="line">server.undertow.accesslog.pattern=%t %a &quot;%r&quot; %s (%D ms)</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­pattern å¸¸ç”¨æ¨¡å¼ï¼šcommonã€combined</p>
<ul>
<li><strong>common</strong> - <code>%h %l %u %t &quot;%r&quot; %s %b</code></li>
<li><strong>combined</strong> - <code>%h %l %u %t &quot;%r&quot; %s %b &quot;%{i,Referer}&quot; &quot;%{i,User-Agent}&quot;</code></li>
</ul>
<p>è‡ªå®šä¹‰patternï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/undertow-access-log-pattern.jpg" alt=""></p>
]]></content>
      <tags>
        <tag>access.log</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootå¯åŠ¨æµç¨‹</title>
    <url>/article/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="å¯åŠ¨ç±»">å¯åŠ¨ç±»</h3>
<p>SpringBootåº”ç”¨å¯åŠ¨ç±»SpringApplicationï¼Œæä¾›äº†ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼ˆå…¶å®åº•å±‚æ˜¯ä¸€ç§ï¼‰ï¼Œå¦‚ä¸‹ï¼š</p>
<p>ç¬¬ä¸€ç§ï¼šæä¾›äº†é™æ€runæ–¹æ³•ï¼Œä¼ å…¥mainå‡½æ•°æ‰€åœ¨ç±»classä½œä¸ºå‚æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SpringApplication.run(Main.class); <span class="comment">//åº•å±‚è°ƒç”¨ new SpringApplication(primarySources).run(args);</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§ï¼šæä¾›å®ä¾‹runæ–¹æ³•ï¼Œå®ä¾‹åŒ–SpringApplicationæ—¶ä¼ å…¥mainå‡½æ•°æ‰€åœ¨ç±»classä½œä¸ºå‚æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SpringApplication application = <span class="keyword">new</span> SpringApplication(App.class);</span><br><span class="line">application.run(args); <span class="comment">// åŒ application.run();</span></span><br></pre></td></tr></table></figure>
<p>å…ˆåˆ†æSpringApplicationçš„æ„é€ æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">		Assert.notNull(primarySources, <span class="string">"PrimarySources must not be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">    <span class="comment">// step 1</span></span><br><span class="line">		<span class="keyword">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">    <span class="comment">// step 2</span></span><br><span class="line">		setInitializers((Collection)    getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">  	<span class="comment">// step 3</span></span><br><span class="line">		setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">    <span class="comment">// step 4</span></span><br><span class="line">		<span class="keyword">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>æ ¹æ®classpathä¸‹æ˜¯å¦åŒ…å«webç›¸å…³ç±»æ¨æ–­webç¯å¢ƒï¼šreactiveã€servletã€none</p>
</li>
<li>
<p>æ ¹æ®classpathä¸‹jaråŒ…èµ„æºè·¯å¾„ä¸‹META-INF/spring.factoriesæ–‡ä»¶å¾—åˆ°å·¥å‚ç±»å…¨è·¯å¾„åç§°å¹¶ç¼“å­˜åˆ°Map&lt;ClassLoader, MultiValueMap&lt;String, String&gt;&gt; cacheï¼Œåç»­éœ€è¦ä»cacheé‡Œæ ¹æ®keyï¼ˆæ¥å£å…¨è·¯å¾„åç§°ï¼‰æ‰¾åˆ°å®ç°ç±»å…¨è·¯å¾„åç§°å¹¶å®ä¾‹åŒ–å®ç°ç±»</p>
</li>
<li>
<p>ä»2ä¸­cacheæŸ¥æ‰¾æ¥å£org.springframework.context.ApplicationContextInitializerçš„æ‰€æœ‰å®ç°ç±»å…¨è·¯å¾„åç§°å¹¶å®ä¾‹åŒ–å­˜å…¥initializersåˆ—è¡¨</p>
</li>
<li>
<p>ä»2ä¸­cacheæŸ¥æ‰¾æ¥å£org.springframework.context.ApplicationListenerçš„æ‰€æœ‰å®ç°ç±»å…¨è·¯å¾„åç§°å¹¶å®ä¾‹åŒ–å­˜å…¥listenersåˆ—è¡¨</p>
</li>
<li>
<p>ä»RuntimeException().getStackTrace()æ¨æ–­å‡ºmainå‡½æ•°æ‰€åœ¨ç±»å¹¶å®ä¾‹åŒ–</p>
</li>
</ol>
<h3 id="runæ–¹æ³•">Runæ–¹æ³•</h3>
<ol>
<li>
<p>ä»ä¸Šä¸€æ­¥2ä¸­cacheæŸ¥æ‰¾æ¥å£org.springframework.boot.SpringApplicationRunListenerçš„æ‰€æœ‰å®ç°ç±»å…¨è·¯å¾„åç§°å¹¶å®ä¾‹åŒ–ï¼ˆåªæœ‰1ä¸ªå®ç°ç±»EventPublishingRunListenerï¼‰ï¼Œç„¶åç”¨å®ä¾‹åŒ–çš„EventPublishingRunListenerç±»Listå®ä¾‹åŒ–ç±»SpringApplicationRunListeners</p>
<p>âš ï¸ï¼šå®ä¾‹åŒ–EventPublishingRunListenerç±»æ—¶ï¼Œä¼šå°†ä¸Šä¸€æ­¥4ä¸­çš„listenersåŠ å…¥åˆ°EventPublishingRunListenerçš„å¤šæ’­åˆ—è¡¨ä¸­æ¥</p>
</li>
<li>
<p>è¿è¡ŒSpringApplicationRunListeners.startingæ–¹æ³•ï¼Œéå†æ‰§è¡Œä¸Šä¸€æ­¥çš„org.springframework.boot.SpringApplicationRunListenerçš„æ‰€æœ‰å®ç°ç±»ï¼ˆåªæœ‰1ä¸ªå®ç°ç±»ï¼šEventPublishingRunListenerï¼‰çš„startingæ–¹æ³•</p>
<p>âš ï¸ï¼šEventPublishingRunListenerçš„startingæ–¹æ³•æ‰§è¡Œå¤šæ’­ï¼Œé€šçŸ¥å¤šæ’­åˆ—è¡¨çš„æ‰€æœ‰Listenersäº‹ä»¶ApplicationStartingEventï¼Œç›¸åº”çš„listenerï¼ˆgetListenerçš„æ—¶å€™é€šè¿‡äº‹ä»¶ç±»å‹åˆ¤æ–­listeneræ˜¯å¦æ”¯æŒæ­¤äº‹ä»¶ç±»å‹ï¼‰å¯¹ApplicationStartingEventäº‹ä»¶ä½œå‡ºç›¸åº”ï¼ˆå›è°ƒonApplicationEventæ–¹æ³•ï¼‰</p>
</li>
<li>
<p>æ ¹æ®webç¯å¢ƒç±»å‹å®ä¾‹åŒ–Environmentï¼šStandardServletEnvironmentï¼Œå¹¶å¤šæ’­é€šçŸ¥ç›¸åº”çš„Listenersäº‹ä»¶ApplicationEnvironmentPreparedEvent</p>
<p>âš ï¸ï¼šConfigFileApplicationListenerå“åº”ApplicationEnvironmentPreparedEventäº‹ä»¶ï¼Œä»ä¸Šä¸€æ­¥2ä¸­cacheæŸ¥æ‰¾æ¥å£org.springframework.boot.env.EnvironmentPostProcessorçš„æ‰€æœ‰å®ç°ç±»å…¨è·¯å¾„åç§°å¹¶å®ä¾‹åŒ–ï¼Œç„¶åä¾æ¬¡è°ƒç”¨æ¯ä¸ªå®ç°ç±»çš„postProcessEnvironmentæ–¹æ³•ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å®ç°ç±»SystemEnvironmentPropertySourceEnvironmentPostProcessorè´Ÿè´£è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œå­˜å…¥StandardServletEnvironmentå®ä¾‹</span><br><span class="line">ConfigFileApplicationListenerå®ä¾‹åŒ–PropertiesLoaderå’ŒYamlLoaderæ¥è¯»å–é…ç½®æ–‡ä»¶å‚æ•°å­˜å…¥StandardServletEnvironmentå®ä¾‹</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ‰“å°Banner</p>
</li>
<li>
<p>æ ¹æ®webç¯å¢ƒç±»å‹å®ä¾‹åŒ–ApplicationContextï¼šclass org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext</p>
<p>æ³¨æ„ï¼šå®ä¾‹åŒ–AnnotationConfigServletWebServerApplicationContextæ—¶ï¼Œä¼šä¼ å…¥AnnotatedBeanDefinitionReaderå®ä¾‹å’ŒClassPathBeanDefinitionScannerå®ä¾‹ï¼Œç”¨äºæ³¨è§£ã€ç±»è·¯å¾„é…ç½®æ–‡ä»¶æè¿°çš„beanæ³¨å…¥</p>
</li>
<li>
<p>å®ä¾‹åŒ–ExceptionReporterç±»ç”¨äºå¼‚å¸¸æŠ¥å‘Šå¤„ç†</p>
</li>
<li>
<p>prepareContextï¼Œå‘AnnotationConfigServletWebServerApplicationContextå®ä¾‹åº”ç”¨Initializerå¹¶è®¾ç½®ç¯å¢ƒå˜é‡Environmentå®ä¾‹ï¼Œç„¶åå¤šæ’­é€šçŸ¥ApplicationContextInitializedEventäº‹ä»¶</p>
</li>
<li>
<p>logStartupProfileInfoï¼Œæ‰“å°æ—¥å¿—è®°å½•å¯åŠ¨ä½¿ç”¨çš„profile</p>
</li>
<li>
<p>é€šè¿‡AnnotationConfigServletWebServerApplicationContext.beanFactoryæ³¨å†Œä¸¤ä¸ªå•ä¾‹å®ä¾‹SpringApplicationArgumentså’ŒSpringBootBanner</p>
</li>
<li>
<p>loadContextï¼Œæ³¨å†Œå¯åŠ¨ç±»beanå®ä¾‹åˆ°ApplicationContextï¼Œç„¶åæ·»åŠ ç›‘å¬å™¨åˆ°ApplicationContextï¼Œå¤šæ’­é€šçŸ¥ApplicationPreparedEventäº‹ä»¶</p>
</li>
<li>
<p>refreshContextï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// æ‰§è¡Œcontext refreshingå‰çš„å‡†å¤‡å·¥ä½œæ¯”å¦‚ä¸€äº›å±æ€§çš„åˆå§‹åŒ–</span><br><span class="line">prepareRefresh()</span><br><span class="line">// é…ç½®BeanFactoryçš„ä¸Šä¸‹æ–‡ç¯å¢ƒç‰¹æ€§å¦‚ç±»åŠ è½½å™¨ã€åç½®å¤„ç†å™¨</span><br><span class="line">prepareBeanFactory()</span><br><span class="line">// æ³¨å†ŒBean</span><br><span class="line">postProcessBeanFactory()</span><br><span class="line">invokeBeanFactoryPostProcessors()</span><br><span class="line">registerBeanPostProcessors()</span><br><span class="line">// åˆå§‹åŒ–äº‹ä»¶å¤šæ’­å™¨åˆ°ApplicationContext</span><br><span class="line">initApplicationEventMulticaster()</span><br><span class="line">// æ³¨å†Œç‰¹å®šç¯å¢ƒç›¸å…³beanï¼ˆæ­¤å¤„åˆå§‹åŒ–webå®¹å™¨ï¼‰</span><br><span class="line">OnRefresh()</span><br><span class="line">// æ·»åŠ ç›‘å¬å™¨åˆ°äº‹ä»¶å¤šæ’­å™¨</span><br><span class="line">registerListeners()</span><br><span class="line">// åˆå§‹åŒ–æ‰€æœ‰å‰©ä¸‹çš„å•ä¾‹bean</span><br><span class="line">beanfactory.preInstantiateSingletons()</span><br><span class="line">// å¤šæ’­é€šçŸ¥ContextRefreshedEventäº‹ä»¶</span><br><span class="line">publishEvent()</span><br><span class="line">// åœ¨æ­¤å¤„å¯åŠ¨webå®¹å™¨ï¼Œwebå®¹å™¨å¯åŠ¨å®Œæˆåï¼Œå¤šæ’­é€šçŸ¥ServletWebServerInitializedEventäº‹ä»¶</span><br><span class="line">finishRefresh()</span><br><span class="line">// å‘JVMæ³¨å†Œä¼˜é›…åœæœºé’©å­å‡½æ•°ï¼Œç”¨äºå•ä¾‹é‡Šæ”¾ç­‰æ“ä½œ</span><br><span class="line">Runtime.getRuntime().addShutdownHook(hook_thread)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>afterRefreshï¼Œé»˜è®¤å®ç°ä¸ºç©ºï¼Œå¯ä»¥ç»§æ‰¿è‡ªSpringApplicationè‡ªå®šä¹‰å®ç°</p>
</li>
<li>
<p>å¤šæ’­é€šçŸ¥ApplicationStartedEventäº‹ä»¶</p>
</li>
<li>
<p>callRunnerï¼Œè°ƒç”¨ApplicationRunneræ¥å£å’ŒCommandLineRunneræ¥å£çš„å®ç°ç±»</p>
</li>
</ol>
<pre><code> <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CommandLineRunnerå’ŒApplicationRunnerçš„åŒºåˆ«ä»…ä»…æ˜¯runæ–¹æ³•çš„å…¥å‚ç±»å‹ä¸ä¸€æ ·ï¼ŒApplicationRunnerä¸­runæ–¹æ³•çš„å‚æ•°ä¸ºApplicationArgumentsï¼Œè€ŒCommandLineRunneræ¥å£ä¸­runæ–¹æ³•çš„å‚æ•°ä¸ºStringæ•°ç»„</span><br></pre></td></tr></table></figure>

15. å¤šæ’­é€šçŸ¥ApplicationReadyEventäº‹ä»¶
</code></pre>
<p>å¦å¤–SpringBootå¯åŠ¨èµ·æ¥æ€ä¹ˆæ²¡é€€å‡ºï¼Ÿ</p>
<h3 id="jvmé€€å‡ºæœºåˆ¶">JVMé€€å‡ºæœºåˆ¶</h3>
<pre><code>1. æ‰€æœ‰çš„édaemonçº¿ç¨‹é€€å‡º
2. æŸä¸ªçº¿ç¨‹æ˜¾å¼çš„è°ƒç”¨äº†System.exit()æˆ–Runtime.exit()
</code></pre>
<p>æ‰€ä»¥ä¸€å®šæœ‰édaemonçº¿ç¨‹åœ¨è¿è¡Œï¼Œå½“å¯åŠ¨tomcatå®¹å™¨æ—¶ï¼Œä¼šå¯åŠ¨çº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œå› ä¸ºæœ‰è¿™ä¸ªçº¿ç¨‹ä¸€ç›´åœ¨è¿è¡Œï¼Œæ‰€ä»¥JVMä¸ä¼šé€€å‡º</p>
<h3 id="çº¿ç¨‹æ± å¼‚å¸¸å¤„ç†">çº¿ç¨‹æ± å¼‚å¸¸å¤„ç†</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">çº¿ç¨‹æ± å¯¹ä»»åŠ¡å¼‚å¸¸é»˜è®¤ä¸ä½œå¤„ç†</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>spring-boot</tag>
      </tags>
  </entry>
  <entry>
    <title>godaddyåŸŸå+cloudflare_CDN+v2ray+caddyçºªå®</title>
    <url>/article/godaddy%E5%9F%9F%E5%90%8D-cloudflare-CDN-v2ray-caddy%E7%BA%AA%E5%AE%9E/</url>
    <content><![CDATA[<p>ç¥–å›½70å¤§å¯¿ä¸´è¿‘ï¼Œç½‘ç»œå®‰å…¨å‡çº§ï¼Œvpsè¢«å°ã€‚æ­¤æ—¶æˆ‘åªæƒ³é«˜æ­Œä¸€æ›²ï¼šæˆ‘çˆ±ä½ ï¼Œä¸­å›½ã€‚ã€‚ã€‚</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/pingpe-test.jpg" alt=""></p>
<p>ç”¨ <a href="http://ping.pe/ping.php" target="_blank" rel="noopener">http://ping.pe/ping.php</a> pingä¸€ä¸‹ä½ çš„vpsï¼Œå¦‚æœå›½å†…çš„èŠ‚ç‚¹100%lossï¼Œå›½å¤–èŠ‚ç‚¹å¯æ­£å¸¸è®¿é—®ï¼Œå³è¯´æ˜IPè¢«å°äº†ã€‚æ­¤æ—¶ç›´æ¥é€šè¿‡vpsæ­å»ºv2rayæˆ–ssç¿»å¢™å·²ç»è¡Œä¸é€šäº†ã€‚</p>
<p>å‚è€ƒç½‘ä¸Šèµ„æ–™é€šè¿‡åŸŸå+CDN+v2rayçš„æ–¹å¼æˆåŠŸå®ç°ç¿»å¢™ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<h2 id="godaddyè´­ä¹°åŸŸå">godaddyè´­ä¹°åŸŸå</h2>
<ol>
<li>
<p>æ³¨å†Œè´¦å·</p>
</li>
<li>
<p>é€‰è´­åŸŸå</p>
</li>
<li>
<p>é…ç½®åŸŸåæœåŠ¡å™¨ï¼Œæ­¤å¤„è¦å¡«å†™cloudflareä¸­çš„åŸŸåæœåŠ¡å™¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bella.ns.cloudflare.com</span><br><span class="line">carter.ns.cloudflare.com</span><br></pre></td></tr></table></figure>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/godaddy-dnsserver.jpg" alt=""></p>
</li>
</ol>
<h2 id="cloudflareæ·»åŠ åŸŸå">cloudflareæ·»åŠ åŸŸå</h2>
<ol>
<li>
<p>æ³¨å†Œè´¦å·</p>
</li>
<li>
<p>æ·»åŠ ç½‘å€</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/cloudflare-addsite.jpg" alt=""></p>
</li>
<li>
<p>åˆ°åŸŸåè´­ä¹°å•†ç½‘ç«™é…ç½®åŸŸåæœåŠ¡å™¨ï¼Œé…ç½®æˆcloudflareçš„åŸŸåæœåŠ¡å™¨ï¼ˆå³ä¸Šä¸€æ­¥éª¤-3ï¼‰</p>
</li>
<li>
<p>é€‰æ‹©DNSé€‰é¡¹å¡ï¼Œæ·»åŠ Aè®°å½•é…ç½®åŸŸåDNSè§£æåˆ°VPS IPåœ°å€ ï¼ˆåœ¨DNSé€‰é¡¹å¡é‡Œç¡®ä¿äº‘æœµå›¾æ ‡æ˜¯ç°è‰²ï¼‰</p>
</li>
<li>
<p>é€‰æ‹©SSL/TLSé€‰é¡¹å¡ï¼Œé€‰æ‹©SSL/TLSæ¨¡å¼ä¸ºFull(strict)</p>
</li>
<li>
<p>é€‰æ‹©SSL/TLSé€‰é¡¹å¡ï¼Œé€‰æ‹©Origin Serverå­é€‰é¡¹å¡ï¼Œç‚¹å‡»Creat Certificateï¼Œåˆ›å»ºå…è´¹è¯ä¹¦ï¼Œæ­¤æ—¶ä¼šç”Ÿæˆä¸¤ä¸ªå¯†æ–‡ï¼Œå¤åˆ¶ä¸Šé¢çš„åˆ°vpsæœåŠ¡å™¨ä¿å­˜ä¸ºxxx.pemï¼Œå¤åˆ¶ä¸‹é¢çš„åˆ°vpsæœåŠ¡å™¨xxx.keyã€‚ç”±äºcaddyå‘Letâ€™s Encryptç­¾åè¯ä¹¦æ€»æ˜¯å¤±è´¥ï¼Œæˆ‘ä»¬åé¢ä¼šä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼ŒæŒ‡å®šçš„ è¯ä¹¦å³ä¸ºè¿™å„¿çš„xxx.pemï¼Œè¯ä¹¦keyå³ä¸ºè¿™å„¿çš„xxx.key</p>
</li>
<li>
<p>cloudflareçš„é…ç½®è‡³æ­¤å‘Šä¸€æ®µè½ï¼Œç„¶åç§»æ­¥è‡³vpsæœåŠ¡å™¨é…ç½®v2rayå’Œcaddyï¼Œé…ç½®è¿è¡ŒOKåï¼Œå›åˆ°cloudflareï¼Œé€‰æ‹©DNSé€‰é¡¹å¡ï¼Œå°†äº‘æœµå›¾æ ‡ç‚¹äº®ä¸ºæ©™è‰²ï¼ˆDNS Proxyï¼Œæ­¤æ—¶åŸŸåä¼šè¢«è§£æåˆ°cloudflareçš„IPï¼Œcloudflareä¼šåšè½¬å‘åˆ°æˆ‘ä»¬çœŸæ­£çš„VPS IP åœ°å€ï¼‰</p>
</li>
</ol>
<h2 id="v2rayç®¡ç†è„šæœ¬">v2rayç®¡ç†è„šæœ¬</h2>
<ol>
<li>
<p>è¿è¡Œv2rayç®¡ç†è„šæœ¬ä¸€é”®å®‰è£…è„šæœ¬ï¼š bash &lt;(curl -s -L <a href="https://233blog.com/v2ray.sh" target="_blank" rel="noopener">https://233blog.com/v2ray.sh</a>)</p>
</li>
<li>
<p>è¿è¡Œv2rayå‘½ä»¤ï¼Œè¿è¡Œv2rayç®¡ç†è„šæœ¬ï¼Œä¿®æ”¹åè®®ï¼ˆé€‰é¡¹2ï¼‰ä¸ºï¼šwebsocket + tlsï¼ˆé€‰é¡¹4ï¼‰ï¼Œç„¶åä¼šæç¤ºè¾“å…¥åŸŸåï¼Œæ­¤æ—¶è¦ç¡®ä¿åŸŸåè§£æåˆ°VPS IP åœ°å€ã€‚ä¸€è·¯é»˜è®¤ï¼Œä¼šå®‰è£…caddyåå‘ä»£ç†ï¼Œä½†æ˜¯caddyè‡ªåŠ¨tlsè¯ä¹¦ç”³è¯·å¤±è´¥</p>
</li>
<li>
<p>æ­¤æ—¶è¿è¡Œv2ray status æŸ¥çœ‹v2rayå’Œcaddyè¿è¡ŒçŠ¶æ€éƒ½æœªè¿è¡Œ</p>
</li>
<li>
<p>æ‰‹åŠ¨è¿è¡Œv2rayï¼š v2ray --config=/etc/v2ray/config.json &amp;</p>
</li>
<li>
<p>æ‰‹åŠ¨è¿è¡Œcaddyï¼šé¦–å…ˆä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œè¯ä¹¦æ˜¯cloudflareæä¾›çš„å…è´¹è¯ä¹¦ï¼Œå°†xxx.pemã€xxx.keyå¤åˆ¶åˆ°/etc/ssl/caddyç›®å½•ä¸‹ï¼Œé…ç½®/etc/caddy/Caddyfileï¼šæŒ‡å®štlsè¯ä¹¦å’Œkeyï¼ŒæŒ‡å®šhttpsç«¯å£443ï¼Œsystemctl start caddyè¿è¡Œcaddy</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xxx.com:443 &#123;</span><br><span class="line">    tls /etc/ssl/caddy/xxx.pem /etc/ssl/caddy/xxx.key</span><br><span class="line">    timeouts none</span><br><span class="line">    #33334 æ˜¯v2ray inboundç›‘å¬çš„ç«¯å£</span><br><span class="line">    proxy / 127.0.0.1:33334 &#123;</span><br><span class="line">	websocket</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>ä¸€å®šæ³¨æ„</strong>ï¼šä¹‹å‰ä½¿ç”¨ufwæ§åˆ¶é˜²ç«å¢™ï¼Œufw allow 443ï¼Œä½†æ˜¯telnet è¿˜æ˜¯ä¸é€šã€‚å»ºè®®ç›´æ¥å…³æ‰é˜²ç«å¢™åå³å¯ã€‚</p>
</li>
<li>
<p>è‡³æ­¤ï¼ŒæœåŠ¡å™¨é…ç½®å®Œæˆï¼Œç„¶åç§»æ­¥cloudflareï¼Œå°†DNSé€‰é¡¹å¡çš„äº‘æœµç‚¹äº®</p>
</li>
<li>
<p>v2ray info æŸ¥çœ‹v2rayé…ç½®ï¼Œå®¢æˆ·ç«¯v2rayæ®æ­¤é…ç½®å³å¯</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/v2rayconfig.jpg" alt=""></p>
</li>
</ol>
<h2 id="åˆ†å‰²çº¿">åˆ†å‰²çº¿</h2>
<p>é ï¼Œç»ˆäºåˆå¯ä»¥ç”¨googleäº†ã€‚ã€‚ã€‚</p>
]]></content>
      <tags>
        <tag>v2ray</tag>
      </tags>
  </entry>
  <entry>
    <title>java-åŸºç¡€</title>
    <url>/article/java-%E5%9F%BA%E7%A1%80/</url>
    <content><![CDATA[<h3 id="æ•°æ®ç±»å‹">æ•°æ®ç±»å‹</h3>
<p>byte(1å­—èŠ‚), short(2å­—èŠ‚), int(4å­—èŠ‚), long(8å­—èŠ‚), float(4å­—èŠ‚), double(8å­—èŠ‚), char(2å­—èŠ‚), boolean(true, false)</p>
<p>Java æ²¡æœ‰ä»»ä½•æ— ç¬¦å·(unsigned) å½¢å¼çš„ intã€longã€short æˆ– byte ç±»å‹ã€‚</p>
<p>char ç±»å‹æè¿°äº† UTF-16 ç¼–ç ä¸­çš„ä¸€ä¸ªä»£ç å•å…ƒï¼Œå 2å­—èŠ‚ï¼Œï¼ˆæœ‰çš„å­—ç¬¦ç¼–ç å ç”¨ä¸¤ä¸ªä»£ç å•å…ƒï¼‰å»ºè®®ä¸è¦åœ¨ç¨‹åºä¸­ä½¿ç”¨ char ç±»å‹ã€‚</p>
<p>æ•´æ•°è¢« 0 é™¤å°†ä¼šäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ï¼Œ è€Œæµ®ç‚¹æ•°è¢« 0 é™¤å°†ä¼šå¾—åˆ°æ— ç©·å¤§æˆ– NaN ç»“æœã€‚</p>
<p>&amp;&amp;å’Œ||è¿ç®—ç¬¦æ˜¯æŒ‰ç…§â€œ çŸ­è·¯â€æ–¹å¼æ¥æ±‚å€¼çš„: å¦‚æœç¬¬ä¸€ä¸ªæ“ä½œæ•°å·²ç»èƒ½å¤Ÿç¡®å®šè¡¨è¾¾å¼çš„å€¼ï¼Œç¬¬äºŒä¸ªæ“ä½œæ•°å°±ä¸å¿…è®¡ç®—äº†ã€‚</p>
<p>&gt;&gt;è¿ç®—ç¬¦ä¼šç”¨ç¬¦å·ä½å¡«å……é«˜ä½ï¼Œ&gt;&gt;&gt;è¿ç®—ç¬¦ä¼šç”¨ 0 å¡«å……é«˜ä½ã€‚</p>
<p>ç§»ä½è¿ç®—ç¬¦çš„å³æ“ä½œæ•°è¦å®Œæˆæ¨¡32çš„è¿ç®—(é™¤éå·¦æ“ä½œæ•°æ˜¯longç±»å‹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦å¯¹å³æ“ä½œæ•°æ¨¡ 64 )ã€‚ ä¾‹å¦‚ï¼Œ1&lt;&lt;35 çš„å€¼ç­‰åŒäº 1&lt;&lt;3 ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println ( <span class="number">1.0</span> / <span class="number">0</span> );</span><br><span class="line"><span class="comment">//output Infinity</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> valInt = <span class="number">1</span>&lt;&lt;<span class="number">35</span>;</span><br><span class="line">System.out.println ( valInt);</span><br><span class="line"><span class="comment">//output 8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> valLong = (<span class="keyword">long</span>)<span class="number">1</span>&lt;&lt;<span class="number">35</span>;</span><br><span class="line">System.out.println ( valLong );</span><br><span class="line"><span class="comment">//output 34359738368</span></span><br></pre></td></tr></table></figure>
<p>å­—ç¬¦ä¸²â€œxxooâ€æ˜¯unicodeå­—ç¬¦xã€xã€oã€oç»„æˆçš„åºåˆ—ã€‚å­—ç¬¦ä¸²ã€Stringç±»å¯¹è±¡æ˜¯ä¸å¯å˜å¯¹è±¡ã€‚</p>
<p>åˆ¤æ–­å­—ç¬¦ä¸²å†…å®¹ç›¸ç­‰ç”¨equalsï¼Œ==è¿ç®—ç¬¦æ˜¯åˆ¤æ–­å­—ç¬¦ä¸²çš„åœ°å€æ˜¯å¦ç›¸ç­‰ã€‚</p>
<p>Stringå–lengthæ˜¯å–çš„å­—ç¬¦ä¸²çš„ä»£ç å•å…ƒçš„ä¸ªæ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String hehe = <span class="string">"ğŸ˜„"</span>;</span><br><span class="line">System.out.println ( hehe.length () ); <span class="comment">//2</span></span><br></pre></td></tr></table></figure>
<p>Consoleç±»ç”¨äºè¾“å…¥å¯†ç ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œè¿”å›çš„å¯†ç å­˜æ”¾åœ¨ä¸€ç»´å­—ç¬¦æ•°ç»„ä¸­ï¼Œ è€Œä¸æ˜¯å­—ç¬¦ä¸²ä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å› ä¸ºå­—ç¬¦ä¸²æœ‰å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¯¼è‡´å¯†ç é•¿æœŸä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå®¹æ˜“é€šè¿‡jmap+jhatåˆ†æå‡ºå¯†ç æ¥ï¼Œè€Œä½¿ç”¨å­—ç¬¦æ•°ç»„ï¼Œç”¨å®Œå³å¯ç½®ä¸ºnullï¼Œç›¸å¯¹å®‰å…¨</span><br></pre></td></tr></table></figure>
<p>åœ¨ C++ ä¸­ï¼Œ å¯ä»¥åœ¨åµŒå¥—çš„å—ä¸­é‡å®šä¹‰ä¸€ä¸ªå˜é‡ã€‚ åœ¨å†…å±‚å®šä¹‰çš„å˜é‡ä¼šè¦†ç›–åœ¨å¤–å±‚å®šä¹‰çš„å˜é‡ã€‚ ä½†æ˜¯ï¼Œåœ¨javaä¸­ä¸å…è®¸åµŒå¥—å—ä¸­é‡å®šä¹‰å¤–å±‚çš„å˜é‡ã€‚</p>
<p>åœ¨ Java ä¸­ï¼Œ å…è®¸æ•°ç»„é•¿åº¦ä¸º 0ã€‚ åœ¨ Java ä¸­ï¼Œ å…è®¸å°†ä¸€ä¸ªæ•°ç»„å˜é‡æ‹·è´ç»™ å¦ä¸€ä¸ªæ•°ç»„å˜é‡ã€‚è¿™æ—¶ï¼Œ ä¸¤ä¸ªå˜é‡å°†å¼•ç”¨åŒ ä¸€ä¸ªæ•°ç»„ã€‚å¦‚æœå¸Œæœ›å°† ä¸€ä¸ªæ•°ç»„çš„æ‰€æœ‰å€¼æ‹·è´åˆ°ä¸€ä¸ªæ–°çš„æ•°ç»„ä¸­å»ï¼Œ å°±è¦ä½¿ç”¨ Arrays ç±»çš„ copyOf æ–¹æ³•ã€‚å¯ä»¥é€šè¿‡äºŒç»´æ•°ç»„åˆ›å»ºä¸è§„åˆ™æ•°ç»„ï¼ˆå…ˆåˆ›å»ºè¡Œï¼Œå†å•ç‹¬åˆ›å»ºæ¯è¡Œçš„æ•°ç»„ï¼‰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æµ®ç‚¹æ•°é»˜è®¤ä¸ºåŒç²¾åº¦çš„ï¼ˆdoubleï¼‰</span></span><br><span class="line"><span class="comment">//float i = 1.1;</span></span><br><span class="line"><span class="keyword">float</span> i = (<span class="keyword">float</span>) <span class="number">1.1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">short</span> j = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//æ•´å‹é»˜è®¤ä¸ºint</span></span><br><span class="line"><span class="comment">//j = j + 1;</span></span><br><span class="line"><span class="comment">// += è¿ç®—è‡ªåŠ¨å‘ä¸‹è½¬å‹ int -&gt; short</span></span><br><span class="line">j += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ä½¿ç”¨ä¸´æ—¶å˜é‡äº¤æ¢ä¸¤ä¸ªæ•´æ•°çš„å€¼</span></span><br><span class="line"><span class="comment">//æ–¹æ³•1. ä½¿ç”¨å¼‚æˆ–æ“ä½œswap a å’Œ b çš„å€¼</span></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">456</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">123</span>;</span><br><span class="line">a = a ^ b;</span><br><span class="line">b = a ^ b;</span><br><span class="line">a = a ^ b;</span><br><span class="line">System.out.println ( a ); <span class="comment">//123</span></span><br><span class="line">System.out.println ( b ); <span class="comment">//456</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–¹æ³•2. ä½¿ç”¨åŠ å‡æ³•è¿ç®—</span></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">123</span>;</span><br><span class="line"><span class="keyword">int</span> b = <span class="number">456</span>;</span><br><span class="line">a = a + b;</span><br><span class="line">b = a - b;</span><br><span class="line">a = a - b;</span><br><span class="line">System.out.println ( a );</span><br><span class="line">System.out.println ( b );</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¼–è¯‘æ—¶èƒ½ç¡®å®šçš„Stringå¯¹è±¡éƒ½æ”¾å…¥å¸¸é‡æ± </span></span><br><span class="line"><span class="comment">//è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šæˆ–è€…newå‡ºçš„Stringå¯¹è±¡éƒ½æ”¾å…¥å †</span></span><br><span class="line">String str1 = <span class="string">"I am String1"</span>; <span class="comment">//å˜é‡str1å¼•ç”¨æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± </span></span><br><span class="line"><span class="keyword">final</span> String str2 = <span class="string">"I am String"</span>; <span class="comment">//finalä¿®é¥°ï¼Œstr2æ˜¯ç¼–è¯‘æœŸå¸¸é‡</span></span><br><span class="line">String str3 = <span class="string">"I am String"</span>; <span class="comment">//å˜é‡str3å¼•ç”¨æŒ‡å‘å­—ç¬¦ä¸²å¸¸é‡æ± </span></span><br><span class="line">String str4 = str2 + <span class="number">1</span>; <span class="comment">// str2 + 1 å¾—åˆ°çš„ä¹Ÿæ˜¯ä¸ªå¸¸é‡ï¼Œæ”¾åœ¨å¸¸é‡æ± </span></span><br><span class="line">String str5 = str3 + <span class="number">1</span>; <span class="comment">// str3 + 1 å¾—åˆ°çš„æ˜¯ä¸ªå˜é‡ï¼Œæ”¾åœ¨å †ä¸Š ï¼ˆå› ä¸ºstr3å˜é‡åœ¨è¿è¡Œæ—¶æ‰å¯ä»¥å–åˆ°å®ƒæ‰€å¼•ç”¨çš„å€¼ï¼‰</span></span><br><span class="line">System.out.println ( str1 == str4 );</span><br><span class="line">System.out.println ( str1 == str5 );</span><br><span class="line"></span><br><span class="line"><span class="comment">//tryè¯­å¥å¸¦returnï¼Œfinallyæ‰§è¡Œæ—¶æœº</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="keyword">if</span> (a == <span class="number">123</span>) &#123;</span><br><span class="line">     System.out.println ( <span class="string">"in try return a = "</span> + a );</span><br><span class="line">     <span class="keyword">return</span>; <span class="comment">// æ‰§è¡Œåˆ°æ­¤å¤„ï¼Œè®°å½•returnçš„å€¼ï¼Œç„¶åæ‰§è¡Œfinallyä»£ç å—ï¼Œå†ç„¶åreturn</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"> a = <span class="number">1234</span>;</span><br><span class="line"> System.out.println ( <span class="string">"in finally a = "</span> + a );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç±»å’Œå¯¹è±¡">ç±»å’Œå¯¹è±¡</h3>
<p>è¯†åˆ«ç±»çš„ç®€å•è§„åˆ™æ˜¯åœ¨åˆ†æé—®é¢˜çš„è¿‡ç¨‹ä¸­å¯»æ‰¾åè¯ï¼Œ è€Œæ–¹æ³•å¯¹åº”ç€åŠ¨è¯ã€‚</p>
<table>
<thead>
<tr>
<th>å…³ç³»</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç»§æ‰¿(is a)</td>
<td>is aï¼Œç±»Aæ‰©å±•è‡ªç±»B</td>
</tr>
<tr>
<td>æ¥å£å®ç°</td>
<td>ç±»å®ç°æ¥å£ä¸­çš„æ–¹æ³•</td>
</tr>
<tr>
<td>ä¾èµ–(use a)</td>
<td>use aï¼Œä¸€ä¸ªç±»çš„æ–¹æ³•æ“çºµå¦ä¸€ä¸ªç±»çš„å¯¹è±¡</td>
</tr>
<tr>
<td>èšåˆ(has a)</td>
<td>has aï¼Œç±»Açš„å¯¹è±¡åŒ…å«ç±»Bçš„å¯¹è±¡ï¼ˆå±æ€§å…³è”ï¼‰</td>
</tr>
<tr>
<td>å…³è”</td>
<td>é€šè¿‡å±æ€§ã€æ–¹æ³•å…³è”</td>
</tr>
</tbody>
</table>
<p>æ„é€ å™¨æ€»æ˜¯ä¼´éšç€ new æ“ä½œç¬¦çš„æ‰§è¡Œè¢«è°ƒç”¨ã€‚</p>
<p>ä¸è¦ç¼–å†™è¿”å›å¼•ç”¨å¯å˜æ•°æ®åŸŸå¯¹è±¡çš„è®¿é—®å™¨æ–¹æ³•ã€‚ å¦‚æœéœ€è¦è¿”å›ä¸€ä¸ªå¯å˜æ•°æ®åŸŸçš„æ‹·è´ï¼Œ å°±åº”è¯¥ä½¿ç”¨ cloneã€‚</p>
<ol>
<li>Getä¸ä½¿ç”¨cloneï¼Œç›´æ¥è¿”å›å¼•ç”¨</li>
</ol>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/java-base-get-return-ref-1.jpg" alt=""></p>
<ol start="2">
<li>Getè¿”å›å¼•ç”¨å¯¹è±¡çš„clone</li>
</ol>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/java-base-get-return-ref-2.jpg" alt=""></p>
<p>å¯¹äºå¯å˜çš„ç±»ï¼Œ ä½¿ç”¨ final ä¿®é¥°ç¬¦å¯èƒ½ä¼šå¯¹è¯»è€…é€ æˆæ··ä¹±ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span>  StringBuilder evaluations;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>&#123;</span><br><span class="line">     evaluations = <span class="keyword">new</span> StringBuilder (  );</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//final å…³é”®å­—åªæ˜¯è¡¨ç¤ºå­˜å‚¨åœ¨ evaluations å˜é‡ä¸­çš„å¯¹è±¡å¼•ç”¨ä¸ä¼šå†æŒ‡ç¤ºå…¶ä»– StringBuilder å¯¹è±¡ã€‚ ä¸è¿‡è¿™ä¸ªå¯¹è±¡å¯ä»¥æ›´æ”¹</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">giveGoldStar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     evaluations.append ( <span class="keyword">new</span> Date () + <span class="string">": Gold Star!\n"</span> );</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">printTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     System.out.println ( evaluations );</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™æ€å˜é‡ä½¿ç”¨å¾—æ¯”è¾ƒå°‘ï¼Œ ä½†é™æ€å¸¸é‡(static final)å´ä½¿ç”¨å¾—æ¯”è¾ƒå¤šã€‚ é™æ€æ–¹æ³•æ˜¯æ²¡æœ‰thiså‚æ•°çš„æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªéé™æ€æ–¹æ³•ä¸­thiså‚æ•°æ˜¯è¯¥æ–¹æ³•çš„éšå¼å‚æ•°ï¼Œä»£è¡¨æ“ä½œæ­¤æ–¹æ³•çš„å¯¹è±¡ã€‚</p>
<p>javaæ–¹æ³•è°ƒç”¨å‚æ•°æ˜¯æŒ‰å€¼ä¼ é€’ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹ Java ä¸­æ–¹æ³•å‚æ•°çš„ä½¿ç”¨æƒ…å†µ:</p>
<p>â€¢ ä¸€ä¸ªæ–¹æ³•ä¸èƒ½ä¿®æ”¹ä¸€ä¸ªåŸºæœ¬æ•°æ®ç±»å‹çš„å‚æ•° (å³æ•°å€¼å‹æˆ–å¸ƒå°”å‹)ã€‚</p>
<p>â€¢ ä¸€ä¸ªæ–¹æ³•å¯ä»¥æ”¹å˜ä¸€ä¸ªå¯¹è±¡å‚æ•°çš„çŠ¶æ€ã€‚</p>
<p>â€¢ ä¸€ä¸ªæ–¹æ³•ä¸èƒ½è®©å¯¹è±¡å‚æ•°å¼•ç”¨ä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚</p>
<p>ç±»å±æ€§ä¸å±€éƒ¨å˜é‡çš„ä¸»è¦ä¸åŒç‚¹ï¼š å¿…é¡»æ˜ç¡®åœ°åˆå§‹åŒ–æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–ç±»ä¸­çš„å±æ€§ï¼Œ å®ƒå°†ä¼šè¢«è‡ªåŠ¨åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼(0ã€false æˆ– null )ï¼Œä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ç§è‰¯å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ã€‚</p>
<p>ä»…å½“ç±»æ²¡æœ‰æä¾›ä»»ä½•æ„é€ å™¨çš„æ—¶å€™ï¼Œç³»ç»Ÿæ‰ä¼šæä¾›ä¸€ä¸ªé»˜è®¤çš„æ„é€ å™¨ ã€‚</p>
<p>å¯ä»¥åœ¨ç±»å®šä¹‰ä¸­ï¼Œ ç›´æ¥å°†ä¸€ä¸ªå€¼èµ‹ç»™ä»»ä½•å±æ€§ã€‚åœ¨æ‰§è¡Œæ„é€ å™¨ä¹‹å‰ï¼Œå°†ä¼šå…ˆæ‰§è¡Œèµ‹å€¼æ“ä½œã€‚</p>
<p>ç±»æ„é€ åˆå§‹åŒ–æ¬¡åºï¼š</p>
<ol>
<li>static å±æ€§èµ‹å€¼</li>
<li>static åˆå§‹åŒ–å—</li>
<li>å®ä¾‹å±æ€§èµ‹å€¼</li>
<li>å®ä¾‹å±æ€§åˆå§‹åŒ–å—</li>
<li>æ„é€ å‡½æ•°ä½“</li>
</ol>
<p>å¯ä»¥ä¸ºä»»ä½•ä¸€ä¸ªç±»æ·»åŠ  finalize æ–¹æ³•ã€‚finalize æ–¹æ³•å°†åœ¨åƒåœ¾å›æ”¶å™¨æ¸…é™¤å¯¹è±¡ä¹‹å‰è°ƒç”¨ã€‚ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ ä¸è¦ä¾èµ–äºä½¿ç”¨ finalize æ–¹æ³•å›æ”¶ä»»ä½•çŸ­ç¼ºçš„èµ„æºï¼Œè¿™æ˜¯å› ä¸ºå¾ˆéš¾çŸ¥é“è¿™ä¸ªæ–¹æ³•ä»€ä¹ˆæ—¶å€™æ‰èƒ½å¤Ÿè°ƒç”¨ã€‚</p>
<p>ä»ç¼–è¯‘å™¨çš„è§’åº¦æ¥çœ‹ï¼ŒåµŒå¥—çš„åŒ…ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ ä¾‹å¦‚ï¼Œ java.util åŒ…ä¸ java.util.jar åŒ…æ¯«æ— å…³ç³»ã€‚æ¯ä¸€ä¸ªéƒ½æ‹¥æœ‰ç‹¬ç«‹çš„ç±»é›†åˆã€‚</p>
<p>å°†åŒ…ä¸­çš„æ–‡ä»¶æ”¾åˆ°ä¸å®Œæ•´çš„åŒ…ååŒ¹é…çš„å­ç›®å½•ä¸­ã€‚</p>
<p>åˆ©ç”¨ -classpath é€‰é¡¹è®¾ç½®ç±»è·¯å¾„æ˜¯é¦–é€‰çš„æ–¹æ³•ï¼Œ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® CLASSPATH ç¯å¢ƒå˜é‡ å®Œæˆè¿™ä¸ªæ“ä½œã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -classpath c:\classdir;.;c:\archives\archive.jar MyProg</span><br><span class="line">//æˆ–è€…</span><br><span class="line">export CLASSPATH=/home/user/classdir:.:/home/user/archives/archive.jar</span><br></pre></td></tr></table></figure>
<h3 id="ç»§æ‰¿">ç»§æ‰¿</h3>
<p>å¦‚æœå­ç±»çš„æ„é€ å™¨æ²¡æœ‰æ˜¾å¼åœ°è°ƒç”¨è¶…ç±»çš„æ„é€ å™¨ï¼Œåˆ™å°†è‡ªåŠ¨åœ°è°ƒç”¨è¶…ç±»é»˜è®¤(æ²¡æœ‰å‚æ•° ) çš„æ„é€ å™¨ã€‚ å¦‚æœè¶…ç±»æ²¡æœ‰ä¸å¸¦å‚æ•°çš„æ„é€ å™¨ï¼Œå¹¶ä¸”åœ¨å­ç±»çš„æ„é€ å™¨ä¸­åˆæ²¡æœ‰æ˜¾å¼åœ°è°ƒç”¨è¶…ç±»çš„å…¶ä»–æ„é€ å™¨ï¼Œ åˆ™ Java ç¼–è¯‘å™¨å°†æŠ¥å‘Šé”™è¯¯ã€‚</p>
<p>æ˜¯å¦åº”è¯¥è®¾è®¡ä¸ºç»§æ‰¿å…³ç³»çš„ä¸€ä¸ªç®€å•è§„åˆ™ï¼š â€œis-aâ€ è§„åˆ™ã€‚å®ƒçš„å¦ä¸€ç§è¡¨è¿°æ³•æ˜¯ç½®æ¢æ³•åˆ™ã€‚å®ƒè¡¨æ˜ç¨‹åºä¸­å‡ºç°è¶…ç±»å¯¹è±¡çš„ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ç”¨å­ç±»å¯¹è±¡ç½®æ¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Employee e;</span><br><span class="line">e = <span class="keyword">new</span> Employee();</span><br><span class="line">e = <span class="keyword">new</span> Manager(); <span class="comment">//ok, Manager extends from Employee</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ Java ä¸­ï¼Œå­ç±»æ•°ç»„çš„å¼•ç”¨å¯ä»¥è½¬æ¢æˆè¶…ç±»æ•°ç»„çš„å¼•ç”¨ï¼Œè€Œä¸éœ€è¦é‡‡ç”¨å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚ä½†æ˜¯ä¸€å®šè¦æ³¨æ„è¿™ç§ç”¨æ³•ä¼šå¼•èµ·ä»¥ä¸‹ç±»å‹ç´Šä¹±çš„é”™è¯¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Manager[] managers = <span class="keyword">new</span> Manager[<span class="number">10</span>];</span><br><span class="line">Employee[] staff = managers; <span class="comment">//ok, but now staff and managers reference to the same Objects</span></span><br><span class="line">staff[<span class="number">0</span>] = <span class="keyword">new</span> Employee(); <span class="comment">//ok</span></span><br><span class="line">managers[<span class="number">0</span>].setBonus(<span class="number">1000</span>); <span class="comment">//error, this will arise ArrayStoreException</span></span><br></pre></td></tr></table></figure>
<p>è¿”å›ç±»å‹ä¸æ˜¯ç­¾åçš„ä¸€éƒ¨åˆ†ï¼Œ å› æ­¤ï¼Œåœ¨è¦†ç›–æ–¹æ³•æ—¶ï¼Œä¸€å®šè¦ä¿è¯è¿”å›ç±»å‹çš„å…¼å®¹æ€§ã€‚å…è®¸å­ç±»å°†è¦†ç›–æ–¹æ³•çš„è¿”å›ç±»å‹å®šä¹‰ä¸ºåŸè¿”å›ç±»å‹çš„å­ç±»å‹ã€‚</p>
<p>æ–¹æ³•è°ƒç”¨çš„ä¸¤ç§æ–¹å¼ï¼šé™æ€ç»‘å®šï¼ˆprivateæ–¹æ³•ã€staticæ–¹æ³•ã€finalæ–¹æ³•ï¼‰ï¼ŒåŠ¨æ€ç»‘å®šï¼ˆå…¶ä»–ï¼‰</p>
<p>å¦‚æœå°†ä¸€ä¸ªç±»å£°æ˜ä¸º finalï¼Œ åªæœ‰å…¶ä¸­çš„æ–¹æ³•è‡ªåŠ¨åœ°æˆä¸º final, è€Œä¸åŒ…æ‹¬å±æ€§ã€‚</p>
<p>åªèƒ½åœ¨ç»§æ‰¿å±‚æ¬¡å†…è¿›è¡Œç±»å‹è½¬æ¢ã€‚ åœ¨å°†è¶…ç±»è½¬æ¢æˆå­ç±»ä¹‹å‰ï¼Œåº”è¯¥ä½¿ç”¨ instanceof è¿›è¡Œæ£€æŸ¥ã€‚ ä½†æ˜¯å°½é‡ä¸è¦ä½¿ç”¨ç±»å‹è½¬æ¢ï¼Œå¦‚æœå¿…é¡»ä½¿ç”¨ç±»å‹è½¬æ¢ï¼Œåˆ™åº”è¯¥æ£€æŸ¥è¶…ç±»çš„è®¾è®¡æ˜¯å¦åˆç†ã€‚</p>
<p>åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæŠ½è±¡æ–¹æ³•çš„ç±»æœ¬èº«å¿…é¡»è¢«å£°æ˜ä¸ºæŠ½è±¡çš„ã€‚ ä½†æ˜¯ï¼Œç±»å³ä½¿ä¸å«æŠ½è±¡æ–¹æ³•ï¼Œ ä¹Ÿå¯ä»¥å°†ç±»å£°æ˜ä¸ºæŠ½è±¡ç±»ã€‚</p>
<p>åœ¨ Java ä¸­ï¼Œåªæœ‰åŸºæœ¬ç±»å‹ ( primitive types ) ä¸æ˜¯å¯¹è±¡ï¼Œ æ‰€æœ‰çš„æ•°ç»„ç±»å‹ï¼Œä¸ç®¡æ˜¯å¯¹è±¡æ•°ç»„è¿˜æ˜¯åŸºæœ¬ç±»å‹çš„æ•°ç»„éƒ½æ˜¯æ‰©å±•è‡ªObjectçš„ç±»å¯¹è±¡ã€‚</p>
<p>ä¸ºä¸€ä¸ªç±»ç¼–å†™equalsæ–¹æ³•çš„å®Œç¾å»ºè®®ï¼š</p>
<blockquote>
<ol>
<li>æ˜¾ç¤ºå‚æ•°å‘½åä¸ºotherObject</li>
<li>æ£€æµ‹thisä¸otheObjectæ˜¯å¦å¼•ç”¨åŒä¸€å¯¹è±¡ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (<span class="keyword">this</span> == otherObject) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="3">
<li>æ£€æµ‹otherObjectæ˜¯å¦ä¸ºnull</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (otherObject == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="4">
<li>æ£€æµ‹thisä¸otherObjectæ˜¯å¦å±äºåŒä¸€ä¸ªç±»ï¼š</li>
</ol>
<p>å¦‚æœequalsçš„è¯­ä¹‰åœ¨æ¯ä¸ªå­ç±»æœ‰æ‰€æ”¹å˜ï¼Œåˆ™ä½¿ç”¨getClassæ£€æµ‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (getClass() != otherObject.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>å¦‚æœæ‰€æœ‰å­ç±»ä½¿ç”¨ç›¸åŒçš„è¯­ä¹‰ï¼Œå³ç”±è¶…ç±»å†³å®šç›¸ç­‰çš„æ¦‚å¿µï¼Œåˆ™ä½¿ç”¨instanceofæ£€æµ‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (!(otherObject <span class="keyword">instanceof</span> ClassName)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="5">
<li>å°†otherObjectè½¬æ¢ä¸ºç›¸åº”çš„ç±»ç±»å‹å˜é‡</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; ClassName other = (ClassName) otherObject;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="6">
<li>å¼€å§‹å±æ€§åŸŸçš„æ¯”è¾ƒï¼Œä½¿ç”¨==æ¯”è¾ƒåŸºæœ¬ç±»å‹ï¼Œä½¿ç”¨Objects.equalsæ¯”è¾ƒå¯¹è±¡</li>
</ol>
</blockquote>
<p>å¦‚æœé‡æ–°å®šä¹‰ equals æ–¹æ³•ï¼Œ å°±å¿…é¡»é‡æ–°å®šä¹‰ hashCode æ–¹æ³•ã€‚</p>
<p>å¼ºçƒˆå»ºè®®ä¸ºè‡ªå®šä¹‰çš„æ¯ä¸€ä¸ªç±»å¢åŠ toStringæ–¹æ³•ã€‚</p>
<p>å¯¹è±¡åŒ…è£…å™¨ç±»ï¼ˆIntegerï¼ŒLongï¼ŒFloatï¼ŒDoubleï¼ŒShortï¼ŒByteï¼ŒCharacterï¼ŒVoidï¼ŒBooleanï¼‰æ˜¯finalç±», å› æ­¤ä¸èƒ½å®šä¹‰å®ƒä»¬çš„å­ç±»ã€‚</p>
<p>è‡ªåŠ¨è£…ç®±è§„èŒƒè¦æ±‚ ä»‹äº -128 ~ 127 ä¹‹é—´çš„byte,  short , int, char(0~127) è¢«åŒ…è£…åˆ°å›ºå®šçš„å¯¹è±¡ä¸­(ByteCache,ShortCache,IntegerCache,CharacterCache)ã€‚ å› æ­¤</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer a = <span class="number">1000</span>;</span><br><span class="line">Integer b = <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">if</span> (a == b) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">Integer a = <span class="number">100</span>;</span><br><span class="line">Integer b = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">if</span> (a == b) <span class="comment">// true</span></span><br><span class="line">  </span><br><span class="line">System.out.println ( <span class="string">"--------Short--------"</span> );</span><br><span class="line"></span><br><span class="line">Short s1 = <span class="number">12</span>;</span><br><span class="line">Short s2 = <span class="number">12</span>;</span><br><span class="line">Short s3 = <span class="number">129</span>;</span><br><span class="line">Short s4 = <span class="number">129</span>;</span><br><span class="line">System.out.println ( s1 == s2 ); <span class="comment">//true</span></span><br><span class="line">System.out.println ( s3 == s4 ); <span class="comment">//false</span></span><br><span class="line"></span><br><span class="line">System.out.println ( <span class="string">"--------Byte--------"</span> );</span><br><span class="line"></span><br><span class="line">Byte b1 = <span class="number">13</span>;</span><br><span class="line">Byte b2 = <span class="number">13</span>;</span><br><span class="line">Byte b3 = <span class="number">127</span>;</span><br><span class="line">Byte b4 = <span class="number">127</span>;</span><br><span class="line">System.out.println ( b1 == b2 ); <span class="comment">//true</span></span><br><span class="line">System.out.println ( b3 == b4 ); <span class="comment">//true</span></span><br><span class="line"></span><br><span class="line">System.out.println ( <span class="string">"--------Character--------"</span> );</span><br><span class="line"></span><br><span class="line">Character c1 = <span class="number">56</span>;</span><br><span class="line">Character c2 = <span class="number">56</span>;</span><br><span class="line">Character c3 = <span class="number">156</span>;</span><br><span class="line">Character c4 = <span class="number">156</span>;</span><br><span class="line">System.out.println ( c1 == c2 ); <span class="comment">//true</span></span><br><span class="line">System.out.println ( c3 == c4 ); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<p>è‡ªåŠ¨è£…ç®±æ‹†ç®±é™·é˜±</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Integer a = <span class="number">1</span>;</span><br><span class="line">Integer b = <span class="number">2</span>;</span><br><span class="line">Integer c = <span class="number">3</span>;</span><br><span class="line">Integer e = <span class="number">321</span>;</span><br><span class="line">Integer e1 = <span class="number">300</span>;</span><br><span class="line">Integer e2 = <span class="number">21</span>;</span><br><span class="line">Long g = <span class="number">3L</span>;</span><br><span class="line">System.out.println ( e == (e1+e2) ); <span class="comment">//true == åœ¨é‡åˆ°ç®—æœ¯è¿ç®—åï¼Œè‡ªåŠ¨æ‹†ç®±ï¼Œæ¯”è¾ƒå€¼ç›¸ç­‰</span></span><br><span class="line">System.out.println ( c.equals ( a+b ) ); <span class="comment">//true a+b ç®—æœ¯è¿ç®—åï¼Œè‡ªåŠ¨è£…ç®±ä¸ºInteger</span></span><br><span class="line">System.out.println ( g == (a+b) ); <span class="comment">// true a+b ç®—æœ¯è¿ç®—åï¼Œè‡ªåŠ¨æ‹†ç®±ä¸º 3</span></span><br><span class="line">System.out.println ( g.equals ( a+b ) ); <span class="comment">//false equalsæ–¹æ³•ä¸ä¼šå¤„ç†æ•°æ®ç±»å‹è½¬æ¢çš„å…³ç³»</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java-å­—ç¬¦ä¸²</title>
    <url>/article/java-%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    <content><![CDATA[<p>Javaå­—ç¬¦ä¸²è¡¨ç¤ºæ–¹å¼æœ‰ä¸‰ç§ï¼š</p>
<ol>
<li>
<p>å­—ç¬¦ä¸²å¸¸é‡ï¼Œä»¥åŒå¼•å·æ‹¬èµ·æ¥çš„å†…å®¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String literialStr = â€œå­—ç¬¦ä¸²å¸¸é‡â€;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å­—ç¬¦æ•°ç»„ï¼Œä»¥å•å¼•å·æ‹¬èµ·æ¥çš„å†…å®¹è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œå¤šä¸ªè¿èµ·æ¥è¡¨ç¤ºå­—ç¬¦ä¸²ï¼ŒStringå†…éƒ¨å°±æ˜¯ç”¨å­—ç¬¦æ•°ç»„æ¥è¡¨ç¤ºçš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">char</span>[] chars = &#123;<span class="string">'å­—'</span>, <span class="string">'ç¬¦'</span>, <span class="string">'ä¸²'</span>, <span class="string">'å¸¸'</span>, <span class="string">'é‡'</span>&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Stringå®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String strs = <span class="keyword">new</span> String(<span class="string">"å­—ç¬¦ä¸²å¸¸é‡"</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>å­—ç¬¦ä¸²ç‰¹æ€§ï¼š</p>
<ol>
<li>
<p>æ¯”è¾ƒï¼Œä½¿ç”¨==æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼›ä½¿ç”¨equalsæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç›¸ç­‰</p>
</li>
<li>
<p>StringBuilderï¼ˆå¤šçº¿ç¨‹ä¸å®‰å…¨ï¼‰å’ŒStringBufferï¼ˆå¤šçº¿ç¨‹å®‰å…¨ï¼‰çš„toStringæ–¹æ³•è¿”å›çš„æ˜¯new String(&quot;â€¦&quot;)</p>
</li>
<li>
<p>å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œjavap -verbose ClassNameï¼Œåç¼–è¯‘ç±»åå¯ä»¥çœ‹åˆ°ä¸€ä¸ªjavaæ–‡ä»¶è¢«ç¼–è¯‘æˆclassæ–‡ä»¶åçš„ç»“æ„å’Œå†…å®¹ã€‚å…¶ä¸­æœ‰ä¸€é¡¹ç»“æ„æ˜¯Constant poolï¼ˆå¸¸é‡æ± ï¼‰ï¼Œå®ƒé‡Œé¢ä¼šä¿å­˜æ­¤classæ–‡ä»¶ç”¨åˆ°çš„æ‰€æœ‰å¸¸é‡åŒ…æ‹¬ç±»åã€æ–¹æ³•åã€å­—ç¬¦ä¸²å¸¸é‡ã€‚å½“classæ–‡ä»¶è¢«è½½å…¥jvmè¿è¡Œæ—¶ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± ä¹Ÿä¼šç›¸åº”çš„è½½å…¥å†…å­˜æˆä¸ºè¿è¡Œæ—¶å¸¸é‡æ± ã€‚ä¸ªäººç†è§£ç±»ä¼¼ç¨‹åºå’Œè¿›ç¨‹çš„æ¦‚å¿µï¼Œä¸€ç§æ˜¯é™æ€çš„æè¿°ï¼Œä¸€ç§æ˜¯è½½å…¥å†…å­˜ååŠ¨æ€çš„è¡¨ç¤ºã€‚</p>
</li>
<li>
<p>internæ–¹æ³•ï¼ŒæŸ¥çœ‹JDKæ–‡æ¡£ï¼Œå…³æ³¨é‡ç‚¹ï¼š</p>
<ol>
<li>è°ƒç”¨internæ–¹æ³•æ—¶ï¼Œä¼šä»å­—ç¬¦ä¸²å¸¸é‡æ± å»æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°ï¼ˆé€šè¿‡equalsæ–¹æ³•åˆ¤æ–­ï¼‰ï¼Œç›´æ¥è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± çš„å¼•ç”¨</li>
<li>æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šå°†æ­¤Stringå¯¹è±¡åŠ å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆå­—ç¬¦ä¸²å¸¸é‡æ± æ­¤æ—¶å°†å»ºç«‹ä¸€ä¸ªæ‰§å‘å †å†…å­˜Stringå¯¹è±¡çš„å¼•ç”¨ï¼‰ï¼Œç„¶åè¿˜æ˜¯è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± çš„å¼•ç”¨ï¼ˆæ³¨æ„ï¼šæ­¤æ—¶å­—ç¬¦ä¸²å¸¸é‡æ± çš„å¼•ç”¨æŒ‡å‘å †å†…å­˜çš„Stringå¯¹è±¡ï¼‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a canonical representation for the string object.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * A pool of strings, initially empty, is maintained privately by the</span></span><br><span class="line"><span class="comment">     * class &#123;<span class="doctag">@code</span> String&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * When the intern method is invoked, if the pool already contains a</span></span><br><span class="line"><span class="comment">     * string equal to this &#123;<span class="doctag">@code</span> String&#125; object as determined by</span></span><br><span class="line"><span class="comment">     * the &#123;<span class="doctag">@link</span> #equals(Object)&#125; method, then the string from the pool is</span></span><br><span class="line"><span class="comment">     * returned. Otherwise, this &#123;<span class="doctag">@code</span> String&#125; object is added to the</span></span><br><span class="line"><span class="comment">     * pool and a reference to this &#123;<span class="doctag">@code</span> String&#125; object is returned.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * It follows that for any two strings &#123;<span class="doctag">@code</span> s&#125; and &#123;<span class="doctag">@code</span> t&#125;,</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> s.intern() == t.intern()&#125; is &#123;<span class="doctag">@code</span> true&#125;</span></span><br><span class="line"><span class="comment">     * if and only if &#123;<span class="doctag">@code</span> s.equals(t)&#125; is &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * All literal strings and string-valued constant expressions are</span></span><br><span class="line"><span class="comment">     * interned. String literals are defined in section 3.10.5 of the</span></span><br><span class="line"><span class="comment">     * &lt;cite&gt;The Java&amp;trade; Language Specification&lt;/cite&gt;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  a string that has the same contents as this string, but is</span></span><br><span class="line"><span class="comment">     *          guaranteed to be from a pool of unique strings.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">intern</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ä¸‹é¢ï¼ŒåŸºäºinternçš„å¤„ç†é€»è¾‘ï¼Œçœ‹çœ‹å‡ ä¸ªä¾‹å­</p>
<p>å‚è€ƒï¼š <a href="https://developer.aliyun.com/article/48686" target="_blank" rel="noopener">https://developer.aliyun.com/article/48686</a></p>
<p>ç¬¬ä¸€ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é¦–å…ˆï¼Œå°†"string_test_1"å­˜å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œç„¶ååœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªStringå¯¹è±¡ï¼Œå¹¶è¿”å›å †ä¸ŠStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s = <span class="keyword">new</span> String(<span class="string">"string_test_1"</span>); </span><br><span class="line"><span class="comment">//è°ƒç”¨internæ–¹æ³•ï¼Œå‘ç°å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œå·²æœ‰â€œstring_test_1â€ï¼Œè¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">s.intern();</span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²å¸¸é‡æ± å·²æœ‰â€œstring_test_1â€ï¼Œè¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± çš„å¼•ç”¨</span></span><br><span class="line">String s2 = <span class="string">"string_test_1"</span>;</span><br><span class="line">System.out.println(s == s2); <span class="comment">//å †ä¸ŠStringå¯¹è±¡å¼•ç”¨ ä¸ç­‰äº å­—ç¬¦ä¸²å¸¸é‡æ± å¯¹è±¡å¼•ç”¨ï¼Œç»“æœä¸ºfalse</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç›´æ¥åœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªStringå¯¹è±¡ï¼Œå¹¶è¿”å›å †ä¸ŠStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s3 = <span class="keyword">new</span> StringBuilder().append ( <span class="string">"string_"</span> ).append ( <span class="string">"test_2"</span> ).toString ();</span><br><span class="line"><span class="comment">//è°ƒç”¨internæ–¹æ³•ï¼Œå‘ç°å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œè¿˜æ²¡æœ‰â€œstring_test_2â€ï¼Œå°†åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± åˆ›å»ºä¸€ä¸ªå¼•ç”¨æŒ‡å‘å †ä¸ŠStringå¯¹è±¡</span></span><br><span class="line">s3.intern();</span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²å¸¸é‡æ± å·²æœ‰æŒ‡å‘å †ä¸ŠStringå¯¹è±¡çš„å¼•ç”¨ï¼Œequalsåˆ¤ç­‰ï¼Œè¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± çš„å¼•ç”¨ï¼ˆæŒ‡å‘å †ä¸ŠStringå¯¹è±¡ï¼‰</span></span><br><span class="line">String s4 = <span class="string">"string_test_2"</span>;</span><br><span class="line">System.out.println(s3 == s4); <span class="comment">//å †ä¸ŠStringå¯¹è±¡å¼•ç”¨ ç­‰äº å­—ç¬¦ä¸²å¸¸é‡æ± çš„å¼•ç”¨ ç»“æœä¸ºtrue</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸‰ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é¦–å…ˆï¼Œå°†"same1"å­˜å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡ŒStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s1 = <span class="string">"same1"</span>;</span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²å¸¸é‡æ± å·²æœ‰â€œsame1â€ï¼Œè¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„Stringå¯¹è±¡å¼•ç”¨</span></span><br><span class="line">String s2 = <span class="string">"same1"</span>;</span><br><span class="line">System.out.println(s1 == s2); <span class="comment">//s1ã€s2åŒä¸ºå­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„Stringå¯¹è±¡å¼•ç”¨ï¼Œç»“æœä¸ºtrue</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬å››ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é¦–å…ˆï¼Œå°†"same2"å­˜å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œç„¶ååœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªStringå¯¹è±¡ï¼Œå¹¶è¿”å›å †ä¸ŠStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s1 = <span class="keyword">new</span> String(<span class="string">"same2"</span>);</span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²å¸¸é‡æ± å·²æœ‰â€œsame2â€ï¼Œè¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡Œçš„Stringå¯¹è±¡å¼•ç”¨</span></span><br><span class="line">String s2 = <span class="string">"same2"</span>;</span><br><span class="line">System.out.println(s1 == s2); <span class="comment">//å †ä¸ŠStringå¯¹è±¡å¼•ç”¨ ä¸ç­‰äº å­—ç¬¦ä¸²å¸¸é‡æ± å¯¹è±¡å¼•ç”¨ï¼Œç»“æœä¸ºfalse</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äº”ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å°†"first"å­˜å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡ŒStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s1 = <span class="string">"first"</span>;</span><br><span class="line"><span class="comment">//å°†"second"å­˜å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡ŒStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s2 = <span class="string">"second"</span>;</span><br><span class="line"><span class="comment">//å°†"firstsecond"å­˜å…¥å­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œå¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡ŒStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s3 = <span class="string">"firstsecond"</span>;</span><br><span class="line"><span class="comment">//s1+s2æ˜¯è°ƒç”¨StringBuilderè¿”å›ä¸€ä¸ªnew Stringå¯¹è±¡å¼•ç”¨ï¼Œåœ¨å †ä¸Š</span></span><br><span class="line">String s4 = s1 + s2;</span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²å¸¸é‡ç›¸åŠ ï¼Œåœ¨ç¼–è¯‘æœŸæ›¿æ¢æˆâ€œfirstsecondâ€ï¼Œä»å­—ç¬¦ä¸²å¸¸é‡æ± æŸ¥æ‰¾å¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡ŒStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s5 = <span class="string">"first"</span> + <span class="string">"second"</span>;</span><br><span class="line">System.out.println(s3 == s4); <span class="comment">// false</span></span><br><span class="line">System.out.println(s3 == s5); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬å…­ä¸ªï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> String s1 = <span class="string">"first"</span>;</span><br><span class="line"><span class="keyword">final</span> String s2 = <span class="string">"second"</span>;</span><br><span class="line">String s3 = <span class="string">"firstsecond"</span>;</span><br><span class="line"><span class="comment">//s1ã€s2è¢«finalä¿®é¥°åï¼Œåœ¨ç¼–è¯‘æœŸè¢«æ›¿æ¢æˆå­—ç¬¦ä¸²å¸¸é‡ç›¸åŠ ï¼Œå¾—åˆ°â€œfirstsecondâ€ï¼Œä»å­—ç¬¦ä¸²å¸¸é‡æ± æŸ¥æ‰¾å¹¶è¿”å›å­—ç¬¦ä¸²å¸¸é‡æ± é‡ŒStringå¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">String s4 = s1 + s2;</span><br><span class="line">String s5 = <span class="string">"first"</span> + <span class="string">"second"</span>;</span><br><span class="line">System.out.println(s3 == s4); <span class="comment">// true</span></span><br><span class="line">System.out.println(s3 == s5); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>java String</tag>
      </tags>
  </entry>
  <entry>
    <title>java-æ³¨è§£</title>
    <url>/article/java-%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<p>æ¢ç©¶javaæ³¨è§£åº•å±‚å®ç°åŸç†ï¼Œé¦–å…ˆè‡ªå®šä¹‰ä¸€ä¸ªæ³¨è§£ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyTypeAnnotation &#123;</span><br><span class="line">   <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†å®šä¹‰ä¸ªmainå‡½æ•°ç±»æ¥ä½¿ç”¨è¯¥æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@MyTypeAnnotation</span>(name=<span class="string">"Test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMyTypeAnnotation</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		MyTypeAnnotation type = TestMyTypeAnnotation.class.getAnnotation(MyTypeAnnotation.class);</span><br><span class="line">		System.out.println(type.name());</span><br><span class="line">		System.in.read(); <span class="comment">//waiting...</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œjavac *.javaç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œé€šè¿‡javapæŸ¥çœ‹å­—èŠ‚ç å¯çŸ¥ï¼šæ³¨è§£æ˜¯ä¸€ç§ç»§æ‰¿è‡ªæ¥å£<code>java.lang.annotation.Annotation</code>çš„ç‰¹æ®Šæ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[qiaojian<span class="meta">@Mac</span>Â testannotationÂ ]% javap MyTypeAnnotation                                     [<span class="number">0</span>]</span><br><span class="line">Compiled from <span class="string">"MyTypeAnnotation.java"</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyTypeAnnotation</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">annotation</span>.<span class="title">Annotation</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> java.lang.<span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥å£æ˜¯æ€ä¹ˆç›´æ¥ä½¿ç”¨çš„å‘¢ï¼Ÿè¿˜æ˜¯é€šè¿‡javaä¸­ä¸‡èƒ½çš„åŠ¨æ€ä»£ç†å®ç°çš„ï¼ŒåŠ¨æ€ä»£ç†ä¼šåœ¨è¿è¡Œæ—¶ç”Ÿæˆä¸€ä¸ªå®ç°äº†MyTypeAnnotationæ¥å£çš„ç±»å®ä¾‹ï¼Œå¹¶è®¾ç½®ä¸Šæˆ‘ä»¬é…ç½®çš„æ³¨è§£å±æ€§å€¼ï¼Œç„¶åé€šè¿‡åå°„è·å–ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ ä¸Šè¿è¡Œå‚æ•°-Dsun.misc.ProxyGenerator.saveGeneratedFiles=trueç”ŸæˆåŠ¨æ€ä»£ç†ç±»classæ–‡ä»¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[qiaojian<span class="meta">@Mac</span>Â testannotationÂ ]% java -Dsun.misc.ProxyGenerator.saveGeneratedFiles=<span class="keyword">true</span> TestMyTypeAnnotation</span><br><span class="line">Test</span><br><span class="line">^C%                                                                                            [qiaojian<span class="meta">@Mac</span>Â testannotationÂ ]% ls                                                       [<span class="number">130</span>]</span><br><span class="line">MyTypeAnnotation.class     TestMyTypeAnnotation.class com</span><br><span class="line">MyTypeAnnotation.java      TestMyTypeAnnotation.java</span><br><span class="line">[qiaojian<span class="meta">@Mac</span>Â testannotationÂ ]% ls com/sun/proxy/com/                                      [<span class="number">0</span>]</span><br><span class="line">\$Proxy0.class  \$Proxy1.class  com/</span><br></pre></td></tr></table></figure>
<p>åç¼–è¯‘æŸ¥çœ‹classæ–‡ä»¶å¯çŸ¥ï¼šç”Ÿæˆçš„ä»£ç†ç±»å®ç°äº†MyTypeAnnotationæ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[qiaojian<span class="meta">@Mac</span>Â proxyÂ ]% javap \$Proxy1                                                      [<span class="number">0</span>]</span><br><span class="line">Warning: Binary file $Proxy1 contains com.sun.proxy.$Proxy1</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">com</span>.<span class="title">sun</span>.<span class="title">proxy</span>.$<span class="title">Proxy1</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">reflect</span>.<span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">MyTypeAnnotation</span> </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> com.sun.proxy.$Proxy1(java.lang.reflect.InvocationHandler);</span><br><span class="line">  <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> java.lang.<span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> java.lang.<span class="function">String <span class="title">toString</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> java.lang.<span class="function">Class <span class="title">annotationType</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡HotSpot DeBugerå·¥å…·æ¥å®æ—¶æŸ¥çœ‹ä¸€ä¸‹æ³¨è§£çš„å®ç°å’Œå€¼æ˜¯å¦å’Œæˆ‘ä»¬é¢„æœŸä¸€æ ·</p>
<p>é¦–å…ˆï¼Œæ‰§è¡Œjavaï¼Œå°†ç¨‹åºè·‘èµ·æ¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[qiaojian<span class="meta">@Mac</span>Â testannotationÂ ]% java TestMyTypeAnnotation                                           [<span class="number">0</span>]</span><br><span class="line">Test</span><br></pre></td></tr></table></figure>
<p>ç„¶åpsæŸ¥çœ‹è¿›ç¨‹IDï¼š88954</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[qiaojian<span class="meta">@Mac</span>Â testannotationÂ ]% psfind TestMyTypeAnnotation                                         [<span class="number">0</span>]</span><br><span class="line">  PID TTY           TIME CMD</span><br><span class="line"><span class="number">88954</span> ttys001    <span class="number">0</span>:<span class="number">00.21</span> /usr/bin/java TestMyTypeAnnotation</span><br><span class="line"><span class="number">88965</span> ttys002    <span class="number">0</span>:<span class="number">00.00</span> grep --color --color=auto TestMyTypeAnnotation</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€HSDB</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">[qiaojian<span class="meta">@Mac</span>Â testannotationÂ ]% sudo java -cp /Library/Java/JavaVirtualMachines/jdk1.8.0_131.jdk/Contents/Home/lib/sa-jdi.jar sun.jvm.hotspot.HSDB</span><br><span class="line">Password:</span><br></pre></td></tr></table></figure>
<p>attach è¿›ç¨‹ID</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/annotation-attach-pid.jpg" alt=""></p>
<p>æŸ¥çœ‹å †å†…å­˜å‚æ•°</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/annotation-heap-param.jpg" alt=""></p>
<p>æŸ¥çœ‹æ³¨è§£çš„å®ç°ç±»å®ä¾‹</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/annotation-proxy-inst.jpg" alt=""></p>
<p>æŸ¥çœ‹æ³¨è§£å±æ€§çš„è®¾ç½®å€¼</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/annotation-inspect-value.jpg" alt=""></p>
<p>ä½¿ç”¨HSDBå¯ä»¥æ–¹ä¾¿çš„æŸ¥çœ‹java è¿›ç¨‹çš„è¿è¡Œæ—¶æ•°æ®çŠ¶æ€ï¼Œæ–¹ä¾¿debug</p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java-çº¿ç¨‹æ± </title>
    <url>/article/java-%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ">ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± </h3>
<p>çº¿ç¨‹æ±  = workerçº¿ç¨‹ + ä»»åŠ¡é˜Ÿåˆ—</p>
<h3 id="workerçº¿ç¨‹">workerçº¿ç¨‹</h3>
<p>ç»§æ‰¿è‡ªAQSï¼Œå¹¶ä¸”å®ç°äº†Runnableæ¥å£ã€‚workerçº¿ç¨‹ä¸æ–­ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œå½“ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢æ²¡æœ‰ä»»åŠ¡å¯æ‰§è¡Œäº†æˆ–è€…ä»»åŠ¡æ‰§è¡Œé€”ä¸­æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œçº¿ç¨‹é€€å‡ºï¼Œé”€æ¯çº¿ç¨‹ã€‚</p>
<h4 id="aqs">AQS</h4>
<p>AQSä¸ºé‚£äº›åŸºäºFIFOç­‰å¾…é˜Ÿåˆ—çš„åŒæ­¥å™¨å’Œé˜»å¡é”æä¾›äº†ä¸€ä¸ªæ¡†æ¶<br>
AQSä¸ºé‚£äº›ç”¨å•ä¸ªåŸå­intå€¼è¡¨ç¤ºçŠ¶æ€çš„åŒæ­¥å™¨ï¼Œæä¾›äº†çŠ¶æ€çš„åŸå­æ“ä½œï¼ˆgetStateã€setStateã€compareAndSetStateï¼‰<br>
åŒæ­¥å™¨è¦ç»§æ‰¿è‡ªAQSï¼Œå¹¶ä½œä¸ºépublicçš„å†…éƒ¨helperç±»ï¼Œå…·ä½“çš„publicåŒæ­¥æ–¹æ³•ç”±å¤–å›´åŒ…è£…ç±»æä¾›<br>
AQSæ”¯æŒäº’æ–¥ã€å…±äº«ä¸¤ç§è·å–é”çš„æ¨¡å¼ï¼Œå­ç±»åŒæ­¥å™¨ä¸€èˆ¬å®ç°å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥å®ç°ä¸¤ç§æ¨¡å¼ä¾›ç”¨æˆ·é€‰æ‹©ï¼Œå¦‚ReadWriteLock<br>
AQSå®šä¹‰äº†åµŒå¥—ç±»ConditionObject å®ç°äº†Conditionæ¥å£ï¼Œæ”¯æŒäº’æ–¥æ¨¡å¼çš„å­ç±»åŒæ­¥å™¨å¯ä»¥ä½¿ç”¨æ­¤å¯¹è±¡æ¥å®ç°Objectå†…ç½®çš„wait-notifyè¯­ä¹‰<br>
å­ç±»åŒæ­¥å™¨éœ€è¦å®ç°ä»¥ä¸‹æ–¹æ³•ï¼Œä¸”è¦ä¿è¯å®ç°æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ï¼Œä¿®æ”¹æˆ–è€…è·å–çŠ¶æ€ä½¿ç”¨AQSæä¾›çš„æ–¹æ³•getStateã€setStateã€compareAndSetState<br>
tryAcquire<br>
tryRelease<br>
tryAcquireShared<br>
tryReleaseShared<br>
isHeldExclusively</p>
<p>AQSå†…éƒ¨çš„FIFOé˜Ÿåˆ—çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Acquire:</span><br><span class="line">    while (!tryAcquire(arg)) &#123; //å°è¯•è·å–é”</span><br><span class="line">        enqueue thread if it is not already queued; //è·å–å¤±è´¥åˆ™ï¼Œå°†å½“å‰çº¿ç¨‹å…¥é˜Ÿåˆ—</span><br><span class="line">        possibly block current thread; //å½“å‰çº¿ç¨‹åœ¨FIFOé˜Ÿåˆ—é˜»å¡ç­‰å¾…</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">Release:</span><br><span class="line">    if (tryRelease(arg)) //å°è¯•é‡Šæ”¾é”</span><br><span class="line">        unblock the first queued thread; //é‡Šæ”¾æˆåŠŸåˆ™ï¼Œå°†FIFOé˜Ÿé¦–çº¿ç¨‹å‡ºé˜Ÿåˆ—</span><br></pre></td></tr></table></figure>
<p>å¦‚æœAQSä¸èƒ½æ»¡è¶³ä½ çš„åŒæ­¥å™¨éœ€æ±‚ï¼Œä½ å¯ä»¥åŸºäºæ›´åº•å±‚çš„java.util.concurrent.atomicç±»ã€java.util.Queueç±»å’ŒLockSupportç±»æ¥å®ç°è‡ªå®šä¹‰çš„åŒæ­¥å™¨</p>
<p>AQSä½¿ç”¨ä¸¾ä¾‹ï¼š<br>
Mutexç±»ï¼šäº’æ–¥é”ï¼ŒçŠ¶æ€0ä»£è¡¨unlockï¼ŒçŠ¶æ€1ä»£è¡¨locked</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mutex</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†…éƒ¨Helperç±»ç»§æ‰¿è‡ª AQS</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æŸ¥çœ‹é”æ˜¯å¦å·²è¢«å ç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isHeldExclusively</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> getState() == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–é”ï¼Œå°†stateç”± 0 ä¿®æ”¹ä¸º 1</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">assert</span> acquires == <span class="number">1</span>; <span class="comment">// Otherwise unused</span></span><br><span class="line">      <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”ï¼Œå°†stateç”± 1 ä¿®æ”¹ä¸º 0</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">assert</span> releases == <span class="number">1</span>; <span class="comment">// Otherwise unused</span></span><br><span class="line">      <span class="keyword">if</span> (getState() == <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">      setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">      setState(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æä¾›Conditonæ¥å£å®ç°ç­‰å¾…é€šçŸ¥æœºåˆ¶</span></span><br><span class="line">    <span class="function">Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Deserializes properly</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">      s.defaultReadObject();</span><br><span class="line">      setState(<span class="number">0</span>); <span class="comment">// reset to unlocked state</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å±æ€§å®ä¾‹åŒ–åŒæ­¥å™¨ï¼ˆåˆå§‹åŒ–çº¿ç¨‹å®‰å…¨ï¼‰ï¼Œå¹¶å°†åŒæ­¥å™¨ç½®ä¸ºfinalï¼ˆæ“ä½œçº¿ç¨‹å®‰å…¨ï¼‰</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Sync sync = <span class="keyword">new</span> Sync();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤–å›´åŒ…è£…ç±»Mutexæä¾›ç”¨æˆ·ä½¿ç”¨æ¥å£</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span>                </span>&#123; sync.acquire(<span class="number">1</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span>          </span>&#123; <span class="keyword">return</span> sync.tryAcquire(<span class="number">1</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span>              </span>&#123; sync.release(<span class="number">1</span>); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> sync.newCondition(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLocked</span><span class="params">()</span>         </span>&#123; <span class="keyword">return</span> sync.isHeldExclusively(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasQueuedThreads</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> sync.hasQueuedThreads(); &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(timeout));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CLHé˜Ÿåˆ—ï¼šåŸºäºé“¾è¡¨çš„ç¡®ä¿æ— é¥¥é¥¿çš„ã€æä¾›å…ˆæ¥å…ˆæœåŠ¡çš„ï¼Œå…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹åªåœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒã€ä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå¦‚æœå‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ï¼Œè·å¾—é”ã€‘<br>
å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼š<br>
1. åˆ›å»ºNodeèŠ‚ç‚¹ï¼šå°è£…çº¿ç¨‹+çŠ¶æ€ï¼ŒçŠ¶æ€ç½®ä¸ºï¼šè·å–é”ï¼Œ åŠ å…¥FIFOé˜Ÿåˆ—é˜Ÿå°¾<br>
2. è·å–é˜Ÿåˆ—é‡Œçš„å‰é©±èŠ‚ç‚¹ï¼Œè‡ªæ—‹æ£€æŸ¥å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œç›´åˆ°å‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸ºï¼šé‡Šæ”¾é” æ—¶ï¼Œè‡ªå·±è·å–åˆ°é”ï¼Œå¹¶å›æ”¶å‰é©±èŠ‚ç‚¹</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼š<br>
1. é‡Šæ”¾é”çš„èŠ‚ç‚¹å¿…ç„¶æ˜¯é˜Ÿåˆ—å¤´èŠ‚ç‚¹ï¼Œè®¾ç½®è‡ªå·±çš„çŠ¶æ€ä¸ºï¼šé‡Šæ”¾é”</p>
<p>ç­‰å¾…é˜Ÿåˆ—ï¼šCLHé˜Ÿåˆ—çš„å˜ç§ ç”¨äºé˜»å¡åŒæ­¥<br>
å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”æ—¶ï¼š æ²¡è·å–åˆ°ï¼Œä¼šåŠ å…¥é˜Ÿå°¾ï¼Œå¹¶ä¸”ä½¿ç”¨LockSupport.park é˜»å¡å½“å‰çº¿ç¨‹ï¼Œè¿›å…¥ç¡çœ çŠ¶æ€</p>
<p>å½“ä¸Šä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”æ—¶ï¼Œä½¿ç”¨LockSupport.unpark å»é€šçŸ¥åç»§èŠ‚ç‚¹ï¼Œå”¤é†’ç›¸åº”çš„çº¿ç¨‹</p>
<h3 id="ä»»åŠ¡é˜Ÿåˆ—">ä»»åŠ¡é˜Ÿåˆ—</h3>
<p>ä»»åŠ¡é˜Ÿåˆ—å®ç°BlockingQueueæ¥å£ï¼Œç»†åˆ†ä¸ºï¼š</p>
<p>æ— ç•Œé˜Ÿåˆ—ï¼šDelayedWorkQueueã€LinkedBlockingQueue</p>
<p>æœ‰ç•Œé˜Ÿåˆ—ï¼šArrayBlockingQueue</p>
<p>ç›´æ¥é€’äº¤ç»™workerçº¿ç¨‹å‹é˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—ä¸å­˜æ”¾ä»»åŠ¡ï¼‰ï¼šSynchronousQueue</p>
<h3 id="çº¿ç¨‹æ± ä¸­çš„ä½è¿ç®—">çº¿ç¨‹æ± ä¸­çš„ä½è¿ç®—</h3>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/threadpool-bit-operation.jpg" alt=""></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>java1.8-HashMap</title>
    <url>/article/java1-8-HashMap/</url>
    <content><![CDATA[<h3 id="ç±»å›¾ç»“æ„">ç±»å›¾ç»“æ„</h3>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/HashMap-%E7%B1%BB%E5%9B%BE%E7%BB%93%E6%9E%84.jpg" alt=""></p>
<h3 id="ç±»æ–‡ä»¶è¯´æ˜">ç±»æ–‡ä»¶è¯´æ˜</h3>
<p>æˆ‘ä»¬çŸ¥é“java sdké‡Œçš„æ³¨é‡Šæ˜¯æœ€å¥½çš„docæ–‡æ¡£ã€‚æ¯ä¸ªæºç æ–‡ä»¶å¼€å§‹éƒ½æœ‰ä¸€å¤§æ®µæ³¨é‡Šæ¥è¯´æ˜æ­¤æ–‡ä»¶æ‰€æè¿°çš„å†…å®¹ï¼Œåœ¨è¿™å„¿æˆ‘ä»¬å¯ä»¥å¯¹æºç æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ã€‚</p>
<p><strong>ä¸€ï¼š</strong></p>
<p>HashMapå’ŒHashTableç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºHashMapæ˜¯éåŒæ­¥çš„å³ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›HashMapå…è®¸keyã€valueä¸ºnull</p>
<p><strong>äºŒï¼š</strong></p>
<p>HashMapä¸ä¿è¯æ’å…¥å…ƒç´ æ‰€å­˜æ”¾çš„é¡ºåºï¼Œç”šè‡³ä¸ä¿è¯å…ƒç´ çš„å­˜æ”¾é¡ºåºä¼šä¸€ç›´ä¿æŒä¸å˜</p>
<p><strong>ä¸‰ï¼š</strong></p>
<p>å‡å®šhashå‡½æ•°æ•£åˆ—æ€§èƒ½æ¯”è¾ƒå¥½ï¼ŒåŸºæœ¬çš„getã€putæ“ä½œéƒ½æ˜¯O(1) æ€§èƒ½ã€‚å¯¹Mapçš„éå†æ“ä½œæ€§èƒ½åˆ™å’ŒMapçš„capacity(æ¡¶æ·±)ã€sizeï¼ˆé”®å€¼å¯¹ä¸ªæ•°ï¼‰æˆæ¯”ä¾‹ï¼Œæ‰€ä»¥å¦‚æœå¯¹éå†æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„è¯ï¼Œåˆ™ä¸è¦å°†initial capacityè®¾ç½®å¤ªé«˜ï¼Œä¹Ÿä¸è¦å°†loadFactorè®¾ç½®è¿‡ä½</p>
<p><strong>å››ï¼š</strong></p>
<p>HashMapæœ‰ä¸¤ä¸ªé‡è¦çš„å½±å“æ€§èƒ½çš„å‚æ•°ï¼šinitial capacityå’ŒloadFactorã€‚initial capacityæ˜¯å“ˆå¸Œè¡¨åˆ›å»ºæ—¶å“ˆå¸Œæ•°ç»„çš„åˆå§‹å¤§å°ã€‚loadFactor(è´Ÿè½½å› å­)æ˜¯å“ˆå¸Œè¡¨è‡ªåŠ¨æ‰©å®¹å‰æ‰€å…è®¸å“ˆå¸Œæ•°ç»„çš„å·²ä½¿ç”¨å®¹é‡ï¼Œå½“å·²ä½¿ç”¨å®¹é‡è¶…è¿‡loadFactoræ—¶ï¼Œå“ˆå¸Œè¡¨è‡ªåŠ¨æ‰©å®¹åˆ°ä¸¤å€ä¹‹å‰çš„capacityï¼Œé‡æ–°æ„å»ºå†…éƒ¨ç»“æ„ã€‚loadFactorä¸º0.75æ—¶ï¼Œæ—¶é—´ç©ºé—´å¤æ‚åº¦æœ€å¥½ã€‚loadFactorå¤§äº0.75æ—¶ï¼Œç©ºé—´æ¶ˆè€—å°‘ï¼Œæ—¶é—´æ¶ˆè€—å¢åŠ ã€‚loadFactorå°äº0.75æ—¶ï¼Œç©ºé—´æ¶ˆè€—å¢åŠ ï¼Œæ—¶é—´æ¶ˆè€—å°‘ã€‚æ‰€ä»¥åœ¨åˆå§‹åŒ–HashMapæ—¶è¦æ ¹æ®loadFactoræ¥è®¾ç½®initial capacityï¼Œä»¥å‡å°‘æ‰©å®¹(å½±å“æ€§èƒ½)çš„æ¬¡æ•°ã€‚</p>
<p><strong>äº”ï¼š</strong></p>
<p>HashMapæ˜¯é€šè¿‡keyçš„hashcodeæ¥ç¡®å®šæ‰€å¯¹åº”çš„å­˜æ”¾bucketï¼Œæ‰€ä»¥ä¸ºäº†HashMapçš„æ€§èƒ½ï¼Œéœ€è¦è®©keyçš„hashcodeå°½é‡ä¸é‡å¤</p>
<p><strong>å…­ï¼š</strong></p>
<p>HashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä¸ªHashMapæ—¶ï¼Œå¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†HashMapçš„ç»“æ„(å¢åŠ æˆ–åˆ é™¤å…ƒç´ ç­‰æ“ä½œ)ï¼Œåˆ™éœ€è¦å¯¹è¿™ä¸ªHashMapåŠ ä¸ŠSynchronizedåŒæ­¥ã€‚ä¸€ä¸ªä½¿HashMapæˆä¸ºçº¿ç¨‹å®‰å…¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Map m = Collections.synchronizedMap(new HashMap(...));</span><br></pre></td></tr></table></figure>
<p><strong>ä¸ƒï¼š</strong></p>
<p>åœ¨HashMapä¸Šå–Iteratorä¹‹åï¼Œå¦‚æœä¸æ˜¯é€šè¿‡Iteratorè‡ªå·±çš„æ–¹æ³•æ¥æ”¹å˜HashMapçš„ç»“æ„ï¼ˆå¢åŠ æˆ–åˆ é™¤å…ƒç´ ç­‰æ“ä½œï¼‰ï¼ŒIteratorå°†ä¼šå¤±æ•ˆï¼Œåç»­åŸºäºIteratorçš„ä»£ç å°†ä¼šæŠ›å¼‚å¸¸ï¼šjava.util.ConcurrentModificationExceptionã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMapTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span>  Map&lt;String, String&gt; employers = <span class="keyword">new</span> HashMap&lt;&gt; (  );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        employers.put ( <span class="string">"1"</span>, <span class="string">"qiaojian"</span> );</span><br><span class="line">        employers.put ( <span class="string">"2"</span>, <span class="string">"leo"</span> );</span><br><span class="line">        employers.put ( <span class="string">"3"</span>, <span class="string">"guo"</span> );</span><br><span class="line">        employers.put ( <span class="string">"4"</span>, <span class="string">"min"</span> );</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Map.Entry&lt;String, String&gt;&gt; iter = employers.entrySet ().iterator ();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext ()) &#123;</span><br><span class="line">            employers.put ( <span class="string">"5"</span>, <span class="string">"bab"</span> ); <span class="comment">//æ­¤è¡Œä»£ç å¯¼è‡´æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            Map.Entry&lt;String, String&gt; next = iter.next ();</span><br><span class="line">            <span class="keyword">if</span> (next.getKey ().equals ( <span class="string">"2"</span> )) &#123;</span><br><span class="line">                iter.remove (); <span class="comment">//é€šè¿‡Iteratorè‡ªå·±çš„æ–¹æ³•åˆ é™¤å…ƒç´ æ˜¯æ­£ç¡®çš„</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println ( employers.size () );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…«ï¼š</strong></p>
<p>æ³Šæ¾åˆ†å¸ƒåœ¨HashMapä¸­çš„åº”ç”¨ï¼šHahsMapé»˜è®¤loadFactorä¸º0.75æ—¶ï¼Œkeyçš„hashæ•£åˆ—è‰¯å¥½æ—¶ï¼Œæ’å…¥èŠ‚ç‚¹åœ¨æ•°ç»„çš„åˆ†å¸ƒæ»¡è¶³<em>Î»</em> =0.5çš„æ³Šæ¾åˆ†å¸ƒã€‚æ­¤æ—¶åœ¨ä¸€ä¸ªç´¢å¼•ä¸‹å‡ºç°é“¾è¡¨çš„sizeå¤§å°æ»¡è¶³ä»¥ä¸‹æ¦‚ç‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">* 0:    0.60653066</span><br><span class="line">* 1:    0.30326533</span><br><span class="line">* 2:    0.07581633</span><br><span class="line">* 3:    0.01263606</span><br><span class="line">* 4:    0.00157952</span><br><span class="line">* 5:    0.00015795</span><br><span class="line">* 6:    0.00001316</span><br><span class="line">* 7:    0.00000094</span><br><span class="line">* 8:    0.00000006</span><br><span class="line">* more: less than 1 in ten million</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œè®¾ç½®é“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼TREEIFY_THRESHOLD=8ï¼Œè¡¨ç¤ºçœŸçš„å‡ºç°ä½¿ç”¨çº¢é»‘æ ‘çš„æƒ…å†µçš„æ¦‚ç‡å¾ˆå°å¾ˆå°ã€‚</p>
<h3 id="serialversionuid">serialVersionUID</h3>
<p><code>serialVersionUID</code> ç”¨æ¥è¡¨æ˜ç±»çš„ä¸åŒç‰ˆæœ¬é—´çš„å…¼å®¹æ€§ã€‚</p>
<p>å¯¹äºå®ç°äº†Serializableæ¥å£çš„ç±»è¡¨ç¤ºæ­¤ç±»å¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p><code>serialVersionUID</code>æ˜¯æ ¹æ®ç±»åã€æ¥å£åã€æˆå‘˜æ–¹æ³•åŠå±æ€§ç­‰æ¥ç”Ÿæˆä¸€ä¸ª64ä½çš„å“ˆå¸Œå­—æ®µã€‚</p>
<p>Javaçš„ååºåˆ—åŒ–å³æ˜¯é€šè¿‡ä¼ è¿‡æ¥çš„<code>serialVersionUID</code>å’Œæœ¬åœ°å®šä¹‰çš„ç±»çš„<code>serialVersionUID</code>ä½œæ¯”å¯¹æ¥ç¡®ä¿ååºåˆ—åŒ–çš„æ­£ç¡®æ€§ã€‚</p>
<p>æ˜¾ç¤ºçš„å®šä¹‰<code>serialVersionUID</code>å¯ä»¥åœ¨ååºåˆ—åŒ–æ—¶ï¼Œç¡®ä¿ç±»ç‰ˆæœ¬çš„å…¼å®¹æ€§ã€‚å³ä½¿æŸä¸ªç±»åœ¨ä¸ä¹‹å¯¹åº”çš„å¯¹è±¡å·²ç»åºåˆ—åŒ–å‡ºå»ååšäº†ä¿®æ”¹ï¼Œè¯¥å¯¹è±¡ä¾ç„¶å¯ä»¥è¢«æ­£ç¡®ååºåˆ—åŒ–ï¼ˆå½“<code>serialVersionUID</code>ç›¸åŒæ—¶ï¼Œå®ƒå°±ä¼šå°†ä¸ä¸€æ ·çš„fieldä»¥typeçš„é¢„è®¾å€¼Deserializeï¼Œç¡®ä¿å…¼å®¹æ€§ï¼‰ã€‚</p>
<p>å…³äºHashMapçš„åºåˆ—åŒ–</p>
<ol>
<li>é¦–å…ˆ HashMap å®ç°äº† Serializable æ¥å£ï¼Œå¯ä»¥åºåˆ—åŒ–</li>
<li>serialVersionUID ç”¨äºä¿è¯ç‰ˆæœ¬çš„å…¼å®¹æ€§</li>
<li>staticå’Œfinalå±æ€§ä¸ä¼šè¢«åºåˆ—åŒ–</li>
<li>transientä¿®é¥°çš„å±æ€§ä¸ä¼šè¢«åºåˆ—åŒ–</li>
<li>HashMapçš„ tableã€entrySetã€sizeå’ŒmodCountå±æ€§éƒ½è¢«æ ‡è®°ä¸ºtransient</li>
<li>HashMapå®ç°äº†è‡ªå·±çš„åºåˆ—åŒ–æ–¹æ³•: writeObject å’Œååºåˆ—åŒ–æ–¹æ³• readObjectï¼Œè¡¨ç¤ºä¸ä¼šä½¿ç”¨JDKä¸­é»˜è®¤çš„åºåˆ—åŒ–æ–¹æ³•</li>
<li>Javaçš„åºåˆ—åŒ–ä½¿ç”¨ObjectOutputStreamç±»çš„å„ç§æ–¹æ³•ï¼ˆwriteIntã€writeBooleanã€writeObjectç­‰ï¼‰ï¼Œååºåˆ—åŒ–ä½¿ç”¨ObjectInputStreamçš„å„ç§æ–¹æ³•ï¼ˆreadIntã€readBooleanã€readObjectç­‰ï¼‰ï¼Œè€ŒwriteObjectå’ŒreadObjectä¼šåˆ¤æ–­è¢«åºåˆ—åŒ–å¯¹è±¡æ˜¯å¦é‡å†™äº†å¯¹åº”çš„æ–¹æ³•æ¥è°ƒç”¨è¢«åºåˆ—åŒ–å¯¹è±¡è‡ªå·±çš„æ–¹æ³•å®Œæˆè‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</li>
<li>HashMapä¸ºä»€ä¹ˆè¦è‡ªå·±å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•ï¼Ÿ å› ä¸ºHashMapä¸­ï¼Œç”±äºEntryçš„å­˜æ”¾ä½ç½®æ˜¯æ ¹æ®Keyçš„Hashå€¼æ¥è®¡ç®—ï¼Œç„¶åå­˜æ”¾åˆ°æ•°ç»„ä¸­çš„ï¼Œå¯¹äºåŒä¸€ä¸ªKeyï¼Œåœ¨ä¸åŒçš„JVMå®ç°ä¸­è®¡ç®—å¾—å‡ºçš„Hashå€¼å¯èƒ½æ˜¯ä¸åŒçš„ã€‚è€ŒKeyçš„Hashå€¼ä¸åŒä¼šå¯¼è‡´tableç»“æ„çš„ä¸åŒï¼Œå¯¼è‡´JDKé»˜è®¤åºåˆ—åŒ–å‡ºæ¥çš„æ•°æ®ä¹Ÿä¸åŒã€‚è€ŒHashMapè‡ªå®šä¹‰çš„åºåˆ—åŒ–æ–¹æ³•writeObjectä¸­å°†tableé‡Œæ¯ä¸ªNodeçš„keyå’Œvalueåˆ†åˆ«åºåˆ—åŒ–ã€‚åœ¨è‡ªå®šä¹‰çš„ååºåˆ—åŒ–æ–¹æ³•readObjectä¸­å°†keyã€valueæå–å‡ºæ¥é‡æ–°è®¡ç®—hashï¼Œé‡æ–°putå½¢æˆtable</li>
</ol>
<h3 id="tablesizefor">tableSizeFor</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Returns a power of two size for the given target capacity.</span></span><br><span class="line"><span class="comment"> * æ­¤å‡½æ•°çš„ä½œç”¨æ˜¯ï¼šæ ¹æ®å½“å‰ä¼ å…¥çš„capï¼Œè®¡ç®—å‡ºtable sizeï¼ˆä¸º2çš„å¹‚æ¬¡æ–¹ï¼Œç­‰äº capacity * loadfactorï¼‰</span></span><br><span class="line"><span class="comment"> * æ¯”å¦‚ï¼šnew Hashmap&lt;&gt; (5); åˆ™æ ¹æ®5è®¡ç®—å‡º table sizeä¸º8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">  n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ºä»€ä¹ˆè¦ä¿æŒtable sizeæ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Ÿ</span></span><br><span class="line"><span class="comment">//å› ä¸ºï¼šåœ¨putå…ƒç´ æ—¶æ˜¯æ ¹æ®ï¼ˆhash(key) % capacityï¼‰æ¥ç¡®å®šå…ƒç´ è¦å­˜æ”¾çš„indexï¼š</span></span><br><span class="line"><span class="comment">//è€Œï¼šå–ä½™(%)æ“ä½œä¸­å¦‚æœé™¤æ•°æ˜¯2çš„å¹‚æ¬¡æ–¹åˆ™ç­‰åŒäºä¸å…¶é™¤æ•°å‡ä¸€çš„ä¸(&amp;)æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥ä¸Šå¼ç­‰åŒäºä¸‹å¼</span></span><br><span class="line">index = e.hash % newCap</span><br><span class="line"><span class="comment">//ç­‰åŒäº</span></span><br><span class="line">index = e.hash &amp; (newCap - <span class="number">1</span>);</span><br><span class="line"><span class="comment">//æ‰€ä»¥ä¿æŒtable sizeæ˜¯2çš„å¹‚æ¬¡æ–¹æ˜¯ä¸ºäº†æ ¹æ®hashæ¥è®¡ç®—indexå¯ä»¥é€šè¿‡&amp;è¿ç®—å®Œæˆä»¥æä¾›æ€§èƒ½</span></span><br></pre></td></tr></table></figure>
<h3 id="hashkey">hash(key)</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç”±ä¸‹å¯è§ï¼Œåœ¨putå…ƒç´ æ—¶ï¼Œæ ¹æ®keyè®¡ç®—hashå€¼</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//hashå€¼çš„è®¡ç®—è§„åˆ™ï¼šå–keyçš„hashCodeä¸å…¶è‡ªèº«çš„é«˜16ä½è¿›è¡Œå¼‚æˆ–è¿ç®—</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> h;</span><br><span class="line">  <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸ºä»€ä¹ˆhashè®¡ç®—è¦å–keyçš„hashCodeä¸å…¶è‡ªèº«çš„é«˜16ä½è¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Ÿ</span></span><br><span class="line"><span class="comment">//å› ä¸ºä¸Šé¢æˆ‘ä»¬æåˆ°indexçš„è¿ç®—è§„åˆ™æ˜¯e.hash &amp; (newCap - 1)ã€‚</span></span><br><span class="line"><span class="comment">//ç”±äºnewCapæ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œé‚£ä¹ˆnewCap - 1çš„é«˜ä½åº”è¯¥ä¸º0ã€‚</span></span><br><span class="line"><span class="comment">//å¦‚æœe.hashå€¼åªç”¨è‡ªèº«çš„hashcodeçš„è¯ï¼Œé‚£ä¹ˆnewCap - 1åªä¼šå’Œe.hashä½ä½åš&amp;æ“ä½œ(e.hashæœ‰32ä½å€¼ï¼Œè€ŒnewCap - 1 é€šå¸¸æ²¡æœ‰é‚£ä¹ˆå¤§)ã€‚è¿™æ ·ä¸€æ¥ï¼Œe.hashçš„å€¼å°±åªæœ‰ä½ä½å‚ä¸è¿ç®—ï¼Œé«˜ä½æœªå‚ä¸è®¡ç®—ï¼Œä»è€Œä¼šå¸¦æ¥å“ˆå¸Œå†²çªçš„é£é™©ã€‚</span></span><br><span class="line"><span class="comment">//æ‰€ä»¥åœ¨è®¡ç®—keyçš„å“ˆå¸Œå€¼çš„æ—¶å€™ï¼Œç”¨å…¶è‡ªèº«hashcodeå€¼ä¸å…¶é«˜16ä½åšå¼‚æˆ–æ“ä½œã€‚è¿™ä¹Ÿå°±è®©é«˜ä½å‚ä¸åˆ°indexçš„è®¡ç®—ä¸­æ¥äº†ï¼Œå³é™ä½äº†å“ˆå¸Œå†²çªçš„é£é™©åˆä¸ä¼šå¸¦æ¥å¤ªå¤§çš„æ€§èƒ½é—®é¢˜ã€‚</span></span><br></pre></td></tr></table></figure>
<h3 id="nodelt-k-v-gt">Node&lt; K ,V &gt;[]</h3>
<p><code>Node&lt;K,V&gt;[] table</code>æ˜¯<code>HashMap</code>åº•å±‚å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ä¸ª<code>Node</code>æ•°ç»„ã€‚<code>Node</code>ç±»ä¸ºå…ƒç´ ç»´æŠ¤äº†ä¸€ä¸ªå•å‘é“¾è¡¨ã€‚è¿™æ ·è®¾è®¡çš„åŸå› æ˜¯è€ƒè™‘åˆ°é‡åˆ°å“ˆå¸Œå†²çªçš„æ—¶å€™ï¼ŒåŒ<code>index</code>çš„<code>value</code>å€¼å°±ç”¨å•å‘é“¾è¡¨æ¥ç»´æŠ¤ã€‚å½“å•é“¾è¡¨çš„é•¿åº¦è¶…è¿‡<code>TREEIFY_THRESHOLD</code> (é»˜è®¤8)æ—¶ï¼Œå°†å†…éƒ¨ç»“æ„å•é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘å­˜å‚¨ï¼Œçº¢é»‘æ ‘èŠ‚ç‚¹ç”±Nodeçš„å­ç±»TreeNodeè¡¨ç¤º</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">  <span class="keyword">final</span> K key;</span><br><span class="line">  V value;</span><br><span class="line">  Node&lt;K,V&gt; next; <span class="comment">//å•é“¾è¡¨</span></span><br><span class="line">  ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ„é€ å‡½æ•°">æ„é€ å‡½æ•°</h3>
<p>ç”±ä¸‹å¯çŸ¥<code>HashMap</code>ä¸€å…±æœ‰å››ä¸ªæ„é€ å‡½æ•°ï¼šå‡æœªåœ¨æ„é€ å‡½æ•°é‡Œåˆå§‹åŒ–hash tableæ•°ç»„ï¼Œåªæ˜¯è®¾ç½®å±æ€§ï¼š</p>
<p><code>loadFactor</code>  å’Œ <code>threshhold</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                       initialCapacity);</span><br><span class="line">  <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">    initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">  <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                       loadFactor);</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">  <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">  putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="resize">resize()</h3>
<p>åœ¨putå…ƒç´ æ—¶ä¼šæ ¹æ®tableæ˜¯å¦ä¸ºç©ºæ¥åˆå§‹åŒ–tableï¼Œæˆ–è€…åœ¨putå…ƒç´ åæ ¹æ®tableçš„å…ƒç´ sizeæ˜¯å¦è¶…è¿‡<code>threshold</code>æ¥æ‰©å®¹ã€‚è€Œåˆå§‹åŒ–tableå’Œå¯¹tableè¿›è¡Œæ‰©å®¹å‡æ˜¯é€šè¿‡resize()å®ç°çš„ã€‚å¦‚æœtableä¸ºnullï¼Œåˆ™å°†thresholdé‡Œçš„å€¼ä½œä¸ºinitial capacityæ¥åˆå§‹åŒ–tableã€‚tableä¸ä¸ºç©ºï¼Œåˆ™è¿›è¡Œtable sizeåŠ å€æ‰©å®¹ã€‚ç”±äºä½¿ç”¨çš„å¹‚æ‰©å±•ï¼Œæ‰©å®¹åæ–°tableé‡Œçš„å…ƒç´ è¦ä¹ˆç»´æŒåŸæ¥çš„indexä¸å˜ï¼Œè¦ä¹ˆindexç§»åŠ¨2çš„å¹‚æ¬¡æ–¹(oldCap)ã€‚</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/hashmap-resize.jpg" alt="hashmap-resize"></p>
<h3 id="modcount">modCount</h3>
<p>modCountè®°å½•HashMapç»“æ„åŒ–æ”¹å˜çš„æ¬¡æ•°ï¼Œç”¨äºIteratoréå†HashMapæ—¶çš„å¹¶å‘ä¿®æ”¹å¼‚å¸¸æ¢æµ‹(ä»…æ˜¯do the best ä¸æ˜¯ç»å¯¹å¯é ï¼Œå› ä¸ºæ²¡åŠ é”ã€‚ã€‚ã€‚)<br>
Iteratorçš„æ—¶å€™ï¼Œæ¯æ¬¡éå†å–Nextï¼Œæˆ–æ‰§è¡Œremvoeçš„æ—¶å€™éƒ½è¦å»æ£€æµ‹modCountå’ŒIteratoråˆå§‹åŒ–æ—¶çš„expectModCountç›¸åŒï¼Œä¸åŒåˆ™ä¼šæŠ›å¼‚å¸¸ConcurrentModificationException<br>
åŒæ—¶ï¼Œé€šè¿‡Iteratorçš„removeæ–¹æ³•åœ¨éå†çš„æ—¶å€™å»åˆ é™¤å…ƒç´ ä¼šåŒæ—¶ä¿®æ”¹modCountå’ŒIteratorçš„expectModCountï¼Œæ‰€ä»¥æ²¡æœ‰é—®é¢˜(do the best)<br>
Fast-Fail Iterator &amp; Fail-Safe Iterator<br>
Fast-Fail Iterator: åœ¨iteratoréå†æ—¶ï¼Œä¸é€šè¿‡iteratorçš„ç»“æ„ä¿®æ”¹ä¼šæŠ›å¼‚å¸¸ConcurrentModificationException<br>
Fail-Safe Iteratorï¼šåœ¨iteratoréå†æ—¶ï¼Œå¯ä»¥ä¸é€šè¿‡iteratoræ¥ä¿®æ”¹é›†åˆçš„ç»“æ„ï¼Œä¸ä¼šæŠ›å¼‚å¸¸<br>
JDKä¸­ä½¿ç”¨Fast-Failæ¨¡å¼çš„é›†åˆï¼šArrayListã€HashMapã€Vectorç­‰<br>
JDKä¸­ä½¿ç”¨Fail-Safeæ¨¡å¼çš„é›†åˆï¼šConcurrentHashMapã€CopyOnWriteAraayList</p>
<h3 id="put">put</h3>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/hashmap-put.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//LinkedHashMap ç§»é™¤æ—§èŠ‚ç‚¹ç¤ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// LinkedHashMap removeEldestEntry() é»˜è®¤å®ç°è¿”å›falseï¼Œä¸èµ·ä½œç”¨</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„é€ åŒ¿åç±»ç»§æ‰¿è‡ªLinkedHashMapï¼Œå¹¶å®ç°removeEldestEntryï¼Œæ¯æ¬¡æ’å…¥èŠ‚ç‚¹æ—¶æ£€æµ‹å¤§å°è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è‡ªåŠ¨åˆ é™¤æ—§èŠ‚ç‚¹</span></span><br><span class="line">  LinkedHashMap&lt;Integer, String&gt; li_hash_map =</span><br><span class="line">    <span class="keyword">new</span> LinkedHashMap&lt;Integer, String&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;Integer, String&gt; eldest)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> size() &gt; MAX;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// æ’å…¥2ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">  li_hash_map.put(<span class="number">1</span>, <span class="string">"One"</span>);</span><br><span class="line">  li_hash_map.put(<span class="number">2</span>, <span class="string">"Two"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//&#123;1=One, 2=Two&#125;</span></span><br><span class="line">  System.out.println(<span class="string">""</span> + li_hash_map);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’å…¥ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¶…å‡ºé˜ˆå€¼</span></span><br><span class="line">  li_hash_map.put(<span class="number">3</span>, <span class="string">"Three"</span>);</span><br><span class="line">  <span class="comment">//&#123;2=Two, 3=Three&#125;</span></span><br><span class="line">  System.out.println(<span class="string">""</span> + li_hash_map);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ’å…¥ç¬¬å››ä¸ªèŠ‚ç‚¹ï¼Œè¶…å‡ºé˜ˆå€¼</span></span><br><span class="line">  li_hash_map.put(<span class="number">4</span>, <span class="string">"Four"</span>);</span><br><span class="line">  <span class="comment">//&#123;3=Three, 4=Four&#125;</span></span><br><span class="line">  System.out.println(<span class="string">""</span> + li_hash_map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="get">get</h3>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/hashmap-get.jpg" alt=""></p>
<p>é¦–å…ˆæ ¹æ®keyè®¡ç®—hashï¼Œç„¶åé€šè¿‡hashä¸table lengthå–ä½™è¿ç®—å¾—å‡ºkey-valueæ‰€åœ¨çš„tableçš„indexï¼Œå–å‡ºindexå¤„çš„key-valueï¼Œå†æ¯”è¾ƒkeyï¼Œè‹¥æ²¡æ‰¾åˆ°ï¼Œå†éå†é“¾è¡¨æ¯”è¾ƒã€‚æ³¨æ„å›¾ä¸­1å’Œ2å¤„keyçš„æ¯”è¾ƒï¼Œä½¿ç”¨ == å’Œ equalsï¼Œè¡¨ç¤ºHashMapçš„ä¸¤ä¸ªkeyç›¸ç­‰çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šåŒæ ·çš„keyå¯¹è±¡æˆ–è€…è‡ªå®šä¹‰çš„key.equalsç›¸ç­‰ã€‚ç”±æ­¤ä¹Ÿå¯çŸ¥ä½œä¸ºHashMapçš„Keyå¯¹è±¡å¿…é¡»å®ç°hashCodeæ–¹æ³•å’Œequalsæ–¹æ³•ã€‚hashCodeç”¨äºç¡®å®škey-valueåœ¨æ•°ç»„ä¸­çš„indexï¼Œequalsç”¨äºæ¯”è¾ƒæŸ¥æ‰¾key-valueã€‚</p>
<h3 id="17-ä¸18åŒºåˆ«">1.7 ä¸1.8åŒºåˆ«</h3>
<p>1.7é‡‡ç”¨æ•°ç»„+å•é“¾è¡¨ï¼Œ1.8é‡‡ç”¨æ•°ç»„+å•é“¾è¡¨+çº¢é»‘æ ‘</p>
<p>1.7å‘å•é“¾è¡¨æ’å…¥å…ƒç´ æ˜¯å¤´æ’ï¼ˆæœ€è¿‘æ’å…¥çš„å…ƒç´ è¢«è®¿é—®çš„æ¦‚ç‡æ›´å¤§ï¼‰ï¼Œ1.8å‘å•é“¾è¡¨æ’å…¥å…ƒç´ æ˜¯å°¾æ’ï¼ˆé¿å…äº†é“¾è¡¨æˆç¯çš„é—®é¢˜ï¼‰ã€‚</p>
<p>1.7å¤´æ’åœ¨æ‰©å®¹æ—¶ï¼Œå¤šçº¿ç¨‹ä¸‹ä¼šå¯¼è‡´é“¾è¡¨æˆç¯ã€‚1.7æ‰©å®¹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Transfers all entries from current table to newTable.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable)</span> </span>&#123;</span><br><span class="line">  Entry[] src = table;</span><br><span class="line">  <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; src.length; j++) &#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = src[j];</span><br><span class="line">    <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">      src[j] = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        Entry&lt;K,V&gt; next = e.next; <span class="comment">// ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œåˆ°æ­¤ï¼Œç„¶åå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢</span></span><br><span class="line">        <span class="keyword">int</span> i = indexFor(e.hash, newCapacity); </span><br><span class="line">        e.next = newTable[i];</span><br><span class="line">        newTable[i] = e;</span><br><span class="line">        e = next;</span><br><span class="line">      &#125; <span class="keyword">while</span> (e != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.7 å’Œ1.8 å¤šçº¿ç¨‹æ’å…¥æ•°æ®æ—¶éƒ½ä¼šå­˜åœ¨æ•°æ®è¦†ç›–çš„ç°è±¡ï¼š</p>
<p>æ¯”å¦‚ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶putæ—¶ï¼Œè®¡ç®—å‡ºçš„ç´¢å¼•ä½ç½®ä¸€æ ·æ—¶ï¼Œç”±äºCPUæ—¶é—´ç‰‡åˆ‡æ¢å¯èƒ½å¯¼è‡´ä¸€ä¸ªçº¿ç¨‹æ’å…¥çš„å€¼è¢«å¦ä¸€ä¸ªçº¿ç¨‹åæ’å…¥çš„å€¼è¦†ç›–äº†ï¼Œè€Œä¸æ˜¯æ’å…¥ä¸¤ä¸ªå½¢æˆå•é“¾è¡¨ã€‚</p>
<p>å†æ¯”å¦‚æ’å…¥æˆåŠŸåéƒ½ä¼šå¯¹size++ï¼Œå¾ˆæ˜æ˜¾å¤šçº¿ç¨‹ç¯å¢ƒä¸‹size++æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ•°æ®è¦†ç›–å¯èƒ½å¯¼è‡´sizeå°‘åŠ äº†ã€‚</p>
<h3 id="é“¾è¡¨è½¬çº¢é»‘æ ‘">é“¾è¡¨è½¬çº¢é»‘æ ‘</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é“¾è¡¨é•¿åº¦è¶…è¿‡8æ—¶ï¼Œè½¬çº¢é»‘æ ‘</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(java.util.HashMap.Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> n, index; java.util.HashMap.Node&lt;K,V&gt; e;</span><br><span class="line">  <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">    <span class="comment">// æ•°ç»„å¤§å°å°äº64ï¼Œåˆ™èµ°æ‰©å®¹ï¼Œæ‰©å®¹æ•°ç»„è‡³2å€åŸæ¥å¤§å°</span></span><br><span class="line">    resize();</span><br><span class="line">  <span class="comment">//æ‰¾åˆ°é“¾è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//éå†Nodeé“¾è¡¨ï¼Œå°†Nodeé“¾è¡¨å…ƒç´ è½¬TreeNodeé“¾è¡¨</span></span><br><span class="line">    java.util.HashMap.TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="comment">//è°ƒç”¨replacementTreeNodeï¼Œæ ¹æ®Nodeé“¾è¡¨èŠ‚ç‚¹æ„é€ TreeNodeèŠ‚ç‚¹</span></span><br><span class="line">      java.util.HashMap.TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//TreeNodeé“¾è¡¨ä¸ºç©ºï¼Œåˆ™å°†TreeNodeèŠ‚ç‚¹è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹</span></span><br><span class="line">        hd = p;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//TreeNodeé“¾è¡¨ä¸ä¸ºç©ºï¼Œåˆ™å‘TreeNodeé“¾è¡¨åæ·»åŠ TreeNodeå…ƒç´ </span></span><br><span class="line">        p.prev = tl;</span><br><span class="line">        tl.next = p;</span><br><span class="line">      &#125;</span><br><span class="line">      tl = p;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</span><br><span class="line">      <span class="comment">//hdå³æ˜¯TreeNodeé“¾è¡¨ï¼Œè°ƒç”¨treeifyå°†TreeNodeé“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">      hd.treeify(tab);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>treeifyBinå°†Nodeé“¾è¡¨è½¬åŒ–æˆTreeNodeé“¾è¡¨ï¼Œç„¶åè°ƒç”¨hd.treeifyå°†TreeNodeé“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘ï¼š</p>
<p>hdæŒ‡å‘çš„TreeNodeé“¾è¡¨å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/HashMap-%E9%93%BE%E8%A1%A8%E8%BD%AC%E7%BA%A2%E9%BB%91%E6%A0%91size.jpg" alt=""></p>
<h3 id="çº¢é»‘æ ‘">çº¢é»‘æ ‘</h3>
<h4 id="å®šä¹‰">å®šä¹‰</h4>
<p>å…³äºçº¢é»‘æ ‘ï¼šæ˜¯ä¸€é¢—è‡ªå¹³è¡¡äºŒå‰æ ‘ï¼Œé€šè¿‡å®ƒçš„5ä¸ªç‰¹æ€§é™åˆ¶ç¡®ä¿äº†çº¢é»‘æ ‘çš„å…³é”®ç‰¹æ€§ï¼šä»æ ¹åˆ°å¶å­çš„æœ€é•¿çš„å¯èƒ½è·¯å¾„ä¸å¤šäºæœ€çŸ­çš„å¯èƒ½è·¯å¾„çš„ä¸¤å€é•¿ã€‚åŒ…å«<em>n</em>ä¸ªå†…éƒ¨èŠ‚ç‚¹çš„çº¢é»‘æ ‘çš„é«˜åº¦æ˜¯O(logn)ã€‚å› æ­¤å®ƒå¯ä»¥åœ¨O(logn)æ—¶é—´å†…å®ŒæˆæŸ¥æ‰¾ï¼Œæ’å…¥å’Œåˆ é™¤ã€‚</p>
<ol>
<li>èŠ‚ç‚¹æ˜¯çº¢è‰²æˆ–é»‘è‰²ã€‚</li>
<li>æ ¹æ˜¯é»‘è‰²ã€‚</li>
<li>æ‰€æœ‰å¶å­éƒ½æ˜¯é»‘è‰²ï¼ˆå¶å­æ˜¯NULLèŠ‚ç‚¹ï¼‰ã€‚</li>
<li>æ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ã€‚ï¼ˆä»æ¯ä¸ªå¶å­åˆ°æ ¹çš„æ‰€æœ‰è·¯å¾„ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹ã€‚ï¼‰</li>
<li>ä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰ç®€å•è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚</li>
</ol>
<p>çº¢é»‘æ ‘çš„å¹³è¡¡ï¼šæ»¡è¶³ä»¥ä¸Šæ€§è´¨çš„çº¢é»‘æ ‘å³æ˜¯å¹³è¡¡çš„</p>
<p>å…³äºæ—‹è½¬ï¼ˆå·¦æ—‹å’Œå³æ—‹ï¼‰å’Œå˜è‰²ï¼š</p>
<p>åœ¨æ’å…¥å’Œåˆ é™¤æ“ä½œä¹‹åï¼Œçº¢é»‘æ ‘å¯èƒ½ä¼šå¤±å»å¹³è¡¡ï¼Œé€šè¿‡æ—‹è½¬å’Œå˜è‰²å¯ä»¥ä½¿å¾—çº¢é»‘æ ‘é‡æ–°è¾¾åˆ°å¹³è¡¡ã€‚</p>
<h4 id="æ’å…¥">æ’å…¥</h4>
<p>æ’å…¥å‰æï¼š</p>
<ol>
<li>å¾…æ’å…¥èŠ‚ç‚¹é»˜è®¤ä¸ºçº¢è‰²ï¼Œå› ä¸ºæ’å…¥çº¢è‰²èŠ‚ç‚¹ä¸ä¼šç ´åä¹‹å‰çš„å¹³è¡¡çŠ¶æ€ï¼Œå‡å°‘ç”±äºä¸å¹³è¡¡éœ€è¦è¿›è¡Œçš„æ—‹è½¬å˜è‰²æ“ä½œ</li>
<li>æ‰€æœ‰æ’å…¥æ“ä½œéƒ½æ˜¯åœ¨å¶å­èŠ‚ç‚¹è¿›è¡Œçš„ï¼Œè¿™ç‚¹æ˜¯ç”±äºŒå‰æ ‘çš„ç‰¹æ€§ä¿è¯çš„</li>
</ol>
<p>æ’å…¥æƒ…å½¢1: æ²¡æœ‰çˆ¶èŠ‚ç‚¹</p>
<p>æ’å…¥èŠ‚ç‚¹å°±æ˜¯æ ¹èŠ‚ç‚¹ï¼Œä¿®æ”¹é¢œè‰²ä¸ºçº¢è‰²å³å¯</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91i1.jpg" alt=""></p>
<p>æ’å…¥æƒ…å½¢2: æœ‰çˆ¶èŠ‚ç‚¹ï¼Œä¸”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²</p>
<p>ç›´æ¥æ’å…¥çº¢è‰²èŠ‚ç‚¹ï¼Œä¸ä¼šç ´åå¹³è¡¡</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91i2.jpg" alt=""></p>
<p>æ’å…¥æƒ…å½¢3: æœ‰çˆ¶èŠ‚ç‚¹ï¼Œä¸”çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œæ­¤æ—¶æ’å…¥èŠ‚ç‚¹åï¼Œæœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹äº†ï¼Œéœ€è¦è¿›è¡Œè°ƒæ•´ï¼Œè°ƒæ•´çš„ä¾æ®æ˜¯æ ¹æ®å‘¨è¾¹ç¯å¢ƒæ¥è°ƒæ•´ã€‚è€Œä¸”æ’å…¥ä¹‹å‰æ˜¯å¹³è¡¡çš„ï¼Œåˆ™è‚¯å®šå­˜åœ¨ç¥–çˆ¶èŠ‚ç‚¹ï¼Œä¸”ç¥–çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚</p>
<p>æ’å…¥æƒ…å½¢3.1: çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œä¸”å­˜åœ¨å”çˆ¶èŠ‚ç‚¹ï¼Œåˆ™å”çˆ¶èŠ‚ç‚¹å¿…æ˜¯çº¢è‰²ï¼Œå› ä¸ºæ’å…¥ä¹‹å‰æ˜¯å¹³è¡¡çš„</p>
<p>æ³¨æ„ï¼šä¸ºä»€ä¹ˆè¦æŠŠPPè®¾ä¸ºçº¢è‰²å‘¢ï¼ŒPPä¿æŒé»‘è‰²ï¼Œè¿˜æ˜¯å¹³è¡¡çš„ï¼Œä¸æ›´ç®€å•å—ï¼Ÿå› ä¸ºé»‘è‰²è¶Šå¤šï¼Œæ ‘å°±è¶Šé«˜ï¼ŒæŸ¥è¯¢æ¬¡æ•°è¶Šå¤šã€‚</p>
<p>æ­¤æ—¶PPæ˜¯çº¢è‰²ï¼Œä½†æ˜¯æ ‘å·²ç»æ˜¯å¹³è¡¡çš„äº†ï¼Œåªæ˜¯<strong>å¯èƒ½</strong>è¿˜ä¸æ»¡è¶³æ€§è´¨ã€ä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹ã€‘ï¼Œéœ€è¦å°†PPå½“ä½œæ–°æ’å…¥çš„èŠ‚ç‚¹ç»§ç»­å¤„ç†ï¼Œç»§ç»­å¤„ç†å¯èƒ½ä¼šç¢°åˆ°ã€å­˜åœ¨å”çˆ¶èŠ‚ç‚¹ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‘çš„æƒ…å†µã€‚</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91i4.jpg" alt=""></p>
<p>æ’å…¥æƒ…å½¢3.2: çˆ¶äº²èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œä¸å­˜åœ¨å”çˆ¶èŠ‚ç‚¹æˆ–å­˜åœ¨å”çˆ¶èŠ‚ç‚¹ï¼Œå”çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼ˆè¿™ç§æƒ…å†µåªèƒ½æ˜¯è‡ªåº•å‘ä¸Šé€’å½’æ—¶æ‰å­˜åœ¨ï¼Œæ­¤æ—¶æ•´é¢—æ ‘å·²ç»æ˜¯é»‘è‰²èŠ‚ç‚¹å¹³è¡¡çš„äº†ï¼Œå’Œåˆæ¬¡æ’å…¥ã€çˆ¶äº²èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œä¸å­˜åœ¨å”çˆ¶èŠ‚ç‚¹ã€‘çš„å¤„ç†æ–¹å¼ä¸€æ ·ï¼‰</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91i3.jpg" alt=""></p>
<p>æ’å…¥æ“ä½œä¸­çš„è‡ªåº•å‘ä¸Šgifå‚è€ƒï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91%E6%8F%92%E5%85%A5%E8%87%AA%E5%BA%95%E5%90%91%E4%B8%8A%E5%A4%84%E7%90%86.gif" alt=""></p>
<h4 id="åˆ é™¤">åˆ é™¤</h4>
<p>çº¢é»‘æ ‘åˆ é™¤æ“ä½œæ­¥éª¤ï¼š</p>
<ol>
<li>
<p>æŸ¥æ‰¾å¾…åˆ é™¤çš„èŠ‚ç‚¹</p>
</li>
<li>
<p>ä»å¾…åˆ é™¤èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ä»£æ›¿èŠ‚ç‚¹ï¼ˆå¾…åˆ é™¤èŠ‚ç‚¹çš„å·¦å­æ ‘çš„æœ€å¤§èŠ‚ç‚¹æˆ–è€…å³å­æ ‘çš„æœ€å°èŠ‚ç‚¹ï¼‰ã€è·ŸäºŒå‰æ ‘çš„åˆ é™¤ä¸€æ ·ï¼Œè¦ä¹ˆç”¨å¾…åˆ é™¤èŠ‚ç‚¹çš„å·¦å­æ ‘é¡¶ä¸Šï¼Œè¦ä¹ˆç”¨å¾…åˆ é™¤èŠ‚ç‚¹çš„å³å­æ ‘é¡¶ä¸Šã€‘</p>
</li>
<li>
<p>å¤åˆ¶ä»£æ›¿èŠ‚ç‚¹çš„å€¼åˆ°å¾…åˆ é™¤èŠ‚ç‚¹ï¼Œå¾…åˆ é™¤èŠ‚ç‚¹é¢œè‰²ä¸å˜ï¼Œåˆ é™¤æ“ä½œè½¬ç§»åˆ°ä»£æ›¿èŠ‚ç‚¹ã€‚</p>
</li>
<li>
<p>åˆ é™¤ä»£æ›¿èŠ‚ç‚¹ï¼ˆä»£æ›¿èŠ‚ç‚¹å¿…å®šæ˜¯å¶å­èŠ‚ç‚¹ï¼ˆä¸è€ƒè™‘NILèŠ‚ç‚¹ï¼‰ï¼‰</p>
</li>
<li>
<p>å¦‚æœè¢«åˆ é™¤çš„ä»£æ›¿èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œç›´æ¥åˆ é™¤å³å¯ï¼Œä¸ç ´åå¹³è¡¡ã€‚</p>
</li>
<li>
<p>å¦‚æœè¢«åˆ é™¤çš„ä»£æ›¿èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼Œéœ€è¦åˆ†æƒ…å†µå¤„ç†ï¼Œé‡æ–°å¤„ç†è‡ªå¹³è¡¡</p>
<p>é¦–å…ˆä»£æ›¿èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼Œåˆ™ä»£æ›¿èŠ‚ç‚¹å¿…ç„¶æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œç„¶ååˆ†åˆ«è€ƒè™‘å„ç§æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><strong>æƒ…å†µ1</strong>:  å…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘è‰²ï¼Œå…„å¼ŸèŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹</p>
<p>æ­¤æ—¶ï¼Œå…„å¼ŸèŠ‚ç‚¹æ²¡æœ‰çº¢è‰²èŠ‚ç‚¹å¯å€Ÿï¼Œéœ€è¦è¿›è¡Œè‡ªåº•å‘ä¸Šçš„å¤„ç†ï¼Œå¤„ç†ä¹‹å‰ç”±äºåˆ æ‰äº†Rï¼Œä¸ºäº†ä¿æŒå½“å‰å­æ ‘çš„å¹³è¡¡éœ€è¦å°†Sç½®ä¸ºçº¢è‰²ï¼Œç„¶åå°†På½“ä½œå¾…åˆ é™¤çš„é»‘è‰²èŠ‚ç‚¹è¿›è¡Œè‡ªåº•å‘ä¸Šçš„ç»§ç»­å¤„ç†ã€‚æ„æ€å°±æ˜¯æˆ‘ä¿è¯å½“å‰å­æ ‘å¹³è¡¡ï¼Œåç»­çš„å¹³è¡¡äº¤ç»™çˆ¶èŠ‚ç‚¹å¤„ç†ã€‚</p>
<p><strong>æƒ…å†µ2</strong>: å…„å¼ŸèŠ‚ç‚¹æ˜¯é»‘è‰²ï¼Œå…„å¼ŸèŠ‚ç‚¹æœ‰çº¢è‰²å­èŠ‚ç‚¹</p>
<p>æ­¤æ—¶å¯ä»¥é€šè¿‡æ—‹è½¬å’Œå˜è‰²æ¥ä¿è¯åˆ é™¤Råï¼Œå½“å‰å­æ ‘ä¾ç„¶æ˜¯é»‘è‰²èŠ‚ç‚¹å¹³è¡¡çš„ã€‚</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91%E5%88%A0%E9%99%A4-1.jpg" alt=""></p>
<p><strong>æƒ…å†µ3</strong>: å…„å¼ŸèŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œåˆ™çˆ¶äº²èŠ‚ç‚¹å¿…æ˜¯é»‘è‰²ï¼Œå…„å¼ŸèŠ‚ç‚¹å¿…æœ‰ä¸¤ä¸ªé»‘è‰²èŠ‚ç‚¹</p>
<p>æ­¤æ—¶ï¼Œå¯ä»¥é€šè¿‡æ—‹è½¬å˜è‰²å³å¯é‡æ–°è¾¾åˆ°å¹³è¡¡ã€‚</p>
</li>
</ol>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91%E5%88%A0%E9%99%A4-2.jpg" alt=""></p>
<p>ä»¥ä¸Šè®¨è®ºçš„æ˜¯å¾…åˆ é™¤èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹çš„æƒ…å†µï¼Œå¾…åˆ é™¤èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹çš„å¤„ç†æƒ…å†µåŒä¸Šï¼Œ åªæ˜¯æ“ä½œæ–¹å‘ç›¸åã€‚</p>
<p>åˆ é™¤æ“ä½œä¸­çš„è‡ªåº•å‘ä¸Šgifå‚è€ƒï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E7%BA%A2%E9%BB%91%E6%A0%91%E5%88%A0%E9%99%A4-%E8%87%AA%E5%BA%95%E5%90%91%E4%B8%8A%E5%A4%84%E7%90%86.gif" alt=""></p>
<p>å¦‚æœå¯¹çº¢é»‘æ ‘çš„æ’å…¥åˆ é™¤æƒ…å†µç†è§£æœ‰å›°éš¾å¯ä»¥å‚è€ƒ<a href="https://www.cs.usfca.edu/~galles/visualization/RedBlack.html" target="_blank" rel="noopener">çº¢é»‘æ ‘Virsualization</a>ã€‚</p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>javaæ²™ç®±</title>
    <url>/article/java%E6%B2%99%E7%AE%B1/</url>
    <content><![CDATA[<p>å‚è€ƒæ–‡æ¡£1ï¼š<a href="https://www.zybuluo.com/changedi/note/237999" target="_blank" rel="noopener">https://www.zybuluo.com/changedi/note/237999</a></p>
<p>å‚è€ƒæ–‡æ¡£2ï¼š<a href="https://benjaminwhx.com/2018/06/19/AccessController-doPrivileged/" target="_blank" rel="noopener">https://benjaminwhx.com/2018/06/19/AccessController-doPrivileged/</a></p>
<p>èµ·å› æ˜¯åœ¨å­¦ä¹ JDBCé©±åŠ¨åŠ è½½æœºåˆ¶(SPI-æ¥å£ä¸å®ç°åˆ†ç¦»ï¼Œå®ç°è§£è€¦ï¼Œå‚è€ƒæ–‡æ¡£ï¼š<a href="https://juejin.im/post/5b9b1c115188255c5e66d18c" target="_blank" rel="noopener">https://juejin.im/post/5b9b1c115188255c5e66d18c</a>)çš„æ—¶å€™ç¢°åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  drivers = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;String&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> System.getProperty(<span class="string">"jdbc.drivers"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">  drivers = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§æ„æ˜¯é€šè¿‡<code>ç‰¹æƒ</code>çš„æ–¹å¼çªç ´å½“å‰åŸŸæƒé™çš„é™åˆ¶ï¼Œä¸´æ—¶æ‰©å¤§è®¿é—®æƒé™ï¼Œè·å–ç³»ç»Ÿèµ„æºã€‚</p>
<p>è¿™æ˜¯ä¸ºäº†åœ¨å¼€å¯javaçš„æ²™ç®±æœºåˆ¶çš„ç¨‹åºä¸­è·å¾—æ‰§è¡Œä»£ç çš„æƒé™ã€‚javaæ²™ç®±æœºåˆ¶å‚è€ƒä»¥ä¸Šæ–‡æ¡£ä»‹ç»ã€‚</p>
<p>è¿è¡Œjavaç¨‹åºæ—¶é»˜è®¤æ˜¯ä¸å¼€å¯æ²™ç®±æœºåˆ¶çš„ï¼Œè¦å¼€å¯æ²™ç®±æœºåˆ¶åŠ å…¥å¯åŠ¨å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">-Djava.security.manager</span><br></pre></td></tr></table></figure>
<p>å¼€å¯æ²™ç®±æœºåˆ¶åï¼Œjavaçš„å®‰å…¨ç®¡ç†å™¨SecurityManagerå³èµ·ä½œç”¨äº†ï¼Œå®‰å…¨ç®¡ç†å™¨ä¼šå»è¯»ç­–ç•¥æ–‡ä»¶æ¥åˆ¤æ–­javaç±»çš„æ‰§è¡Œæƒé™ï¼Œé»˜è®¤çš„ç­–ç•¥æ–‡ä»¶<code>$JREHOME/lib/security/java.policy</code>ï¼Œå¯ä»¥å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šç­–ç•¥æ–‡ä»¶ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">-Djava.security.policy=xx.policy</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªåˆ›å»ºæ–‡ä»¶çš„ä¾‹å­æ¥è¯´æ˜å¼€å¯æ²™ç®±åçš„æƒé™éªŒè¯å’ŒAccessController.doPrivilegedçš„ç‰¹æƒä½œç”¨</p>
<blockquote>
<ol>
<li>vim FileUtil.java</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">package</span> com.leo.security;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="keyword">import</span> java.io.File;</span><br><span class="line">&gt; <span class="keyword">import</span> java.io.IOException;</span><br><span class="line">&gt; <span class="keyword">import</span> java.security.AccessControlException;</span><br><span class="line">&gt; <span class="keyword">import</span> java.security.AccessController;</span><br><span class="line">&gt; <span class="keyword">import</span> java.security.PrivilegedAction;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="comment">/**</span></span><br><span class="line"><span class="comment">&gt;  *</span></span><br><span class="line"><span class="comment">&gt;  */</span></span><br><span class="line">&gt; <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUtil</span> </span>&#123;</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String FOLDER_PATH = <span class="string">"/Users/qiaojian/Downloads/"</span>;</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">makeFile</span><span class="params">(String fileName)</span> </span>&#123;</span><br><span class="line">&gt;         <span class="keyword">try</span> &#123;</span><br><span class="line">&gt;             File fs = <span class="keyword">new</span> File(FOLDER_PATH + fileName);</span><br><span class="line">&gt;             fs.createNewFile();</span><br><span class="line">&gt;         &#125; <span class="keyword">catch</span> (AccessControlException | IOException e) &#123;</span><br><span class="line">&gt;             e.printStackTrace();</span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt;     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doPrivilegedAction</span><span class="params">(<span class="keyword">final</span> String fileName)</span> </span>&#123;</span><br><span class="line">&gt;         <span class="comment">// ç”¨ç‰¹æƒè®¿é—®æ–¹å¼åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line">&gt;         AccessController.doPrivileged( <span class="keyword">new</span> PrivilegedAction&lt;String&gt; () &#123;</span><br><span class="line">&gt;             <span class="meta">@Override</span></span><br><span class="line">&gt;             <span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&gt;                 makeFile(fileName);</span><br><span class="line">&gt;                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&gt;             &#125;</span><br><span class="line">&gt;         &#125;);</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="2">
<li>å°†æ­¤javaæ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªé¡¹ç›®jaråŒ…</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% mkdir target</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% javac FileUtil.java -d target</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% jar cvf file-util.jar -C target/ .</span><br><span class="line"><span class="meta">&gt;</span> #å°†æ­¤jaråŒ…æ”¾åˆ°libç›®å½•ä¸‹ä¾›å…¶ä»–é¡¹ç›®ä½¿ç”¨</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% mkdir lib</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% mv file-util.jar lib/</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="3">
<li>vim PrivilegeTest.java</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; <span class="keyword">package</span> com.leo.security;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="keyword">import</span> java.io.File;</span><br><span class="line">&gt; <span class="keyword">import</span> java.io.IOException;</span><br><span class="line">&gt; <span class="keyword">import</span> java.security.AccessControlException;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="comment">/**</span></span><br><span class="line"><span class="comment">&gt;  *</span></span><br><span class="line"><span class="comment">&gt;  */</span></span><br><span class="line">&gt; <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrivilegeTest</span> </span>&#123;</span><br><span class="line">&gt;     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">&gt;         System.out.println(<span class="string">"***************************************"</span>);</span><br><span class="line">&gt;         System.out.println(<span class="string">"I will show AccessControl functionality..."</span>);</span><br><span class="line">&gt; </span><br><span class="line">&gt;         System.out.println(<span class="string">"Preparation step : turn on system permission check..."</span>);</span><br><span class="line">&gt;         <span class="comment">// æ‰“å¼€ç³»ç»Ÿå®‰å…¨æƒé™æ£€æŸ¥å¼€å…³ï¼Œæ·»åŠ vm options: -Djava.security.manager</span></span><br><span class="line">&gt;         <span class="comment">// ä½¿ç”¨ç‰¹å®špolicyï¼Œæ·»åŠ vm options: -Djava.security.policy=privilegetest.policy</span></span><br><span class="line">&gt;         System.out.println();</span><br><span class="line">&gt; </span><br><span class="line">&gt;         System.out.println(<span class="string">"#########################################"</span>);</span><br><span class="line">&gt;         System.out.println(<span class="string">"Create a new file named privilege1.txt via privileged action ..."</span>);</span><br><span class="line">&gt;         FileUtil.doPrivilegedAction(<span class="string">"privilege1.txt"</span>);</span><br><span class="line">&gt;         System.out.println(<span class="string">"#########################################"</span>);</span><br><span class="line">&gt; </span><br><span class="line">&gt;         System.out.println();</span><br><span class="line">&gt; </span><br><span class="line">&gt;         System.out.println(<span class="string">"/////////////////////////////////////////"</span>);</span><br><span class="line">&gt;         System.out.println(<span class="string">"Create a new file named privilege2.txt via File ..."</span>);</span><br><span class="line">&gt;         <span class="keyword">try</span> &#123;</span><br><span class="line">&gt;             File fs = <span class="keyword">new</span> File (</span><br><span class="line">&gt;                     <span class="string">"/Users/qiaojian/Downloads/privilege2.txt"</span>);</span><br><span class="line">&gt;             fs.createNewFile();</span><br><span class="line">&gt;         &#125; <span class="keyword">catch</span> (IOException | AccessControlException e) &#123;</span><br><span class="line">&gt;             e.printStackTrace();</span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt;         System.out.println(<span class="string">"/////////////////////////////////////////"</span>);</span><br><span class="line">&gt;         System.out.println();</span><br><span class="line">&gt; </span><br><span class="line">&gt;         System.out.println(<span class="string">"-----------------------------------------"</span>);</span><br><span class="line">&gt;         System.out.println(<span class="string">"create a new file named privilege3.txt via FileUtil ..."</span>);</span><br><span class="line">&gt;         FileUtil.makeFile(<span class="string">"privilege3.txt"</span>);</span><br><span class="line">&gt;         System.out.println(<span class="string">"-----------------------------------------"</span>);</span><br><span class="line">&gt;         System.out.println();</span><br><span class="line">&gt; </span><br><span class="line">&gt;         System.out.println(<span class="string">"***************************************"</span>);</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="4">
<li>å°†æ­¤javaæ–‡ä»¶æ‰“åŒ…æˆå¦ä¸€ä¸ªé¡¹ç›®jaråŒ…</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span> #æ¸…ç©ºtargetç›®å½•ï¼Œé‡æ–°ç¼–è¯‘PrivilegeTest.java</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% cd target;  </span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% rm -rf *;</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% cd ..</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% javac -cp lib/file-util.jar PrivilegeTest.java -d target</span><br><span class="line"><span class="meta">&gt;</span> #æ‰“åŒ…å¹¶æŒ‡å®šMain-Classæ‰€åœ¨ç±»</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% jar cvfe privilege-test.jar com.leo.security.PrivilegeTest -C target/ .</span><br><span class="line"><span class="meta">&gt;</span> #ä¿®æ”¹META-INF/MANIFEST.MFï¼Œæ·»åŠ Class-Path: lib/file-util.jar</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% vim privilege-test.jar</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="5">
<li>ç¼–è¾‘è‡ªå®šä¹‰ç­–ç•¥æ–‡ä»¶ï¼Œæˆæƒåªæœ‰é¡¹ç›®file-util.jarå¯ä»¥å†™æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% vim privilegetest.policy</span><br><span class="line"><span class="meta">&gt;</span> [qiaojian@MacÂ securityÂ ]% cat privilegetest.policy                                         [0]</span><br><span class="line"><span class="meta">&gt;</span> grant codeBase "file:/Users/qiaojian/Downloads/Test/testmybatis/src/main/java/com/leo/security/lib/-" &#123;</span><br><span class="line"><span class="meta">&gt;</span>     permission java.io.FilePermission "/Users/qiaojian/Downloads/*", "write";</span><br><span class="line"><span class="meta">&gt;</span> &#125;;</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<ol start="6">
<li>è¿è¡Œç¨‹åºï¼ŒæŒ‡å®šå¼€å¯æ²™ç®±æœºåˆ¶ï¼ŒæŒ‡å®šç­–ç•¥æ–‡ä»¶</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; java -Djava.security.manager -Djava.security.policy=privilegetest.policy -jar privilege-test.jar</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>ä»è¾“å‡ºå¯è§ï¼Œé¡¹ç›®privilege-test.jaråªæœ‰é€šè¿‡AccessController.doPrivileged æ–¹å¼æ‰å¯ä»¥æˆåŠŸåˆ›å»ºæ–‡ä»¶privilege1.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; ***************************************</span><br><span class="line">&gt; I will show AccessControl functionality...</span><br><span class="line">&gt; Preparation step : turn on system permission check...</span><br><span class="line">&gt; </span><br><span class="line">&gt; #########################################</span><br><span class="line">&gt; Create a new file named privilege1.txt via privileged action ...</span><br><span class="line">&gt; #########################################</span><br><span class="line">&gt; </span><br><span class="line">&gt; /////////////////////////////////////////</span><br><span class="line">&gt; Create a new file named privilege2.txt via File ...</span><br><span class="line">&gt; java.security.AccessControlException: access denied (&quot;java.io.FilePermission&quot; &quot;/Users/qiaojian/Downloads/privilege2.txt&quot; &quot;write&quot;)</span><br><span class="line">&gt; 	at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)</span><br><span class="line">&gt; 	at java.security.AccessController.checkPermission(AccessController.java:884)</span><br><span class="line">&gt; 	at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)</span><br><span class="line">&gt; 	at java.lang.SecurityManager.checkWrite(SecurityManager.java:979)</span><br><span class="line">&gt; 	at java.io.File.createNewFile(File.java:1008)</span><br><span class="line">&gt; 	at com.leo.security.PrivilegeTest.main(PrivilegeTest.java:31)</span><br><span class="line">&gt; /////////////////////////////////////////</span><br><span class="line">&gt; </span><br><span class="line">&gt; -----------------------------------------</span><br><span class="line">&gt; create a new file named privilege3.txt via FileUtil ...</span><br><span class="line">&gt; java.security.AccessControlException: access denied (&quot;java.io.FilePermission&quot; &quot;/Users/qiaojian/Downloads/privilege3.txt&quot; &quot;write&quot;)</span><br><span class="line">&gt; 	at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)</span><br><span class="line">&gt; 	at java.security.AccessController.checkPermission(AccessController.java:884)</span><br><span class="line">&gt; 	at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)</span><br><span class="line">&gt; 	at java.lang.SecurityManager.checkWrite(SecurityManager.java:979)</span><br><span class="line">&gt; 	at java.io.File.createNewFile(File.java:1008)</span><br><span class="line">&gt; 	at com.leo.security.FileUtil.makeFile(FileUtil.java:19)</span><br><span class="line">&gt; 	at com.leo.security.PrivilegeTest.main(PrivilegeTest.java:40)</span><br><span class="line">&gt; -----------------------------------------</span><br><span class="line">&gt; </span><br><span class="line">&gt; ***************************************</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <tags>
        <tag>AccessController.doPrivileged</tag>
      </tags>
  </entry>
  <entry>
    <title>javaçº¿ä¸Šå®æ—¶debugåˆ©å™¨</title>
    <url>/article/java%E7%BA%BF%E4%B8%8A%E5%AE%9E%E6%97%B6debug%E5%88%A9%E5%99%A8/</url>
    <content><![CDATA[<h2 id="btrace">BTrace</h2>
<p>BTraceå¯ç”¨äºåŠ¨æ€è·Ÿè¸ªæ­£åœ¨è¿è¡Œçš„Javaç¨‹åºã€‚BTraceå®˜ç½‘ï¼š<a href="https://github.com/btraceio/btrace" target="_blank" rel="noopener">https://github.com/btraceio/btrace</a></p>
<h3 id="å®‰è£…">å®‰è£…</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ä¸‹è½½å®‰è£…åŒ…</span><br><span class="line">wget https://github.com/btraceio/btrace/releases/download/v1.3.11.3/btrace-bin-1.3.11.3.tgz</span><br><span class="line">#è§£å‹</span><br><span class="line">tar -xzvf btrace-bin-1.3.11.3.tgz</span><br><span class="line">#æ·»åŠ PATHå’ŒJAVA_HOMEç¯å¢ƒå˜é‡</span><br><span class="line">vim ~/.bashrc</span><br><span class="line">export PATH=$PATH:/root/btrace/bin</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.222.b10-0.el7_6.x86_64</span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™btraceè„šæœ¬">ç¼–å†™BTraceè„šæœ¬</h3>
<p>BTraceè„šæœ¬æ˜¯çº¯javaä»£ç ï¼Œä¸»è¦ä½¿ç”¨BTraceæä¾›çš„å·¥å…·btrace.BTraceUtilså’Œæ³¨è§£btrace.annotationsæ¥å®ç°å¯¹ç›‘æ§å¯¹è±¡çš„å®æ—¶æ‰“å°ç»Ÿè®¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import com.sun.btrace.annotations.*;</span><br><span class="line">import static com.sun.btrace.BTraceUtils.*;</span><br><span class="line"></span><br><span class="line">@BTrace</span><br><span class="line">public class V2RTrace &#123;</span><br><span class="line">        @OnMethod(</span><br><span class="line">            clazz=&quot;com.serverbase.controller.V2RForClientController&quot;,</span><br><span class="line">            method=&quot;sendSms&quot;,</span><br><span class="line">            location=@Location(Kind.RETURN)</span><br><span class="line">    )</span><br><span class="line">    public static void traceExecute(String mobile , @Return Object result)&#123;</span><br><span class="line">        println(&quot;call V2RForClientController.&quot;);</span><br><span class="line">        println(strcat(&quot;param mobile is:&quot;,(mobile)));</span><br><span class="line">        println(strcat(&quot;return status is:&quot;,str(get(field(&quot;com.serverbase.common.dto.ServerReturn&quot;, &quot;status&quot;), result))));</span><br><span class="line">        println(strcat(&quot;return msg is:&quot;,str(get(field(&quot;com.serverbase.common.dto.ServerReturn&quot;, &quot;msg&quot;), result))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¿è¡Œbtrace">è¿è¡Œbtrace</h3>
<p>btraceè¿è¡Œå‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<blockquote>
<p>btrace -cp /root/btrace/build  -p 16111 4634 ./V2RTrace.java</p>
</blockquote>
<p>-cp æŒ‡å®šclasspathåŒ…å«btraceçš„jaråŒ…è·¯å¾„</p>
<p>-p æŒ‡å®šbtraceè¿è¡Œçš„ç«¯å£</p>
<p>4634 è¢«ç›‘æ§çš„Javaè¿›ç¨‹å·</p>
<p>V2RTrace.java btraceç›‘æ§è„šæœ¬javaä»£ç æ–‡ä»¶</p>
<p>ç›‘æ§æ•ˆæœå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/btrace-run.jpg" alt=""></p>
<h2 id="arthas">Arthas</h2>
<p>Arthas å¯ä»¥è¯´æ˜¯BTraceçš„è¿›é˜¶ç‰ˆï¼Œæä¾›äº†æ“ä½œæ›´æ–¹ä¾¿çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œä¸éœ€è¦å†ç¼–å†™è„šæœ¬ï¼Œé€šè¿‡Arthasæä¾›çš„å‘½ä»¤å³å¯å®ç°åœ¨çº¿debugã€‚ä½¿ç”¨æ–¹å¼è¯¦è§å®˜ç½‘ï¼š<a href="https://github.com/alibaba/arthas" target="_blank" rel="noopener">https://github.com/alibaba/arthas</a></p>
<p>å®è·µä¸­<strong>è¿œç¨‹debug</strong>æäº†å¥½ä¹…ï¼Œä»¥å…è¸©å‘è®°å½•ä¸€ä¸‹ã€‚</p>
<blockquote>
<p>ä¸€é”®è„šæœ¬å®‰è£…arthas</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -L https://alibaba.github.io/arthas/install.sh | sh</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¿®æ”¹as.shè„šæœ¬ï¼Œè®©æ‰§è¡Œas.shè„šæœ¬æ—¶ï¼Œåªattachï¼Œä¸è¿›å…¥äº¤äº’debugç•Œé¢</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># target process id to attach</span><br><span class="line"># æ­¤é»˜è®¤é…ç½®è¡¨ç¤ºarthas serveråªå…è®¸æœ¬æœºå¯è®¿é—®ï¼Œè¦å…è®¸è¿œç¨‹debugï¼Œä¿®æ”¹ä¸ºï¼š0.0.0.0</span><br><span class="line">TARGET_IP=&quot;127.0.0.1&quot;</span><br><span class="line"></span><br><span class="line"># telnet port</span><br><span class="line"># æ­¤é»˜è®¤é…ç½®è¡¨ç¤ºarthas server telnetç«¯å£ä¸º3685</span><br><span class="line">TELNET_PORT=&quot;3658&quot;</span><br><span class="line"></span><br><span class="line"># http port</span><br><span class="line">#æ­¤é»˜è®¤é…ç½®è¡¨ç¤ºarthas server httpç«¯å£ä¸º8563</span><br><span class="line">HTTP_PORT=&quot;8563&quot;</span><br><span class="line"># attach only, do not telnet connect</span><br><span class="line">#æ­¤é…ç½®é»˜è®¤ä¸ºfalseï¼Œæ”¹ä¸ºtrueè¡¨ç¤ºæ‰§è¡Œas.shè„šæœ¬æ—¶ï¼Œåªattach java processï¼Œä¸è¿›å…¥äº¤äº’debugç•Œé¢</span><br><span class="line">ATTACH_ONLY=true</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯åŠ¨arthas serverï¼Œattachè¦debug çš„javaè¿›ç¨‹</p>
</blockquote>
<p><a href="http://as.sh" target="_blank" rel="noopener">as.sh</a> PID</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@qiaojian ~]# as.sh 32431</span><br><span class="line">Arthas script version: 3.1.1</span><br><span class="line">[INFO] JAVA_HOME: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.222.b10-0.el7_6.i386</span><br><span class="line">Arthas home: /root/.arthas/lib/3.1.1/arthas</span><br><span class="line">Calculating attach execution time...</span><br><span class="line">Attaching to 32431 using version /root/.arthas/lib/3.1.1/arthas...</span><br><span class="line"></span><br><span class="line">real    0m1.109s</span><br><span class="line">user    0m0.200s</span><br><span class="line">sys     0m0.025s</span><br><span class="line">Attach success.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿œç¨‹telnetè¿æ¥</p>
</blockquote>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/arthas-telnet-remote.jpg" alt=""></p>
<blockquote>
<p>è¿œç¨‹httpè¿æ¥</p>
</blockquote>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/arthas-http-remote.jpg" alt=""></p>
]]></content>
      <tags>
        <tag>btrace</tag>
      </tags>
  </entry>
  <entry>
    <title>Controller_vs_RestController</title>
    <url>/article/Controller-vs-RestController/</url>
    <content><![CDATA[<p>Controlleræ³¨è§£ è¿”å›å€¼ç±»å‹ï¼š</p>
<ol>
<li>ModelAndView<br>
é¡µé¢å’Œæ•°æ®æ•´åˆçš„ç±»å‹ï¼Œä½¿ç”¨æ¨¡ç‰ˆå¼•æ“æ—¶å¯ä½¿ç”¨è¿™ç§æ–¹å¼</li>
<li>void<br>
æ­¤æ—¶ï¼Œå¯ä»¥è¿›è¡Œforwardè½¬å‘ï¼Œrequest.getRequestDispatcher(â€œforwardUrlâ€).forward(request, response)ï¼ˆé¡µé¢urlä¸å˜ï¼‰<br>
ä¹Ÿå¯ä»¥è¿›è¡Œredirecté‡å®šå‘ï¼Œresponse.sendRedirect(â€œredirectUrlâ€) (é¡µé¢urlä¼šè·³è½¬)<br>
è¿˜å¯ä»¥é€šè¿‡response.getWriter.write()ç›´æ¥è¿”å›é¡µé¢æ•°æ®</li>
<li>String<br>
Controlleræ³¨è§£ä¸‹ï¼Œè¿”å›å­—ç¬¦ä¸²é»˜è®¤æ˜¯é€»è¾‘è§†å›¾åç§°ï¼ŒåŠŸèƒ½åŒè¿”å›ModelAndView<br>
ä¹Ÿå¯ä»¥è¿›è¡Œredirecté‡å®šå‘ï¼Œresponse.sendRedirect(â€œredirectUrlâ€) (é¡µé¢urlä¼šè·³è½¬)ï¼Œæ­¤æ—¶è¿”å›å€¼æ— ç”¨<br>
è¿˜å¯ä»¥è¿›è¡Œforwardè½¬å‘ï¼Œrequest.getRequestDispatcher(â€œforwardUrlâ€).forward(request, response)ï¼ˆé¡µé¢urlä¸å˜ï¼‰ï¼Œæ­¤æ—¶è¿”å›å€¼æ— ç”¨</li>
<li>ä»»æ„æ•°æ®ç±»å‹ + ResponseBodyæ³¨è§£<br>
æ­¤æ—¶å°†è¿”å›å€¼æŒ‰ç…§è¿”å›ç±»å‹è¿›è¡Œjsonè§£æï¼Œå¹¶è¿”å›jsonæ•°æ®</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(path = <span class="string">"/hehe"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"test"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(@RequestParam String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"HELLO "</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"testvoid"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testVoid</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                         HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                         @RequestParam String name)</span> </span>&#123;</span><br><span class="line">        response.setCharacterEncoding ( <span class="string">"utf-8"</span> );</span><br><span class="line">        response.setContentType ( <span class="string">"application/json; charset=utf-8"</span> );</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.getWriter ().write ( <span class="string">"response write data: "</span> + name );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"redirect1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">redirect1</span><span class="params">(@RequestParam String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:test?name="</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"redirect2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">redirect2</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                           HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                           @RequestParam String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.sendRedirect ( <span class="string">"/hehe/test?name="</span> + name );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"redirect3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedirectView <span class="title">redirect3</span><span class="params">(@RequestParam String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedirectView ( <span class="string">"/hehe/test?name="</span> + name );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"forward1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  String <span class="title">forward1</span><span class="params">(@RequestParam String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"forward:test"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"forward2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forward2</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">            @RequestParam String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">             request.getRequestDispatcher ( <span class="string">"/hehe/test"</span> )</span><br><span class="line">                    .forward ( request, response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RestControlleræ³¨è§£ ç›¸å½“äº Controlleræ³¨è§£ + ResponseBodyæ³¨è§£ï¼Œä¼šå¯¹è¿”å›å€¼è¿›è¡ŒJSONåŒ–å¤„ç†å¹¶ç›´æ¥è¿”å›æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestRestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/rest"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashMap (  );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>æ³¨è§£</tag>
      </tags>
  </entry>
  <entry>
    <title>javaé›†åˆ-ArrayDeque</title>
    <url>/article/java%E9%9B%86%E5%90%88-ArrayDeque/</url>
    <content><![CDATA[<h3 id="ç±»å›¾ç»“æ„">ç±»å›¾ç»“æ„</h3>
<p>ArrayDequeæ˜¯Dequeæ¥å£çš„åŸºäºå¯å˜å¤§å°æ•°ç»„å®ç°ç±»ã€‚å®ƒçš„ç±»å±‚çº§ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/ArrayDeque%E7%B1%BB%E5%9B%BE%E7%BB%93%E6%9E%84.jpg" alt=""></p>
<h3 id="ç±»æ–‡ä»¶è¯´æ˜">ç±»æ–‡ä»¶è¯´æ˜</h3>
<p>ArrayDequeå’ŒArrayListä¸€æ ·åº•å±‚å®ç°æ˜¯åŠ¨æ€æ•°ç»„ï¼Œæ²¡æœ‰å®¹é‡é™åˆ¶ï¼Œå¯ä»¥åŠ¨æ€æ‰©å®¹ã€‚ArrayDequeæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚<strong>ArrayDequeä¸æ”¯æŒæ’å…¥nullå…ƒç´ </strong>ã€‚ArrayDequeå¯ä»¥æä¾›Stackä¸€æ ·çš„æ“ä½œï¼Œä½†æ˜¯æ¯”Stackæ›´å¿«ï¼Œå› ä¸ºStackåŠ äº†åŒæ­¥é”synchronizedã€‚</p>
<p>ArrayDequeçš„iteratoræ˜¯fail-fastæ¨¡å¼çš„ã€‚å½“è¿”å›iteratoråï¼Œä»»ä½•ä¸æ˜¯é€šè¿‡iteratorè‡ªå·±çš„ä¿®æ”¹å‡½æ•°å¯¹ArrayDequeçš„ä¿®æ”¹éƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ConcurrentModificationExceptionã€‚</p>
<p>ArrayDequeåº•å±‚æ•°æ®ç±»å‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„</span></span><br><span class="line"><span class="keyword">transient</span> Object[] elements; </span><br><span class="line"><span class="comment">// æŒ‡å‘åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨index</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> head;</span><br><span class="line"><span class="comment">// æŒ‡å‘åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨index</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> tail;</span><br></pre></td></tr></table></figure>
<h3 id="æ„é€ å‡½æ•°">æ„é€ å‡½æ•°</h3>
<p>ArrayDequeæœ‰ä¸‰ä¸ªæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤åŠ¨æ€æ•°ç»„åˆå§‹å®¹é‡ä¸º16</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayDeque</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  elements = <span class="keyword">new</span> Object[<span class="number">16</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¾å¼ä¼ å…¥å…ƒç´ ä¸ªæ•°ï¼Œä½†æ˜¯allocateElementså‡½æ•°ä¼šå¯¹å…ƒç´ ä¸ªæ•°è¿›è¡Œå‘ä¸Šå–2çš„å¹‚æ¬¡æ–¹</span></span><br><span class="line"><span class="comment">// æ¯”å¦‚ä¼ å…¥28ï¼Œå®é™…åˆå§‹å®¹é‡ä¼šæ˜¯32</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayDeque</span><span class="params">(<span class="keyword">int</span> numElements)</span> </span>&#123;</span><br><span class="line">  allocateElements(numElements);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æŒ‡å®šé›†åˆåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// é¦–å…ˆæ ¹æ®é›†åˆçš„å®¹é‡å’ŒallocateElementså‡½æ•°ç¡®å®šArrayDequeçš„åˆå§‹å®¹é‡</span></span><br><span class="line"><span class="comment">// addAllä¼šä»å°¾ç«¯tailæ·»åŠ é›†åˆé‡Œçš„å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayDeque</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">  allocateElements(c.size());</span><br><span class="line">  addAll(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="addfirst">addFirst</h3>
<p>addFirstä»åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨headæ·»åŠ å…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFirst</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¸æ”¯æŒnullå…ƒç´ </span></span><br><span class="line">  <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–å®Œæˆï¼šhead == tail == 0</span></span><br><span class="line">  <span class="comment">// å‡è®¾åˆå§‹å®¹é‡ä¸º16: åˆ™:</span></span><br><span class="line">  <span class="comment">// head = (head - 1) &amp; (elements.length - 1)</span></span><br><span class="line">  <span class="comment">// head = -1 &amp; 15 </span></span><br><span class="line">  <span class="comment">// head = 15</span></span><br><span class="line">  <span class="comment">// å°†å…ƒç´ æ’å…¥æ•°ç»„æœ€æœ«å°¾ä½ç½®ï¼Œheadä¹Ÿç›¸åº”æŒ‡å‘æ•°ç»„æœ€æœ«å°¾ä½ç½®</span></span><br><span class="line">  elements[head = (head - <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)] = e;</span><br><span class="line">  <span class="comment">// æ­¤æ—¶ head == 15, tail == 0ï¼Œä¸éœ€è¦æ‰©å®¹</span></span><br><span class="line">  <span class="keyword">if</span> (head == tail)</span><br><span class="line">    doubleCapacity();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ·»åŠ å…ƒç´ é€”ä¸­ä»…å½“æ•°ç»„æ»¡äº†çš„æ—¶å€™ï¼ˆhead == tailï¼‰æ‰è¿›è¡Œæ‰©å®¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doubleCapacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> head == tail;</span><br><span class="line">  <span class="comment">// è·å–æ­¤æ—¶å¤´éƒ¨ç´¢å¼•ä½ç½®</span></span><br><span class="line">  <span class="keyword">int</span> p = head;</span><br><span class="line">  <span class="keyword">int</span> n = elements.length;</span><br><span class="line">  <span class="comment">// è·å–æ­¤æ—¶å¤´éƒ¨ç´¢å¼•ä½ç½®åˆ°æ•°ç»„æœ«ç«¯å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">int</span> r = n - p; <span class="comment">// number of elements to the right of p</span></span><br><span class="line">  <span class="comment">// æ‰©å®¹ä¸¤å€</span></span><br><span class="line">  <span class="keyword">int</span> newCapacity = n &lt;&lt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Sorry, deque too big"</span>);</span><br><span class="line">  Object[] a = <span class="keyword">new</span> Object[newCapacity];</span><br><span class="line">  <span class="comment">// é¦–å…ˆæ‹·è´åŸå¤´éƒ¨ç´¢å¼•ä½ç½®åˆ°æ•°ç»„æœ«ç«¯çš„å…ƒç´ åˆ°æ–°æ•°ç»„</span></span><br><span class="line">  System.arraycopy(elements, p, a, <span class="number">0</span>, r);</span><br><span class="line">  <span class="comment">// å†æ‹·è´åŸæ•°ç»„é¦–éƒ¨åˆ°å¤´éƒ¨ç´¢å¼•ä½ç½®å…ƒç´ åˆ°æ–°æ•°ç»„</span></span><br><span class="line">  System.arraycopy(elements, <span class="number">0</span>, a, r, p);</span><br><span class="line">  elements = a;</span><br><span class="line">  head = <span class="number">0</span>;</span><br><span class="line">  tail = n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰©å®¹å‰åç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p>æ‰©å®¹å‰ï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/ArrayDeque-full.jpg" alt=""></p>
<p>æ‰©å®¹åï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/ArrayDeque-newCap.jpg" alt=""></p>
<h3 id="addlast">addLast</h3>
<p>addFirstä»åŒç«¯é˜Ÿåˆ—çš„å°¾éƒ¨tailæ·»åŠ å…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLast</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¸æ”¯æŒnullå…ƒç´ </span></span><br><span class="line">  <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">  <span class="comment">// ç›´æ¥èµ‹å€¼åˆ°tailç´¢å¼•æ‰€åœ¨çš„ä½ç½®</span></span><br><span class="line">  <span class="comment">// å¯çŸ¥tailæ˜¯æŒ‡å‘å°¾éƒ¨å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®</span></span><br><span class="line">  elements[tail] = e;</span><br><span class="line">  <span class="comment">// ç„¶åå°†å°¾éƒ¨ç´¢å¼•tailåŠ 1</span></span><br><span class="line">  <span class="comment">// åˆ¤æ–­tail == headæ—¶æ‰©å®¹</span></span><br><span class="line">  <span class="keyword">if</span> ( (tail = (tail + <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)) == head)</span><br><span class="line">    doubleCapacity();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="get">get</h3>
<p>getFirstä»åŒç«¯é˜Ÿåˆ—å¤´éƒ¨è·å–å…ƒç´ ï¼ŒgetLastä»åŒç«¯é˜Ÿåˆ—å°¾éƒ¨è·å–å…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">getFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="comment">// ä»å¤´éƒ¨è·å–å…ƒç´ ï¼Œç›´æ¥è¿”å›headç´¢å¼•æ‰€åœ¨ä½ç½®çš„å…ƒç´ </span></span><br><span class="line">  E result = (E) elements[head];</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">getLast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  <span class="comment">// ä»å°¾éƒ¨è·å–å…ƒç´ </span></span><br><span class="line">  <span class="comment">// é¦–å…ˆå°†tail - 1</span></span><br><span class="line">  <span class="comment">// ç„¶åè¿”å›tail - 1ç´¢å¼•æ‰€åœ¨ä½ç½®çš„å…ƒç´ </span></span><br><span class="line">  E result = (E) elements[(tail - <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>)];</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="remove">remove</h3>
<p>removeé»˜è®¤ä»å¤´èŠ‚ç‚¹åˆ é™¤å…ƒç´ ï¼Œç„¶åå°†headæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> removeFirst();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">removeFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  E x = pollFirst();</span><br><span class="line">  <span class="keyword">if</span> (x == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">  <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">pollFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> h = head;</span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">  E result = (E) elements[h];</span><br><span class="line">  <span class="comment">// Element is null if deque empty</span></span><br><span class="line">  <span class="keyword">if</span> (result == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">//å°†åˆ é™¤çš„åŸheadç´¢å¼•ä½ç½®çš„å…ƒç´ ç½®ä¸ºnull</span></span><br><span class="line">  elements[h] = <span class="keyword">null</span>;     <span class="comment">// Must null out slot</span></span><br><span class="line">  <span class="comment">// å°†headç´¢å¼•åç§»ä¸€ä¸ªä½ç½®</span></span><br><span class="line">  head = (h + <span class="number">1</span>) &amp; (elements.length - <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>remove(Object o)æŒ‡å®šçš„å…ƒç´ é»˜è®¤åˆ é™¤ä»headç´¢å¼•å¼€å§‹æŸ¥æ‰¾ç¬¬ä¸€æ¬¡å‡ºç°çš„å…ƒç´ ï¼Œå¦‚ä¸‹å¯çŸ¥åˆ é™¤æŒ‡å®šå…ƒç´ ï¼Œéœ€è¦é‡æ–°æ‹·è´å…ƒç´ ï¼Œæ˜¯å¾ˆè€—æ€§èƒ½çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> removeFirstOccurrence(o);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeFirstOccurrence</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¸æ”¯æŒnullå…ƒç´ </span></span><br><span class="line">  <span class="keyword">if</span> (o == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">int</span> mask = elements.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> i = head;</span><br><span class="line">  Object x;</span><br><span class="line">  <span class="comment">// ä»headç´¢å¼•ä½ç½®å¼€å§‹æŸ¥æ‰¾</span></span><br><span class="line">  <span class="keyword">while</span> ( (x = elements[i]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (o.equals(x)) &#123;</span><br><span class="line">      <span class="comment">//ç¬¬ä¸€æ¬¡å‡ºç°å³åˆ é™¤</span></span><br><span class="line">      delete(i);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    i = (i + <span class="number">1</span>) &amp; mask;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">  checkInvariants();</span><br><span class="line">  <span class="keyword">final</span> Object[] elements = <span class="keyword">this</span>.elements;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> mask = elements.length - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> h = head;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> t = tail;</span><br><span class="line">  <span class="comment">// frontè¡¨ç¤ºå¾…åˆ é™¤å…ƒç´ åˆ°headç´¢å¼•ä½ç½®çš„è·ç¦»</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> front = (i - h) &amp; mask;</span><br><span class="line">  <span class="comment">// backè¡¨ç¤ºå¾…åˆ é™¤å…ƒç´ åˆ°tailç´¢å¼•ä½ç½®çš„è·ç¦»</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> back  = (t - i) &amp; mask;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Invariant: head &lt;= i &lt; tail mod circularity</span></span><br><span class="line">  <span class="keyword">if</span> (front &gt;= ((t - h) &amp; mask))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Optimize for least element motion</span></span><br><span class="line">  <span class="comment">// æ¯”è¾ƒfrontã€backçš„å¤§å°ï¼Œå‡å°‘ä¸å¿…è¦copyçš„å…ƒç´ </span></span><br><span class="line">  <span class="keyword">if</span> (front &lt; back) &#123;</span><br><span class="line">    <span class="keyword">if</span> (h &lt;= i) &#123;</span><br><span class="line">      System.arraycopy(elements, h, elements, h + <span class="number">1</span>, front);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// Wrap around</span></span><br><span class="line">      System.arraycopy(elements, <span class="number">0</span>, elements, <span class="number">1</span>, i);</span><br><span class="line">      elements[<span class="number">0</span>] = elements[mask];</span><br><span class="line">      System.arraycopy(elements, h, elements, h + <span class="number">1</span>, mask - h);</span><br><span class="line">    &#125;</span><br><span class="line">    elements[h] = <span class="keyword">null</span>;</span><br><span class="line">    head = (h + <span class="number">1</span>) &amp; mask;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &lt; t) &#123; <span class="comment">// Copy the null tail as well</span></span><br><span class="line">      System.arraycopy(elements, i + <span class="number">1</span>, elements, i, back);</span><br><span class="line">      tail = t - <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// Wrap around</span></span><br><span class="line">      System.arraycopy(elements, i + <span class="number">1</span>, elements, i, mask - i);</span><br><span class="line">      elements[mask] = elements[<span class="number">0</span>];</span><br><span class="line">      System.arraycopy(elements, <span class="number">1</span>, elements, <span class="number">0</span>, t);</span><br><span class="line">      tail = (t - <span class="number">1</span>) &amp; mask;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>é›†åˆ ArrayDeque</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitæ‰‹å†Œ</title>
    <url>/article/Git%E6%89%8B%E5%86%8C/</url>
    <content><![CDATA[<h2 id="gitåŸºç¡€">GitåŸºç¡€</h2>
<ol>
<li>
<p>ä»€ä¹ˆæ˜¯ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼ˆVCSï¼‰ï¼Ÿ</p>
<p>è®°å½•æ–‡ä»¶çš„å˜åŒ–çŠ¶æ€ï¼Œä»¥ä¾¿æŸ¥é˜…ç‰¹å®šèŠ‚ç‚¹çš„æ–‡ä»¶å’Œå¯¹ç‰¹å®šèŠ‚ç‚¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚</p>
</li>
<li>
<p>é›†ä¸­åŒ–çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ</p>
<p>ä¾‹å¦‚SVNï¼ŒPerforceç­‰ï¼Œä»¥C/Sçš„æ–¹å¼è¿›è¡Œå·¥ä½œï¼ŒæœåŠ¡å™¨éƒ¨ç½²åœ¨è¿œç«¯ï¼Œè®°å½•äº†æ‰€æœ‰çš„ç‰ˆæœ¬å†å²å’ŒçŠ¶æ€ï¼Œå®¢æˆ·ç«¯å¯ä»¥ä»æœåŠ¡å™¨æ‹‰å–æŸä¸ªç‰¹å®šèŠ‚ç‚¹çš„å¿«ç…§ï¼Œå¹¶ä½œä¿®æ”¹å’Œæäº¤ã€‚æœ€å¤§çš„ç‰¹ç‚¹æ˜¯ï¼šå®¢æˆ·ç«¯åªæ‹‰å–åˆ°ç‰¹å®šèŠ‚ç‚¹çš„å¿«ç…§ï¼Œä¸åŒ…å«æ•´ä¸ªé¡¹ç›®çš„ç‰ˆæœ¬å†å²å’ŒçŠ¶æ€ã€‚</p>
</li>
<li>
<p>åˆ†å¸ƒå¼çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ</p>
<p>ä¾‹å¦‚Gitï¼ŒMercurialç­‰ï¼ŒåŒæ ·ä»¥C/Sçš„æ–¹å¼å·¥ä½œï¼Œä½†æ˜¯å®¢æˆ·ç«¯æ‹‰å–åˆ°çš„ä¸æ˜¯å¯¹æŸä¸ªèŠ‚ç‚¹çš„å¿«ç…§ï¼Œè€Œæ˜¯å¯¹æ•´ä¸ªé¡¹ç›®çš„å®Œæ•´çš„å…‹éš†ï¼ŒåŒ…å«äº†æ•´ä¸ªé¡¹ç›®çš„ç‰ˆæœ¬å†å²å’ŒçŠ¶æ€ã€‚æœ€å¤§çš„ç‰¹ç‚¹ï¼šæ–¹ä¾¿çµæ´»ï¼Œç”±äºæ¯ä¸ªå®¢æˆ·ç«¯æ‹‰å–åˆ°çš„éƒ½æ˜¯å®Œæ•´çš„ä»£ç å¤‡ä»½ï¼Œå› æ­¤å¯ä»¥å¤šäººåˆ†å°ç»„è¿›è¡Œåä½œï¼ŒæŒ‡å®šä¸åŒçš„å·¥ä½œæµã€‚</p>
</li>
<li>
<p>Gitçš„å·¥ä½œåŸç†</p>
<p>Gitåªå…³å¿ƒæ–‡ä»¶æ•°æ®çš„æ•´ä½“æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œä¸ä¿å­˜æ–‡ä»¶çš„å·®å¼‚ã€‚Git æ›´åƒæ˜¯æŠŠå˜åŒ–çš„æ–‡ä»¶ä½œå¿«ç…§åï¼Œè®°å½•åœ¨ä¸€ä¸ªå¾®å‹çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ¯æ¬¡æäº¤æ›´æ–°æ—¶ï¼Œå®ƒä¼šçºµè§ˆä¸€éæ‰€æœ‰æ–‡ä»¶çš„æŒ‡çº¹ä¿¡æ¯ï¼ˆSHAï¼‰å¹¶å¯¹æ–‡ä»¶ä½œä¸€å¿«ç…§ï¼Œç„¶åä¿å­˜ä¸€ä¸ªæŒ‡å‘è¿™æ¬¡å¿«ç…§çš„ç´¢å¼•ã€‚ä¸ºæé«˜æ€§èƒ½ï¼Œè‹¥æ–‡ä»¶æ²¡æœ‰å˜åŒ–ï¼ŒGit ä¸ä¼šå†æ¬¡ä¿å­˜ï¼Œè€Œåªå¯¹ä¸Šæ¬¡ä¿å­˜çš„å¿«ç…§ä½œä¸€é“¾æ¥ã€‚</p>
<p>GitåŸºäºåˆ†æ”¯çš„ç®¡ç†æ–¹å¼ï¼Œè¿‘ä¹æ‰€æœ‰æ“ä½œéƒ½æ˜¯åœ¨æœ¬åœ°è¿›è¡Œï¼Œåªæœ‰æäº¤åˆå¹¶æ‹‰å–ç­‰å°‘é‡æ“ä½œéœ€è¦å’Œè¿œç«¯æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚</p>
<p>Gité¡¹ç›®ä¸­æ–‡ä»¶çš„ä¸‰ç§åŸºæœ¬çŠ¶æ€ï¼šGitå·¥ä½œåŒºçŠ¶æ€ï¼šå¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œè¿˜æœªä¿å­˜ï¼›Gitæš‚å­˜åŒºï¼šå°†æ–‡ä»¶çš„ä¿®æ”¹ä¿å­˜åœ¨ä¸€ä¸ªä¸­é—´æ€ï¼ˆgit addï¼‰ï¼›Gitæœ¬åœ°ä»“åº“åŒºï¼šå°†ä¿®æ”¹æ°¸ä¹…ä¿å­˜åˆ°Gitä»“åº“ä¸­æ¥ï¼ˆgit commitï¼‰ã€‚</p>
</li>
</ol>
<h2 id="gitå®‰è£…">Gitå®‰è£…</h2>
<ol>
<li>æºç ç¼–è¯‘å®‰è£…</li>
<li>å®‰è£…åŒ…å®‰è£…</li>
</ol>
<h2 id="gité…ç½®">Gité…ç½®</h2>
<p>æ¯ä¸ªGité¡¹ç›®æ–‡ä»¶å¤¹ä¸‹éƒ½æœ‰ä¸€ä¸ª.gitç›®å½•ï¼Œå®ƒè®°å½•äº†Gité¡¹ç›®çš„æ–‡ä»¶çŠ¶æ€ã€‚</p>
<p>ä½¿ç”¨Gitå‰ï¼Œéœ€è¦å¯¹Gitè¿›è¡Œé…ç½®ï¼Œå‘½ä»¤git configä¸“é—¨ç”¨æ¥é…ç½®æˆ–è¯»å–ç›¸åº”çš„å·¥ä½œç¯å¢ƒå˜é‡ã€‚</p>
<p>Gitä¼šä¾æ¬¡è¯»å–ä¸‰ä¸ªåœ°æ–¹çš„ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼š</p>
<ol>
<li>/etc/gitconfigï¼š ç³»ç»Ÿçº§é…ç½®ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·ç”Ÿæ•ˆï¼Œé€šè¿‡git config --systemè¯»å–å’Œé…ç½®</li>
<li>~/.gitconfigï¼šç”¨æˆ·çº§é…ç½®ï¼Œåªå¯¹è¯¥ç”¨æˆ·ç”Ÿæ•ˆï¼Œé€šè¿‡git config --globalè¯»å–å’Œé…ç½®</li>
<li>.git/configï¼šé¡¹ç›®çº§é…ç½®ï¼Œåªå¯¹å½“å‰Gité¡¹ç›®ç”Ÿæ•ˆï¼Œç›´æ¥vim ./git/configè¯»å–å’Œä¿®æ”¹é…ç½®</li>
</ol>
<p>æ¯ä¸€ä¸ªçº§åˆ«çš„é…ç½®éƒ½ä¼šè¦†ç›–ä¸Šå±‚çš„ç›¸åŒé…ç½®ã€‚</p>
<h2 id="git-help">Git help</h2>
<p>git help cmd ï¼ˆegï¼šgit help configï¼‰</p>
<p>git cmd --help ï¼ˆegï¼šgit  config  --helpï¼‰</p>
<p>man git</p>
<h2 id="gité¡¹ç›®è·å–">Gité¡¹ç›®è·å–</h2>
<ol>
<li>
<p>åœ¨æœ¬åœ°å·¥ä½œç›®å½•ä¸‹æ–°å»ºgitä»“åº“</p>
<p>git init</p>
</li>
<li>
<p>ä»è¿œç«¯ç°æœ‰ä»“åº“å…‹éš†</p>
<p>git clone <a href="http://url/test.git" target="_blank" rel="noopener">http://url/test.git</a></p>
<p>git clone git://url/test.git</p>
</li>
</ol>
<h2 id="å¿½ç•¥éƒ¨åˆ†æ–‡ä»¶">å¿½ç•¥éƒ¨åˆ†æ–‡ä»¶</h2>
<p>ç¼–å†™.gitignoreæ–‡ä»¶ï¼Œå¹¶åŠ å…¥Gitä»“åº“</p>
<h2 id="git-å‘½ä»¤è‡ªåŠ¨è¡¥å…¨">git å‘½ä»¤è‡ªåŠ¨è¡¥å…¨</h2>
<p>ç¯å¢ƒCentOSï¼š</p>
<ol>
<li>
<p>å°†gitæºç ç›®å½•ä¸‹æ–‡ä»¶contrib/completion/git-completion.bash æ‹·è´åˆ°æœ¬æœº /etc/bash_completion.d/</p>
</li>
<li>
<p>ç¼–è¾‘~/.bashrcï¼ŒåŠ å…¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if [ -f /etc/bash_completion.d/git-completion.bash ]; then</span><br><span class="line">        . /etc/bash_completion.d/git-completion.bash</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é‡æ–°source ~/.bashrc</p>
</li>
</ol>
<h2 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h2>
<ol>
<li>
<p>git addï¼Œæ·»åŠ ä¿®æ”¹åˆ°æš‚å­˜åŒºï¼Œå†git commit -m â€œcommentâ€ æäº¤åˆ°æœ¬åœ°ä»“åº“ã€‚git add -i è¿›å…¥äº¤äº’å¼æš‚å­˜æ¨¡å¼ã€‚</p>
</li>
<li>
<p>git commit -a -m â€œcommentâ€ å¯ä»¥è·³è¿‡git addï¼Œç›´æ¥æäº¤ä¿®æ”¹åˆ°æœ¬åœ°ä»“åº“ï¼Œæ–°å¢çš„æ–‡ä»¶è¿˜æ˜¯untrackedçŠ¶æ€ä»ç„¶éœ€è¦å…ˆgit addã€‚</p>
</li>
<li>
<p>æ–‡ä»¶é‡å‘½åï¼šgit mv old new</p>
</li>
<li>
<p>æŸ¥çœ‹æäº¤å†å²ï¼šgit log</p>
</li>
<li>
<p><strong>ä¿®æ”¹æœ€è¿‘ä¸€æ¬¡æäº¤ï¼šgit commit --amendï¼ˆæ¯”å¦‚ï¼šå…ˆgit commitï¼Œå‘ç°è¿˜æœ‰æœªæäº¤æ–‡ä»¶ï¼Œgit add å¿˜æäº¤æ–‡ä»¶ï¼Œå†æ¬¡æ‰§è¡Œgit commit --amendï¼Œä¼šè¦†ç›–ä¸Šæ¬¡çš„commitï¼Œgit logä¸­åªä¼šè®°å½•æœ€è¿‘è¿™æ¬¡çš„commitã€‚æ³¨æ„ä¸èƒ½ä¿®æ”¹å·²ç»pushçš„commitï¼Œä¼šå¯¼è‡´å†æ¬¡pushå†²çªï¼‰</strong></p>
</li>
<li>
<p>å–æ¶ˆä¿å­˜åˆ°æš‚å­˜åŒºçš„æ–‡ä»¶ï¼šgit reset HEAD fileï¼Œæ­¤æ“ä½œä¼šå°†git addçš„æ–‡ä»¶è¿˜åŸå›ä¿®æ”¹å¾…æ·»åŠ çš„çŠ¶æ€</p>
</li>
<li>
<p>æ”¾å¼ƒå¯¹æ–‡ä»¶çš„ä¿®æ”¹ï¼šgit checkout â€“ fileï¼Œæ­¤æ“ä½œä¼šå°†å·²ç»ä¿®æ”¹å¾…æ·»åŠ çš„æ–‡ä»¶çš„ä¿®æ”¹åˆ é™¤ï¼Œæ…ç”¨</p>
</li>
<li>
<p>æ”¾å¼ƒå¯¹å·²ç»ä¿å­˜åˆ°æš‚å­˜åŒºçš„æ–‡ä»¶çš„ä¿®æ”¹ï¼šgit reset --hard commitNo ï¼ˆcommitNoæŒ‡resetåˆ°å“ªä¸ªæäº¤ç‚¹ï¼Œé»˜è®¤æ˜¯HEADæ‰€åœ¨æäº¤ç‚¹ï¼‰</p>
<p>git reset å›æ»šï¼š</p>
<blockquote>
<p>ä¸‰ç§æ¨¡å¼ï¼šé»˜è®¤mixedæ¨¡å¼</p>
<p>git reset [â€“soft | --mixed | --hard] commitNo</p>
<p>â€“softï¼šå›æ»šåˆ°æŒ‡å®šcommitNoï¼Œæ­¤commitNoä¹‹åçš„æäº¤ä¿®æ”¹ï¼ˆgit commitï¼‰å›æ»šåˆ°æš‚å­˜åŒºçŠ¶æ€ï¼ˆgit addï¼‰</p>
<p>â€“mixedï¼šå›æ»šåˆ°æŒ‡å®šcommitNoï¼Œæ­¤commitNoä¹‹åçš„æäº¤ä¿®æ”¹ï¼ˆgit commitï¼‰å›æ»šåˆ°å·²ä¿®æ”¹çŠ¶æ€ï¼ˆæœªæ‰§è¡Œgit  addï¼‰</p>
<p>â€“hardï¼šå›æ»šåˆ°æŒ‡å®šcommitNoï¼Œæ­¤commitNoä¹‹åçš„æäº¤ä¿®æ”¹ï¼ˆgit commitï¼‰ç›´æ¥ä¸¢å¼ƒ</p>
</blockquote>
</li>
<li>
<p>git fetchï¼šæ‹‰å–è¿œç¨‹ä»“åº“çš„åˆ†æ”¯ä¿¡æ¯å’Œtagä¿¡æ¯</p>
</li>
<li>
<p>æ‰“æ ‡ç­¾ï¼šåˆ†ä¸ºï¼šè½»é‡çº§æ ‡ç­¾ï¼ˆåªæ˜¯ä¸ªå¼•ç”¨ï¼ŒæŒ‡å‘æŸä¸ªæäº¤ç‚¹ï¼‰ï¼Œå«é™„æ³¨çš„æ ‡ç­¾ï¼ˆç‹¬ç«‹çš„ä¸€ä¸ªæ ‡ç­¾å¯¹è±¡ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾ï¼šgit tag</span><br><span class="line">æ–°å»ºè½»é‡çº§æ ‡ç­¾ git tag v1.0</span><br><span class="line">æ–°å»ºå«é™„æ³¨æ ‡ç­¾ git tag -a v1.0 -m â€œcomentâ€</span><br><span class="line">é’ˆå¯¹æŸä¸ªcommitæ·»åŠ æ ‡ç­¾ï¼šgit tag -a v1.2 ef35ae2 -m â€œcommentâ€</span><br><span class="line">å°†æ ‡ç­¾ä¿¡æ¯pushåˆ°è¿œç«¯ä»“åº“ï¼šgit push origin --tags</span><br><span class="line">åˆ‡æ¢åˆ°æŸä¸ªtagï¼šgit checkout v1.0</span><br><span class="line">æ‹‰å–æŸä¸ªtagï¼šgit pull origin :remotes/origin/v1.0</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>git checkout commitNo / git checkout tagNameï¼Œä¼šå¯¼è‡´HEADæ‰§è¡Œå…·ä½“çš„æŸæ¬¡commitæˆ–æŸä¸ªtagï¼Œæ­¤æ—¶HEADå¤„äºæ¸¸ç¦»çŠ¶æ€ï¼ˆdetachedï¼‰ï¼Œæ­¤æ—¶åŸºäºHEADçš„ä¿®æ”¹ä¼šæäº¤åˆ°ä¸€ä¸ªæ–°å¼€çš„åŒ¿ååˆ†æ”¯ï¼Œä¸€æ—¦åˆ‡æ¢åˆ°å…¶ä»–åˆ†æ”¯ï¼Œæ­¤detachedåˆ†æ”¯å³ä¸å¯è§ã€‚è§£å†³åŠæ³•ï¼š</p>
<blockquote>
<ol>
<li>git reflog å¯ä»¥æŸ¥çœ‹ä¹‹å‰åˆ°æ‰€æœ‰æäº¤è®°å½•</li>
<li>æ‰¾åˆ°ä¹‹å‰åŸºäºHEAD detachedåˆ†æ”¯çš„æœ€æ–°æäº¤commitNo</li>
<li>git checkout commitNoï¼Œåˆ‡æ¢åˆ°ä¹‹å‰åŸºäºHEAD detachedåˆ†æ”¯çš„æœ€æ–°æäº¤commitNo</li>
<li>åŸºäºæ­¤commitæ–°å»ºä¸€ä¸ªåˆ†æ”¯ï¼šgit checkout -b newDetached</li>
<li>åˆ‡æ¢å›æ­£å¸¸åˆ†æ”¯å¦‚masterï¼šgit checkout master</li>
<li>æ‰§è¡Œåˆ†æ”¯åˆå¹¶å³å¯æ‰¾å›ä¹‹å‰åŸºäºHEAD detachedåˆ†æ”¯çš„ä¿®æ”¹ï¼šgit merge newDetached</li>
</ol>
</blockquote>
</li>
<li>
<p>åˆ†æ”¯åŸºæœ¬æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. åŸºäºå½“å‰commitåˆ›å»ºæ–°åˆ†æ”¯ï¼šgit checkout -b branchxx</span><br><span class="line">2. åˆ‡æ¢åˆ°åˆ†æ”¯masterï¼šgit checkout master</span><br><span class="line">3. åœ¨æ–°åˆ†æ”¯ä¸Šç¬¬ä¸€æ¬¡pushåŒæ­¥referenceï¼šgit push --set-upstream origin branchxx</span><br><span class="line">4. åœ¨åˆ†æ”¯masterä¸‹åˆå¹¶branchxxåˆ†æ”¯ï¼šgit merge branchxx</span><br><span class="line">5. åˆ é™¤åˆ†æ”¯ï¼šgit branch -d branchxx</span><br><span class="line">6. åŒæ­¥è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æ•°æ®åˆ°æœ¬åœ°ï¼šgit fetch origin</span><br><span class="line"></span><br><span class="line">7. æ·»åŠ å¤šä¸ªè¿œç¨‹æœåŠ¡å™¨åˆ†æ”¯ï¼šgit remote add githubCalendar git@github.com:qiaojianqj/gitCalendar.git</span><br><span class="line">8. åšæ–°çš„ä¿®æ”¹å¹¶æäº¤ï¼šgit cm -a -m &quot;remote add gitCalendar&quot;</span><br><span class="line">9. æ¨é€æœ¬åœ°masteråˆ†æ”¯åˆ°è¿œç¨‹gitCalendaræœåŠ¡å™¨ä¸Šå¯¹åº”masteråˆ†æ”¯ï¼Œ</span><br><span class="line">è¯­æ³•ï¼šgit push [è¿œç¨‹å] [æœ¬åœ°åˆ†æ”¯]:[è¿œç¨‹åˆ†æ”¯]</span><br><span class="line">é»˜è®¤æ¨é€å½“å‰æ‰€åœ¨åˆ†æ”¯ï¼š</span><br><span class="line">git push githubCalendar ï¼ˆgit push githubCalendar master:masterï¼‰</span><br><span class="line">10. æŸ¥çœ‹æœ¬åœ°ä»“åº“.git/configæ–‡ä»¶ï¼Œæœ‰ä¸¤ä¸ªremoteï¼šoriginã€githubCalendarï¼Œæ¯æ¬¡æ¨é€çš„æ—¶å€™å¯ä»¥æŒ‡å®šremoteæœåŠ¡å™¨é€‰æ‹©æ¨é€åˆ°å“ªä¸ªè¿œç¨‹æœåŠ¡å™¨ï¼Œé»˜è®¤æ¨é€åˆ°originï¼š</span><br><span class="line">git push (git push origin)</span><br><span class="line">git push githubCalendar</span><br><span class="line">11. åˆ é™¤è¿œç¨‹åˆ†æ”¯githubCalendar-devï¼špushçš„æ—¶å€™å¦‚æœçœç•¥ [æœ¬åœ°åˆ†æ”¯]ï¼Œé‚£å°±ç­‰äºæ˜¯åœ¨è¯´â€œåœ¨è¿™é‡Œæå–ç©ºç™½ç„¶åæŠŠå®ƒå˜æˆ[è¿œç¨‹åˆ†æ”¯]ï¼Œä¹Ÿå°±åˆ é™¤äº†è¿œç¨‹åˆ†æ”¯ï¼š</span><br><span class="line">11.1 æ–°å»ºè¿œç¨‹åˆ†æ”¯devï¼šgit push githubCalendar master:dev</span><br><span class="line">11.2 åˆ é™¤è¿œç¨‹åˆ†æ”¯devï¼šgit push githubCalendar :dev</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>åˆ†æ”¯çš„å˜åŸº-rebase</p>
<blockquote>
<ol>
<li>å˜åŸºçš„åº”ç”¨</li>
</ol>
<p>ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨å˜åŸºçš„ç›®çš„ï¼Œæ˜¯æƒ³è¦å¾—åˆ°ä¸€ä¸ªèƒ½åœ¨è¿œç¨‹åˆ†æ”¯ä¸Šå¹²å‡€åº”ç”¨çš„è¡¥ä¸ â€” æ¯”å¦‚æŸäº›é¡¹ç›®ä½ ä¸æ˜¯ç»´æŠ¤è€…ï¼Œä½†æƒ³å¸®ç‚¹å¿™çš„è¯ï¼Œæœ€å¥½ç”¨å˜åŸºï¼šå…ˆåœ¨è‡ªå·±çš„ä¸€ä¸ªæœ¬åœ°åˆ†æ”¯é‡Œè¿›è¡Œå¼€å‘ï¼Œå½“å‡†å¤‡å‘ä¸»é¡¹ç›®æäº¤è¡¥ä¸çš„æ—¶å€™ï¼Œæ ¹æ®æœ€æ–°çš„ <code>origin/master</code> è¿›è¡Œä¸€æ¬¡å˜åŸºæ“ä½œç„¶åå†æäº¤ï¼Œè¿™æ ·ç»´æŠ¤è€…å°±ä¸éœ€è¦åšä»»ä½•æ•´åˆå·¥ä½œï¼ˆè¯‘æ³¨ï¼šå®é™…ä¸Šæ˜¯æŠŠè§£å†³åˆ†æ”¯è¡¥ä¸åŒæœ€æ–°ä¸»å¹²ä»£ç ä¹‹é—´å†²çªçš„è´£ä»»ï¼ŒåŒ–è½¬ä¸ºç”±æäº¤è¡¥ä¸çš„äººæ¥è§£å†³ã€‚ï¼‰ï¼Œåªéœ€æ ¹æ®ä½ æä¾›çš„ä»“åº“åœ°å€ä½œä¸€æ¬¡å¿«è¿›åˆå¹¶ï¼Œæˆ–è€…ç›´æ¥é‡‡çº³ä½ æäº¤çš„è¡¥ä¸ã€‚</p>
<ol start="2">
<li>å˜åŸºä¸é€‚ç”¨çš„åœ°æ–¹</li>
</ol>
<p>å¦‚æœæŠŠå˜åŸºå½“æˆä¸€ç§åœ¨æ¨é€ä¹‹å‰æ¸…ç†æäº¤å†å²çš„æ‰‹æ®µï¼Œè€Œä¸”ä»…ä»…å˜åŸºé‚£äº›å°šæœªå…¬å¼€çš„æäº¤å¯¹è±¡ï¼Œå°±æ²¡é—®é¢˜ã€‚å¦‚æœå˜åŸºé‚£äº›å·²ç»å…¬å¼€çš„æäº¤å¯¹è±¡ï¼Œå¹¶ä¸”å·²ç»æœ‰äººåŸºäºè¿™äº›æäº¤å¯¹è±¡å¼€å±•äº†åç»­å¼€å‘å·¥ä½œçš„è¯ï¼Œå°±ä¸é€‚ç”¨ï¼Œä¼šä½¿å¾—æäº¤å†å²é‡å¤ä¸æ¸…</p>
<ol start="3">
<li>å˜åŸºrebaseå’Œåˆå¹¶mergeçš„åŒºåˆ«</li>
</ol>
<p>å˜åŸºæ˜¯æ¸…ç†åˆ†æ”¯æäº¤å†å²ï¼Œåˆå¹¶ä¼šä¿ç•™åˆ†æ”¯çš„æäº¤å†å²</p>
<ol start="4">
<li>ä¸¾ä¾‹</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; 0. å‰æï¼šå½“å‰masteråˆ†æ”¯</span><br><span class="line">&gt; 1. æ–°å»ºåˆ†æ”¯devå¹¶ä½œæäº¤ï¼š</span><br><span class="line">&gt; git checkout -b dev</span><br><span class="line">&gt; git cm -a -m â€œcommentâ€</span><br><span class="line">&gt; 2. åˆ‡å›masteråˆ†æ”¯å¹¶ä½œæäº¤</span><br><span class="line">&gt; git checkout master</span><br><span class="line">&gt; git cm -a -m â€œcommentâ€</span><br><span class="line">&gt; 3. æ­¤æ—¶ä¸¤ä¸ªåˆ†æ”¯åˆ†å‰äº†ï¼Œå°†devåˆ†æ”¯çš„ä¿®æ”¹å¹²å‡€çš„åˆå¹¶åˆ°masteråˆ†æ”¯ï¼š</span><br><span class="line">&gt; git checkout dev</span><br><span class="line">&gt; git rebase master</span><br><span class="line">&gt; git checkout master</span><br><span class="line">&gt; git merge dev </span><br><span class="line">&gt; 4. æ­¤æ—¶devåˆ†æ”¯çš„æ‰€æœ‰æäº¤å†å²éƒ½æ²¡æœ‰äº†ï¼Œä½†æ˜¯devçš„æ‰€æœ‰ä¿®æ”¹éƒ½åˆå¹¶åˆ°äº†masgeråˆ†æ”¯</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li>
<p>cherry-pick</p>
<blockquote>
<p>åœ¨æŸä¸ªç‰¹æ€§åˆ†æ”¯ä¸Šè¿›è¡Œå¼€å‘ï¼Œè¿›è¡Œäº†å¤šæ¬¡æäº¤ï¼Œæ­¤æ—¶åªæƒ³å°†ç‰¹æ€§åˆ†æ”¯ä¸Šçš„æŸä¸ªæäº¤åˆå¹¶è¿›ä¸»åˆ†æ”¯ï¼Œå³å¯ä½¿ç”¨cherry-pick</p>
<p>åœ¨ä¸»åˆ†æ”¯ä¸Šï¼šgit cherry-pick commitNo</p>
</blockquote>
</li>
<li>
<p>reflog</p>
<blockquote>
<p>reflow å¼•ç”¨æ—¥å¿—ï¼šä¸€ä»½è®°å½•æœ€è¿‘å‡ ä¸ªæœˆä½ çš„ HEAD å’Œåˆ†æ”¯å¼•ç”¨çš„æ—¥å¿—</p>
<p>git reflog</p>
</blockquote>
</li>
<li>
<p>stash</p>
<p>ç»å¸¸æœ‰è¿™æ ·çš„äº‹æƒ…å‘ç”Ÿï¼Œå½“ä½ æ­£åœ¨è¿›è¡Œé¡¹ç›®ä¸­æŸä¸€éƒ¨åˆ†çš„å·¥ä½œï¼Œé‡Œé¢çš„ä¸œè¥¿å¤„äºä¸€ä¸ªæ¯”è¾ƒæ‚ä¹±çš„çŠ¶æ€ï¼Œè€Œä½ æƒ³è½¬åˆ°å…¶ä»–åˆ†æ”¯ä¸Šè¿›è¡Œä¸€äº›å·¥ä½œã€‚é—®é¢˜æ˜¯ï¼Œä½ ä¸æƒ³æäº¤è¿›è¡Œäº†ä¸€åŠçš„å·¥ä½œï¼Œå¦åˆ™ä»¥åä½ æ— æ³•å›åˆ°è¿™ä¸ªå·¥ä½œç‚¹ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±æ˜¯git stashå‘½ä»¤</p>
<blockquote>
<p>git stash</p>
<p>git stash list</p>
<p>git stash apply stash@{0}</p>
<p>git stash branch stashBranchName (åŸºäºå‚¨è—å·¥ä½œæ—¶çš„æ‰€å¤„çš„æäº¤åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯)</p>
</blockquote>
</li>
<li>
<p>é‡å†™æäº¤å†å²ï¼ˆåŸºäºæœ¬åœ°æäº¤ï¼Œpushåˆ°è¿œç«¯ä»“åº“çš„æäº¤ä¸å®œå†è¿›è¡Œé‡å†™ï¼Œå®¹æ˜“å¼•èµ·æ··ä¹±ï¼‰</p>
<blockquote>
<p>é‡å†™æœ€è¿‘ä¸€æ¬¡çš„æäº¤å†å²ï¼šgit commit --amend</p>
<p>äº¤äº’å¼é‡å†™æœ€è¿‘næ¬¡çš„æäº¤å†å²ï¼ˆåˆå¹¶ï¼Œåˆ é™¤ï¼Œè°ƒæ•´æ¬¡åºï¼‰ï¼šgit rebase -i HEAD~n</p>
<p>å…¨å±€æ€§æ›´æ”¹æäº¤è€…åç§°å’Œç”µå­é‚®ä»¶åœ°å€ï¼šï¼ˆæ³¨æ„å°†ä¿®æ”¹pushåˆ°ä»“åº“ï¼Œä¼šè¯»å–git configçš„é…ç½®ï¼Œæ‰€ä»¥æœ€å¥½ä¿æŒæ­¤å¤„çš„name å’Œ emailå’Œgit configçš„ä¸€è‡´ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; git filter-branch --commit-filter &apos;</span><br><span class="line">&gt;  if [ &quot;$GIT_AUTHOR_EMAIL&quot; = &quot;gaga@GaGadeBook.lan&quot; ];</span><br><span class="line">&gt;  then</span><br><span class="line">&gt;          GIT_AUTHOR_NAME=&quot;localGa&quot;;</span><br><span class="line">&gt;          GIT_AUTHOR_EMAIL=&quot;localGa@docker.com&quot;;</span><br><span class="line">&gt;          git commit-tree &quot;$@&quot;;</span><br><span class="line">&gt;  else</span><br><span class="line">&gt;          git commit-tree &quot;$@&quot;;</span><br><span class="line">&gt;  fi&apos; HEAD</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li>
<p>æ–‡ä»¶æ ‡æ³¨ï¼šæŸ¥çœ‹æ–‡ä»¶çš„æ¯ä¸€è¡Œå¯¹åº”çš„æœ€åä¸€æ¬¡æäº¤ä¿¡æ¯</p>
<p>git blame fileName</p>
</li>
<li>
<p>å­æ¨¡å—ï¼šå…è®¸ä½ å°†ä¸€ä¸ª Git ä»“åº“å½“ä½œå¦å¤–ä¸€ä¸ªGitä»“åº“çš„å­ç›®å½•ã€‚è¿™å…è®¸ä½ å…‹éš†å¦å¤–ä¸€ä¸ªä»“åº“åˆ°ä½ çš„é¡¹ç›®ä¸­å¹¶ä¸”ä¿æŒä½ çš„æäº¤åœ¨ä¸¤ä¸ªgitä»“åº“ç›¸å¯¹ç‹¬ç«‹ã€‚</p>
<blockquote>
<p>å­æ¨¡å—åº”ç”¨åœºæ™¯ï¼š</p>
<p>å½“ä½ åœ¨ä¸€ä¸ªé¡¹ç›®ä¸Šå·¥ä½œæ—¶ï¼Œä½ éœ€è¦åœ¨å…¶ä¸­ä½¿ç”¨å¦å¤–ä¸€ä¸ªé¡¹ç›®ã€‚ä¹Ÿè®¸å®ƒæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹å¼€å‘çš„åº“æˆ–è€…æ˜¯ä½ ç‹¬ç«‹å¼€å‘å’Œå¹¶åœ¨å¤šä¸ªçˆ¶é¡¹ç›®ä¸­ä½¿ç”¨çš„ã€‚è¿™ä¸ªåœºæ™¯ä¸‹ä¸€ä¸ªå¸¸è§çš„é—®é¢˜äº§ç”Ÿäº†ï¼šä½ æƒ³å°†ä¸¤ä¸ªé¡¹ç›®å•ç‹¬å¤„ç†ä½†æ˜¯åˆéœ€è¦åœ¨å…¶ä¸­ä¸€ä¸ªä¸­ä½¿ç”¨å¦å¤–ä¸€ä¸ªã€‚</p>
<p>git submodule add  repourl ï¼ˆæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªç›¸åº”çš„å­ç›®å½• å’Œ .gitmodulesæ–‡ä»¶ï¼Œgitæ“ä½œåœ¨å­ç›®å½•å’Œå¤–å±‚ç›®å½•æ˜¯ç‹¬ç«‹çš„ã€‚åœ¨å¤–å±‚é¡¹ç›®ä¸­ï¼ŒæŠŠå­ç›®å½•å½“ä½œä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶å¤„ç†ï¼Œæ¯æ¬¡å­ç›®å½•æœ‰æ–°çš„æäº¤å˜æ›´æ—¶ï¼Œå¤–å±‚ç›®å½•ä¼šçœ‹åˆ°ç›¸åº”çš„å­ç›®å½•ç‰¹æ®Šæ–‡ä»¶æœ‰ä¿®æ”¹ï¼‰</p>
<p>å½“ä½ å…‹éš†ä¸€ä¸ªå¸¦å­æ¨¡å—çš„é¡¹ç›®æ—¶ï¼Œä½ å°†å¾—åˆ°åŒ…å«å­é¡¹ç›®çš„ç›®å½•ï¼Œä½†é‡Œé¢æ˜¯ç©ºçš„æ²¡æœ‰æ–‡ä»¶ï¼Œæ­¤æ—¶è¿˜éœ€è¦è¿è¡Œï¼šgit submodule init &amp; git submodule update æ¥åˆå§‹åŒ–é…ç½®å¹¶æ‹‰å–å­é¡¹ç›®æ–‡ä»¶</p>
<p>ä½†æ˜¯åœ¨å¸¦å­æ¨¡å—çš„é¡¹ç›®é‡Œåˆ‡æ¢åˆ†æ”¯éœ€è¦é¢å¤–å¤šä½™çš„æ“ä½œå¾ˆéº»çƒ¦</p>
</blockquote>
</li>
<li>
<p>å­æ ‘å½’å¹¶ï¼šå¤„ç†å­é¡¹ç›®çš„å¦ä¸€ç§æ–¹å¼ï¼šä»¥åˆ†æ”¯åˆå¹¶çš„æ–¹å¼æ¥æ·»åŠ å­é¡¹ç›®</p>
<blockquote>
<p>å­æ ‘å½’å¹¶çš„æ€æƒ³æ˜¯ä½ æ‹¥æœ‰ä¸¤ä¸ªå·¥ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªé¡¹ç›®æ˜ å°„åˆ°å¦å¤–ä¸€ä¸ªé¡¹ç›®çš„å­ç›®å½•ä¸­</p>
<p>æ¯”å¦‚å°†learnGité¡¹ç›®æ·»åŠ è¿›CalendarServerä½œä¸ºå­é¡¹ç›®ï¼š</p>
<ol>
<li>git remote add learnGit <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:qiaojianqj/learnGit.git ï¼ˆæ·»åŠ è¿œç¨‹ä»“åº“ï¼‰</li>
<li>git fetch learnGit ï¼ˆè·å–è¿œç¨‹ä»“åº“é…ç½®åˆ†æ”¯ä¿¡æ¯ï¼‰</li>
<li>git checkout -b learngit learnGit/master ï¼ˆä»¥æ–°æ·»åŠ çš„è¿œç¨‹ä»“åº“masteråˆ†æ”¯å»ºç«‹æœ¬åœ°åˆ†æ”¯learngitï¼‰</li>
<li>git checkout master ï¼ˆåˆ‡æ¢å›CalendarServeré¡¹ç›®æœ¬åœ°åˆ†æ”¯ï¼‰</li>
<li>git read-tree --prefix=learngit/ -u learngit ï¼ˆæ‹‰å–learngitåˆ†æ”¯åˆ°masteråˆ†æ”¯çš„learngitç›®å½•ï¼Œä½œä¸ºå­é¡¹ç›®ï¼‰</li>
</ol>
</blockquote>
</li>
</ol>
<h2 id="git-hook">git hook</h2>
<p>åœ¨gité¡¹ç›®çš„.git/hooksç›®å½•ä¸‹å­˜æ”¾æœ‰é’©å­è„šæœ¬ï¼Œåœ¨ç‰¹å®šgitå‘½ä»¤æ‰§è¡Œå‰åä¼šè¢«è°ƒç”¨ï¼Œå®ç°è‡ªå®šä¹‰é€»è¾‘</p>
<p>é»˜è®¤è„šæœ¬ä»¥.sampleç»“å°¾ï¼Œä¸èµ·ä½œç”¨ï¼Œå»æ‰.sampleä½¿å¾—é’©å­å‘½ä»¤ç”Ÿæ•ˆ</p>
<h2 id="git-svn">git svn</h2>
<p>git svn å‘½ä»¤é›†ç”¨äº gitå®¢æˆ·ç«¯å’ŒsvnæœåŠ¡ç«¯äº¤äº’ï¼Œä»¥åŠå°†svnä»“åº“è¿å¾™è‡³gitä»“åº“</p>
<h2 id="git-æ‰‹å†Œ">git æ‰‹å†Œ</h2>
<p><a href="https://git-scm.com/book/zh/v1/" target="_blank" rel="noopener">https://git-scm.com/book/zh/v1/</a></p>
]]></content>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>javaé›†åˆ-ArrayList</title>
    <url>/article/java%E9%9B%86%E5%90%88-ArrayList/</url>
    <content><![CDATA[<h3 id="ç±»å›¾ç»“æ„">ç±»å›¾ç»“æ„</h3>
<p>ArrayListæ˜¯Listæ¥å£çš„å¯å˜å¤§å°æ•°ç»„çš„å®ç°ç±»ã€‚å®ƒçš„ç±»å±‚çº§ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/ArrayList%E7%B1%BB%E5%9B%BE%E7%BB%93%E6%9E%84.jpg" alt=""></p>
<p>Iterableæ¥å£ï¼šå®ç°æ­¤æ¥å£çš„é›†åˆç±»å¯ä»¥æ‰§è¡ŒforEachè¯­å¥ï¼Œå¦å¤–spliteratoræ¥å£æ˜¯ä¸ºäº†å¹¶è¡Œéå†æ•°æ®æºä¸­çš„å…ƒç´ è€Œè®¾è®¡çš„è¿­ä»£å™¨</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/Iterable%E6%8E%A5%E5%8F%A3.jpg" alt=""></p>
<p>Collectionæ¥å£ï¼šé›†åˆç±»çš„é€šç”¨æ¥å£ï¼ŒJDKä¸æä¾›æ­¤æ¥å£çš„å…·ä½“å®ç°ç±»ï¼Œå…·ä½“çš„é›†åˆå­æ¥å£Setã€Listç»§æ‰¿è‡ªCollectionã€‚å› æ­¤æ­¤æ¥å£æä¾›Setã€Listé›†åˆé€šç”¨çš„ä¸€äº›åŠŸèƒ½æ¥å£ä»¥åŠé»˜è®¤å®ç°ã€‚</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/Collection%E6%8E%A5%E5%8F%A3.jpg" alt=""></p>
<p>AbstractCollectionæŠ½è±¡ç±»ï¼šæä¾›é›†åˆé€šç”¨åŠŸèƒ½éª¨æ¶å®ç°ï¼Œå¦‚æœè¦å®ç°ä¸€ä¸ªä¸å¯ä¿®æ”¹çš„Collectionï¼Œå¯ä»¥ç»§æ‰¿è‡ªAbstractCollectionå¹¶å®ç°iteratorå’Œsizeæ–¹æ³•ã€‚å¦‚æœè¦å®ç°ä¸€ä¸ªå¯ä»¥ä¿®æ”¹çš„Collectionï¼Œå¯ä»¥ç»§æ‰¿è‡ªAbstractCollectionå¹¶å®ç°addã€removeæ–¹æ³•ã€‚</p>
<p>Listæ¥å£ï¼šç»§æ‰¿è‡ªCollectionæ¥å£ï¼Œé¢å¤–æä¾›Listç±»å‹éœ€è¦å®ç°çš„æ–¹æ³•æ¥å£ï¼Œå¦‚getã€setã€indexOfã€lastIndexOfç­‰ã€‚</p>
<p>AbstractListæŠ½è±¡ç±»ï¼šæä¾›Listç±»å‹é›†åˆçš„é€šç”¨åŠŸèƒ½éª¨æ¶å®ç°ã€‚å¦‚æœè¦å®ç°ä¸€ä¸ªä¸å¯ä¿®æ”¹çš„Listï¼Œå¯ä»¥ç»§æ‰¿è‡ªListå¹¶å®ç°getå’Œsizeæ–¹æ³•ã€‚å¦‚æœè¦å®ç°ä¸€ä¸ªå¯ä»¥ä¿®æ”¹çš„Listï¼Œå¯ä»¥ç»§æ‰¿è‡ªListå¹¶å®ç°setã€addã€removeæ–¹æ³•ã€‚</p>
<p>RandomAccessæ¥å£ï¼šæ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼ŒListé›†åˆå®ç°æ­¤æ¥å£ï¼Œè¡¨ç¤ºListæ”¯æŒé›†åˆå…ƒç´ çš„éšæœºè®¿é—®ã€‚</p>
<p>Serializableæ¥å£ï¼šä¹Ÿæ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼Œå®ç°æ­¤æ¥å£è¡¨ç¤ºæ”¯æŒJDKåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p>Cloneableæ¥å£ï¼šä¹Ÿæ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼Œä½†æ˜¯å®ç°æ­¤æ¥å£çš„ç±»åº”è¯¥è¦è¦†å†™Objectç±»çš„cloneæ–¹æ³•å¹¶æä¾›Classå­—æ®µçš„æ‹·è´ã€‚</p>
<h3 id="ç±»æ–‡ä»¶è¯´æ˜">ç±»æ–‡ä»¶è¯´æ˜</h3>
<p>ArrayListå…ƒç´ ç±»å‹æ˜¯æ³›å‹ï¼Œå¯ä»¥å­˜æ”¾ã€æ‰€æœ‰ã€‘ç±»å‹çš„å…ƒç´ ï¼ŒåŒ…æ‹¬nullï¼Œæ„Ÿå—ä¸€ä¸‹ArrayListå¯ä»¥å­˜æ”¾æ‰€æœ‰ç±»å‹å…ƒç´ è¿™å¥è¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ArrayList list = <span class="keyword">new</span> ArrayList ();</span><br><span class="line">list.add ( <span class="number">1</span> );</span><br><span class="line">list.add ( <span class="number">1.2</span> );</span><br><span class="line">list.add ( <span class="string">"1.3"</span> );</span><br><span class="line">list.add ( NaN );</span><br><span class="line">list.add ( <span class="keyword">null</span> );</span><br><span class="line">list.add ( <span class="keyword">true</span> );</span><br><span class="line">list.add ( <span class="keyword">new</span> Exception (<span class="string">"exp"</span>) );</span><br><span class="line">list.add ( Class.class );</span><br></pre></td></tr></table></figure>
<p>sizeã€isEmptyã€getã€setã€iteratorã€listIteratorè¿™äº›æ¥å£çš„æ“ä½œæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ã€‚addæ¥å£æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å’Œæ·»åŠ çš„å…ƒç´ ä¸ªæ•°æˆæ­£æ¯”ä¸ºO(n)ã€‚</p>
<p>ArrayListçš„å®¹é‡å¤§äºç­‰äºå…ƒç´ çš„sizeã€‚æ·»åŠ å…ƒç´ çš„æ—¶å€™å®¹é‡ä¼šè‡ªåŠ¨å¢é•¿ï¼ˆint newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1);ï¼‰ï¼Œå¹¶ä¸”æ‰©å®¹çš„æ—¶é—´å¤æ‚åº¦å¹³æ‘Šä¸‹æ¥æ˜¯O(1)ã€‚ä½†æ˜¯åœ¨æ‰©å®¹åä¼šè¿›è¡Œä¸€æ¬¡å…ƒç´ çš„å…¨é‡æ‹·è´ï¼Œå› æ­¤å¦‚æœä¸€æ¬¡éœ€è¦æ·»åŠ å¾ˆå¤šå…ƒç´ çš„æ—¶å€™ï¼Œå¯ä»¥é¢„å…ˆæŒ‡å®šä¸€ä¸ªè¾ƒå¤§çš„å®¹é‡æ¥æé«˜æ€§èƒ½ã€‚</p>
<p>ArrayListä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œArrayListå¹¶ä¸”ã€è‡³å°‘ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†ArrayListçš„ç»“æ„ã€‘æ—¶ï¼Œå¿…é¡»è¿›è¡ŒåŒæ­¥ã€‚å¢åŠ ã€åˆ é™¤å…ƒç´ æˆ–è€…æ‰©å®¹éƒ½å±äºä¿®æ”¹ArrayListç»“æ„ï¼Œä½†æ˜¯è®¾ç½®å…ƒç´ çš„å€¼ä¸å±äºä¿®æ”¹ArrayListçš„ç»“æ„ã€‚</p>
<p>ArrayListçš„iterator()è¿”å›çš„è¿­ä»£å™¨å±äºfail-fastç±»å‹ã€‚å°±æ˜¯è¯´åœ¨è¿”å›è¿­ä»£å™¨ä¹‹åå¦‚æœä¸æ˜¯é€šè¿‡iteratorçš„addå’Œremoveæ–¹æ³•æ¥å¯¹ArrayListçš„ç»“æ„è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸”åœ¨å¤–é¢è¿›è¡Œäº†ArrayList ç»“æ„çš„ä¿®æ”¹çš„è¯ï¼Œiteratorä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ã€‚</p>
<h3 id="add">add</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">  modCount++;</span><br><span class="line">  add(e, elementData, size);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(E e, Object[] elementData, <span class="keyword">int</span> s)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (s == elementData.length)</span><br><span class="line">    elementData = grow();</span><br><span class="line">  elementData[s] = e;</span><br><span class="line">  size = s + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯çŸ¥ï¼šå‘ArrayListé‡Œæ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œåªæœ‰å½“å‰sizeç­‰äºæ•°ç»„å®¹é‡æ—¶æ‰è¿›è¡Œæ‰©å®¹ï¼Œç„¶åæ·»åŠ å…ƒç´ size+1</p>
<h3 id="grow">grow</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Object[] grow() &#123;</span><br><span class="line">  <span class="keyword">return</span> grow(size + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object[] grow(<span class="keyword">int</span> minCapacity) &#123;</span><br><span class="line">  <span class="keyword">return</span> elementData = Arrays.copyOf(elementData,</span><br><span class="line">                                     newCapacity(minCapacity));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">newCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// overflow-conscious code</span></span><br><span class="line">  <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">  <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (newCapacity - minCapacity &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA)</span><br><span class="line">      <span class="keyword">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    <span class="keyword">return</span> minCapacity;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (newCapacity - MAX_ARRAY_SIZE &lt;= <span class="number">0</span>)</span><br><span class="line">    ? newCapacity</span><br><span class="line">    : hugeCapacity(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">  <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE)</span><br><span class="line">    ? Integer.MAX_VALUE</span><br><span class="line">    : MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯çŸ¥ï¼šæ‰©å®¹åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥ï¼šnewCapacityç¡®å®šæ–°çš„æ•°ç»„çš„å®¹é‡æ˜¯æ—§å®¹é‡çš„1.5å€ï¼›ç¬¬äºŒæ­¥ï¼šè°ƒç”¨Arrays.copyOfå°†åŸæ•°ç»„çš„å…ƒç´ æ‹·è´åˆ°æ–°æ•°ç»„ï¼Œç„¶åè¿”å›æ–°æ•°ç»„ã€‚</p>
<p>è¿™é‡Œæ³¨æ„æœ‰ä¸ªæŠ€å·§ï¼šoverflow-conscious code</p>
<p>é¦–å…ˆï¼šè®¡ç®—æœºé‡Œçš„æ•°å­—éƒ½æ˜¯ä»¥è¡¥ç è¡¨ç¤ºï¼ˆæ­£æ•°çš„è¡¥ç ä¸å˜ï¼Œè´Ÿæ•°çš„è¡¥ç æ˜¯å¯¹åº”çš„æ­£æ•°å–ååŠ 1ï¼‰ï¼Œè®¡ç®—æœºé‡Œåªæœ‰åŠ æ³•å™¨ï¼Œå‡æ³•è¿ç®—éƒ½è¦è½¬æ¢æˆåŠ æ³•è¿ç®—æ¯”å¦‚10-5<br>
$$<br>
-\frac{0000 1010}  {0000 0101}<br>
$$</p>
<p>è½¬æ¢æˆ10 + (-5):<br>
$$<br>
+\frac{0000 1010}{1111 1011}<br>
$$</p>
<p>$$<br>
1|00000101<br>
$$</p>
<p>ç¬¦å·ä½å‰æº¢å‡ºä¸è¦ï¼Œå¾—åˆ°æ­£æ•°è¡¥ç 5ä¹Ÿå°±æ˜¯åŸç ã€‚</p>
<p>å†å›æ¥çœ‹æ‰©å®¹çš„ä»£ç ï¼šæ·»åŠ å…ƒç´ è‡ªåŠ¨æ‰©å®¹æ—¶size=åº•å±‚æ•°ç»„é•¿åº¦length</p>
<p>å½“ oldCapacityå¾ˆå¤§æ¥è¿‘Integer.MAX_VALUEæ—¶ï¼Œæ¯”å¦‚oldCapacity = Integer.MAX_VALUE - 15ï¼›</p>
<p>åˆ™ newCapacityæ‰©å®¹ä¸ºoldCapacityçš„1.5å€æ—¶ï¼Œå‘ç”Ÿäº†æº¢å‡ºï¼ŒnewCapacityå˜ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼š-16ï¼›</p>
<p>è¿™æ—¶minCapacity=size+1=Integer.MAX_VALUE-14ï¼›</p>
<p>æ­¤æ—¶ï¼šnewCapacity - minCapacity = 2147483647 ä¸ºæ­£æ•°ï¼Œ</p>
<p>æ‰€ä»¥ä»¥ä¸‹åˆ¤æ–­ä¸ºfalseï¼Œä¿è¯newCapacityæº¢å‡ºæ—¶ä¸ä¼šè¿›å…¥æ­¤ifåˆ†æ”¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (newCapacity - minCapacity &lt;=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½¿ç”¨ä»¥ä¸‹åˆ¤æ–­ï¼Œåˆ™ç”±äºnewCapacityä¸ºè´Ÿæ•°ã€‚åˆ¤æ–­ä¸ºtrueï¼Œä½¿å¾—æ‰©å®¹åä½¿ç”¨äº†minCapacity</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (newCapacity &lt; minCapacity)</span><br></pre></td></tr></table></figure>
<p>è€ŒnewCapacityæº¢å‡ºçš„å¤„ç†æ˜¯ä»¥ä¸‹returnè¯­å¥ï¼šç”±äºnewCapacityæº¢å‡ºä¸ºè´Ÿæ•°å¯¼è‡´newCapacity - MAX_ARRAY_SIZE = 2147483641 ä¸ºæ­£æ•°ï¼Œæ‰€ä»¥ä¼šèµ°åˆ†æ”¯hugeCapacity(minCapacity)ä½¿ç”¨MAX_ARRAY_SIZE æˆ– Integer.MAX_VALUEã€Integer.MAX_VALUE - 8ä½œä¸ºæ‰©å®¹åçš„æ–°å®¹é‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> (newCapacity - MAX_ARRAY_SIZE &lt;= <span class="number">0</span>)</span><br><span class="line">    ? newCapacity</span><br><span class="line">    : hugeCapacity(minCapacity);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">  <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE)</span><br><span class="line">    ? Integer.MAX_VALUE</span><br><span class="line">    : MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå¯çŸ¥ArrayListçš„æœ€å¤§å®¹é‡ä¸ºï¼šInteger.MAX_VALUE - 8 æˆ–è€…æ˜¯Integer.MAX_VALUE.</p>
<p>é¦–å…ˆï¼ŒArrayListçš„sizeç±»å‹æ˜¯intï¼Œè¯´æ˜èƒ½å­˜æ”¾çš„æœ€å¤§å€¼æ˜¯Integer.MAX_VALUEï¼Œè€Œä¸æ˜¯Long.MAX_VALUEã€‚</p>
<p>å…¶æ¬¡ï¼Œæ•°ç»„åœ¨Javaä¸­ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨è™šæ‹Ÿæœºä¸­ä¼šåˆ›å»ºä¸€ä¸ªæ•°ç»„å¯¹è±¡å‡ºæ¥ï¼Œè€ŒJavaçš„å¯¹è±¡éƒ½æœ‰ä¸ªå¯¹è±¡å¤´ï¼Œæ•°ç»„çš„å¯¹è±¡å¤´å¸ƒå±€å¦‚ä¸‹ï¼Œ</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="params">|------------------------------------------------------------------------------------------|</span></span><br><span class="line"><span class="params">|                                 Object Header (96/192 bits)                              |</span></span><br><span class="line"><span class="params">|-----------------------------------|</span>--------------------------<span class="params">|---------------------------|</span></span><br><span class="line"><span class="params">|        Mark Word(32/64bits)       |</span>    Klass Word(<span class="number">32</span>/<span class="number">64</span>bits) <span class="params">|  array length(32/64bits)  |</span></span><br><span class="line"><span class="params">|-----------------------------------|</span>--------------------------<span class="params">|---------------------------|</span></span><br></pre></td></tr></table></figure>
<p>è€ŒJDKæ–‡æ¡£æ³¨é‡Šæ˜¯è¿™æ ·è¯´çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The maximum size of array to allocate (unless necessary).</span></span><br><span class="line"><span class="comment">     * Some VMs reserve some header words in an array.</span></span><br><span class="line"><span class="comment">     * Attempts to allocate larger arrays may result in</span></span><br><span class="line"><span class="comment">     * OutOfMemoryError: Requested array size exceeds VM limit</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class="number">8</span>;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´æœ‰äº›è™šæ‹Ÿæœºæ˜¯å°†æ•°ç»„é•¿åº¦æ”¾åœ¨æ•°ç»„å¯¹è±¡çš„å¯¹è±¡å¤´çš„ï¼Œè€Œæœ‰äº›è™šæ‹Ÿæœºæ˜¯å°†æ•°ç»„é•¿åº¦æ”¾åœ¨æ•°ç»„å®ä¾‹æ•°æ®é‡Œçš„ï¼Œæ‰€ä»¥æ•°ç»„å®ä¾‹éœ€è¦é¢„ç•™8ä¸ªå­—èŠ‚æ¥ä¿å­˜è‡ªå·±çš„æ•°ç»„é•¿åº¦ã€‚æ‰€ä»¥æ•°ç»„çš„æœ€å¤§å®¹é‡æ—¢å¯ä»¥æ˜¯Integer.MAX_VALUEä¹Ÿå¯ä»¥æ˜¯Integer.MAX_VALUE - 8ã€‚</p>
<p>æ³¨é‡Šä¹Ÿè¯´äº†å®é™…ä½¿ç”¨ä¸­å°è¯•åˆ†é…è¿™ä¹ˆå¤§çš„æ•°ç»„å¯èƒ½ä¼šå¯¼è‡´OOMã€‚</p>
<h3 id="trimtosize">trimToSize</h3>
<p>å½“ArrayListç»è¿‡å¤šæ¬¡æ‰©å®¹åï¼Œcapacityå¯èƒ½ä¼šæ¯”å®é™…size å¤§çš„å¤šï¼Œä¸ºäº†èŠ‚çœç©ºé—´ï¼ŒtrimToSizeå°†capacityè£å‰ªåˆ°å½“å‰sizeå¤§å°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  modCount++;</span><br><span class="line">  <span class="keyword">if</span> (size &lt; elementData.length) &#123;</span><br><span class="line">    elementData = (size == <span class="number">0</span>)</span><br><span class="line">      ? EMPTY_ELEMENTDATA</span><br><span class="line">      : Arrays.copyOf(elementData, size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="iterator">Iterator</h3>
<p>è¿­ä»£å™¨å†…éƒ¨æœ‰ä¸€ä¸ªå±æ€§ï¼šexpectedModCountï¼Œåœ¨åˆ›å»ºè¿­ä»£å™¨æ—¶ï¼Œå°†å½“å‰é›†åˆçš„modCountèµ‹å€¼ç»™å±æ€§expectedModCount</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> cursor;       <span class="comment">// index of next element to return</span></span><br><span class="line">       <span class="keyword">int</span> lastRet = -<span class="number">1</span>; <span class="comment">// index of last element returned; -1 if no such</span></span><br><span class="line">       <span class="keyword">int</span> expectedModCount = modCount;</span><br><span class="line">       ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ä½¿ç”¨è¿­ä»£å™¨è¿›è¡Œé›†åˆå…ƒç´ è¿­ä»£æ“ä½œnextã€removeã€forEachéå†æ—¶éƒ½ä¼šæ£€æµ‹å½“å‰çš„modCountå’ŒexpectedModCountæ˜¯å¦ç›¸ç­‰ï¼Œä¸ç­‰åˆ™ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼šConcurrentModificationExceptionï¼Œè¡¨ç¤ºåœ¨éå†æ—¶é›†åˆè¢«å¤–éƒ¨ä¿®æ”¹äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkForComodification</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¦åœ¨éå†æ—¶åˆ é™¤é›†åˆå…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨Iteratorçš„removeæ–¹æ³•ï¼Œå®ƒä¼šåœ¨åˆ é™¤å…ƒç´ ä¹‹åæ›´æ–°iteratorçš„expectedModCountå±æ€§ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">  checkForComodification();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ArrayList.<span class="keyword">this</span>.remove(lastRet);</span><br><span class="line">    cursor = lastRet;</span><br><span class="line">    lastRet = -<span class="number">1</span>;</span><br><span class="line">    expectedModCount = modCount;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="foreach">forEach</h3>
<p>forEachéå†ï¼Œä¼šåœ¨æ¯æ¬¡æ‰§è¡ŒforEachçš„Consumerå‡½æ•°æ¥å£æ–¹æ³•å‰æ£€æµ‹åœ¨forEachæ“ä½œä¹‹å¤–é›†åˆæ˜¯å¦æœ‰ç»“æ„æ€§ä¿®æ”¹ï¼Œå³ä½¿æ˜¯é€šè¿‡Iteratorä¿®æ”¹ï¼ŒforEachéå†ä¹Ÿä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> E&gt; action)</span> </span>&#123;</span><br><span class="line">  Objects.requireNonNull(action);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> expectedModCount = modCount;</span><br><span class="line">  <span class="keyword">final</span> Object[] es = elementData;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> size = <span class="keyword">this</span>.size;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; modCount == expectedModCount &amp;&amp; i &lt; size; i++)</span><br><span class="line">    action.accept(elementAt(es, i));</span><br><span class="line">  <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¾‹å¦‚ä¸‹å°†ä¼šåœ¨forEachä¸­æŠ›å‡ºå¹¶å‘ä¿®æ”¹å¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ArrayList list = <span class="keyword">new</span> ArrayList ();</span><br><span class="line">list.add ( <span class="number">1.2</span> );</span><br><span class="line">list.add ( <span class="string">"1.3"</span> );</span><br><span class="line">list.add ( NaN );</span><br><span class="line">list.add ( <span class="keyword">null</span> );</span><br><span class="line">list.add ( <span class="number">1</span> );</span><br><span class="line">list.add ( <span class="keyword">true</span> );</span><br><span class="line">list.add ( <span class="keyword">new</span> Exception (<span class="string">"exp"</span>) );</span><br><span class="line">list.add ( Class.class );</span><br><span class="line"><span class="keyword">new</span> Thread (() -&gt; &#123;</span><br><span class="line">  Iterator&lt;Object&gt; listItr = list.iterator ();</span><br><span class="line">  <span class="keyword">while</span> (listItr.hasNext ()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Thread.sleep ( <span class="number">500</span> );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      e.printStackTrace ();</span><br><span class="line">    &#125;</span><br><span class="line">    Object next = listItr.next ();</span><br><span class="line">    <span class="keyword">if</span> (next <span class="keyword">instanceof</span>  Integer) &#123;</span><br><span class="line">      listItr.remove ();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).start ();</span><br><span class="line">list.forEach ( (element) -&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep ( <span class="number">1000</span> );</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace ();</span><br><span class="line">  &#125;</span><br><span class="line">  System.out.println (<span class="string">"list value: "</span> + element);</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<h3 id="çº¿ç¨‹å®‰å…¨list">çº¿ç¨‹å®‰å…¨List</h3>
<p>ArrayListå’ŒLinkedListéƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦è¿›è¡ŒåŒæ­¥ã€‚JDKæä¾›äº†ä¸€ä¸ªåŒæ­¥å·¥å…·ç±»SynchronizedListå¯ä»¥æ—¢å¯¹ArrayListå’ŒLinkedListè¿›è¡ŒåŒæ­¥ã€‚é‚£SynchronizedListå’ŒVectoråˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p>
<p>åªä»åŒæ­¥ä¸Šæ¥çœ‹ï¼ŒåŒºåˆ«æ˜¯ï¼š</p>
<ol>
<li>SynchronizedListå¯ä»¥è‡ªå·±æŒ‡å®šé”å¯¹è±¡ï¼Œè€ŒVectorä¸è¡Œã€‚</li>
<li>SynchronizedListæ²¡æœ‰å¯¹listIteratoræ–¹æ³•è¿›è¡ŒåŠ é”ï¼Œæ‰€ä»¥é€šè¿‡listIteratorå¯¹å°è£…çš„Listè¿›è¡Œä¿®æ”¹æ—¶éœ€è¦æ‰‹åŠ¨åŠ é”ã€‚</li>
</ol>
<p>å¦å¤–CopyOnWriteArrayListåŸºäºCOWæœºåˆ¶å®ç°äº†çº¿ç¨‹å®‰å…¨ï¼Œåº”ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå› ä¸ºåœ¨å†™æ—¶ä¼šè¿›è¡Œæ•°ç»„çš„æ‹·è´ï¼Œå¦‚æœè¯»å†™éƒ½å¾ˆé¢‘ç¹çš„åœºæ™¯åˆ™ä¸é€‚åˆã€‚</p>
]]></content>
      <tags>
        <tag>é›†åˆ ArrayList</tag>
      </tags>
  </entry>
  <entry>
    <title>mysqlç¬”è®°</title>
    <url>/article/mysql%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h3 id="æŸ¥çœ‹mysql-ç”¨æˆ·çš„è¿æ¥æƒé™">æŸ¥çœ‹mysql ç”¨æˆ·çš„è¿æ¥æƒé™</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; select host , user  from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| host      | user          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| %         | root          |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">| localhost | root          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>å¯è§å…è®¸rootç”¨æˆ·åœ¨ä»»ä½•IPæ®µä¸‹è¿æ¥æ•°æ®åº“å®ä¾‹</p>
<h3 id="mysqlè¿æ¥æ–¹å¼">mysqlè¿æ¥æ–¹å¼</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. TCP/IPæ–¹å¼ï¼šæœ¬åœ°æˆ–è¿œç¨‹ç™»å½•</span><br><span class="line">mysql -hhost -uname -ppassword</span><br><span class="line">2. socketæ–¹å¼ï¼šæœ¬åœ°ç™»å½•</span><br><span class="line">[root@localhost ~]# ps -ef | grep mysql</span><br><span class="line">root      3076     1  0 Oct14 ?        00:00:00 /bin/sh /usr/bin/mysqld_safe --datadir=/var/lib/mysql --socket=/var/lib/mysql/mysql.sock --pid-file=/var/run/mysqld/mysqld.pid --basedir=/usr --user=mysql</span><br><span class="line">mysql -uname -S/var/lib/mysql/mysql.sock</span><br></pre></td></tr></table></figure>
<h3 id="innodb-å­˜å‚¨ç»“æ„bæ ‘">InnoDB å­˜å‚¨ç»“æ„ï¼šB+æ ‘</h3>
<p>MyIsamå¼•æ“æ˜¯é»˜è®¤å­˜å‚¨å¼•æ“ï¼Œå¯¹åº”ç£ç›˜ä¸Šä¸‰ä¸ªæ–‡ä»¶ï¼š.frmï¼ˆå­˜å‚¨è¡¨å®šä¹‰ï¼‰ .MYDï¼ˆå­˜å‚¨æ•°æ®ï¼‰ .MYIï¼ˆå­˜å‚¨ç´¢å¼•ï¼‰</p>
<p>InnoDBå¼•æ“ï¼Œå¯¹åº”ç£ç›˜ä¸Šä¸¤ä¸ªæ–‡ä»¶ï¼š.frmï¼ˆå­˜å‚¨è¡¨å®šä¹‰ï¼‰.ibdï¼ˆå­˜å‚¨èšé›†ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å³æ•°æ®ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">InnoDBçš„ä¸€å¼ è¡¨çš„æ•°æ®å’Œç´¢å¼•éƒ½å­˜åœ¨è¡¨ç©ºé—´ï¼Œä¸€ä¸ªè¡¨ç©ºé—´å¯¹åº”ä¸€ä¸ªibdæ–‡ä»¶</span><br><span class="line"></span><br><span class="line">è¡¨ç©ºé—´ç”±æ®µã€åŒºã€é¡µç»„æˆ</span><br><span class="line">æ®µç”±å¤šä¸ªåŒºç»„æˆ</span><br><span class="line">åŒºç”±è¿ç»­çš„å¤šä¸ªé¡µç»„æˆï¼ˆé¡µå¤§å°é»˜è®¤ä¸º16KBï¼‰</span><br><span class="line">é¡µå­˜æ”¾tableçš„è¡Œæ•°æ®</span><br><span class="line"></span><br><span class="line">B+æ ‘å¶å­èŠ‚ç‚¹ï¼šå­˜å‚¨ æ•°æ®æ®µ</span><br><span class="line">B+æ ‘éå¶å­èŠ‚ç‚¹ï¼šå­˜å‚¨ ç´¢å¼•æ®µ</span><br></pre></td></tr></table></figure>
<h3 id="ç´¢å¼•">ç´¢å¼•</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. èšé›†ç´¢å¼•ï¼š</span><br><span class="line">ä¸€å¼ è¡¨åªæœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œå› ä¸ºInnoDBçš„æ•°æ®å­˜å‚¨å°±æ˜¯æŒ‰ç…§ä¸»é”®é¡ºåºå­˜æ”¾çš„ä¸€é¢—B+æ ‘ï¼Œæ­¤æ—¶B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯æ•´å¼ è¡¨çš„è¡Œè®°å½•æ•°æ®ã€‚</span><br><span class="line">èšé›†ç´¢å¼•ï¼Œé€‚åˆåŸºäºä¸»é”®çš„æ’åºæŸ¥æ‰¾å’ŒèŒƒå›´æŸ¥æ‰¾</span><br><span class="line"></span><br><span class="line">2. è¾…åŠ©ç´¢å¼•ï¼š</span><br><span class="line">è¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼Œè€Œæ˜¯å­˜å‚¨èšé›†ç´¢å¼•çš„ä¸»é”®å€¼ï¼ˆå› æ­¤ä¸»é”®ä¸å®œæ˜¯å å¤ªå¤§çš„ç©ºé—´çš„å­—æ®µï¼‰ã€‚</span><br><span class="line">å½“é€šè¿‡è¾…åŠ©ç´¢å¼•æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œéœ€è¦å…ˆåœ¨è¾…åŠ©ç´¢å¼•B+æ ‘æ‰¾åˆ°å¯¹åº”çš„èšé›†ç´¢å¼•çš„ä¸»é”®å€¼ï¼Œå†åˆ°èšé›†ç´¢å¼•B+æ ‘æŸ¥æ‰¾æŒ‡å®šä¸»é”®å€¼æ‰€å¯¹åº”çš„æ•°æ®</span><br><span class="line"></span><br><span class="line">3. å»ºç«‹ç´¢å¼•çš„åŸåˆ™ï¼š</span><br><span class="line">é€‰æ‹©å–å€¼é‡å¤åº¦ä½ï¼ˆåŒºåˆ†åº¦é«˜ï¼‰çš„å­—æ®µå»ºç«‹ç´¢å¼•ï¼Œæ¯”å¦‚ç”¨æˆ·åé€‚åˆå»ºç«‹ç´¢å¼•ï¼Œæ€§åˆ«å°±ä¸é€‚åˆå»ºç«‹ç´¢å¼•</span><br><span class="line">ä¸è¦é‡å¤åˆ›å»ºç´¢å¼•</span><br><span class="line">å°½é‡æ‰©å±•å·²æœ‰ç´¢å¼•ï¼Œè€Œä¸æ˜¯æ·»åŠ æ–°çš„å¤šä½™çš„ç´¢å¼•</span><br><span class="line">mysqlä¼˜åŒ–å™¨ä¼šå¯¹ä½¿ç”¨ç´¢å¼•å¯¹è¯­å¥è¿›è¡Œåˆ¤æ–­ï¼Œå½“ä½¿ç”¨è¾…åŠ©ç´¢å¼•çš„è¯­å¥æ‰«æè¡Œæ•°è¶…è¿‡30%ï¼ˆå¤§æ¦‚å€¼ï¼‰æ—¶ï¼Œmysqlä¼˜åŒ–å™¨ä¼šé€‰æ‹©èµ°èšé›†ç´¢å¼•çš„å…¨è¡¨æ‰«æ</span><br><span class="line"></span><br><span class="line">4. åªselect éœ€è¦çš„å­—æ®µï¼ˆå¯èƒ½ä¼šç”¨åˆ°è¦†ç›–ç´¢å¼•ï¼Œåªéœ€è¦ä»è¾…åŠ©ç´¢å¼•æ£€ç´¢å³å¯æŸ¥åˆ°æ‰€éœ€æ•°æ®ï¼Œæ›´å¿«ï¼‰ï¼Œä¸è¦select *</span><br><span class="line"></span><br><span class="line">5. è”åˆç´¢å¼•ä¾ç…§æœ€å·¦åŒ¹é…çš„é¡ºåºæ¥æ£€ç´¢B+æ ‘ï¼Œç›´åˆ°é‡åˆ°èŒƒå›´æŸ¥è¯¢ï¼ˆ&gt; &lt; between likeï¼‰åœæ­¢åŒ¹é…ï¼Œæ‰€ä»¥ç»å¸¸è¿›è¡ŒèŒƒå›´æŸ¥è¯¢çš„å­—æ®µåœ¨è”åˆç´¢å¼•ä¸­è¦æ”¾åœ¨æœ€åã€‚æ¯”å¦‚a = 1 and b = 2 and c &gt; 3 and d = 4 å¦‚æœå»ºç«‹(a,b,c,d)é¡ºåºçš„ç´¢å¼•ï¼Œdæ˜¯ç”¨ä¸åˆ°ç´¢å¼•çš„ï¼Œå¦‚æœå»ºç«‹(a,b,d,c)çš„ç´¢å¼•åˆ™éƒ½å¯ä»¥ç”¨åˆ°ï¼Œa,b,dçš„é¡ºåºå¯ä»¥ä»»æ„è°ƒæ•´</span><br><span class="line"></span><br><span class="line">6. ä½¿ç”¨explain/desc æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œæ‰¾å‡ºæ‰«æè¡Œå¾ˆå¤šï¼ˆrowsï¼‰çš„è¯­å¥ï¼Œä¿®æ”¹sqlè¯­å¥ä½¿å¾—æ‰«æè¡Œå°½é‡å°‘å³å¯</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ç´¢å¼•(Cardinalityï¼šåŸºæ•°å€¼è¶Šå¤§ï¼ŒåŒºåˆ†åº¦è¶Šé«˜ï¼Œé€‚åˆå»ºç«‹ç´¢å¼•)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show index from table_name;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ ç´¢å¼•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// æ™®é€šç´¢å¼•</span><br><span class="line">alter table table_name add index index_name(column_list);</span><br><span class="line">create index index_name on table_name(column_list);</span><br><span class="line">// å”¯ä¸€ç´¢å¼•</span><br><span class="line">alter table table_name add unique(column_list);</span><br><span class="line">create unique index index_name on table_name(column_list);</span><br><span class="line">// ä¸»é”®ç´¢å¼•</span><br><span class="line">alter table table_name add primary key(column_list);</span><br></pre></td></tr></table></figure>
<p>explain/desc æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼š</p>
<p>Â±â€”Â±-----------------Â±--------Â±-------------Â±--------Â±-------------------Â±------Â±-----------Â±-----Â±-------Â±---------Â±-----------+<br>
| id | select_type | table | partitions | type | possible_keys | key | key_len | ref | rows | filtered | Extra  |</p>
<p>Â±â€”Â±-----------------Â±--------Â±--------------Â±-------Â±--------------------Â±------Â±-----------Â±-----Â±-------Â±---------Â±----------+</p>
<blockquote>
<p>id: æŸ¥è¯¢åºå·</p>
<p><strong>idç›¸åŒ</strong>ï¼šæ‰§è¡Œé¡ºåºç”±ä¸Šè‡³ä¸‹</p>
<p><strong>idä¸åŒ</strong>ï¼šå¦‚æœæ˜¯å­æŸ¥è¯¢ï¼Œidçš„åºå·ä¼šé€’å¢ï¼Œidå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆè¢«æ‰§è¡Œ</p>
<p><strong>idç›¸åŒåˆä¸åŒï¼ˆä¸¤ç§æƒ…å†µåŒæ—¶å­˜åœ¨ï¼‰</strong>ï¼šidå¦‚æœç›¸åŒï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œä»ä¸Šå¾€ä¸‹é¡ºåºæ‰§è¡Œï¼›åœ¨æ‰€æœ‰ç»„ä¸­ï¼Œidå€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ</p>
</blockquote>
<blockquote>
<p>select_typeï¼šæŸ¥è¯¢ç±»å‹</p>
<p><strong>SIMPLE</strong>ï¼šç®€å•çš„selectæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸­ä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€…union</p>
<p><strong>PRIMARY</strong>ï¼šæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•å¤æ‚çš„å­éƒ¨åˆ†ï¼Œæœ€å¤–å±‚æŸ¥è¯¢åˆ™è¢«æ ‡è®°ä¸ºprimary</p>
<p><strong>SUBQUERY</strong>ï¼šåœ¨select æˆ– whereåˆ—è¡¨ä¸­åŒ…å«äº†å­æŸ¥è¯¢</p>
<p><strong>DERIVED</strong>ï¼šåœ¨fromåˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢è¢«æ ‡è®°ä¸ºderivedï¼ˆè¡ç”Ÿï¼‰ï¼Œmysqlæˆ–é€’å½’æ‰§è¡Œè¿™äº›å­æŸ¥è¯¢ï¼ŒæŠŠç»“æœæ”¾åœ¨ä¸´æ—¶è¡¨é‡Œ</p>
</blockquote>
<blockquote>
<p>tableï¼šæŸ¥è¯¢çš„æ•°æ®è¡¨ï¼Œå½“ä»è¡ç”Ÿè¡¨ä¸­æŸ¥æ•°æ®æ—¶ä¼šæ˜¾ç¤º<code>&lt;derivedx&gt;</code>ï¼Œ <code>x</code> è¡¨ç¤ºå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’<code>id</code></p>
</blockquote>
<blockquote>
<p>partitionsï¼šè¡¨åˆ†åŒºï¼Œè¡¨åˆ›å»ºçš„æ—¶å€™å¯ä»¥æŒ‡å®šé€šè¿‡é‚£ä¸ªåˆ—è¿›è¡Œè¡¨åˆ†åŒº</p>
</blockquote>
<blockquote>
<p>typeï¼šè®¿é—®ç±»å‹ï¼Œæ€§èƒ½ç”±å¥½åˆ°åä¾æ¬¡æ˜¯ï¼š</p>
<p><strong>system</strong> &gt; <strong>const</strong> &gt; <strong>eq_ref</strong> &gt; <strong>ref</strong> &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; <strong>range</strong> &gt; <strong>index</strong> &gt; <strong>ALL</strong></p>
<p><strong>system</strong>ï¼šè¡¨åªæœ‰ä¸€è¡Œè®°å½•</p>
<p><strong>const</strong>ï¼šè¡¨ç¤ºé€šè¿‡ç´¢å¼•ä¸€æ¬¡å°±æ‰¾åˆ°äº†ï¼Œä¸”åªæœ‰ä¸€æ¡åŒ¹é…è®°å½•ï¼›constç”¨äºæ¯”è¾ƒprimary key æˆ–è€… uniqueç´¢å¼•</p>
<p><strong>eq_ref</strong>ï¼šå”¯ä¸€æ€§ç´¢å¼•æˆ–ä¸»é”®æ‰«æ</p>
<p><strong>ref</strong>ï¼šéå”¯ä¸€æ€§ç´¢å¼•æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œ</p>
<p><strong>range</strong>ï¼šåªæ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œï¼Œä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥é€‰æ‹©è¡Œ</p>
<p><strong>index</strong>ï¼šFull Index Scanï¼Œéå†ç´¢å¼•</p>
<p><strong>ALL</strong>ï¼šFull Table Scanï¼Œéå†å…¨è¡¨</p>
</blockquote>
<blockquote>
<p>possible_keysï¼šæŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šå­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢å®é™…ä½¿ç”¨</p>
</blockquote>
<blockquote>
<p>keyï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•ï¼Œå¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•</p>
</blockquote>
<blockquote>
<p>key_lenï¼šæŸ¥è¯¢ä¸­ä½¿ç”¨åˆ°çš„ç´¢å¼•çš„æœ€å¤§å¯èƒ½é•¿åº¦</p>
</blockquote>
<blockquote>
<p>refï¼šæ˜¾ç¤ºä½¿ç”¨åˆ°çš„ç´¢å¼•å­—æ®µæˆ–å¸¸é‡æŸ¥è¯¢ï¼ˆconstï¼‰</p>
</blockquote>
<blockquote>
<p>rowsï¼šä¼°ç®—æ‰¾åˆ°æ‰€éœ€çš„è®°å½•æ‰€éœ€è¦è¯»å–çš„è¡Œæ•°</p>
</blockquote>
<blockquote>
<p>extraï¼šé¢å¤–ä¿¡æ¯</p>
<p><strong>Using filesort</strong> ï¼šä½¿ç”¨éç´¢å¼•åˆ—è¿›è¡Œæ’åºæ—¶å‡ºç°ï¼Œéå¸¸è€—æ€§èƒ½</p>
<p><strong>Using temporary</strong>ï¼š ä½¿ç”¨ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœï¼Œå¸¸è§äºorder by å’Œ group by ã€joinå­æŸ¥è¯¢</p>
<p><strong>Using index</strong>ï¼šä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Œé¿å…äº†è®¿é—®èšé›†ç´¢å¼•æ•°æ®è¡Œï¼Œæ•ˆç‡é«˜</p>
<p><strong>Using where</strong>ï¼šä½¿ç”¨äº†whereå­å¥æ¥è¿‡æ»¤ç»“æœé›†</p>
</blockquote>
<h3 id="limitæŸ¥è¯¢">LimitæŸ¥è¯¢</h3>
<p>mysqlé€šè¿‡limitå®ç°åˆ†é¡µæŸ¥è¯¢ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// è¿”å›å‰10æ¡è®°å½•</span><br><span class="line">select * from user limit 10;</span><br><span class="line">// è¿”å›ä»offset=50000å¼€å§‹çš„å‰10æ¡è®°å½•</span><br><span class="line">// æ€§èƒ½ä½çš„limit offset countæŸ¥è¯¢</span><br><span class="line">select * from user limit 50000, 10;</span><br></pre></td></tr></table></figure>
<p>å½“offsetè¿‡å¤§æ—¶ï¼Œåˆ†é¡µæŸ¥è¯¢æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼ˆæŠ›å¼€mysqlçš„æŸ¥è¯¢ç¼“å­˜ï¼‰ï¼Œä¸ºäº†æå‡limitæŸ¥è¯¢çš„æ€§èƒ½ï¼Œä¼˜åŒ–æ–¹å‘æœ‰ä»¥ä¸‹ç§ï¼š</p>
<ol>
<li>
<p>ä½¿ç”¨è¦†ç›–ç´¢å¼•å­æŸ¥è¯¢ï¼ŒæŸ¥è¯¢æ‰€éœ€offsetçš„æœ€å°ä¸»é”®å€¼ï¼Œç„¶åé€šè¿‡ä¸»é”®èŒƒå›´æŸ¥è¯¢çš„whereå­å¥æ¥å¾—åˆ°ç»“æœï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// è¦†ç›–ç´¢å¼•å­æŸ¥è¯¢ + where èŒƒå›´æŸ¥è¯¢ + limit countæŸ¥è¯¢</span><br><span class="line">select * from user where user_id &gt;= (select user_id from user order by user_id limit 50000, 1) limit 10;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä½¿ç”¨è¦†ç›–ç´¢å¼•å­æŸ¥è¯¢ï¼ŒæŸ¥è¯¢æ‰€éœ€offsetçš„æœ€å°ä¸»é”®å€¼ï¼Œç„¶åé€šè¿‡JOINè”è¡¨æŸ¥è¯¢çš„whereå­å¥æ¥å¾—åˆ°ç»“æœï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// è¦†ç›–ç´¢å¼•å­æŸ¥è¯¢ + JOIN + where + limit count æŸ¥è¯¢</span><br><span class="line">select * from user as t1 inner join (select user_id from user order by user_id limit 50000, 1) as t2 where t1.user_id &gt;= t2.user_id limit 10;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select t1.* from user_task t1 where t1.task_no in (100, 110, 120, 130, 140) limit 46000, 10; --- ç™¾ä¸‡æ•°æ®æŸ¥è¯¢è€—æ—¶2ï½3ç§’</span><br><span class="line">select t1.* from user_task t1 inner join (select id from user_task where task_no in (100, 110, 120, 130, 140) order by id asc limit 46000, 10) t2 on t1.id=t2.id;  --- ç™¾ä¸‡æ•°æ®æŸ¥è¯¢è€—æ—¶0.1ç§’å·¦å³</span><br><span class="line">---æ€§èƒ½æå‡20ï½30å€</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ä¸šåŠ¡ä¼˜åŒ–ï¼Œæ ¹æ®ä¸šåŠ¡é€»è¾‘ç¡®å®šå…¶ä»–å­—æ®µçš„å€¼æ¥ä»£æ›¿limitçš„offsetå€¼</p>
</li>
</ol>
<h3 id="ä¼˜åŒ–">ä¼˜åŒ–</h3>
<ol>
<li>æŸ¥çœ‹sqlå…·ä½“æ‰§è¡Œæ—¶é—´ï¼Œå…·ä½“æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; set profiling=1;</span><br><span class="line">mysql&gt; select * from test;</span><br><span class="line">mysql&gt; show profiles;</span><br><span class="line">mysql&gt; show profile;</span><br><span class="line">mysql&gt; show profile for query 1;</span><br><span class="line">mysql&gt; show profile all for query 2;</span><br><span class="line">mysql&gt; show status like &quot;last_query_cost&quot;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>mysql æ€§èƒ½ç›‘æ§performance_schemaï¼Œå…·ä½“æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">mysql&gt; use performance_schema;</span><br></pre></td></tr></table></figure>
<h3 id="äº‹åŠ¡æŸ¥è¯¢">äº‹åŠ¡æŸ¥è¯¢</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show full processlist;</span><br><span class="line">mysql&gt; select * from information_schema.innodb_trx\G</span><br><span class="line">mysql&gt; select * from information_schema.innodb_locks\G</span><br><span class="line">mysql&gt; select * from information_schema.innodb_lock_waits\G</span><br><span class="line">mysql&gt; select * from sys.innodb_lock_waits\G</span><br></pre></td></tr></table></figure>
<p>InnoDBåœ¨Repeatable Readäº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œä½¿ç”¨<strong>å¿«ç…§è¯»</strong>ï¼Œå¿«ç…§è¯»ä¸ä¼šå ç”¨å’Œç­‰å¾…è¡¨é”</p>
<p>åº”è¯¥æ˜¾ç¤ºçš„ä½¿ç”¨äº‹åŠ¡ï¼Œä¸è¦ä½¿ç”¨autocommit</p>
<h3 id="æ•°æ®åº“æ›´æ–°ä¸¢å¤±é—®é¢˜">æ•°æ®åº“æ›´æ–°ä¸¢å¤±é—®é¢˜</h3>
<p><strong>å¹¶å‘äº‹åŠ¡ä¸­è¿›è¡ŒæŸ¥è¯¢å¹¶æ›´æ–°å¯èƒ½ä¼šå¯¼è‡´æ›´æ–°ä¸¢å¤±ã€‚è¯´ç™½äº†å°±æ˜¯æŸ¥è¯¢å¹¶æ›´æ–°ä¸¤æ¡sqlä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œè€Œä¸”æ›´æ–°è¯­å¥ä¸­ä½¿ç”¨äº†æŸ¥è¯¢å‡ºæ¥çš„æ—§å€¼ï¼Œæˆ–è€…æ›´æ–°è¯­å¥æ˜¯æ ¹æ®æŸ¥è¯¢è¯­å¥çš„æ—§å€¼è¿›è¡Œä¸šåŠ¡é€»è¾‘çš„æ›´æ–°ï¼Œæ­¤æ—¶å…¶ä»–äº‹åŠ¡çš„æ›´æ–°æ‰ä¼šè¢«è¦†ç›–ã€‚å¦‚æœæ›´æ–°è¯­å¥å’ŒæŸ¥è¯¢è¯­å¥çš„ç»“æœä¸è¦å»ºç«‹å…³ç³»ï¼Œåˆ™æ²¡é—®é¢˜ï¼Œæ¯”å¦‚ update bank set money = money - 100 where id = 123;</strong></p>
<p>ä¾‹å¦‚ï¼šmysql äº‹åŠ¡çº§åˆ«Repeatable Readä¸‹ï¼š</p>
<p>SET AUTOCOMMIT=0;</p>
<p>CREATE TABLE <code>bank</code> (<br>
<code>id</code> int(10) NOT NULL AUTO_INCREMENT,<br>
<code>money</code> int(10) NOT NULL,<br>
PRIMARY KEY (<code>id</code>)<br>
);</p>
<p>INSERT INTO <code>bank</code> VALUES (1, 900);</p>
<table>
<thead>
<tr>
<th style="text-align:center">äº‹åŠ¡1ï¼ˆå­˜100å…ƒï¼‰</th>
<th style="text-align:center">äº‹åŠ¡2ï¼ˆå–100å…ƒï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">begin;</td>
</tr>
<tr>
<td style="text-align:center">select * from bank where id=1;ï¼ˆ900ï¼‰</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">select * from bank where id=1; ï¼ˆ900ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">update bank set money=1000 where id=1;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">update bank set money=800 where id=1;ï¼ˆé˜»å¡ç›´åˆ°äº‹åŠ¡1commitï¼‰</td>
</tr>
<tr>
<td style="text-align:center">commit;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">commit; (äº‹åŠ¡1çš„æ›´æ–°è¢«è¦†ç›–)</td>
</tr>
</tbody>
</table>
<p>è§£å†³åŠæ³•1ï¼šæ‚²è§‚é”ï¼ˆselect for updateï¼‰</p>
<table>
<thead>
<tr>
<th style="text-align:center">äº‹åŠ¡1ï¼ˆå­˜100å…ƒï¼‰</th>
<th style="text-align:center">äº‹åŠ¡2ï¼ˆå–100å…ƒï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">begin;</td>
</tr>
<tr>
<td style="text-align:center">select * from bank where id=1 for update;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">select * from bank where id=1 for update;ï¼ˆé˜»å¡ç›´åˆ°äº‹åŠ¡1commitï¼‰ï¼ˆ1000ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">update bank set money=1000 where id=1;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">update bank set money=900 where id=1;ï¼ˆåŸºäº1000å‡å»100ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">commit;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">commit;</td>
</tr>
</tbody>
</table>
<p>è§£å†³åŠæ³•2ï¼šä¹è§‚é”-æ—§å€¼åˆ¤æ–­</p>
<table>
<thead>
<tr>
<th style="text-align:center">äº‹åŠ¡1ï¼ˆå­˜100å…ƒï¼‰</th>
<th style="text-align:center">äº‹åŠ¡2ï¼ˆå–100å…ƒï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">begin;</td>
</tr>
<tr>
<td style="text-align:center">select * from bank where id=1;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">select * from bank where id=1;</td>
</tr>
<tr>
<td style="text-align:center">update bank set money=1000 where id=1 and money=900;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">update bank set money=800 where id=1 and money=900;ï¼ˆé˜»å¡ç›´åˆ°äº‹åŠ¡1commitï¼Œä½†æ˜¯æ­¤æ¡æ›´æ–°ä¼šå¤±è´¥ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">commit;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">commit;</td>
</tr>
</tbody>
</table>
<p>è§£å†³åŠæ³•3ï¼šä¹è§‚é”-è¡¨ä¸Šå¢åŠ ç‰ˆæœ¬å­—æ®µ</p>
<p>CREATE TABLE <code>bank</code> (<br>
<code>id</code> int(10) NOT NULL AUTO_INCREMENT,<br>
<code>money</code> int(10) NOT NULL,<br>
<code>timeStamp</code> int(10) DEFAULT NULL,<br>
PRIMARY KEY (<code>id</code>)<br>
);</p>
<p>INSERT INTO <code>bank</code> VALUES (1, 900, 1571129028);</p>
<table>
<thead>
<tr>
<th style="text-align:center">äº‹åŠ¡1ï¼ˆå­˜100å…ƒï¼‰</th>
<th style="text-align:center">äº‹åŠ¡2ï¼ˆå–100å…ƒï¼‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">begin;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">begin;</td>
</tr>
<tr>
<td style="text-align:center">select * from bank where id=1;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">select * from bank where id=1;</td>
</tr>
<tr>
<td style="text-align:center">update bank set money=1000, timeStamp=1571129243 where id=1 and timeStamp=1571129028;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">update bank set money=800, timeStamp=1571129246 where id=1 and timeStamp=1571129028;ï¼ˆé˜»å¡ç›´åˆ°äº‹åŠ¡1commitï¼Œä½†æ˜¯æ­¤æ¡æ›´æ–°ä¼šå¤±è´¥ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">commit;</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">commit;</td>
</tr>
</tbody>
</table>
<h3 id="ä¸€è‡´è¯»vså½“å‰è¯»">ä¸€è‡´è¯»vså½“å‰è¯»</h3>
<p>å‚è€ƒï¼š<a href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/MySQL%E5%AE%9E%E6%88%9845%E8%AE%B2/08%20%20%E4%BA%8B%E5%8A%A1%E5%88%B0%E5%BA%95%E6%98%AF%E9%9A%94%E7%A6%BB%E7%9A%84%E8%BF%98%E6%98%AF%E4%B8%8D%E9%9A%94%E7%A6%BB%E7%9A%84%EF%BC%9F.md" target="_blank" rel="noopener">äº‹åŠ¡åˆ°åº•æ˜¯éš”ç¦»çš„è¿˜æ˜¯ä¸éš”ç¦»çš„</a></p>
<p>å¯é‡å¤è¯»çš„æ ¸å¿ƒå°±æ˜¯ä¸€è‡´æ€§è¯»ï¼ˆconsistent readï¼‰ï¼›è€Œ<strong>äº‹åŠ¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œåªèƒ½ç”¨å½“å‰è¯»</strong>ã€‚å¦‚æœå½“å‰çš„è®°å½•çš„è¡Œé”è¢«å…¶ä»–äº‹åŠ¡å ç”¨çš„è¯ï¼Œå°±éœ€è¦è¿›å…¥é”ç­‰å¾…ã€‚</p>
<p>è€Œè¯»æäº¤çš„é€»è¾‘å’Œå¯é‡å¤è¯»çš„é€»è¾‘ç±»ä¼¼ï¼Œå®ƒä»¬æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ï¼š</p>
<ul>
<li>åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œåªéœ€è¦åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™åˆ›å»ºä¸€è‡´æ€§è§†å›¾ï¼Œä¹‹åäº‹åŠ¡é‡Œçš„å…¶ä»–æŸ¥è¯¢éƒ½å…±ç”¨è¿™ä¸ªä¸€è‡´æ€§è§†å›¾ï¼›</li>
<li>åœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ¯ä¸€ä¸ªè¯­å¥æ‰§è¡Œå‰éƒ½ä¼šé‡æ–°ç®—å‡ºä¸€ä¸ªæ–°çš„è§†å›¾ã€‚</li>
</ul>
<h3 id="æ¸…ç©ºè¡¨">æ¸…ç©ºè¡¨</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">truncate vs delete vs drop</span><br><span class="line">truncate æ˜¯ddlæ“ä½œï¼Œä»…åˆ é™¤æ•°æ®ï¼Œä¸æ”¯æŒæ¡ä»¶è¿‡æ»¤ï¼Œä¸èƒ½å›æ»šï¼Œè¾ƒå¿«</span><br><span class="line">delete æ˜¯dqlæ“ä½œï¼Œä»…åˆ é™¤æ•°æ®ï¼Œæ”¯æŒæ¡ä»¶è¿‡æ»¤ï¼Œå¯ä»¥å›æ»šï¼Œæ…¢</span><br><span class="line">drop æ˜¯ddlæ“ä½œï¼Œåˆ é™¤æ•°æ®åŒæ—¶åˆ é™¤è¡¨ç»“æ„ï¼Œæœ€å¿«</span><br></pre></td></tr></table></figure>
<h3 id="åˆ†åº“åˆ†è¡¨">åˆ†åº“åˆ†è¡¨</h3>
<p>åˆ†åº“databaseï¼š<strong>åˆ†åº“çš„ç›®çš„æ˜¯é™ä½å•å°æœåŠ¡å™¨è´Ÿè½½ï¼Œåˆ‡åˆ†åŸåˆ™æ˜¯æ ¹æ®ä¸šåŠ¡ç´§å¯†ç¨‹åº¦æ‹†åˆ†ï¼Œç¼ºç‚¹æ˜¯è·¨æ•°æ®åº“æ— æ³•è”è¡¨æŸ¥è¯¢</strong></p>
<p>åˆ†è¡¨tableï¼š<strong>å½“å•è¡¨æ•°æ®é‡è¶…å¤§çš„æ—¶å€™ï¼ŒB-Treeç´¢å¼•å°±æ— æ³•èµ·ä½œç”¨äº†ã€‚é™¤éæ˜¯è¦†ç›–ç´¢å¼•æŸ¥è¯¢ï¼Œå¦åˆ™æ•°æ®åº“æœåŠ¡å™¨éœ€è¦æ ¹æ®ç´¢å¼•æ‰«æçš„ç»“æœå›è¡¨ï¼ˆå›ä¸»é”®ç´¢å¼•æŸ¥è¯¢å¶å­èŠ‚ç‚¹è¡Œè®°å½•ï¼‰ï¼ŒæŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œå¦‚æœæ•°æ®é‡å·¨å¤§ï¼Œè¿™å°†äº§ç”Ÿå¤§é‡éšæœºI/Oï¼Œéšä¹‹ï¼Œæ•°æ®åº“çš„å“åº”æ—¶é—´å°†å¤§åˆ°ä¸å¯æ¥å—çš„ç¨‹åº¦ã€‚å¦å¤–ï¼Œç´¢å¼•ç»´æŠ¤ï¼ˆç£ç›˜ç©ºé—´ã€I/Oæ“ä½œï¼‰çš„ä»£ä»·ä¹Ÿéå¸¸é«˜</strong></p>
<p>åˆ†è¡¨åˆ†ä¸ºï¼šå‚ç›´åˆ†è¡¨å’Œæ°´å¹³åˆ†è¡¨</p>
<p>å‚ç›´åˆ†è¡¨ï¼šå°±æ˜¯è¡¨çš„å­—æ®µå¤ªå¤šï¼Œå°†å­—æ®µæ‹†åˆ†åˆ°ä¸åŒçš„è¡¨ä¸­ã€‚</p>
<p>æ°´å¹³åˆ†è¡¨ï¼šæ¯ä¸ªè¡¨çš„å­—æ®µä¸€æ ·ï¼Œå­˜å‚¨çš„è®°å½•ä¸ä¸€æ ·ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘è¿›è¡Œæ‹†åˆ†ï¼ˆuser_idï¼Œåœ°åŒºï¼Œæ—¶é—´ï¼Œhashç­‰ï¼‰</p>
<p>æ°´å¹³åˆ†è¡¨åçš„é—®é¢˜ï¼š</p>
<p>â€‹	æ€ä¹ˆè®¾ç½®å…¨å±€å”¯ä¸€ä¸»é”®ï¼ˆç°æˆæ–¹æ¡ˆï¼šsnowflakeç­‰ï¼‰</p>
<p>â€‹	æ€ä¹ˆä¿è¯æ•°æ®å‡åŒ€å­˜å‚¨ï¼Œæ²¡æœ‰çƒ­ç‚¹é—®é¢˜ï¼ˆæ ¹æ®ä¸šåŠ¡é€»è¾‘æ¥ï¼‰</p>
<p>â€‹	æ€ä¹ˆæ–¹ä¾¿æ‰©å®¹å’Œç¼©å®¹ï¼ˆä¸€è‡´æ€§hashï¼‰</p>
<h3 id="åˆ†åŒº">åˆ†åŒº</h3>
<p>åˆ†è¡¨å­˜åœ¨çš„é—®é¢˜æ˜¯éœ€è¦æœåŠ¡ç«¯ä¿®æ”¹ï¼Œå¼•å…¥ä¸­é—´ä»¶æ¥å±è”½åˆ†åº“åˆ†è¡¨å¸¦æ¥çš„å·®å¼‚</p>
<p>åˆ†åŒºç›¸å½“äºmysqlå±‚çš„åˆ†è¡¨ï¼Œå¯¹æœåŠ¡ç«¯æ˜¯é€æ˜çš„ï¼ŒæœåŠ¡ç«¯ä¸éœ€è¦åšä»»ä½•ä¿®æ”¹</p>
<p>è€Œä¸”åˆ†åŒºçš„æ‰©å®¹å’Œç¼©å®¹å¾ˆå®¹æ˜“ï¼Œç›´æ¥å¢åŠ åˆ†åŒºï¼Œåˆ é™¤åˆ†åŒºå³å¯ï¼Œå¯¹æ•°æ®å®Œæ•´æ€§æ²¡å½±å“</p>
<p>æ‰€ä»¥ä¸å­˜åœ¨å•æœºè´Ÿè½½é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨åˆ†åŒºæ¥ä»£æ›¿åˆ†è¡¨ï¼Œç®€åŒ–æœåŠ¡ç«¯çš„æ›´æ”¹</p>
<p>å‚è€ƒ<a href="http://haitian299.github.io/2016/05/26/mysql-partitioning/" target="_blank" rel="noopener">MySQLåˆ†åŒºä¸ä¼ ç»Ÿçš„åˆ†åº“åˆ†è¡¨</a></p>
<h3 id="mysql-repication">mysql repication</h3>
<p>ä¸»ä»å¤åˆ¶å¤‡ä»½ï¼Œè¯»å†™åˆ†ç¦»</p>
<h3 id="mysql-fabric">mysql fabric</h3>
<p>åœ¨replicationçš„åŸºç¡€ä¸Šï¼Œæä¾›æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨Failoverã€è¯·æ±‚è·¯ç”±å’Œåˆ†ç‰‡ï¼ˆshardingï¼‰åŠŸèƒ½</p>
<h3 id="mysql-cluster">mysql cluster</h3>
<p>é¢å‘å¤§è§„æ¨¡æ•°æ®çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼ŒClusterçš„æ¶æ„æ€æƒ³ä¸Hadoopéå¸¸ç±»ä¼¼ï¼Œå®ƒè®¾è®¡çš„å‰ææ˜¯â€œè®¤ä¸ºæ¯ä¸ªNodeéƒ½æ˜¯æ˜“äºå‡ºé”™çš„â€ã€é›†ç¾¤è§„æ¨¡å·¨å¤§ã€å¤šç§Ÿæˆ·ï¼Œæ‰€ä»¥å®ƒæä¾›äº†æ•°æ®å¤‡ä»½æœºåˆ¶ã€è‡ªåŠ¨è¿ç§»ã€è‡ªåŠ¨Failoverç­‰ç‰¹æ€§ï¼Œæ¥ä¿è¯å¯ç”¨æ€§ã€å¥å£®æ€§ã€‚å®ƒçš„æ ¸å¿ƒç‰¹æ€§ä¸ºï¼šæ•°æ®é›†å¹¶ä¸æ˜¯å­˜å‚¨æŸä¸ªç‰¹å®šçš„MySQLå®ä¾‹ä¸Šï¼Œè€Œæ˜¯è¢«åˆ†å¸ƒåœ¨å¤šä¸ªData Nodesä¸­ï¼Œå³ä¸€ä¸ªtableçš„æ•°æ®å¯èƒ½è¢«åˆ†æ•£åœ¨å¤šä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šï¼Œä»»ä½•æ•°æ®éƒ½ä¼šåœ¨å¤šä¸ªData Nodesä¸Šå†—ä½™å¤‡ä»½ã€‚ä»»ä½•ä¸€ä¸ªæ•°æ®å˜æ›´æ“ä½œï¼Œéƒ½å°†åœ¨ä¸€ç»„Data Nodesä¸ŠåŒæ­¥ä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>
<h3 id="dualè¡¨">DUALè¡¨</h3>
<p>Mysqlé‡Œé¢å¾ˆå¤šå†…ç½®å‡½æ•°çš„ç”¨æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight tcl"><table><tr><td class="code"><pre><span class="line">mysql&gt; select rand();</span><br><span class="line">+-------------------+</span><br><span class="line">| rand()            |</span><br><span class="line">+-------------------+</span><br><span class="line">| <span class="number">0.783871779017031</span> |</span><br><span class="line">+-------------------+</span><br><span class="line"><span class="number">1</span> row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select last_insert_id();</span><br><span class="line">+------------------+</span><br><span class="line">| last_insert_id() |</span><br><span class="line">+------------------+</span><br><span class="line">|                <span class="number">0</span> |</span><br><span class="line">+------------------+</span><br><span class="line"><span class="number">1</span> row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select sysdate();</span><br><span class="line">+---------------------+</span><br><span class="line">| sysdate()           |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="number">2020</span><span class="number">-05</span><span class="number">-19</span> <span class="number">01</span>:<span class="number">54</span>:<span class="number">25</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">1</span> row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<p>å…¶å®ä»–ä»¬éƒ½ç­‰åŒäºå¦‚ä¸‹è¯­å¥ï¼š</p>
<figure class="highlight tcl"><table><tr><td class="code"><pre><span class="line">mysql&gt; select rand() from dual;</span><br><span class="line">+--------------------+</span><br><span class="line">| rand()             |</span><br><span class="line">+--------------------+</span><br><span class="line">| <span class="number">0.7727739147588367</span> |</span><br><span class="line">+--------------------+</span><br><span class="line"><span class="number">1</span> row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select last_insert_id() from dual;</span><br><span class="line">+------------------+</span><br><span class="line">| last_insert_id() |</span><br><span class="line">+------------------+</span><br><span class="line">|                <span class="number">0</span> |</span><br><span class="line">+------------------+</span><br><span class="line"><span class="number">1</span> row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select sysdate() from dual;</span><br><span class="line">+---------------------+</span><br><span class="line">| sysdate()           |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="number">2020</span><span class="number">-05</span><span class="number">-19</span> <span class="number">01</span>:<span class="number">56</span>:<span class="number">36</span> |</span><br><span class="line">+---------------------+</span><br><span class="line"><span class="number">1</span> row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
<p>DUALè¡¨æ˜¯ä¸€å¼ è™šæ‹Ÿè¡¨ï¼Œçº¯ç²¹æ˜¯ä¸ºäº†æ»¡è¶³ select from whereè¿™ä¸€è¯­æ³•ä¹ æƒ¯è€Œè®¾ç½®çš„ã€‚</p>
<p>å®é™…åº”ç”¨ä¸­å¯ä»¥ç”¨äºï¼Œæ¡ä»¶æŸ¥è¯¢ä¸å­˜åœ¨åˆ™æ’å…¥çš„æ“ä½œï¼š</p>
<p>æ¯”å¦‚æ–°å»ºä¸€ä¸ªè§’è‰²è¡¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure for role</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS `role`;</span><br><span class="line">CREATE TABLE `role` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(255) DEFAULT NULL,</span><br><span class="line">  `no` int(11) NOT NULL,</span><br><span class="line">  `type` int(11) DEFAULT NULL,</span><br><span class="line">  `remark` varchar(255) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`seqid`,`no`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure>
<p>æ¡ä»¶æ’å…¥è¯­å¥å¯ä»¥å¦‚ä¸‹ï¼š</p>
<p>å…ˆselect * from role where name=â€˜xxooâ€™;åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œå†insert into role (id, name, no, type, remark ) values (â€¦);</p>
<p>ä½¿ç”¨DUALè¡¨ä¸€æ¡è¯­å¥æå®šï¼š</p>
<p>insert into role  (id, name, no, type, remark ) select 123, â€˜test-dualâ€™, 456, 1, â€˜test-dualâ€™ from dual where not exists (select * from role where name=â€˜test-dualâ€™);</p>
<h3 id="æ—¥å¿—">æ—¥å¿—</h3>
<p>Mysqlæ—¥å¿—ç±»å‹ï¼š</p>
<ol>
<li>
<p>redo logï¼š åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å…ˆå†™redo logï¼Œä»¥é˜²å‘ç”Ÿæ•…éšœæ—¶ï¼Œåœ¨æ¢å¤çš„æ—¶å€™æ ¹æ®redo logè¿›è¡Œé‡åšæ—¥å¿—ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§</p>
</li>
<li>
<p>undo logï¼šåœ¨äº‹åŠ¡å¼€å§‹å‰å°†å½“å‰æ•°æ®åº“ç‰ˆæœ¬ç”Ÿæˆundo logï¼Œç”¨äºäº‹åŠ¡å›æ»šæ“ä½œ</p>
</li>
<li>
<p>bin logï¼šç”¨äºä¸»ä»å¤åˆ¶ï¼Œä»åº“è¿æ¥åˆ°ä¸»åº“ï¼Œè¯»å–bin logè¿›è¡Œä¸»ä»åŒæ­¥ã€‚åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™ä¼šåˆ·æ–°bin log</p>
</li>
<li>
<p>relay logï¼šç”¨äºä¸»ä»å¤åˆ¶ï¼Œä»åº“å°†ä¸»åº“è¯»åˆ°çš„binlogå¤åˆ¶åˆ°ä»åº“çš„relay logä¸­ï¼Œç„¶åå›æ”¾relay logä»¥è¾¾åˆ°ä¸»ä»åŒæ­¥</p>
</li>
<li>
<p>error log:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-error	= /var/log/mysql/error.log</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>query log</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">general_log_file=/var/log/mysql/query.log</span><br><span class="line">general_log=ON</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>slow query log</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#1. æŸ¥çœ‹mysqlé…ç½®æ–‡ä»¶</span><br><span class="line">mysql --help | grep my.cnf</span><br><span class="line">/etc/my.cnf /etc/mysql/my.cnf /usr/etc/my.cnf ~/.my.cnf</span><br><span class="line"></span><br><span class="line">#2. ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼švim /etc/my.cnf</span><br><span class="line">slow_query_log=ON</span><br><span class="line">slow_query_log_file=/var/log/slowmysql.log</span><br><span class="line">long_query_time=10</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="æŸ¥çœ‹æŸä¸ªæ“ä½œçš„è¯­æ³•">æŸ¥çœ‹æŸä¸ªæ“ä½œçš„è¯­æ³•</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; ? create table</span><br><span class="line">Name: &apos;CREATE TABLE&apos;</span><br><span class="line">Description:</span><br><span class="line">Syntax:</span><br><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</span><br><span class="line">    (create_definition,...)</span><br><span class="line">    [table_options]</span><br><span class="line">    [partition_options]</span><br><span class="line">    </span><br><span class="line">mysql&gt; help prepare</span><br><span class="line">Name: &apos;PREPARE&apos;</span><br><span class="line">Description:</span><br><span class="line">Syntax:</span><br><span class="line">PREPARE stmt_name FROM preparable_stmt</span><br></pre></td></tr></table></figure>
<h3 id="å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™">å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™</h3>
<p>å­—ç¬¦é›†æŒ‡å®šå­—ç¬¦çš„ç¼–ç æ–¹å¼ã€‚æ¯”å¦‚Mysqlæ¨èä½¿ç”¨çš„å­—ç¬¦é›†ä¸ºï¼šutf8mb4</p>
<p>æ ¡å¯¹è§„åˆ™åˆ¶å®šå­—ç¬¦å¦‚ä½•æ’åºåŠæ¯”è¾ƒå¤§å°ã€‚æ¯”å¦‚Mysqlæ¨èä½¿ç”¨çš„æ ¡å¯¹è§„åˆ™ä¸ºï¼šutf8mb4_unicode_ci ï¼ˆciç»“å°¾è¡¨ç¤ºcase insensitiveï¼‰</p>
<p>Mysqlå¯¹å­—ç¬¦é›†çš„è½¬æ¢å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®åº“æ•°æ®ï¼Œå‘é€çš„æ•°æ®ä½¿ç”¨character_set_clientå­—ç¬¦é›†</li>
<li>MySQLå®ä¾‹æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ•°æ®åï¼Œå°†å…¶è½¬æ¢ä¸ºcharacter_set_connectionå­—ç¬¦é›†</li>
<li>è¿›è¡Œå†…éƒ¨æ“ä½œæ—¶ï¼Œå°†æ•°æ®å­—ç¬¦é›†è½¬æ¢ä¸ºå†…éƒ¨æ“ä½œå­—ç¬¦é›†ï¼š</li>
<li>ä½¿ç”¨æ¯ä¸ªæ•°æ®å­—æ®µçš„character setè®¾å®šå€¼</li>
<li>è‹¥ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¯¹åº”æ•°æ®è¡¨çš„default character setè®¾å®šå€¼</li>
<li>è‹¥ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¯¹åº”æ•°æ®åº“çš„default character setè®¾å®šå€¼</li>
<li>è‹¥ä¸å­˜åœ¨ï¼Œä½¿ç”¨character_set_serverè®¾å®šå€¼</li>
<li>å°†æ“ä½œç»“æœå€¼ä»å†…éƒ¨æ“ä½œå­—ç¬¦é›†è½¬æ¢ä¸ºcharacter_set_results</li>
</ol>
<p>ä»¥é˜²ä¸­æ–‡æ˜¾ç¤ºä¹±ç ï¼Œå°†character_set_clientã€character_set_connectionã€character_set_resultsã€character_set_serveréƒ½è®¾ç½®ä¸ºutf8mb4ï¼›</p>
<p><strong>æŸ¥çœ‹é»˜è®¤å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &quot;%char%&quot;;</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE &quot;%coll%&quot;;</span><br></pre></td></tr></table></figure>
<p><strong>è®¾ç½®å­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™</strong></p>
<ol>
<li>å¯åŠ¨mysqlæ—¶è®¾ç½®ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">collation-server=utf8mb4_unicode_ci</span><br><span class="line">[client]</span><br><span class="line">default-character-set=utf8mb4</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>åˆ›å»ºæ•°æ®åº“æ—¶æŒ‡å®š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE myDb</span><br><span class="line">  DEFAULT CHARACTER SET utf8mb4</span><br><span class="line">  DEFAULT COLLATE utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>åˆ›å»ºè¡¨æ—¶æŒ‡å®š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE myTb () ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br></pre></td></tr></table></figure>
<p>mysqlé»˜è®¤å­—ç¬¦é›†ä¸ºlatinï¼Œå¦‚æœä¸å­˜å‚¨ä¸­æ–‡å­—ç¬¦ï¼Œä½¿ç”¨é»˜è®¤å³å¯ï¼ŒèŠ‚çœå†…å­˜ï¼Œå¦‚æœè¦å­˜å‚¨ä¸­æ–‡ï¼Œå¯ä»¥å¯¹å­˜å‚¨ä¸­æ–‡çš„ç‰¹å®šå­—æ®µè®¾ç½®å­—ç¬¦é›†</p>
<h3 id="sqlæ³¨å…¥">SQLæ³¨å…¥</h3>
<p>åœ¨è¾“å…¥SQLå‚æ•°çš„åœ°æ–¹è¾“å…¥äº†ç‰¹æ®Šçš„SQLè¯­å¥ã€‚é˜²æ­¢SQLæ³¨å…¥ï¼šå¯¹å‚æ•°è¿›è¡Œæ£€æŸ¥è½¬ä¹‰ã€‚</p>
<p>Mybatisçš„å‚æ•°å¼•ç”¨æ–¹å¼ï¼š<code>#{param}</code>å’Œ<code>${param}</code>ï¼Œå…¶ä¸­<code>#{}</code>å½¢å¼çš„SQLè¯­å¥ä¼šåˆ›å»ºä¸€ä¸ªé¢„ç¼–è¯‘è¯­å¥PreparedStatementï¼Œå‚æ•°ä¼šç”¨ï¼Ÿå ä½ç¬¦æ¥æ ‡è¯†ï¼ŒPreparedStatementé‡Œä¼šå¯¹è¾“å…¥å‚æ•°è¿›è¡Œè½¬ä¹‰å¤„ç†ã€‚è€Œ<code>${}</code>å½¢å¼çš„SQLè¯­å¥ä¼šç›´æ¥ç”¨è¾“å…¥å‚æ•°è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢ã€‚</p>
<p>å¦å¤–PreparedStatementçš„é¢„ç¼–è¯‘åŠŸèƒ½æ˜¯ä¾èµ–Mysqlæ•°æ®åº“æœåŠ¡å™¨çš„ã€‚Mysqlçš„é¢„ç¼–è¯‘åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; prepare selectVodById from &apos;select * from vods where vodid = ?&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Statement prepared</span><br><span class="line"></span><br><span class="line">mysql&gt; set @vodId=&apos;34 or 1 = 1&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; execute selectVodById using @vodId\G</span><br></pre></td></tr></table></figure>
<p>Mysql JDBC Connectoré©±åŠ¨ä»5.0å¼€å§‹é»˜è®¤å…³é—­äº†æœåŠ¡å™¨é¢„ç¼–è¯‘åŠŸèƒ½ï¼Œå°±æ˜¯è¯´PreapredStatementçš„æ‰§è¡Œæ•ˆæœå’ŒStatementåœ¨æœåŠ¡å™¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚åªæœ‰æ˜¾å¼å¼€å¯äº†æœåŠ¡å™¨é¢„ç¼–è¯‘åŠŸèƒ½ï¼ŒPreparedStatementæ‰ä¼šè¢«é¢„ç¼–è¯‘ã€‚ç›´æ¥åœ¨æ•°æ®åº“urlä¸­æ·»åŠ useServerPrepStmts=trueå³å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jdbc:mysql://localhost:3306/test?useServerPrepStmts=true</span><br></pre></td></tr></table></figure>
<h3 id="druidè¿æ¥æ± ç›‘æ§">Druidè¿æ¥æ± +ç›‘æ§</h3>
<p>ä¸€ï¼š é…ç½®æ•°æ®åº“å¯†ç åŠ å¯†</p>
<ol>
<li>æ‰§è¡Œå‘½ä»¤ï¼Œç”Ÿæˆå¯†ç åŠ å¯†åçš„çš„privateKeyã€publicKeyå’ŒåŠ å¯†åçš„password</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -cp druid-1.1.17.jar com.alibaba.druid.filter.config.ConfigTools 12345678</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">privateKey:</span><span class="string">MIIBVQIBADANBgkqhkiG9w0BAQEFAASCAT8wggE7AgEAAkEAjdRL/KlKXM5TjMHSRZC/Gq45a/DvEBXIRBDUHodCmQrs4HkB4kMsEuYJ5i6ID45XUZw8ibyyCNrcx9FNkj6NSwIDAQABAkEAgbMO+jNmSZB1X1cwD2XbHW8OG+Ps+uywg25QTMqs4H55W+D9rThzDpgWBHbj1o8hupKOm1aoeeZf0itIi8TggQIhANrioKxjzAHRpNTTr5KsJWMRjIzhmn3KZCwpyNkZItoxAiEApeDSq/268bRIEsLapBHYfZA6Sy7M4JJCKPxv6pfFhDsCIQCLZk3BvIUOm3+Ic5CbrrrYzzJd/sgvWJhXb/0UFmgV4QIgHCh2+rU+p8sXtP+Yx+MzodT64EpYgwKw8m4vvV34LIMCIGh979qmx/BZk5ZpsOf4Y3H8V9G8ApTIHUCORs5gbIDn</span></span><br><span class="line"><span class="attr">publicKey:</span><span class="string">MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAI3US/ypSlzOU4zB0kWQvxquOWvw7xAVyEQQ1B6HQpkK7OB5AeJDLBLmCeYuiA+OV1GcPIm8sgja3MfRTZI+jUsCAwEAAQ==</span></span><br><span class="line"><span class="attr">password:</span><span class="string">WusbaYnEH4csLTFPt/XFOoQ6oLsPFDV//UVQCW0+gk+r0jx0qvBvZRBH9OVbjV9Wuw8ELRUsWtnQYHXuamkz1g==</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>å°†publicKeyå’ŒåŠ å¯†åçš„passwordå†™å…¥é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">datasource:</span> </span><br><span class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://127.0.0.1:3306/db?useUnicode=yes&amp;characterEncoding=UTF-8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">WusbaYnEH4csLTFPt/XFOoQ6oLsPFDV//UVQCW0+gk+r0jx0qvBvZRBH9OVbjV9Wuw8ELRUsWtnQYHXuamkz1g==</span></span><br><span class="line"><span class="attr">    druid:</span></span><br><span class="line">    	<span class="attr">filter:</span></span><br><span class="line"><span class="attr">        config:</span></span><br><span class="line"><span class="attr">          enabled:</span> <span class="literal">true</span></span><br><span class="line">    	<span class="attr">connection-properties:</span> <span class="string">config.decrypt=true;config.decrypt.key=MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAI3US/ypSlzOU4zB0kWQvxquOWvw7xAVyEQQ1B6HQpkK7OB5AeJDLBLmCeYuiA+OV1GcPIm8sgja3MfRTZI+jUsCAwEAAQ==</span></span><br></pre></td></tr></table></figure>
<p>äºŒï¼šé…ç½®ç›‘æ§</p>
<ol>
<li>é…ç½®æ–‡ä»¶æ·»åŠ å…·ä½“çš„filterï¼Œå¦‚ä¸‹</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">	<span class="attr">datasource:</span></span><br><span class="line"><span class="attr">    druid:</span></span><br><span class="line"><span class="attr">      stat-view-servlet:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      web-stat-filter:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      filters:</span> <span class="string">stat,wall,slf4j</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>å¯åŠ¨åº”ç”¨ï¼Œè®¿é—®/druid/index.html</li>
</ol>
<h3 id="groupbyhavingä½¿ç”¨åœºæ™¯">GroupBy+Havingä½¿ç”¨åœºæ™¯</h3>
<p>æ¯”å¦‚å‘˜å·¥è¡¨employeeå¦‚ä¸‹ï¼š</p>
<p>â€œidâ€	â€œnameâ€	â€œdeptâ€	â€œsalaryâ€	â€œhire_dateâ€<br>
â€œ1â€	â€œå¼ ä¸‰â€	â€œå¼€å‘éƒ¨â€	â€œ1200000â€	&quot;1/10/2019 17:34:05&quot;<br>
â€œ2â€	â€œæå››â€	â€œå¼€å‘éƒ¨â€	â€œ1500000â€	&quot;21/4/2020 17:34:48&quot;<br>
â€œ3â€	â€œç‹äº”â€	â€œè®¾è®¡éƒ¨â€	â€œ900000â€	&quot;4/8/2020 17:35:23&quot;<br>
â€œ4â€	â€œåˆ˜å¡â€	â€œæµ‹è¯•éƒ¨â€	â€œ1500000â€	&quot;20/10/2020 17:36:16&quot;<br>
â€œ5â€	â€œé’±å…«â€	â€œé”€å”®éƒ¨â€	â€œ800000â€	&quot;1/4/2019 17:36:48&quot;<br>
â€œ6â€	â€œå­™ä¹…â€	â€œé”€å”®éƒ¨â€	â€œ950000â€	&quot;28/4/2020 17:37:29&quot;<br>
â€œ7â€	â€œéº»å­â€	â€œè®¾è®¡éƒ¨â€	â€œ1100000â€	&quot;15/10/2020 17:38:10&quot;<br>
â€œ8â€	â€œæ›¹å¼¯â€	â€œå¼€å‘éƒ¨â€	â€œ2200000â€	â€œ20/7/2020 17:39:03â€</p>
<p>æŸ¥è¯¢è‡ª2020å¹´ä»¥æ¥å…¥èŒçš„å‘˜å·¥ä¸­å“ªä¸ªéƒ¨é—¨çš„æœ€ä½å·¥èµ„æ˜¯æœ€ä½çš„ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> dept, <span class="keyword">min</span>(salary) <span class="keyword">as</span> <span class="keyword">minimum</span> <span class="keyword">from</span> employee <span class="keyword">where</span> hire_date &gt; <span class="string">'2020-01-01'</span> <span class="keyword">group</span> <span class="keyword">by</span> dept <span class="keyword">having</span> <span class="keyword">minimum</span>&gt;<span class="number">1000000</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">minimum</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>mavené¡¹ç›®éƒ¨ç½²å®è·µ</title>
    <url>/article/maven%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<p>ä½¿ç”¨mavenæ„å»ºspring booté¡¹ç›®ï¼Œä¸”ä½¿ç”¨mavenæ’ä»¶æ‰“åŒ…ä¸åŒ…å«ä¾èµ–çš„ç˜¦èº«jaråŒ…</p>
<h2 id="æ ‡å‡†pom">æ ‡å‡†pom</h2>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--é»˜è®¤æ‰“åŒ…ç±»å‹ä¸ºjar--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>server-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Spring Boot çˆ¶é¡¹ç›®--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.M5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--æ‰“åŒ…ä¸åŒ…å«ä¾èµ–çš„thin jaråŒ…ï¼Œå¹¶æŒ‡å®šå¯åŠ¨ç±»ã€classpathï¼Œå¹¶æŒ‡å®šä¸æ‰“åŒ…èµ„æº--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.Application<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--ä¸æ‰“åŒ…èµ„æºæ–‡ä»¶ï¼Œcopy-resourceæ’ä»¶ä¼šæ‹·è´åˆ°ç›¸åº”çš„ç›®å½•å»--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>bin/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>config/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--ä¸ç¼–è¯‘testç±»--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--ä¸æ‰§è¡Œå•å…ƒæµ‹è¯•--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--æ‹·è´ä¾èµ– copy-dependencies --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-dependencies<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.basedir&#125;/release/lib<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">overWriteReleases</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteReleases</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">overWriteSnapshots</span>&gt;</span>false<span class="tag">&lt;/<span class="name">overWriteSnapshots</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">overWriteIfNewer</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overWriteIfNewer</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--æ‹·è´èµ„æºæ–‡ä»¶ copy-resources --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>copy-resources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>copy-resources<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                                        <span class="comment">&lt;!--æ‹·è´è„šæœ¬å’Œé…ç½®æ–‡ä»¶--&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">include</span>&gt;</span>bin/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">include</span>&gt;</span>config/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;/target<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                                        <span class="comment">&lt;!--æ‹·è´thin jaråŒ…--&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">include</span>&gt;</span>*.jar<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">directory</span>&gt;</span>$&#123;project.basedir&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                                        <span class="comment">&lt;!--æ‹·è´å…¶ä»–é…ç½®æ–‡ä»¶--&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">include</span>&gt;</span>others.conf<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.basedir&#125;/release<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-resources-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--å½“èµ„æºæ–‡ä»¶ä½¿ç”¨$&#123;&#125; æˆ– @@ å¼•ç”¨pomé‡Œçš„å˜é‡ï¼Œæ‰§è¡Œæ›¿æ¢--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">delimiters</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">delimiter</span>&gt;</span>$&#123;*&#125;<span class="tag">&lt;/<span class="name">delimiter</span>&gt;</span><span class="comment">&lt;!-- to keep the default behavior --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">delimiter</span>&gt;</span>@<span class="tag">&lt;/<span class="name">delimiter</span>&gt;</span><span class="comment">&lt;!-- to add Ant-like tokens style --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">delimiters</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">useDefaultDelimiters</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useDefaultDelimiters</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">nonFilteredFileExtensions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nonFilteredFileExtension</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">nonFilteredFileExtension</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nonFilteredFileExtension</span>&gt;</span>bat<span class="tag">&lt;/<span class="name">nonFilteredFileExtension</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nonFilteredFileExtension</span>&gt;</span>bytes<span class="tag">&lt;/<span class="name">nonFilteredFileExtension</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">nonFilteredFileExtensions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--æ‰§è¡Œcleançš„æ—¶å€™åˆ é™¤logsç›®å½•--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-clean-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">filesets</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">fileset</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>logs<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">fileset</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">filesets</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--å½“èµ„æºæ–‡ä»¶ä½¿ç”¨$&#123;&#125; æˆ– @@ å¼•ç”¨pomé‡Œçš„å˜é‡ï¼Œæ‰§è¡Œæ›¿æ¢--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">testResources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">testResource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/test/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--å½“èµ„æºæ–‡ä»¶ä½¿ç”¨$&#123;&#125; æˆ– @@ å¼•ç”¨pomé‡Œçš„å˜é‡ï¼Œæ‰§è¡Œæ›¿æ¢--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">testResource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">testResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>develop-qj<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span><span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>local<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span><span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span><span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>product<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span><span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--æŒ‡å®šé¡¹ç›®ä¾èµ–jaråŒ…--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--ç»Ÿä¸€ç®¡ç†ä¾èµ–çš„ç‰ˆæœ¬--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">&lt;!--æŒ‡å®šä¸‹è½½jaråŒ…çš„è¿œç¨‹ä»“åº“--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-release<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--æŒ‡å®šä¸‹è½½æ’ä»¶çš„è¿œç¨‹ä»“åº“--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-release<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="mavenæ‰“åŒ…">mavenæ‰“åŒ…</h2>
<p>æ‰§è¡Œ mvn clean package -Pprofile</p>
<p>ä¾æ¬¡æ‰§è¡Œï¼š</p>
<p>maven-clean-plugin:3.0.0:clean</p>
<p>åˆ é™¤targetç›®å½•å’Œæœ¬åœ°logsç›®å½•</p>
<p>maven-resources-plugin:3.0.2:resources</p>
<p>æ‹·è´src/main/resourcesä¸‹çš„èµ„æºæ–‡ä»¶åˆ°target/classesç›®å½•ä¸‹</p>
<p>maven-compiler-plugin:3.7.0:compile</p>
<p>ç¼–è¯‘src/main/java ç±»æ–‡ä»¶åˆ°target/classesç›®å½•ä¸‹</p>
<p>maven-jar-plugin:3.1.0:jar</p>
<p>æ„å»ºthin jaråŒ…åˆ°targetç›®å½•ä¸‹</p>
<p>maven-dependency-plugin:3.0.1:copy-dependencies</p>
<p>æ‹·è´ä¾èµ–jaråŒ…åˆ°release/libç›®å½•ä¸‹</p>
<p>maven-resources-plugin:3.0.2:copy-resources</p>
<p>æ‹·è´è‡ªå®šä¹‰èµ„æºæ–‡ä»¶åˆ°releaseç›®å½•ä¸‹</p>
<p>æ‰“åŒ…åçš„é¡¹ç›®å’Œç›¸å…³èµ„æºæ–‡ä»¶ä¾èµ–jaråŒ…éƒ½æ”¾åœ¨releaseç›®å½•ä¸‹ï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/maven-project-release-dir.jpg" alt=""></p>
<h2 id="å‘å¸ƒ">å‘å¸ƒ</h2>
<p>rysncè„šæœ¬ï¼šå…¶ä¸­test_envæ˜¯åœ¨~/.ssh/configä¸‹å®šä¹‰çš„æœºå™¨åˆ«å</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">touch ./release/application.pid</span><br><span class="line">chmod a+x ./release/bin/*.sh</span><br><span class="line">release_dir=/home/server-demo/release/</span><br><span class="line">zip -r server-demo-release.zip ./release/</span><br><span class="line">rsync -zvrP --delete --rsync-path=<span class="string">"mkdir -p <span class="variable">$release_dir</span> &amp;&amp; rm -rf <span class="variable">$release_dir</span>/*.jar &amp;&amp; rsync"</span>  ./server-demo-release.zip test_env:<span class="variable">$release_dir</span></span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œreleaseç›®å½•åŒ…å«äº†è¦è¿è¡Œçš„javaç¨‹åºçš„æ‰€æœ‰ç»„ä»¶ï¼Œå°†æ­¤ç›®å½•å‹ç¼©æˆzipåŒ…ï¼Œä½¿ç”¨rsyncè„šæœ¬ä¸Šä¼ åˆ°ç›¸åº”çš„æœåŠ¡å™¨ï¼Œå¯åŠ¨å³å¯ã€‚</p>
<p>æ ¹æ®éœ€æ±‚å¯å°†releaseç›®å½•ä¸‹çš„æ–‡ä»¶åˆ†å¼€ä¸Šä¼ ï¼Œä¾‹å¦‚libç›®å½•ä¸‹çš„ä¾èµ–jaråŒ…æ²¡æœ‰æ›´æ–°å°±ä¸éœ€è¦æ¯æ¬¡é‡å¤æ ¡éªŒä¸Šä¼ äº†ã€‚</p>
]]></content>
      <tags>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>v2ray-kill-GFW</title>
    <url>/article/v2ray-kill-GFW/</url>
    <content><![CDATA[<h3 id="v2ray-æœåŠ¡ç«¯-æ­åœ¨vpsæœåŠ¡å™¨ä¸Šé€šè¿‡docker-è¿è¡Œ">v2ray æœåŠ¡ç«¯ æ­åœ¨vpsæœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡docker è¿è¡Œ</h3>
<p>é…ç½®æ–‡ä»¶ï¼š/etc/v2ray/config.jsonï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶ç”Ÿæˆå™¨ <a href="https://intmainreturn0.com/v2ray-config-gen/#" target="_blank" rel="noopener">https://intmainreturn0.com/v2ray-config-gen/#</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;log&quot;: &#123;</span><br><span class="line">        &quot;access&quot;: &quot;/var/log/v2ray/access.log&quot;,</span><br><span class="line">        &quot;error&quot;: &quot;/var/log/v2ray/error.log&quot;,</span><br><span class="line">        &quot;loglevel&quot;: &quot;warning&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;inbound&quot;: &#123;</span><br><span class="line">        &quot;port&quot;: 18888,</span><br><span class="line">        &quot;protocol&quot;: &quot;vmess&quot;,</span><br><span class="line">        &quot;settings&quot;: &#123;</span><br><span class="line">            &quot;clients&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;id&quot;: &quot;5baf256b-ee48-7baf-3a88-9e6a452e16f4&quot;,</span><br><span class="line">                    &quot;level&quot;: 1,</span><br><span class="line">                    &quot;alterId&quot;: 64</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;outbound&quot;: &#123;</span><br><span class="line">        &quot;protocol&quot;: &quot;freedom&quot;,</span><br><span class="line">        &quot;settings&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;inboundDetour&quot;: [],</span><br><span class="line">    &quot;outboundDetour&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;protocol&quot;: &quot;blackhole&quot;,</span><br><span class="line">            &quot;settings&quot;: &#123;&#125;,</span><br><span class="line">            &quot;tag&quot;: &quot;blocked&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;routing&quot;: &#123;</span><br><span class="line">        &quot;strategy&quot;: &quot;rules&quot;,</span><br><span class="line">        &quot;settings&quot;: &#123;</span><br><span class="line">            &quot;rules&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;field&quot;,</span><br><span class="line">                    &quot;ip&quot;: [</span><br><span class="line">                        &quot;0.0.0.0/8&quot;,</span><br><span class="line">                        &quot;10.0.0.0/8&quot;,</span><br><span class="line">                        &quot;100.64.0.0/10&quot;,</span><br><span class="line">                        &quot;127.0.0.0/8&quot;,</span><br><span class="line">                        &quot;169.254.0.0/16&quot;,</span><br><span class="line">                        &quot;172.16.0.0/12&quot;,</span><br><span class="line">                        &quot;192.0.0.0/24&quot;,</span><br><span class="line">                        &quot;192.0.2.0/24&quot;,</span><br><span class="line">                        &quot;192.168.0.0/16&quot;,</span><br><span class="line">                        &quot;198.18.0.0/15&quot;,</span><br><span class="line">                        &quot;198.51.100.0/24&quot;,</span><br><span class="line">                        &quot;203.0.113.0/24&quot;,</span><br><span class="line">                        &quot;::1/128&quot;,</span><br><span class="line">                        &quot;fc00::/7&quot;,</span><br><span class="line">                        &quot;fe80::/10&quot;</span><br><span class="line">                    ],</span><br><span class="line">                    &quot;outboundTag&quot;: &quot;blocked&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>docker æ‹‰ v2rayé•œåƒ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker pull v2ray/official</span><br></pre></td></tr></table></figure>
<p>docker run v2ray å®¹å™¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d --name v2ray -v /etc/v2ray:/etc/v2ray -v /var/log/v2ray:/var/log/v2ray -p 18888:18888 --restart=always v2ray/official  v2ray -config=/etc/v2ray/config.json</span><br></pre></td></tr></table></figure>
<h3 id="v2ray-å®¢æˆ·ç«¯v2rayu-macå®¢æˆ·ç«¯">v2ray å®¢æˆ·ç«¯ï¼šv2rayU macå®¢æˆ·ç«¯</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">v2ray é…ç½®é»˜è®¤ç›‘å¬sock ç«¯å£ 1080ï¼Œé…ç½®v2rayæœåŠ¡å™¨inboundçš„åœ°å€ã€ç«¯å£ã€id</span><br><span class="line">æ‰€ç”¨æµè§ˆå™¨ä»£ç†è½¯ä»¶ï¼šSwitchyOmegaï¼Œé…ç½®ä»£ç†åè®®åœ°å€ç«¯å£ï¼šsock | 127.0.0.1 | 1080</span><br><span class="line">v2ray å®¢æˆ·ç«¯ä¼šå°†é€šè¿‡ sockåè®® + 1080ç«¯å£æ”¶åˆ°çš„æ•°æ®ç”¨vmessåè®®å°è£…å‘é€ç»™v2rayæœåŠ¡å™¨</span><br></pre></td></tr></table></figure>
<h3 id="v2ray-æœåŠ¡å™¨édockerä¸€é”®æ­å»º">v2ray æœåŠ¡å™¨édockerä¸€é”®æ­å»ºï¼š</h3>
<p>bash &lt;(curl -L -s <a href="https://install.direct/go.sh" target="_blank" rel="noopener">https://install.direct/go.sh</a>)</p>
<p>vi /etc/v2ray/config.json</p>
<p>service v2ray restart</p>
<h3 id="kill-gfw-åŸç†">Kill GFW åŸç†</h3>
<p>æœ¬åœ°ä½¿ç”¨æ­£å‘ä»£ç†v2rayå®¢æˆ·ç«¯ï¼Œv2rayå®¢æˆ·ç«¯ç›‘å¬åœ¨1080ç«¯å£ï¼Œé…ç½®æµè§ˆå™¨ä»£ç†æ’ä»¶SwitchyOmegaå°†æ‰€æœ‰httpæµé‡ç”¨sock5åè®®å°è£…è½¬åˆ°æœ¬åœ°localhost:1080ï¼Œv2rayå®¢æˆ·ç«¯å°†æ”¶åˆ°çš„sock5æ•°æ®ç”¨vmessåè®®å°è£…å‘é€ç»™v2rayæœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è§£æå‡ºé‡Œé¢çš„httpæµé‡ï¼Œå‘èµ·httpè¯·æ±‚ï¼Œæ‹¿åˆ°å“åº”åï¼Œç»§ç»­ç”¨vmesså°è£…ï¼Œå‘å›v2rayå®¢æˆ·ç«¯ï¼Œv2rayå®¢æˆ·ç«¯è§£æå‡ºsock5æ•°æ®ä»1080ç«¯å£å‘é€å›æµè§ˆå™¨ä»£ç†æ’ä»¶SwitchyOmegaï¼ŒSwitchyOmegaå†è§£æå‡ºhttpå“åº”æ•°æ®ï¼Œè¿”å›ç»™æµè§ˆå™¨</p>
]]></content>
      <tags>
        <tag>v2ray</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ†å¸ƒå¼é”</title>
    <url>/article/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    <content><![CDATA[<h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨é”">ä¸ºä»€ä¹ˆä½¿ç”¨é”</h3>
<p>ä¸¤ä¸ªåŸå› ï¼š</p>
<ol>
<li>
<p>æ•ˆç‡</p>
<p>é¿å…å¤šä¸ªå®¢æˆ·ç«¯é‡å¤ç›¸åŒçš„å·¥ä½œï¼Œæ­¤æ—¶å¯¹å…±äº«èµ„æºçš„æ“ä½œéœ€è¦æ»¡è¶³å¹‚ç­‰æ€§ï¼Œæ“ä½œå¤šæ¬¡çš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚è¿™ç§æƒ…å†µä¸‹åŠ é”å°±æ˜¯ä¸ºäº†é¿å…é‡å¤ç›¸åŒçš„å·¥ä½œã€‚</p>
</li>
<li>
<p>æ­£ç¡®æ€§</p>
<p>é¿å…å¤šä¸ªå®¢æˆ·ç«¯æ“ä½œåŒä¸€ä»½å…±äº«èµ„æºæ—¶ç”±äºç¯å¢ƒåŸå› å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œæ­¤æ—¶å¯¹å…±äº«èµ„æºçš„æ“ä½œä¸æ»¡è¶³å¹‚ç­‰æ€§ï¼Œè¿™ç§æƒ…å†µä¸‹åŠ é”å°±æ˜¯ä¸ºäº†ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§ã€‚</p>
</li>
</ol>
<p><strong>é”çš„ä½œç”¨çš„å°±æ˜¯ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥ä¸´ç•ŒåŒºæ‰§è¡Œä»£ç </strong></p>
<h3 id="ä»€ä¹ˆæ˜¯é”">ä»€ä¹ˆæ˜¯é”</h3>
<p><strong>Linux è‡ªæ—‹é”</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å•å¤„ç†å™¨è‡ªæ—‹é”çš„å·¥ä½œæµç¨‹æ˜¯:</span><br><span class="line">å…³é—­å†…æ ¸æŠ¢å -&gt;è¿è¡Œä¸´ç•ŒåŒºä»£ç -&gt;å¼€å¯å†…æ ¸æŠ¢å ã€‚</span><br><span class="line">æ›´åŠ å®‰å…¨çš„å•å¤„ç†å™¨è‡ªæ—‹é”å·¥ä½œæµç¨‹æ˜¯:</span><br><span class="line">ä¿å­˜IFå¯„å­˜å™¨-&gt;å…³é—­å½“å‰CPUä¸­æ–­-&gt;å…³é—­å†…æ ¸æŠ¢å -&gt;è¿è¡Œä¸´ç•ŒåŒºä»£ç -&gt;å¼€å¯å†…æ ¸æŠ¢å -&gt;å¼€å¯å½“å‰CPUä¸­æ–­-&gt;æ¢å¤IFå¯„å­˜å™¨ã€‚</span><br><span class="line"></span><br><span class="line">å¤šå¤„ç†å™¨è‡ªæ—‹é”çš„å·¥ä½œæµç¨‹æ˜¯:</span><br><span class="line">å…³é—­å†…æ ¸æŠ¢å -&gt;ï¼ˆå¿™ç­‰å¾…-&gt;)è·å–è‡ªæ—‹é”-&gt;è¿è¡Œä¸´ç•ŒåŒºä»£ç -&gt;é‡Šæ”¾è‡ªæ—‹é”-&gt;å¼€å¯å†…æ ¸æŠ¢å ã€‚</span><br><span class="line">æ›´åŠ å®‰å…¨çš„å¤šå¤„ç†å™¨è‡ªæ—‹é”å·¥ä½œæµç¨‹æ˜¯: </span><br><span class="line">ä¿å­˜IFå¯„å­˜å™¨-&gt;å…³é—­å½“å‰CPUä¸­æ–­-&gt;å…³é—­å†…æ ¸æŠ¢å -&gt;ï¼ˆå¿™ç­‰å¾…-&gt;)è·å–è‡ªæ—‹é”-&gt;è¿è¡Œä¸´ç•ŒåŒºä»£ç -&gt;é‡Šæ”¾è‡ªæ—‹é”-&gt;å¼€å¯å†…æ ¸æŠ¢å -&gt;å¼€å¯å½“å‰CPUä¸­æ–­-&gt;æ¢å¤IFå¯„å­˜å™¨ã€‚</span><br></pre></td></tr></table></figure>
<p><strong>Linux äº’æ–¥é”</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">äº’æ–¥é”æ˜¯åŸºäºè‡ªæ—‹é”ã€ç­‰å¾…é˜Ÿåˆ—ã€æ•´å‹å˜é‡çš„å¼•ç”¨è®¡æ•°å™¨çš„ç»“æ„ä½“å°è£…ï¼Œ</span><br><span class="line">å†…éƒ¨çš„åŠ é”é‡Šæ”¾é”çš„é€»è¾‘éƒ½æ˜¯åŸºäºè‡ªæ—‹é”å’ŒCPUåŸå­æ“ä½œå®Œæˆçš„</span><br></pre></td></tr></table></figure>
<p>Javaè¯­è¨€å±‚é¢çš„é”éƒ½æ˜¯åŸºäºLinuxé”å®ç°çš„</p>
<h3 id="æœ¬åœ°é”">æœ¬åœ°é”</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æœ¬åœ°é”æ²¡æœ‰é”è¶…æ—¶çš„æœºåˆ¶ï¼Œä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”å,å…¶ä»–çº¿ç¨‹åªèƒ½é˜»å¡ç­‰å¾…</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testThreadPoolException</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">       Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">       Object object = <span class="keyword">new</span> Object();</span><br><span class="line">       <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               System.out.println(Thread.currentThread().getName() + <span class="string">"ç¡30såé€šçŸ¥"</span>);</span><br><span class="line">               Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">               object.notify();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;).start();</span><br><span class="line">       Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">         	<span class="keyword">try</span> &#123;</span><br><span class="line">               lock.lock();</span><br><span class="line">           		System.out.println(Thread.currentThread().getName() + <span class="string">"ç­‰å¾…sleepçº¿ç¨‹30såé€šçŸ¥"</span>);</span><br><span class="line">             	<span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                   object.wait();</span><br><span class="line">               &#125;</span><br><span class="line">             	System.out.println(Thread.currentThread().getName() + <span class="string">"æ”¶åˆ°sleepçº¿ç¨‹30såé€šçŸ¥ï¼Œé€€å‡ºçº¿ç¨‹ä¸é‡Šæ”¾é”"</span>);</span><br><span class="line">           		Thread.currentThread().stop();</span><br><span class="line">       		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               lock.unlock();</span><br><span class="line">           &#125; </span><br><span class="line">       &#125;);</span><br><span class="line">       thread.start();</span><br><span class="line">       <span class="comment">// çº¿ç¨‹æ± å¯¹ä»»åŠ¡å¼‚å¸¸é»˜è®¤ä¸ä½œå¤„ç†</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">           <span class="comment">// æœ¬åœ°é”æ²¡æœ‰é”è¶…æ—¶çš„æœºåˆ¶ï¼Œä¸€ä¸ªçº¿ç¨‹è·å–åˆ°é”å,å…¶ä»–çº¿ç¨‹åªèƒ½é˜»å¡ç­‰å¾…</span></span><br><span class="line">           executorService.execute(() -&gt; &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   lock.lock();</span><br><span class="line">                   System.out.println(Thread.currentThread().getName() + <span class="string">"æŒæœ‰é”"</span>);</span><br><span class="line">                   <span class="comment">//for (;;)&#123;&#125;</span></span><br><span class="line">                   <span class="comment">//Thread.currentThread().interrupt();</span></span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   lock.unlock();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">//System.out.println(1/0);</span></span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">       System.out.println(executorService.isTerminated());</span><br><span class="line">       <span class="comment">//çº¿ç¨‹æ± é‡Œæœ‰édaemonçº¿ç¨‹åœ¨è¿è¡Œä¸­ï¼ŒJVMä¸é€€å‡º</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¯»å†™é”">è¯»å†™é”</h3>
<p>è¯»å†™é”åº”ç”¨åœ¨è¯»å¤šå†™å°‘çš„åœºåˆï¼Œæ¯”å¦‚ç¼“å­˜</p>
<p>è¯»å†™é”æ˜¯ä¸¤ä¸ªé”çš„ç»„åˆï¼Œä¸»è¦å»ºç«‹äº†ä»¥ä¸‹å…³ç³»ï¼š</p>
<ol>
<li>è¯»é”ä¸å†™é”äº’æ–¥ï¼ˆæ¯”å¦‚ï¼šæ›´æ–°ç¼“å­˜æ—¶åŠ å†™é”ï¼Œè¯»å–ç¼“å­˜æ—¶åŠ è¯»é”ã€‚åˆ™æ›´æ–°ç¼“å­˜æ—¶ï¼Œè¯»å–ç¼“å­˜çš„çº¿ç¨‹è¦é˜»å¡ç­‰å¾…ï¼‰</li>
<li>è¯»é”ä¸è¯»é”å…±äº«ï¼ˆå¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘åŒæ—¶è¯»å–ç¼“å­˜ï¼‰</li>
</ol>
<h3 id="åˆ†å¸ƒå¼é”-spring-integration-redis">åˆ†å¸ƒå¼é”-Spring-Integration-Redis</h3>
<p>Redisä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªå‘½ä»¤ï¼ŒLuaè„šæœ¬çš„è¿è¡Œä¸å…¶ä»–çš„Rediså‘½ä»¤ç›¸åŒï¼Œéƒ½æ˜¯åŸå­æ“ä½œ</p>
<p><strong>è·å–é”</strong>ï¼ˆluaè„šæœ¬æ‰§è¡Œå‘½ä»¤ï¼‰</p>
<p>luaè„šæœ¬é€»è¾‘ï¼š</p>
<p>å…ˆåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Ÿ</p>
<p>keyå­˜åœ¨ï¼Œåˆ™åˆ¤æ–­keyå¯¹åº”valueæ˜¯å¦å’Œæœ¬æ¬¡è¦è®¾ç½®çš„å€¼ä¸€è‡´ï¼Œä¸€è‡´åˆ™è®¾ç½®è¶…æ—¶æ—¶é—´</p>
<p>keyä¸å­˜åœ¨æˆ–è€…keyå¯¹åº”valueä¸ä¸€è‡´ï¼Œåˆ™æ–°è®¾ç½®key-valueï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆsetçš„å€¼è¦ä¿æŒå”¯ä¸€ï¼Œå¯ä»¥ä½¿ç”¨uuidï¼Œä»¥é˜²è¯¯åˆ å…¶ä»–å®¢æˆ·ç«¯è·å–åˆ°çš„é”ã€‚åœºæ™¯ï¼šã€å®¢æˆ·ç«¯Aè·å–é”æˆåŠŸåï¼Œç”±äºæ“ä½œé˜»å¡è¾ƒé•¿æ—¶é—´ï¼Œkeyè¿‡æœŸåˆ é™¤äº†ã€‚ç„¶åå®¢æˆ·ç«¯Bè·å–é”æˆåŠŸï¼Œåœ¨Bæ“ä½œæœŸé—´ï¼Œå®¢æˆ·ç«¯Aåˆå°è¯•å»é‡Šæ”¾é”ï¼Œå¦‚æœæ²¡æœ‰valueåˆ¤æ–­ï¼Œå°±ä¼šé€ æˆå®¢æˆ·ç«¯Aé‡Šæ”¾äº†å®¢æˆ·ç«¯Bè·å–åˆ°çš„é”ã€‘ï¼‰</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> lockClientId = redis.call(<span class="string">'GET'</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">if</span> lockClientId == ARGV[<span class="number">1</span>] <span class="keyword">then</span></span><br><span class="line">  redis.call(<span class="string">'PEXPIRE'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">elseif</span> <span class="keyword">not</span> lockClientId <span class="keyword">then</span></span><br><span class="line">  redis.call(<span class="string">'SET'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], <span class="string">'PX'</span>, ARGV[<span class="number">2</span>])</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p><strong>é‡Šæ”¾é”</strong></p>
<p>åˆ é™¤key</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">// éƒ½æ˜¯åˆ é™¤key</span><br><span class="line">// unlinkæ˜¯å…ˆæŠŠkeyä»key spaceåˆ é™¤ï¼Œç„¶åå¼‚æ­¥åˆ é™¤</span><br><span class="line">// delæ˜¯åŒæ­¥åˆ é™¤</span><br><span class="line">// unlink key  / del key</span><br></pre></td></tr></table></figure>
<p>Spring-Integration-Rediså®ç°åˆ†å¸ƒå¼é”ï¼šï¼ˆReentrantLock + Redisï¼‰</p>
<p>åœ¨æœ¬åœ°ä½¿ç”¨ReentrantLockæ¥é˜²æ­¢ï¼šçº¿ç¨‹1è·å–redisé”ï¼Œæ“ä½œé˜»å¡ï¼Œredisé”è¶…æ—¶è¢«åˆ é™¤ï¼Œç„¶åçº¿ç¨‹2æ¥è·å–é”æ—¶ä¼šé˜»å¡åœ¨è·å–åŒä¸€æŠŠReentrantLockä¸Šï¼Œåªæœ‰çº¿ç¨‹1é‡Šæ”¾redisé”ï¼ˆç”±äºredisé”è¶…æ—¶ï¼Œä¼šthrow IllegalStateException: Lock was released in the store due to expiration. The integrity of data protected by this lock may have been compromisedï¼‰åï¼ŒReentrantLocké”æ‰ä¼šé‡Šæ”¾ï¼Œç„¶åçº¿ç¨‹2æ‰å¯ä»¥è·å–åˆ°åŒä¸€æŠŠredisé”+ReentrantLock</p>
<p>ä½†æ˜¯å¦‚æœçº¿ç¨‹1ã€2ä¸æ˜¯åœ¨åŒä¸€ä¸ªJVMé‡Œï¼Œè¿™ç§æœ¬åœ°é”çš„æ–¹å¼<strong>æ— æ³•è§£å†³ï¼šé”è¶…æ—¶å¼•èµ·çš„ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºçš„é—®é¢˜</strong></p>
<p><strong>Spring-Integration-Redis å¯¹é”è¶…æ—¶æ²¡æœ‰è¿›è¡Œæ›´å¥½çš„å¤„ç†ï¼Œåªæ˜¯æŠ›å‡ºå¼‚å¸¸</strong></p>
<p>æ‰€ä»¥ï¼Œä½¿ç”¨Spring-Integration-Redisæ—¶ï¼Œéœ€è¦æ…é‡è®¾ç½®Keyè¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤60sï¼‰ï¼Œå› ä¸ºè¿‡æœŸæ—¶é—´è®¾ç½®å¤ªçŸ­ä¼šæœ‰é”è¶…æ—¶é—®é¢˜ï¼Œè¿‡æœŸæ—¶é—´è®¾ç½®å¤ªé•¿ï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡åœ¨è·å–é”åå´©æºƒï¼Œ å…¶ä»–æœåŠ¡è¦é˜»å¡å¾ˆä¹…æ‰å¯ä»¥é‡æ–°è·å–é”ã€‚</p>
<p>é—®é¢˜ï¼š</p>
<ol>
<li>æ¯ä¸ªé”å¯¹åº”çš„keyéƒ½è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œé”è¶…æ—¶åˆ é™¤ä¼šå¼•å‘<strong>ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºçš„é—®é¢˜</strong></li>
<li>è¿™ç§æ–¹å¼æ˜¯åŸºäºå•æœºRedisçš„å®ç°ï¼Œè¿˜å…·æœ‰å•ç‚¹å¤±è´¥çš„é£é™©</li>
<li>å³ä½¿å°†Reidsæ¶è®¾æˆä¸»ä»ç»“æ„ï¼Œåœ¨ä¸»ä»åˆ‡æ¢çš„æ—¶å€™ä¹Ÿä¼šå‡ºç°<strong>ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºçš„é—®é¢˜</strong></li>
<li>ä½¿ç”¨RedLockåº”å¯¹Redisé«˜å¯ç”¨ç¯å¢ƒä¸‹åˆ†å¸ƒå¼é”çš„è·å–ï¼Œä¹Ÿä¼šå­˜åœ¨<strong>é›†ç¾¤èŠ‚ç‚¹å´©æºƒå’Œæ—¶é—´è·³è·ƒå¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºçš„é—®é¢˜</strong>ï¼Œå¦å¤–RedLockä¹Ÿæ²¡è§£å†³é”è¶…æ—¶åˆ é™¤ä¼šå¼•å‘<strong>ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºçš„é—®é¢˜</strong></li>
</ol>
<p>è§£å†³ï¼š</p>
<ol>
<li>è§£å†³é”è¶…æ—¶åˆ é™¤ï¼šé”ç»­çº¦æœºåˆ¶</li>
<li>è§£å†³å•ç‚¹å¤±è´¥ï¼šéƒ¨ç½²Redisé›†ç¾¤ä½¿ç”¨RedLock</li>
<li>è§£å†³RedLocké›†ç¾¤èŠ‚ç‚¹å´©æºƒé—®é¢˜ï¼šå»¶è¿Ÿé‡å¯å´©æºƒèŠ‚ç‚¹ï¼ˆç±»ä¼¼TCPé€€é¿é‡ä¼ æœºåˆ¶ï¼Œå»¶è¿Ÿæ—¶é—´å¤§äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼‰</li>
<li>è§£å†³RedLockæ—¶é—´è·³è·ƒé—®é¢˜ï¼šç¦æ­¢äººä¸ºä¿®æ”¹ç³»ç»Ÿæ—¶é—´ï¼Œä½¿ç”¨ä¸€ä¸ªä¸ä¼šè¿›è¡Œâ€œè·³è·ƒâ€å¼è°ƒæ•´ç³»ç»Ÿæ—¶é’Ÿçš„ntpdç¨‹åºã€‚</li>
</ol>
<h3 id="åˆ†å¸ƒå¼é”-reddison">åˆ†å¸ƒå¼é”-Reddison</h3>
<p><strong>è·å–é”</strong>ï¼ˆluaè„šæœ¬æ‰§è¡Œå‘½ä»¤ï¼‰</p>
<p>luaè„šæœ¬é€»è¾‘ï¼š</p>
<p>åˆ¤æ–­HASH keyæ˜¯å¦å­˜åœ¨ï¼Œ</p>
<p>ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºHASH Keyï¼Œè®¾ç½®Fieldå’Œè‡ªå¢Fieldï¼Œå¹¶è®¾ç½®Keyè¿‡æœŸæ—¶é—´</p>
<p>åˆ¤æ–­HASH Key Fieldæ˜¯å¦å­˜åœ¨ï¼Œ</p>
<p>å­˜åœ¨ï¼Œåˆ™è‡ªå¢Fieldï¼Œå¹¶è®¾ç½®Keyè¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤30,000ms=30sï¼‰</p>
<p>è¿”å›Keyè¿‡æœŸæ—¶é—´</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">'exists'</span>, KEYS[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span> </span><br><span class="line">  redis.call(<span class="string">'hincrby'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>); </span><br><span class="line">  redis.call(<span class="string">'pexpire'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>; </span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">'hexists'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>]) == <span class="number">1</span>) <span class="keyword">then</span> </span><br><span class="line">  redis.call(<span class="string">'hincrby'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>); </span><br><span class="line">  redis.call(<span class="string">'pexpire'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>; </span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">'pttl'</span>, KEYS[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>ä¸ºé˜²æ­¢é”è¶…æ—¶å¼•èµ·çš„å®‰å…¨é—®é¢˜ï¼ŒRedissonå¼•å…¥é”ç»­çº¦æœºåˆ¶ï¼šè·å–é”æˆåŠŸåå¼€å¯çœ‹é—¨ç‹—å®šæ—¶å™¨é»˜è®¤æ¯30,000/3ms=10såˆ·æ–°ä¸€æ¬¡Keyè¿‡æœŸæ—¶é—´</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">'hexists'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>]) == <span class="number">1</span>) <span class="keyword">then</span> </span><br><span class="line">  redis.call(<span class="string">'pexpire'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); </span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>; </span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p><strong>é‡Šæ”¾é”</strong></p>
<p>åˆ¤æ–­HASH Key-Fieldæ˜¯å¦å­˜åœ¨ï¼Œ</p>
<p>ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›ç©ºï¼ŒThrow IllegalMonitorStateExceptionï¼šattempt to unlock lock, not locked by current thread</p>
<p>å­˜åœ¨ï¼Œé€’å‡ HASH Key-Fieldï¼Œå¹¶åˆ¤æ–­é€’å‡åè¿”å›countæ˜¯å¦ä¸º0</p>
<p>ä¸º0ï¼Œåˆ™å¯ä»¥é‡Šæ”¾é”ï¼šæ‰§è¡ŒDEL åˆ é™¤Keyï¼Œå¹¶å‘å¸ƒ UNLOCK_MESSAGE æ¶ˆæ¯ï¼ˆåœ¨è·å–é”æ—¶ï¼Œæœªé©¬ä¸Šè·å–é”æˆåŠŸæ—¶ä¼šè®¢é˜…UNLOCK_MESSAGEå¹¶åŒæ­¥ç­‰å¾…ç”¨æˆ·æŒ‡å®šçš„tryLockæ—¶é—´ï¼‰</p>
<p>ä¸ä¸º0ï¼Œåˆ™ç»­çº¦é”</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">'hexists'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">3</span>]) == <span class="number">0</span>) <span class="keyword">then</span> </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"><span class="keyword">local</span> counter = redis.call(<span class="string">'hincrby'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">3</span>], <span class="number">-1</span>); </span><br><span class="line"><span class="keyword">if</span> (counter &gt; <span class="number">0</span>) <span class="keyword">then</span> </span><br><span class="line">  redis.call(<span class="string">'pexpire'</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>]); </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">  redis.call(<span class="string">'del'</span>, KEYS[<span class="number">1</span>]); </span><br><span class="line">  redis.call(<span class="string">'publish'</span>, KEYS[<span class="number">2</span>], ARGV[<span class="number">1</span>]); </span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>; </span><br><span class="line"><span class="keyword">end</span>; </span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>;</span><br></pre></td></tr></table></figure>
<p>ä¼˜ç‚¹ï¼šè§£å†³é”è¶…æ—¶é—®é¢˜ï¼Œæ”¯æŒRedis Clusterç¯å¢ƒä¸‹çš„RedLock</p>
<p>ç¼ºç‚¹ï¼šRedis Clusterçš„ç¼ºç‚¹ï¼šé›†ç¾¤èŠ‚ç‚¹å´©æºƒé—®é¢˜ã€æ—¶é—´è·³è·ƒé—®é¢˜</p>
<h3 id="åˆ†å¸ƒå¼é”-zookeeper">åˆ†å¸ƒå¼é”-ZooKeeper</h3>
<p>zookeeperå’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥åæœ‰å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œå½“zookeeperé•¿æ—¶é—´æ£€æµ‹ä¸åˆ°å®¢æˆ·ç«¯å¿ƒè·³æ—¶ï¼Œä¼šä¸»åŠ¨é‡Šæ”¾å®¢æˆ·ç«¯åˆ›å»ºçš„ä¸´æ—¶èŠ‚ç‚¹ï¼Œå› æ­¤ä¸éœ€è¦è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ï¼Œä¸ä¾èµ–äºé”è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥ä¸å­˜åœ¨é”è¶…æ—¶é—®é¢˜ã€‚</p>
<p>ã€ZooKeeperæ£€æµ‹ä¸åˆ°å®¢æˆ·ç«¯å¿ƒè·³ä¸»åŠ¨é‡Šæ”¾å®¢æˆ·ç«¯åˆ›å»ºçš„ä¸´æ—¶èŠ‚ç‚¹ã€‘è¿™ç§æœºåˆ¶ä¹Ÿå¯èƒ½æ˜¯ç”±å®¢æˆ·ç«¯é•¿æ—¶é—´GCæ‰€å¯¼è‡´çš„ï¼Œæ‰€ä»¥ä¹Ÿå­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯ç›¸æ¯”redisçš„é”è¶…æ—¶è¦å¯é å¤šäº†</p>
<p>å¦å¤–ZooKeeperé›†ç¾¤çš„å¼ºä¸€è‡´æ€§ä¿è¯äº†å®¢æˆ·ç«¯è¦ä¹ˆè·å–ä¸åˆ°é”ï¼Œè¦ä¹ˆè·å–åˆ°é”åï¼ŒZooKeeperçš„é›†ç¾¤èŠ‚ç‚¹æ•°æ®ä¸€å®šæ˜¯ä¸€è‡´çš„ã€‚å³ä¸å­˜åœ¨Redisé›†ç¾¤çš„èŠ‚ç‚¹å´©æºƒå’Œæ—¶é—´è·³è·ƒçš„é—®é¢˜</p>
<p>ä¼˜ç‚¹ï¼šå¼ºä¸€è‡´æ€§ï¼Œä¸éœ€è¦å…³å¿ƒé”è¶…æ—¶é—®é¢˜</p>
<p>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸é«˜</p>
<h3 id="åˆ†å¸ƒå¼é”-mysql">åˆ†å¸ƒå¼é”-Mysql</h3>
<p>åˆ›å»ºä¸€å¼ èµ„æºè¡¨ï¼Œè·å–é”åˆ™æ’å…¥ä¸€æ¡è®°å½•ï¼Œé‡Šæ”¾é”åˆ™åˆ é™¤ç›¸åº”çš„è®°å½•ã€‚</p>
<p>æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<p>æ‚²è§‚é”ï¼šselect for update + insert ï¼ˆä¸€å®šè¦åŠ äº‹åŠ¡ï¼‰ã€äº‹åŠ¡æ˜¯ä¿è¯å¤šä¸ªSQLè¯­å¥è¦ä¹ˆéƒ½æ‰§è¡ŒæˆåŠŸæäº¤ï¼Œè¦ä¹ˆä»»æ„ä¸€ä¸ªå¤±è´¥éƒ½å…¨éƒ¨å›æ»šï¼Œfor updteæ˜¯å¯¹è¦æ›´æ–°çš„è¡ŒåŠ é”ä¿è¯æ›´æ–°çš„é€»è¾‘æ­£ç¡®æ€§ã€‘</p>
<p>ä¹è§‚é”ï¼šselect + update where version=xx  + whileå¾ªç¯ç›´åˆ°æˆåŠŸ</p>
<p>ä¼˜ç‚¹ï¼šä¸å¼•å…¥ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå‡å°‘å•ç‚¹å¤±è´¥æ¦‚ç‡</p>
<p>ç¼ºç‚¹ï¼šæ•°æ®åº“æ€§èƒ½è¾ƒä½ï¼Œæ”¯æŒçš„å¹¶å‘ä¸é«˜</p>
<p>å¦å¤–Mysqlæä¾›äº†get_lock &amp; release_lockå‡½æ•°ä¹Ÿå¯ä»¥ç”¨äºåˆ†å¸ƒå¼é”ï¼ŒåŠ é”é‡Šæ”¾é”æ“ä½œéƒ½å¿…é¡»æ˜¯åŒä¸€ä¸ªSqlSessionï¼Œè¿æ¥æ–­å¼€Mysqlè¿˜ä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚è¿™ç§é”æœºåˆ¶æ˜¯åŸºäºå•æœºæ•°æ®åº“çš„ï¼Œæ‰€ä»¥å­˜åœ¨å•ç‚¹å¤±è´¥é—®é¢˜ã€‚</p>
<p>åŸºæœ¬ç”¨æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#åŠ é”</span><br><span class="line">SELECT GET_LOCK(key, timeout);</span><br><span class="line">#é‡Šæ”¾é”</span><br><span class="line">SELECT RELEASE_LOCK(key);</span><br></pre></td></tr></table></figure>
<h3 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h3>
<h6 id="æµ…è°ˆåˆ†å¸ƒå¼é”"><a href="http://www.linkedkeeper.com/1023.html" target="_blank" rel="noopener">æµ…è°ˆåˆ†å¸ƒå¼é”</a></h6>
<h6 id="åˆ†å¸ƒå¼ä¹‹æŠ‰æ‹©åˆ†å¸ƒå¼é”"><a href="https://www.cnblogs.com/rjzheng/p/9310976.html" target="_blank" rel="noopener">åˆ†å¸ƒå¼ä¹‹æŠ‰æ‹©åˆ†å¸ƒå¼é”</a></h6>
<h6 id="ä¸‡å­—é•¿æ–‡ä¸ä¸ºäººçŸ¥çš„åˆ†å¸ƒå¼é”å®ç°å…¨éƒ½åœ¨è¿™é‡Œäº†"><a href="https://www.modb.co/db/14104" target="_blank" rel="noopener">ä¸‡å­—é•¿æ–‡ï¼ä¸ä¸ºäººçŸ¥çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œå…¨éƒ½åœ¨è¿™é‡Œäº†ï¼</a></h6>
]]></content>
      <tags>
        <tag>åˆ†å¸ƒå¼é”</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡</title>
    <url>/article/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯äº‹åŠ¡">ä»€ä¹ˆæ˜¯äº‹åŠ¡</h3>
<p>äº‹åŠ¡æ˜¯æ•°æ®åº“çš„æœ¯è¯­ï¼Œè¡¨ç¤ºäº‹åŠ¡èŒƒå›´å†…çš„æ“ä½œä¸æˆåŠŸä¾¿æˆä»ã€è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€ã€‘ã€‚å•æ¡sqlçš„æ‰§è¡Œé»˜è®¤éƒ½æ˜¯äº‹åŠ¡çš„ï¼Œä¹Ÿå³å•æ¡sqlçš„æ‰§è¡Œè¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥ï¼Œä¸å­˜åœ¨ä¸­é—´çŠ¶æ€ã€‚å¯¹äºå¤šæ¡sqlçš„äº‹åŠ¡ï¼Œåˆ™éœ€è¦æ˜¾å¼çš„å¼€å¯å’Œå…³é—­äº‹åŠ¡ã€‚æ¯”å¦‚ä¸‹å•å‡åº“å­˜çš„æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#å¼€å¯äº‹åŠ¡</span><br><span class="line">begin;</span><br><span class="line">#æ–°å¢è®¢å•</span><br><span class="line">insert into order values (...);</span><br><span class="line">#ä¿®æ”¹åº“å­˜</span><br><span class="line">update stock set amount = amount -1 where goods_name = &apos;xxoo&apos;;</span><br><span class="line">#æäº¤ æˆ– æ ¹æ®ä¸šåŠ¡é€»è¾‘ä¸»åŠ¨å¤±è´¥å›æ»š</span><br><span class="line">commit; # rollback;</span><br></pre></td></tr></table></figure>
<p>å’Œäº‹åŠ¡å¯†åˆ‡å…³è”çš„æ˜¯æ•°æ®åº“çš„éš”ç¦»çº§åˆ«ã€‚æ•°æ®åº“çš„éš”ç¦»çº§åˆ«å®šä¹‰äº†ä¸åŒäº‹åŠ¡ä¸­çœ‹åˆ°çš„æ•°æ®çš„å·®å¼‚ã€‚Mysqlæœ‰å››ç§éš”ç¦»çº§åˆ«ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">éš”ç¦»çº§åˆ«</th>
<th style="text-align:center">è„è¯»</th>
<th style="text-align:center">ä¸å¯é‡å¤è¯»</th>
<th style="text-align:center">å¹»è¯»</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">è¯»æœªæäº¤</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center">æ˜¯</td>
</tr>
<tr>
<td style="text-align:center">è¯»å·²æäº¤</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center">æ˜¯</td>
</tr>
<tr>
<td style="text-align:center">å¯é‡å¤è¯»</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">æ˜¯ï¼ˆå®é™…æµ‹è¯•ï¼Œå‘ç°æ­¤éš”ç¦»çº§åˆ«ä¸‹æ˜¯è§£å†³äº†å¹»è¯»é—®é¢˜çš„ï¼Œæµ‹è¯•mysqlç‰ˆæœ¬ï¼š5.7.34-logï¼‰</td>
</tr>
<tr>
<td style="text-align:center">ä¸²è¡ŒåŒ–</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">å¦</td>
</tr>
</tbody>
</table>
<p>ä¸åŒçš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œä¸åŒäº‹åŠ¡çš„æ•°æ®ä¸€è‡´æ€§ä¸ä¸€æ ·ã€‚Mysqlé»˜è®¤éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ã€‚å¯ä»¥é€šè¿‡ã€show variables like â€˜%transaction%â€™;ã€‘æŸ¥çœ‹é»˜è®¤éš”ç¦»çº§åˆ«ã€‚æ­¤éš”ç¦»çº§åˆ«ä¸‹çš„è¯­ä¹‰æ˜¯å¤šæ¬¡selectçš„ç»“æœå¯¹å…¶ä»–äº‹åŠ¡çš„updateå±è”½ï¼ˆå¯é‡å¤è¯»ï¼‰ï¼Œä½†æ˜¯å…¶ä»–äº‹åŠ¡çš„insertã€deleteæ˜¯å¯ä»¥çœ‹åˆ°çš„ï¼ˆå¹»è¯»ï¼‰ã€‚</p>
<p>å› æ­¤å¯¹äºä¸€ä¸ªæ¶‰åŠæŸ¥è¯¢æ›´æ–°çš„å¤šæ¡sqläº‹åŠ¡ï¼Œç”±äºæŸ¥è¯¢çš„ç»“æœå¯¹å…¶ä»–äº‹åŠ¡çš„updateå±è”½ï¼Œå› æ­¤æœ‰å¯èƒ½æ›´æ–°åçš„ç»“æœå¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚æ¯”å¦‚ï¼šä¸šåŠ¡é€»è¾‘ï¼šæ‰§è¡Œå½“åº“å­˜å¤§äº0æ—¶å‡åº“å­˜ï¼Œå¦‚æœæŒ‰ä»¥ä¸‹æŸ¥è¯¢æ›´æ–°æ‰§è¡Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from stock where goods_name = &apos;xxoo&apos; and amount &gt; 0;</span><br><span class="line">#ä¸šåŠ¡é€»è¾‘åˆ¤æ–­selectç»“æœä¸ä¸ºç©ºï¼Œåˆ™é€’å‡amount</span><br><span class="line">update stock set amount = amount -1 where goods_name = &apos;xxoo&apos;;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå¦‚æœamountå­—æ®µç±»å‹å¯ä»¥ä¸ºè´Ÿæ•°ï¼Œåˆ™äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œä½†æ˜¯ç”±äºå…¶ä»–äº‹åŠ¡ä¹Ÿæ‰§è¡Œäº†ç›¸åŒçš„æ“ä½œå¹¶ä¸”å…ˆä¸€æ­¥é€’å‡äº†amountï¼Œåˆ™æ­¤æ—¶amountå˜æˆäº†è´Ÿå€¼ï¼Œä¸ç¬¦åˆæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>å› æ­¤äº‹åŠ¡å¹¶ä¸èƒ½ä¿è¯å¤šæ¡sqlè¯­å¥çš„æ‰§è¡Œåœ¨ä¸šåŠ¡é€»è¾‘ä¸Šçš„æ­£ç¡®æ€§ã€‚</p>
<p>å¦‚æœåªæ˜¯sqlæ“ä½œï¼Œå¯ä»¥é€šè¿‡sqlè¯­å¥å±‚é¢çš„æ‚²è§‚é”å’Œä¹è§‚é”æ¥è§£å†³ã€‚</p>
<p>æ‚²è§‚é”ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from stock where goods_name = &apos;xxoo&apos; and amount &gt; 0 for update;</span><br><span class="line">#ä¸šåŠ¡é€»è¾‘åˆ¤æ–­selectç»“æœä¸ä¸ºç©ºï¼Œåˆ™é€’å‡amount</span><br><span class="line">update stock set amount = amount -1 where goods_name = &apos;xxoo&apos;;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå…¶ä»–äº‹åŠ¡çš„select for updateæ“ä½œä¼šè¢«é˜»å¡ç›´åˆ°æ­¤äº‹åŠ¡æäº¤æˆ–å›æ»šï¼Œç”±æ­¤å¯ä»¥ä¿è¯ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§ã€‚</p>
<p>ä¹è§‚é”ï¼šæ—§å€¼åˆ¤æ–­æˆ–è€…æ–°å¢ç‰ˆæœ¬å·ã€æ—¶é—´æˆ³å­—æ®µæ¥åˆ¤æ–­</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from stock where goods_name = &apos;xxoo&apos; and amount &gt; 0;</span><br><span class="line">#ä¸šåŠ¡é€»è¾‘åˆ¤æ–­selectç»“æœä¸ä¸ºç©ºï¼Œåˆ™é€’å‡amount</span><br><span class="line">update stock set amount = amount -1 where goods_name = &apos;xxoo&apos; and amount &gt; 0;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå…¶ä»–äº‹åŠ¡çš„updateæ“ä½œä¼šè¢«é˜»å¡ç›´åˆ°æ­¤äº‹åŠ¡æäº¤æˆ–å›æ»šï¼Œç”±æ­¤ä¿è¯ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§ã€‚</p>
<p>å¦‚æœsqlæ“ä½œä¸­é—´è¿˜æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚ä¸‹é¢çš„å¯¹Account.amountçš„ç´¯åŠ æ“ä½œæ”¾åœ¨ä¸šåŠ¡ä»£ç é‡Œæ‰§è¡Œè€Œä¸æ˜¯sqlè¯­å¥ä¸­æ‰§è¡Œï¼Œåˆ™è¦å¦å¤–åŠ è¯­è¨€å±‚é¢çš„é”ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨æ€§ã€‚</p>
<h3 id="transactionalæ³¨è§£">Transactionalæ³¨è§£</h3>
<p>Transactionalæ³¨è§£åŸºäºAOPï¼Œé€šè¿‡åŠ¨æ€ä»£ç†ï¼Œç”Ÿæˆä»£ç†ç±»ï¼Œåœ¨æ‰§è¡ŒTransactionalæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å‰å¼€å¯äº‹åŠ¡ï¼Œåœ¨æ‰§è¡ŒTransactionalæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•åæäº¤äº‹åŠ¡ã€‚å¹¶æä¾›äº†æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ç¢°åˆ°ä½•ç§å¼‚å¸¸æ‰§è¡Œå›æ»šçš„å±æ€§rollbackForï¼Œæ‰€ä»¥æ–¹æ³•ä¸­å¦‚æœæœ‰try-catchæ•è·å¼‚å¸¸ä¼šå¯¼è‡´äº‹åŠ¡æ— æ³•æ­£ç¡®å›æ»šã€‚</p>
<p>é—®é¢˜ï¼šåœ¨Transactionalæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å†…åŠ é”ï¼Œå¯¼è‡´é”å¤±æ•ˆçš„é—®é¢˜</p>
<p>æè¿°ï¼šæœ‰ä¸ªé€’å¢æ›´æ–°amountå­—æ®µçš„æ“ä½œå¦‚ä¸‹ï¼Œä¸ºäº†ä¿è¯é€’å¢æ“ä½œåœ¨å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨ï¼ŒåŠ äº†é”ã€‚ä½†æ˜¯æµ‹è¯•çš„æ—¶å€™å‘ç°amountçš„æ›´æ–°å€¼ä¸å¯¹ï¼Œé”ä½çš„ä»£ç å—è¿˜æ˜¯å¹¶å‘æ‰§è¡Œäº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(rollbackFor = Throwable.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateLoginInfo</span><span class="params">(String deviceString, String packageFlag,String version, AccountParam param)</span> </span>&#123;</span><br><span class="line">    Account update = <span class="keyword">new</span> Account();</span><br><span class="line">    update.setLoginpackageflag(packageFlag);</span><br><span class="line">    update.setPackageType(<span class="number">0</span>);</span><br><span class="line">    update.setLastLoginTime( LocalDateTime.now().format( DateTimeFormatter.ofPattern(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)));</span><br><span class="line">    update.setLoginDevString(deviceString);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        Account oldAccount = <span class="keyword">this</span>.accountMapper.getByUserName(deviceString);</span><br><span class="line">        <span class="keyword">int</span> oldAmount = oldAccount.getAmount() == <span class="keyword">null</span> ? <span class="number">0</span> : oldAccount.getAmount();</span><br><span class="line">        update.setAccid(oldAmount + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">int</span> count = <span class="keyword">this</span>.accountMapper.updateByExampleSelective(update, param);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†æï¼šç”±äºTransactionalæ³¨è§£æ˜¯åŸºäºSpringçš„AOPï¼Œä¼šåœ¨æ‰§è¡Œæ–¹æ³•ä¹‹å‰å¼€å¯äº‹åŠ¡ï¼Œä¹‹åå†åŠ é”ï¼Œå½“é”ä½çš„ä»£ç æ‰§è¡Œå®Œæˆåï¼Œå†æäº¤äº‹åŠ¡ï¼Œå› æ­¤é”ä½çš„ä»£ç å—æ‰§è¡Œæ˜¯åœ¨äº‹åŠ¡ä¹‹å†…æ‰§è¡Œçš„ï¼Œå› æ­¤åœ¨synchronizedä»£ç å—æ‰§è¡Œå®Œåï¼Œäº‹åŠ¡è¿˜æœªæäº¤ï¼Œé”å·²ç»è¢«é‡Šæ”¾ï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹å¯ä»¥å¼€å¯æ–°çš„äº‹åŠ¡å¹¶æ‹¿åˆ°é”ä¹‹åæ‰§è¡Œé”ä½çš„ä»£ç å—ï¼Œå¯¼è‡´å¹¶å‘é—®é¢˜ã€‚</p>
<p>è§£å†³ï¼šå°†é”æ”¾åˆ°Transactionalæ ‡æ³¨çš„æ–¹æ³•å¤–é¢</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateLoginInfo</span><span class="params">(String deviceString, String packageFlag,String version, AccountParam param)</span> </span>&#123;</span><br><span class="line">    Account update = <span class="keyword">new</span> Account();</span><br><span class="line">    update.setLoginpackageflag(packageFlag);</span><br><span class="line">    update.setPackageType(<span class="number">0</span>);</span><br><span class="line">    update.setLastLoginTime( LocalDateTime.now().format( DateTimeFormatter.ofPattern(<span class="string">"yyyy/MM/dd HH:mm:ss"</span>)));</span><br><span class="line">    update.setLoginDevString(deviceString);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        amountMapper.transactionalUpdate(deviceString, update, param);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(rollbackFor = Throwable.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transactionalUpdate</span><span class="params">(String deviceString, Account update, AccountParam param)</span> </span>&#123;</span><br><span class="line">    Account oldAccount = <span class="keyword">this</span>.accountMapper.getByUserName ( deviceString );</span><br><span class="line">    <span class="keyword">int</span> oldAcid = oldAccount.getAccid () == <span class="keyword">null</span> ? <span class="number">0</span> : oldAccount.getAccid ();</span><br><span class="line">    update.setAccid ( oldAcid + <span class="number">1</span> );</span><br><span class="line">    <span class="keyword">int</span> count = <span class="keyword">this</span>.accountMapper.updateByExampleSelective ( update, param );</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UpdateException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ†å¸ƒå¼äº‹åŠ¡">åˆ†å¸ƒå¼äº‹åŠ¡</h3>
<p>åˆ†å¸ƒå¼äº‹åŠ¡å°±æ˜¯ä¸ºäº†ä¿è¯ä¸åŒæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p>
<p>åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³Cï¼ˆä¸€è‡´æ€§ï¼‰ã€Aï¼ˆå¯ç”¨æ€§ï¼‰ã€Pï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰ï¼›è€Œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹Pæ˜¯å¿…ç„¶è¦ä¿è¯çš„ã€‚ æ‰€ä»¥åˆ†å¸ƒå¼ç³»ç»Ÿè¦ä¹ˆä¾§é‡äºAPï¼Œè¦ä¹ˆä¾§é‡äºCPã€‚</p>
<p>ç”±äºCAPç†è®ºå¯¹ä¸€è‡´æ€§ã€å¯ç”¨æ€§çš„å®šä¹‰å¤ªç²¾å‡†ï¼Œç°å®çš„ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³100%çš„ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œåˆæå‡ºäº†BASEï¼ˆåŸºæœ¬å¯ç”¨ã€è½¯çŠ¶æ€ã€æœ€ç»ˆä¸€è‡´æ€§ï¼‰ç†è®ºã€‚</p>
<h4 id="mysql-xa">Mysql XA</h4>
<p>mysql 5.7åŠä»¥ä¸Šæä¾›å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„æ”¯æŒï¼Œå®ç°äº†XAè§„èŒƒï¼ŒXAè§„èŒƒå®šä¹‰äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/Mysql%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%94%AF%E6%8C%81-XA%E5%AE%9E%E7%8E%B0.jpg" alt=""></p>
<p>RMï¼šèµ„æºç®¡ç†è€…ï¼Œè¦å…·å¤‡commit/rollbackçš„èƒ½åŠ›ã€‚</p>
<p>TMï¼šäº‹åŠ¡ç®¡ç†è€…ï¼Œè¦å…·å¤‡åè°ƒé€šçŸ¥å„ä¸ªRMæ˜¯æ‰§è¡Œcommitè¿˜æ˜¯rollbackçš„èƒ½åŠ›ã€‚</p>
<p>ä¸€ä¸ªå…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²ä¸ªæœ¬åœ°äº‹åŠ¡åˆ†æ”¯ç»„æˆçš„ï¼Œæ¯ä¸ªRMå†…éƒ¨çš„æ“ä½œå°±æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡åˆ†æ”¯ã€‚</p>
<p>TMé€šè¿‡XIDæ¥åè°ƒå„ä¸ªæœ¬åœ°äº‹åŠ¡çš„æ“ä½œã€‚</p>
<p>TMå’ŒRMsä¹‹é—´ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤åè®®æ¥è¿è¡Œï¼š</p>
<p>ç¬¬ä¸€é˜¶æ®µï¼š</p>
<p>TMå‘æ‰€æœ‰RMså‘èµ·prepare commitè¯·æ±‚ï¼Œæ¯ä¸ªRMæ ¹æ®è‡ªèº«æƒ…å†µå›å¤TMæ˜¯å¦å¯ä»¥commitï¼Œå¦‚æœå¯ä»¥åˆ™é¢„ç•™æœ¬åœ°äº‹åŠ¡éœ€è¦çš„èµ„æºç„¶åå›å¤OKï¼Œå¦‚æœä¸å¯ä»¥åˆ™å›å¤FAIL</p>
<p>ç¬¬äºŒé˜¶æ®µï¼š</p>
<p>TMæ ¹æ®å›å¤æƒ…å†µï¼Œå¦‚æœå…¨éƒ¨å›å¤OKåˆ™å‘æ‰€æœ‰RMså‘èµ·commitè¯·æ±‚ï¼Œæ¯ä¸ªRMæ‰§è¡Œcommitå¹¶å›å¤TMæ“ä½œç»“æœã€‚å¦‚æœæœ‰ä¸€ä¸ªå›å¤FAILåˆ™å‘æ‰€æœ‰RMså‘èµ·rollbackè¯·æ±‚ï¼Œæ¯ä¸ªRMæ‰§è¡Œrollbackå¹¶å›å¤TMæ“ä½œç»“æœã€‚</p>
<p>ç”±äºMysql XAå¼ºä¾èµ–äºæ•°æ®åº“ç‰ˆæœ¬ï¼Œæ‰€ä»¥å®é™…ä¸Šåº”ç”¨å¾ˆå°‘ã€‚æ›´å¤šæ˜¯é€šè¿‡ä¸­é—´ä»¶æ¥å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<h4 id="ä¸¤é˜¶æ®µæäº¤2pc">ä¸¤é˜¶æ®µæäº¤2PC</h4>
<p>å®šä¹‰æ¥è‡ªç»´åŸºç™¾ç§‘ï¼š</p>
<h5 id="ç¬¬ä¸€é˜¶æ®µæäº¤è¯·æ±‚é˜¶æ®µ">ç¬¬ä¸€é˜¶æ®µ(æäº¤è¯·æ±‚é˜¶æ®µ)</h5>
<ol>
<li>åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹è¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œæäº¤æ“ä½œï¼Œå¹¶å¼€å§‹ç­‰å¾…å„å‚ä¸è€…èŠ‚ç‚¹çš„å“åº”ã€‚</li>
<li>å‚ä¸è€…èŠ‚ç‚¹æ‰§è¡Œè¯¢é—®å‘èµ·ä¸ºæ­¢çš„æ‰€æœ‰äº‹åŠ¡æ“ä½œï¼Œå¹¶å°†<a href="https://zh.wikipedia.org/w/index.php?title=Undo%E4%BF%A1%E6%81%AF&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">Undoä¿¡æ¯</a>å’Œ<a href="https://zh.wikipedia.org/w/index.php?title=Redo%E4%BF%A1%E6%81%AF&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">Redoä¿¡æ¯</a>å†™å…¥æ—¥å¿—ã€‚</li>
<li>å„å‚ä¸è€…èŠ‚ç‚¹å“åº”åè°ƒè€…èŠ‚ç‚¹å‘èµ·çš„è¯¢é—®ã€‚å¦‚æœå‚ä¸è€…èŠ‚ç‚¹çš„äº‹åŠ¡æ“ä½œå®é™…æ‰§è¡ŒæˆåŠŸï¼Œåˆ™å®ƒè¿”å›ä¸€ä¸ª&quot;åŒæ„&quot;æ¶ˆæ¯ï¼›å¦‚æœå‚ä¸è€…èŠ‚ç‚¹çš„äº‹åŠ¡æ“ä½œå®é™…æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å®ƒè¿”å›ä¸€ä¸ª&quot;ä¸­æ­¢&quot;æ¶ˆæ¯ã€‚</li>
</ol>
<p>æœ‰æ—¶å€™ï¼Œç¬¬ä¸€é˜¶æ®µä¹Ÿè¢«ç§°ä½œ<strong>æŠ•ç¥¨é˜¶æ®µ</strong>ï¼Œå³å„å‚ä¸è€…æŠ•ç¥¨æ˜¯å¦è¦ç»§ç»­æ¥ä¸‹æ¥çš„æäº¤æ“ä½œã€‚</p>
<h5 id="ç¬¬äºŒé˜¶æ®µæäº¤æ‰§è¡Œé˜¶æ®µ">ç¬¬äºŒé˜¶æ®µ(æäº¤æ‰§è¡Œé˜¶æ®µ)</h5>
<h6 id="æˆåŠŸ">æˆåŠŸ</h6>
<p>å½“åè°ƒè€…èŠ‚ç‚¹ä»æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹è·å¾—çš„å“åº”æ¶ˆæ¯éƒ½ä¸º&quot;åŒæ„&quot;æ—¶ï¼š</p>
<ol>
<li>åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡º&quot;æ­£å¼æäº¤&quot;çš„è¯·æ±‚ã€‚</li>
<li>å‚ä¸è€…èŠ‚ç‚¹æ­£å¼æ‰§è¡Œæäº¤ï¼Œå¹¶é‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´å†…å ç”¨çš„èµ„æºã€‚</li>
<li>å‚ä¸è€…èŠ‚ç‚¹å‘åè°ƒè€…èŠ‚ç‚¹å‘é€&quot;å®Œæˆ&quot;æ¶ˆæ¯ã€‚</li>
<li>åè°ƒè€…èŠ‚ç‚¹æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹åé¦ˆçš„&quot;å®Œæˆ&quot;æ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ã€‚</li>
</ol>
<h6 id="å¤±è´¥">å¤±è´¥</h6>
<p>å¦‚æœä»»ä¸€å‚ä¸è€…èŠ‚ç‚¹åœ¨ç¬¬ä¸€é˜¶æ®µè¿”å›çš„å“åº”æ¶ˆæ¯ä¸º&quot;ç»ˆæ­¢&quot;ï¼Œæˆ–è€…åè°ƒè€…èŠ‚ç‚¹åœ¨ç¬¬ä¸€é˜¶æ®µçš„è¯¢é—®è¶…æ—¶ä¹‹å‰æ— æ³•è·å–æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹çš„å“åº”æ¶ˆæ¯æ—¶ï¼š</p>
<ol>
<li>åè°ƒè€…èŠ‚ç‚¹å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡º&quot;å›æ»šæ“ä½œ&quot;çš„è¯·æ±‚ã€‚</li>
<li>å‚ä¸è€…èŠ‚ç‚¹åˆ©ç”¨ä¹‹å‰å†™å…¥çš„Undoä¿¡æ¯æ‰§è¡Œå›æ»šï¼Œå¹¶é‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æœŸé—´å†…å ç”¨çš„èµ„æºã€‚</li>
<li>å‚ä¸è€…èŠ‚ç‚¹å‘åè°ƒè€…èŠ‚ç‚¹å‘é€&quot;å›æ»šå®Œæˆ&quot;æ¶ˆæ¯ã€‚</li>
<li>åè°ƒè€…èŠ‚ç‚¹æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹åé¦ˆçš„&quot;å›æ»šå®Œæˆ&quot;æ¶ˆæ¯åï¼Œå–æ¶ˆäº‹åŠ¡ã€‚</li>
</ol>
<p>æœ‰æ—¶å€™ï¼Œç¬¬äºŒé˜¶æ®µä¹Ÿè¢«ç§°ä½œ<strong>å®Œæˆé˜¶æ®µ</strong>ï¼Œå› ä¸ºæ— è®ºç»“æœæ€æ ·ï¼Œåè°ƒè€…éƒ½å¿…é¡»åœ¨æ­¤é˜¶æ®µç»“æŸå½“å‰äº‹åŠ¡ã€‚</p>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>æ‰§è¡Œè¿‡ç¨‹ä¸­ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µå‚ä¸èŠ‚ç‚¹å‡å¤„äºé˜»å¡çŠ¶æ€ã€‚ã€è§£å†³ï¼šé˜¿é‡ŒFescarçš„è§£å†³æ–¹æ¡ˆï¼Œç›´æ¥åœ¨ç¬¬ä¸€é˜¶æ®µæ‰§è¡Œcommitå¹¶å†™undo logï¼›ç„¶ååœ¨ç¬¬äºŒé˜¶æ®µï¼šå¦‚æœç¬¬ä¸€é˜¶æ®µcommitæˆåŠŸï¼Œåˆ™å¼‚æ­¥åˆ é™¤ç›¸åº”çš„undo logå³å¯ï¼›å¦‚æœç¬¬ä¸€é˜¶æ®µcommitå¤±è´¥ï¼Œåˆ™æ ¹æ®undo logå¼‚æ­¥æ‰§è¡Œrollbackå¹¶åˆ é™¤ç›¸åº”çš„undo logã€‘</li>
<li>åœ¨ç¬¬äºŒé˜¶æ®µéƒ¨åˆ†å‚ä¸è€…æ‰§è¡Œå¤±è´¥æ—¶ï¼Œæ•°æ®ä¼šä¸ä¸€è‡´ã€‚ã€è§£å†³ï¼šåœ¨åè°ƒè€…å¼•å…¥é‡è¯•æœºåˆ¶ã€‘</li>
<li>åè°ƒè€…å•ç‚¹å¤±è´¥é—®é¢˜ã€‚ã€è§£å†³ï¼šç”±ç¬¬ä¸‰æ–¹é›†ç¾¤éƒ¨ç½²çš„ä¸­é—´ä»¶æ¥å……å½“åè°ƒè€…ã€‘</li>
<li>åè°ƒè€…å´©æºƒåæˆ–è€…ç½‘ç»œé—®é¢˜å‚ä¸è€…å’Œåè°ƒè€…å¤±è”åï¼Œå¯¼è‡´å‚ä¸è€…ä¸€ç›´é˜»å¡ã€‚ã€è§£å†³ï¼šåœ¨å‚ä¸è€…å¼•å…¥é‡è¯•æœºåˆ¶ã€‘</li>
</ol>
<h4 id="tcc">TCC</h4>
<p>TCC(Try-Confirm-Cancle)åˆå«è¡¥å¿äº‹åŠ¡ã€‚ç›¸å½“äºæŠŠ2PCç¬¬äºŒé˜¶æ®µçš„æˆåŠŸã€å¤±è´¥ä¸¤ç§æƒ…å†µæ‹†åˆ†æˆConfirmå’ŒCancleä¸¤ä¸ªé˜¶æ®µã€‚å› æ­¤å®ƒå­˜åœ¨çš„é—®é¢˜å’Œ2PCå­˜åœ¨çš„é—®é¢˜ä¸€æ ·ã€‚</p>
<h4 id="rocketmqåˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆ">RocketMQåˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆ</h4>
<p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¤šä¸ªæœåŠ¡ä¹‹é—´é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥è°ƒç”¨ï¼Œåœ¨è¿™ç§ç¯å¢ƒä¸‹å¦‚ä½•ä¿è¯å¤šä¸ªä¸Šä¸‹æ¸¸æ¶ˆæ¯è°ƒç”¨ä¹‹é—´çš„äº‹åŠ¡æ€§ï¼ˆACIDï¼‰ã€‚ç”±äºå¼‚æ­¥è§£è€¦ï¼Œé€šå¸¸ä¼šé‡‡ç”¨å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆã€‚</p>
<p>RocketMQäº‹åŠ¡æ¶ˆæ¯çš„åŸç†å›¾å¤§è‡´å¦‚ä¸‹ï¼ŒRocketMQå……å½“äº†åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„åè°ƒè€…ï¼Œå¹¶ä¸”åœ¨åè°ƒè€…ä¸­å¼•å…¥äº†é‡è¯•æœºåˆ¶ï¼Œåœ¨æ¶ˆè´¹è€…ä¾§ä¹Ÿå¼•å…¥äº†é‡è¯•æœºåˆ¶ï¼Œæ‰€ä»¥æ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§å¯ç”¨æ€§æœ€åå°±åªå–å†³äºRocketMQä¸­é—´ä»¶çš„é«˜å¯ç”¨æ€§ã€‚å¦å¤–ç”±äºå¼•å…¥äº†é‡è¯•æœºåˆ¶ï¼Œéœ€è¦æœåŠ¡æä¾›çš„æ¥å£æ»¡è¶³å¹‚ç­‰æ€§ï¼Œé¿å…é‡å¤è°ƒç”¨å¼•èµ·çš„æ•°æ®ä¸ä¸€è‡´ã€‚</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/RocketMQ%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF.jpg" alt=""></p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<p><a href="https://segmentfault.com/a/1190000018057083" target="_blank" rel="noopener">é˜¿é‡Œå¼€æºåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ Fescar å…¨è§£æ</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/91263461" target="_blank" rel="noopener">é¢è¯•å®˜ï¼šäº†è§£åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿè®²è®²ä½ ç†è§£çš„2PCå’Œ3PCåŸç†</a></p>
<p><a href="https://juejin.im/post/5bf201f7f265da610f63528a" target="_blank" rel="noopener">æ‹œæ‰˜ï¼Œé¢è¯•è¯·ä¸è¦å†é—®æˆ‘TCCåˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°åŸç†</a></p>
<p><a href="https://www.javazhiyin.com/31853.html" target="_blank" rel="noopener">åˆ†å¸ƒå¼äº‹åŠ¡ä¹‹å¦‚ä½•åŸºäºRocketMQçš„äº‹åŠ¡æ¶ˆæ¯ç‰¹æ€§å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ€ç»ˆä¸€è‡´æ€§</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/36153160" target="_blank" rel="noopener">åˆ†å¸ƒå¼ä¸€è‡´æ€§äº‹åŠ¡çœ‹è¿™ç¯‡å°±å¤Ÿäº†</a></p>
]]></content>
      <tags>
        <tag>åˆ†å¸ƒå¼äº‹åŠ¡</tag>
      </tags>
  </entry>
  <entry>
    <title>javaé›†åˆ-LinkedList</title>
    <url>/article/java%E9%9B%86%E5%90%88-LinkedList/</url>
    <content><![CDATA[<h3 id="ç±»å›¾ç»“æ„">ç±»å›¾ç»“æ„</h3>
<p>LinkedListæ˜¯Listæ¥å£å’ŒDequeæ¥å£çš„åŒå‘é“¾è¡¨å®ç°ç±»ã€‚å®ƒçš„ç±»å±‚çº§ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/LinkedList%E7%B1%BB%E5%9B%BE%E7%BB%93%E6%9E%84.jpg" alt=""></p>
<p>LinkedListç»§æ‰¿è‡ªAbstractSequentialListï¼Œè¯´æ˜LinkedListå…·æœ‰é¡ºåºéå†çš„ç‰¹æ€§ï¼ˆArrayListå®ç°äº†RandomAccessæ¥å£å…·æœ‰éšæœºéå†çš„ç‰¹æ€§ï¼‰ï¼Œå¦å¤–å®ƒè¿˜å®ç°äº†Dequeæ¥å£ï¼Œè¯´æ˜LinkedListå…·æœ‰åŒç«¯é˜Ÿåˆ—æ“ä½œçš„ç‰¹æ€§ã€‚</p>
<h3 id="ç±»æ–‡ä»¶è¯´æ˜">ç±»æ–‡ä»¶è¯´æ˜</h3>
<p>LinkedListå…ƒç´ ç±»å‹æ˜¯æ³›å‹ï¼Œå¯ä»¥å­˜æ”¾ã€æ‰€æœ‰ã€‘ç±»å‹çš„å…ƒç´ ï¼ŒåŒ…æ‹¬nullã€‚LinkedListçš„å…ƒç´ ä»¥åŒé“¾è¡¨çš„å½¢å¼å­˜å‚¨ï¼Œå› æ­¤åœ¨æŒ‡å®šä½ç½®æ’å…¥æˆ–åˆ é™¤å…ƒç´ éœ€è¦ä»å¤´é¡ºåºéå†æˆ–ä»å°¾åå‘é¡ºåºéå†åˆ°æŒ‡å®šindexæ‰€åœ¨çš„ä½ç½®ã€‚æ‰€ä»¥<strong>ArrayListéšæœºè®¿é—®è‚¯å®šæ¯”LinkedListå¿«</strong>ã€‚é‚£æ·»åŠ å’Œåˆ é™¤æ“ä½œLinkedListæ¯”ArrayListå¿«å—ï¼Ÿ<strong>NOï¼æ·»åŠ å’Œåˆ é™¤å…ƒç´ ç»¼åˆæ€§èƒ½ä¸¤è€…å·®ä¸å¤šï¼</strong></p>
<p>ArrayListåœ¨æŒ‡å®šindexå¤„æ·»åŠ æˆ–åˆ é™¤å…ƒç´ æ—¶ï¼Œä¸»è¦è€—æ—¶åœ¨è¦System.arraycopyï¼Œå®ƒè¦ç§»åŠ¨æŒ‡å®šindexåé¢æ‰€æœ‰çš„å…ƒç´ ã€‚</p>
<p>LinkedListåœ¨æŒ‡å®šindexæ·»åŠ æˆ–åˆ é™¤å…ƒç´ æ—¶ï¼Œä¸»è¦è€—æ—¶åœ¨éœ€è¦ä»å¤´é¡ºåºéå†æˆ–ä»å°¾åå‘é¡ºåºéå†åˆ°æŒ‡å®šindexæ‰€åœ¨çš„ä½ç½®ã€‚</p>
<p>æ‰€ä»¥ï¼š</p>
<p>å½“æŒ‡å®šæ’å…¥æˆ–åˆ é™¤å…ƒç´ çš„ä½ç½®è¶Šé å‰æ—¶ï¼ŒArrayListçš„æ€§èƒ½è¶Šå·®ã€‚</p>
<p>å½“æŒ‡å®šæ’å…¥æˆ–åˆ é™¤å…ƒç´ çš„ä½ç½®è¶Šé ä¸­é—´æ—¶ï¼ŒLinkedListçš„æ€§èƒ½è¶Šå·®ã€‚</p>
<p>æ•°æ®é‡å°æ—¶åŸºæœ¬æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä¸ç”¨è€ƒè™‘ï¼›æ•°æ®é‡å¤§æ—¶ï¼Œå¦‚æœåœ¨ä¸­é—´ä½ç½®æ’å…¥æˆ–åˆ é™¤çš„æ“ä½œå¢å¤šï¼Œæ­¤æ—¶LinkedListæ€§èƒ½å¹¶ä¸æ¯”ArrayListå¥½ã€‚</p>
<p>ç»¼ä¸Šï¼šä¸€èˆ¬é€‰ç”¨ArrayListå³å¯ã€‚LinkedListä¸»è¦ç”¨äºç‰¹æ®Šæ•°æ®ç»“æ„æ ˆã€é˜Ÿåˆ—ã€åŒç«¯é˜Ÿåˆ—æ“ä½œæ—¶ä½¿ç”¨ã€‚</p>
<p>LinkedListå†…éƒ¨å…ƒç´ åŒé“¾è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/LinkedList%E5%8F%8C%E9%93%BE%E8%A1%A8%E7%BB%93%E6%9E%84.jpg" alt=""></p>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªå‰é©±æŒ‡é’ˆå’Œåé©±æŒ‡é’ˆï¼ŒèŠ‚ç‚¹æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">  E item;</span><br><span class="line">  Node&lt;E&gt; next;</span><br><span class="line">  Node&lt;E&gt; prev;</span><br><span class="line"></span><br><span class="line">  Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class="line">    <span class="keyword">this</span>.item = element;</span><br><span class="line">    <span class="keyword">this</span>.next = next;</span><br><span class="line">    <span class="keyword">this</span>.prev = prev;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LinkedListæ•°æ®ç»“æ„å¦‚ä¸‹ï¼šåªæœ‰ä¸‰ä¸ªå±æ€§ï¼šsizeã€firstã€lastã€‚æ³¨é‡Šä¸Šæœ‰è¯´ï¼š</p>
<ol>
<li>firstä¸ºnullæ—¶lastä¹Ÿå¿…ä¸ºnullè¡¨ç¤ºæ˜¯ç©ºé“¾è¡¨</li>
<li>ç¬¬äºŒç‚¹ï¼šfirst.prev == null &amp;&amp; first.item != nulléªŒè¯äº†ä¸å¯¹ï¼Œitemæ˜¯å¯ä»¥ä¸ºnullçš„</li>
<li>ç¬¬ä¸‰ç‚¹åŒä¸Šï¼šlast.itemä¹Ÿæ˜¯å¯ä»¥ä¸ºnullçš„</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Pointer to first node.</span></span><br><span class="line"><span class="comment">* Invariant: (first == null &amp;&amp; last == null) ||</span></span><br><span class="line"><span class="comment">*            (first.prev == null &amp;&amp; first.item != null)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; first;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Pointer to last node.</span></span><br><span class="line"><span class="comment">* Invariant: (first == null &amp;&amp; last == null) ||</span></span><br><span class="line"><span class="comment">*            (last.next == null &amp;&amp; last.item != null)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;E&gt; last;</span><br></pre></td></tr></table></figure>
<h3 id="linkfirst">linkFirst</h3>
<p>linkFirståœ¨å¤´éƒ¨æ·»åŠ å…ƒç´ ï¼Œéœ€è¦è¿›è¡ŒæŒ‡é’ˆç§»åŠ¨æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Links e as first element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">linkFirst</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;E&gt; f = first;</span><br><span class="line">  <span class="comment">// æ–°å»ºå¤´èŠ‚ç‚¹,prev = null, next = f</span></span><br><span class="line">  <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(<span class="keyword">null</span>, e, f);</span><br><span class="line">  <span class="comment">// firstæŒ‡å‘æ–°å»ºçš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">  first = newNode;</span><br><span class="line">  <span class="comment">// å¦‚æœä¹‹å‰çš„firstä¸ºnullï¼Œè¡¨ç¤ºæ˜¯ç©ºé“¾è¡¨ï¼Œåˆ™lastä¹Ÿä¸ºnullï¼Œ</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶æ’å…¥æ–°èŠ‚ç‚¹é“¾è¡¨ä¸­åªæœ‰è¿™ä¸€ä¸ªèŠ‚ç‚¹ï¼Œfirstå’Œlastéƒ½æŒ‡å‘å®ƒ</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¹‹å‰çš„firstä¸ä¸ºnullï¼Œåˆ™è¡¨ç¤ºä¹‹å‰é“¾è¡¨å·²ç»æœ‰èŠ‚ç‚¹äº†ï¼Œ</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶éœ€è¦ä¿®æ”¹ä¹‹å‰çš„firstçš„å‰é©±prevä¸ºæ–°çš„firstèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (f == <span class="keyword">null</span>)</span><br><span class="line">    last = newNode;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f.prev = newNode;</span><br><span class="line">  size++;</span><br><span class="line">  modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ“ä½œå‰åå›¾ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/LinkedList-addFirst.jpg" alt=""></p>
<h3 id="linklast">linkLast</h3>
<p>linkLaståœ¨å°¾éƒ¨æ·»åŠ å…ƒç´ ï¼Œéœ€è¦è¿›è¡ŒæŒ‡é’ˆç§»åŠ¨æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Links e as last element.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkLast</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">  <span class="comment">// æ–°å»ºå°¾èŠ‚ç‚¹ï¼Œprev = lï¼Œ next = null</span></span><br><span class="line">  <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(l, e, <span class="keyword">null</span>);</span><br><span class="line">  <span class="comment">// lastæŒ‡å‘æ–°å»ºçš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">  last = newNode;</span><br><span class="line">  <span class="comment">// å¦‚æœä¹‹å‰çš„lastä¸ºnullï¼Œè¡¨ç¤ºæ˜¯ç©ºé“¾è¡¨ï¼Œåˆ™firstä¹Ÿä¸ºnullï¼Œ</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶æ’å…¥æ–°èŠ‚ç‚¹é“¾è¡¨ä¸­åªæœ‰è¿™ä¸€ä¸ªèŠ‚ç‚¹ï¼Œfirstå’Œlastéƒ½æŒ‡å‘å®ƒ</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¹‹å‰çš„lastä¸ä¸ºnullï¼Œåˆ™è¡¨ç¤ºä¹‹å‰é“¾è¡¨å·²ç»æœ‰èŠ‚ç‚¹äº†ï¼Œ</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶éœ€è¦ä¿®æ”¹ä¹‹å‰çš„lastçš„åé©±nextä¸ºæ–°çš„lastèŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (l == <span class="keyword">null</span>)</span><br><span class="line">    first = newNode;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    l.next = newNode;</span><br><span class="line">  size++;</span><br><span class="line">  modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ“ä½œå‰åå›¾ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/LinkedList-addLast.jpg" alt=""></p>
<h3 id="linkebefore">linkeBefore</h3>
<p>linkBeforeåœ¨æŒ‡å®šnodeå‰æ·»åŠ å…ƒç´ ï¼Œéœ€è¦è¿›è¡ŒæŒ‡é’ˆç§»åŠ¨æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Inserts element e before non-null Node succ.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkBefore</span><span class="params">(E e, Node&lt;E&gt; succ)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// assert succ != null;</span></span><br><span class="line">  <span class="comment">// æå–å‡ºæ–°æ’å…¥èŠ‚ç‚¹çš„prev</span></span><br><span class="line">  <span class="keyword">final</span> Node&lt;E&gt; pred = succ.prev;</span><br><span class="line">  <span class="comment">// succåˆ™æ˜¯æ–°æ’å…¥èŠ‚ç‚¹çš„next</span></span><br><span class="line">  <span class="comment">// æ–°å»ºå¾…æ’å…¥èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(pred, e, succ);</span><br><span class="line">  <span class="comment">// succ.prevæŒ‡å‘æ–°å»ºçš„èŠ‚ç‚¹</span></span><br><span class="line">  succ.prev = newNode;</span><br><span class="line">  <span class="comment">// å¦‚æœå¾…æ’å…¥èŠ‚ç‚¹çš„prevä¸ºnullï¼Œè¡¨ç¤ºæ–°æ’å…¥çš„èŠ‚ç‚¹å°†æ˜¯å¤´èŠ‚ç‚¹</span></span><br><span class="line">  <span class="comment">// å¦åˆ™ï¼Œæ­£å¸¸è®¾ç½®prev.nextä¸ºæ–°æ’å…¥èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">    first = newNode;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    pred.next = newNode;</span><br><span class="line">  size++;</span><br><span class="line">  modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ“ä½œå‰åå›¾ç¤ºï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/LinkedList-add-index.jpg" alt=""></p>
<h3 id="get">get</h3>
<p>LinkedListå®ç°äº†Listæ¥å£ï¼Œæ‰€ä»¥æ”¯æŒæŒ‰indexè·å–å…ƒç´ çš„æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­index æ˜¯å¦è¶…è¿‡LinkedListçš„indexåŒºé—´[0, sizeï¼‰</span></span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="comment">// æ ¹æ®index è·å–å¯¹åº”ä½ç½®çš„èŠ‚ç‚¹node</span></span><br><span class="line">    <span class="keyword">return</span> node(index).item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®index è·å–å¯¹åº”ä½ç½®çš„èŠ‚ç‚¹node</span></span><br><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// äºŒåˆ†æ³•åˆ¤æ–­æ˜¯ä»firstå¼€å§‹å‘åéå†è¿˜æ˜¯ä»lastå¼€å§‹å‘å‰éå†</span></span><br><span class="line">  <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">    Node&lt;E&gt; x = first;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">      x = x.next;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Node&lt;E&gt; x = last;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">      x = x.prev;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>é›†åˆ LinkedList</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¢¦</title>
    <url>/article/%E6%A2%A6/</url>
    <content><![CDATA[<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/dream.jpg" alt="dream"></p>
<p>å‰äº›å¤©æ™šä¸Šï¼ˆ2019-07-03ï¼‰é¬¼å‹åºŠç»å†ï¼ˆé€»è¾‘æ··ä¹±ï¼Œä½†æ˜¯æŠŠæˆ‘å“æƒ¨äº†ï¼‰:</p>
<ol>
<li>åƒæ˜¯åœ¨å°æ—¶å€™è€å®¶ï¼Œæ”¾å­¦å›å®¶ï¼Œå‘ç°çˆ¸å¦ˆéƒ½ä¸åœ¨å®¶ï¼Œåˆ°å¤„æ‰“ç”µè¯æ²¡äººæ¥ã€‚ç­‰åˆ°å¾ˆæ™šï¼Œå¦ˆæ‰ä»åœ°é‡Œå¹²å†œæ´»å›æ¥ï¼Œæˆ‘ç”Ÿæ°”çš„è´£å¤‡å¥¹ï¼Œå•·ä¸ªä¸æ¥ç”µè¯ï¼Œåˆé—®å¥¹çˆ¸å‘¢ï¼Œå¥¹è¯´ä¸å‡ºä¸ªæ‰€ä»¥ç„¶ã€‚æˆ‘è¿˜æ˜¯æœ‰ç‚¹ç”Ÿæ°”ï¼Œè¿˜æœ‰ç‚¹å¥‡æ€ªå’Œå¾€å¸¸ä¸ä¸€æ ·ï¼Œäºæ˜¯åœ¨å±‹é‡Œé‡Œè½¬æ‚ ä¸€åœˆï¼Œå‘ç°å‰ä¸¤å¤©è¿˜åœ¨çŒªåœˆé‡Œçš„çŒªä¸è§äº†ã€‚</li>
<li>çŒªä¸è§äº†ï¼Œå¦ˆæ²¡å‘Šè¯‰æˆ‘ï¼Œé‚£æ—¶å€™ä¹¡ä¸‹æœ‰å·çŒªçš„ï¼Œå› ä¸ºçŒªåœˆä¸€èˆ¬ç¦»æ­£æˆ¿æ¯”è¾ƒè¿œä¸æ˜“è¢«å‘è§‰ã€‚æˆ‘ä»¥ä¸ºå…»äº†é‚£ä¹ˆå¤§çš„çŒªçªç„¶è¢«å·äº†å¦ˆå¥¹ä¼¤å¿ƒï¼Œä¹Ÿæ€•æˆ‘ä¼¤å¿ƒå°±æ²¡å‘Šè¯‰æˆ‘ã€‚</li>
<li>æŸ¥çŒªä¸è§äº†ï¼Œçº¿ç´¢å‡ºç°åœ¨æˆ‘å¼€äº†ä¸ªä¸çŸ¥æ˜¯ç”µä¿¡è¿˜æ˜¯è”é€šç§»åŠ¨çš„çš„æœåŠ¡å™¨ï¼Œå¾ˆç¥å¥‡ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“å’‹ä»è¿™å„¿å¼€å§‹ï¼Œæ‰‹æœºä¸Šçœ‹æœåŠ¡å™¨çš„æ—¥å¿—å‘ç°å¤´å¤©æ™šä¸ŠåŠå¤œä¸¤ç‚¹æœ‰ä¸ªæ‰‹æœºå·è¿çŒªå‡ºå…³çš„è®°å½•ã€‚ä¸è¦é—®é€»è¾‘å¯¹ä¸å¯¹ï¼Œæˆ‘èƒ½æƒ³èµ·çš„å°±æ˜¯è¿™æ ·ã€‚</li>
<li>äºæ˜¯å»æ‰¾è¿è¥å•†æœåŠ¡å‘˜æŸ¥è¯¢å½“æ™šåŠå¤œä¸¤ç‚¹çš„è®°å½•ï¼Œæœç„¶å‘ç°æœ‰ä¸ªæ‰‹æœºå·è¿çŒªå‡ºå…³çš„è®°å½•ï¼Œåˆè®©æœåŠ¡å‘˜æŸ¥è¿™ä¸ªæ‰‹æœºå·å¯¹åº”çš„äººï¼Œç»ˆäºçŸ¥é“æ˜¯è°äº†ã€‚</li>
<li>ä»–æ˜¯å¤–å›½æ¥æˆ‘ä»¬æ‘æ‰“å·¥ä¸€ä¸ªå°ä¼™ï¼Œå¾ˆæ“…é•¿ç‚’èœï¼Œå‰§æƒ…ç²¾å½©å¼€å§‹äº†ï¼Œä¸€å¼€å§‹ä»–ä¹Ÿå°±ç‚’ç‚’èœï¼Œæœ‰å¤©ä»–å‘ç°ä»–è·Ÿå¦ä¸€ä¸ªä»æ—¥æœ¬æ¥çš„å°ä¼™é•¿å¾—å¾ˆåƒï¼Œä½†æ˜¯æ—¥æœ¬å°ä¼™åšçš„æ˜¯å¾ˆèµšé’±å¾ˆä¸Šæµçš„äº‹ï¼Œå…·ä½“å•¥äº‹å¿˜äº†ï¼Œå¥½åƒæ˜¯æ‹³å‡»ã€‚äºæ˜¯ä»–ç»å¸¸å†’å……æ—¥æœ¬å°ä¼™å»ä»–çš„å·¥ä½œåœ°æ‰“æ‹³å‡»èµšå¤–æ°´ï¼Œå°±è¿™ä¹ˆæµ‘æ°´æ‘¸é±¼å¾ˆä¹…ï¼Œå’‹æ‘¸è¿‡å»çš„æˆ‘ä¹Ÿä¸çŸ¥é“ã€‚ç»ˆäºæœ‰å¤©è¢«æ—¥æœ¬å°ä¼™å‘ç°äº†ï¼Œä¸¤äººéƒ½å¾ˆæƒŠå¥‡æœ‰ä¸ªå’Œè‡ªå·±é•¿å¾—è¿™ä¹ˆåƒçš„äººï¼Œåœ¨æƒŠå¥‡ææ…Œä¹‹é™…ï¼Œä»–å·²ç»çªè¢­è°‹æ€äº†æ—¥æœ¬å°ä¼™ï¼Œä»æ­¤ä»¥æ—¥æœ¬å°ä¼™çš„åä¹‰ç”Ÿæ´»ï¼Œå‡ºå…¥é«˜çº§åœºæ‰€ã€‚è€Œè¿™ä¸€åˆ‡æˆ‘æ˜¯æ€ä¹ˆçŸ¥é“çš„å‘¢ï¼Ÿä¹Ÿæ˜¯é¡ºè—¤æ‘¸ç“œåœ¨è¿è¥å•†æœåŠ¡å‘˜é‚£æŸ¥å‡ºæ¥çš„ã€‚äºæ˜¯çœŸç›¸å¤§ç™½äº†å¼€å§‹æŠ“å‡¶æ‰‹ã€‚</li>
<li>æŠ“å‡¶æ‰‹ï¼Œä¸çŸ¥æ˜¯æ€ä¹ˆèµ°æ¼äº†é£å£°ï¼Œä»–çŸ¥é“è‡ªå·±éœ²é¦…äº†ï¼Œäºæ˜¯å†³å®šå…ˆä¸‹æ‰‹ä¸ºå¼ºï¼Œå»æˆ‘å®¶æ‰“ç®—å¤§å¼€æ€æˆ’ã€‚æˆ‘åŠæ—¶èµ¶å›äº†å®¶ï¼Œåœ¨å±‹å‰é¢çš„é™¢åï¼Œé¦–å…ˆæˆ‘è·Ÿä»–å¯¹è´¨ï¼Œä»–æ‰¿è®¤ä»–å·çŒªäº†ï¼Œä½†æ˜¯ä»–æ‹’ä¸æŠ•é™ï¼Œäºæ˜¯æˆ˜æ–—å¼€å§‹ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆä»–ä¸æ˜¯æˆ‘çš„å¯¹æ‰‹ï¼Œä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæ‰“ç€æ‰“ç€ä»–ç°åŸå½¢äº†ã€‚ã€‚ã€‚åŸæ¥ä»–æ˜¯é¬¼ã€‚ã€‚ã€‚æˆ‘æ‰“çš„æ›´ç”¨åŠ›äº†ï¼Œèƒ½è®°èµ·çš„ç°åœºæ˜¯ä»–å¤´å‘è¢«ä»å¤´çš®æ’•å¼€ï¼Œé²œè¡€æ·‹æ¼“ï¼Œéšåå¤´ç›–éª¨ä¹Ÿæ€å¼€ï¼Œé²œè¡€åƒæ²¸è…¾ä¸€æ ·åœ¨é‚£è·³ï¼Œå‘¨å›´çš„äººçªç„¶è¢«è¿·æƒ‘äº†ï¼Œçœ‹ç€è¿™é²œè¡€æ²¸è…¾çš„å¤´é¢…ï¼Œå¤§å®¶éƒ½çœ‹æˆäº†ä¸€ç›˜å¥½åƒçš„èœï¼Œæ­£æ‰“ç®—ä¸‹å˜´ï¼Œè¢«æˆ‘ä¸€å£°å†å–ï¼Œå¤§å®¶æ‰ä»è¿·æƒ‘ä¸­è§£é™¤ï¼Œç¬é—´å“å¾—åé€€ï¼Œè€Œé‚£ä¸ªé²œè¡€æ²¸è…¾çš„å¤´é¢…å±…ç„¶å˜æˆäº†ç±»ä¼¼éŸ©å›½åƒµå°¸çš„ä¸œè¥¿ç»§ç»­è·Ÿæˆ‘å¯¹æˆ˜ï¼Œå’ŒéŸ©å›½åƒµå°¸ç±»ä¼¼ï¼Œåªè¦è¢«ä»–æŠ“ä¼¤çš„äººé©¬ä¸Šä¹Ÿä¼šå˜åƒµå°¸ã€‚å¾ˆä¸å¹¸åœ¨æˆ‘è§£å†³ä»–ä¹‹å‰ï¼Œå¥¶å¥¶è¢«ä»–æŠ“ä¼¤äº†ï¼Œå˜æˆåƒµå°¸ç»§ç»­æ¥æŠ“æˆ‘ä»¬ï¼Œæˆ‘ä»¬èº²è¿›å±‹é‡Œï¼Œä½†æ˜¯é—¨æ˜¯åçš„ï¼Œå¥¶å¥¶ä¸€ç›´åœ¨é—¨å¤–æ’é—¨ï¼Œçœ¼çœ‹é—¨å°±è¦è¢«æ’å¼€äº†ï¼Œå¤§å®¶çªç„¶ä¸çŸ¥é“å’‹çš„è¹¦çš„ä¸€ä¸‹è·³åˆ°å¥½è¿œçš„åœ°æ–¹ï¼Œè®©å¥¶å¥¶è¿½ä¸ä¸Šï¼Œè¶å¥¶å¥¶è¿½ä¸ä¸Šè¿™æ®µæ—¶é—´å¤§å®¶ä¹˜é£æœºå®‰å…¨è„±é™©äº†ã€‚</li>
<li>ä»¥ä¸ºæ•…äº‹ç»ˆäºå®Œäº†ï¼Œçªç„¶æ„Ÿè§‰é—¨è¢«é£å¹å¼€äº†ä¸€æ¡ç¼ï¼ŒåŸæ¥è‡ªå·±æ˜¯åœ¨åšæ¢¦ï¼Œæ¢¦é†’äº†ã€‚ä½†æ˜¯æˆ‘å´åŠ¨ä¸äº†ï¼Œçœ¼ç›æ„Ÿè§‰çœ‹åˆ°ä»€ä¹ˆä¸œè¥¿ä»é—¨å¤–è¿›æ¥æ…¢æ…¢å‘æˆ‘é è¿‘ï¼Œæˆ‘ä¸åœçš„æŒ£æ‰ï¼Œæè‡ªå·±è‚‰ä¸è¡Œï¼Œç„¶ååˆç”¨åŠ›æ‘†å¤´ï¼Œè¿˜ç”¨åŠ›æç¡åœ¨è¾¹ä¸Šçš„è€å©†ï¼Œä¸€é¡¿æ“ä½œä¹‹åï¼Œç»ˆäºæˆ‘é†’äº†ï¼Œå§æ§½ï¼Œåˆæ˜¯é¬¼å‹åºŠã€‚å¥½ä¹…æ²¡ç¢°åˆ°è¿‡äº†ã€‚æˆ‘æ‘‡é†’è€å©†è¯´æˆ‘åˆšæ‰ç¢°åˆ°é¬¼å‹åºŠäº†ï¼Œæˆ‘æä½ æ‰é†’äº†æŒ£è„±å¼€çš„ã€‚å¥¹è¯´æ²¡æ„Ÿåˆ°æˆ‘æå¥¹å•Šã€‚æˆ‘å†çœ‹é—¨æœ‰æ²¡æœ‰å¼€ä¸€æ¡ç¼ï¼Œä¹Ÿæ²¡æœ‰ã€‚å§æ§½ã€‚ã€‚ã€‚å¿ƒé‡Œä¸€é˜µå“†å—¦ï¼Œå†ä¹Ÿç¡ä¸ç€è§‰äº†ï¼Œæ‹¿èµ·æ‰‹æœºè®°ä¸‹åˆšæ‰å‘ç”Ÿçš„ä¸€åˆ‡ã€‚å¤©æ…¢æ…¢äº®äº†ï¼Œå‡Œæ™¨å…­ç‚¹ã€‚</li>
</ol>
]]></content>
      <tags>
        <tag>ç”Ÿæ´»</tag>
      </tags>
  </entry>
  <entry>
    <title>ç®—æ³•-å½’å¹¶æ’åº</title>
    <url>/article/%E7%AE%97%E6%B3%95-%E5%BD%92%E5%B9%B6%E6%8E%92%E5%BA%8F/</url>
    <content><![CDATA[<p>å½’å¹¶æ’åºåˆ©ç”¨åˆ†è€Œæ²»ä¹‹çš„åŠæ³•å°†é—®é¢˜å¤§åŒ–å°ï¼Œå¹³å‡ã€æœ€åã€æœ€å¥½æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(nlogn)ï¼Œé‡‡ç”¨é€’å½’æ³•ï¼š</p>
<ol>
<li>ç”³è¯·ç©ºé—´ï¼Œä½¿å…¶å¤§å°ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—ä¹‹å’Œï¼Œè¯¥ç©ºé—´ç”¨æ¥å­˜æ”¾åˆå¹¶åçš„åºåˆ—</li>
<li>è®¾å®šä¸¤ä¸ªæŒ‡é’ˆï¼Œæœ€åˆä½ç½®åˆ†åˆ«ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®</li>
<li>æ¯”è¾ƒä¸¤ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ ï¼Œé€‰æ‹©ç›¸å¯¹å°çš„å…ƒç´ æ”¾å…¥åˆ°åˆå¹¶ç©ºé—´ï¼Œå¹¶ç§»åŠ¨æŒ‡é’ˆåˆ°ä¸‹ä¸€ä½ç½®</li>
<li>é‡å¤æ­¥éª¤3ç›´åˆ°æŸä¸€æŒ‡é’ˆåˆ°è¾¾åºåˆ—å°¾</li>
<li>å°†å¦ä¸€åºåˆ—å‰©ä¸‹çš„æ‰€æœ‰å…ƒç´ ç›´æ¥å¤åˆ¶åˆ°åˆå¹¶åºåˆ—å°¾</li>
</ol>
<p>é€’å½’æ³•çš„Javaå®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeSort</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX = <span class="number">100000</span>;<span class="comment">//100000ä¸ªæ•°è¿›è¡Œæ’åº</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] ints = <span class="keyword">new</span> <span class="keyword">int</span>[MAX];</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        Random r = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">1</span> ; index &lt;= MAX ; index++) &#123;</span><br><span class="line">            ints[index - <span class="number">1</span>] = r.nextInt(<span class="number">10000000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String []args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis ();</span><br><span class="line">        <span class="comment">//ints = new int[]&#123;9,8,7,6,5,4,3,2,1&#125;;</span></span><br><span class="line">        sort( ints );</span><br><span class="line">        System.out.println(Arrays.toString( ints ));</span><br><span class="line">        System.out.println ( (System.currentTimeMillis () - start) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span> []arr)</span></span>&#123;</span><br><span class="line">        sort(arr,<span class="number">0</span>,arr.length-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥å¾…æ’åºæ•°ç»„ arr &#123;9,8,7,6,5,4,3,2,1&#125;ä¸¾ä¾‹ï¼šç¨‹åºçš„è¿è¡Œæµç¨‹å¦‚ä¸‹: (å¦‚ä¸‹æ•°å­—è¡¨ç¤ºæ•°ç»„ä¸‹æ ‡)</span></span><br><span class="line"><span class="comment">     *  1.  sort 0, 8</span></span><br><span class="line"><span class="comment">     *  2.  sort 0, 4 (left, mid)</span></span><br><span class="line"><span class="comment">     *  3.  sort 0, 2 (left, mid)</span></span><br><span class="line"><span class="comment">     *  4.  sort 0, 1 (left, mid)</span></span><br><span class="line"><span class="comment">     *  5.  sort 0, 0 (left, mid) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     *  6.  sort 1, 1 (mid+1, right) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     *  7. merge [0,0,1] (åˆå¹¶[0],[1]æˆ[0,1])</span></span><br><span class="line"><span class="comment">     *  9. é€’å½’è¿”å›åˆ° 3. sort 0, 2 çš„ä¸‹ä¸€æ­¥: sort 2, 2 (mid+1, right) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     * 10. merge [0,1,2] (åˆå¹¶[0,1],[2]æˆ[0,2])</span></span><br><span class="line"><span class="comment">     * 11. é€’å½’è¿”å›åˆ° 2. sort 0, 4 çš„ä¸‹ä¸€æ­¥: sort3, 4 (mid+1, right)</span></span><br><span class="line"><span class="comment">     * 12. sort 3, 3 (left, mid) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     * 13. sort 4, 4 (mid+1, right) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     * 15. merge [3,3,4] (åˆå¹¶[3],[4]æˆ[3,4])</span></span><br><span class="line"><span class="comment">     * 16. merge [0,2,4] (åˆå¹¶[0,2],[3,4]æˆ[0,4]) ï¼ˆè‡³æ­¤ï¼Œå·¦è¾¹æ’åºsort(arr,left,mid)å®Œæˆï¼‰</span></span><br><span class="line"><span class="comment">     * 17. sort 5, 8 (mid+1, right) (ç»§ç»­è¿›è¡Œå³è¾¹æ’åºsort(arr,mid+1,right))</span></span><br><span class="line"><span class="comment">     * 18. sort 5, 6 (left, mid)</span></span><br><span class="line"><span class="comment">     * 19. sort 5, 5 (left, mid) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     * 20. sort 6, 6 (mid+1, right) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     * 21. merge [5,5,6] (åˆå¹¶[5],[6]æˆ[5,6])</span></span><br><span class="line"><span class="comment">     * 22. é€’å½’è¿”å›åˆ° 17. sort 5, 8 çš„ä¸‹ä¸€æ­¥: sort 7, 8 (mid+1, right)</span></span><br><span class="line"><span class="comment">     * 23. sort 7, 7 (left, mid) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     * 24. sort 8, 8 (mid+1, right) (è‡ªç„¶æœ‰åºï¼Œç›´æ¥è¿”å›)</span></span><br><span class="line"><span class="comment">     * 25. merge [7,7,8] (åˆå¹¶[7],[8]æˆ[7,8])</span></span><br><span class="line"><span class="comment">     * 26. merge [5,6,8] (åˆå¹¶[5,6],[7,8]æˆ[5,8]) (è‡³æ­¤ï¼Œå³è¾¹æ’åºsort(arr,mid+1,right)å®Œæˆ)</span></span><br><span class="line"><span class="comment">     * 27. merge [0,4,8] (åˆå¹¶[0,4],[5,8]æˆ[0,8]) (è‡³æ­¤ï¼Œå·¦å³ä¸¤è¾¹åˆå¹¶æ’åºå®Œæˆ)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> left</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> right</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> left,<span class="keyword">int</span> right)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(left&lt;right)&#123;</span><br><span class="line">            <span class="keyword">int</span> mid = (left+right)/<span class="number">2</span>;</span><br><span class="line">            sort(arr,left,mid);<span class="comment">//å·¦è¾¹å½’å¹¶æ’åºï¼Œä½¿å¾—å·¦å­åºåˆ—æœ‰åº</span></span><br><span class="line">            sort(arr,mid+<span class="number">1</span>,right);<span class="comment">//å³è¾¹å½’å¹¶æ’åºï¼Œä½¿å¾—å³å­åºåˆ—æœ‰åº</span></span><br><span class="line">            merge(arr,left,mid,right);<span class="comment">//å°†ä¸¤ä¸ªæœ‰åºå­æ•°ç»„åˆå¹¶æ“ä½œ</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> left,<span class="keyword">int</span> mid,<span class="keyword">int</span> right)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = left;<span class="comment">//å·¦åºåˆ—æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">int</span> j = mid+<span class="number">1</span>;<span class="comment">//å³åºåˆ—æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">int</span> t = <span class="number">0</span>;<span class="comment">//ä¸´æ—¶æ•°ç»„æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">int</span>[] temp = <span class="keyword">new</span> <span class="keyword">int</span>[arr.length];</span><br><span class="line">        <span class="keyword">while</span> (i&lt;=mid &amp;&amp; j&lt;=right)&#123;</span><br><span class="line">            <span class="keyword">if</span>(arr[i]&lt;=arr[j])&#123;</span><br><span class="line">                temp[t++] = arr[i++];</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                temp[t++] = arr[j++];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(i&lt;=mid)&#123;<span class="comment">//å°†å·¦è¾¹å‰©ä½™å…ƒç´ å¡«å……è¿›tempä¸­</span></span><br><span class="line">            temp[t++] = arr[i++];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(j&lt;=right)&#123;<span class="comment">//å°†å³åºåˆ—å‰©ä½™å…ƒç´ å¡«å……è¿›tempä¸­</span></span><br><span class="line">            temp[t++] = arr[j++];</span><br><span class="line">        &#125;</span><br><span class="line">        t = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//å°†tempä¸­çš„å…ƒç´ å…¨éƒ¨æ‹·è´åˆ°åŸæ•°ç»„ä¸­</span></span><br><span class="line">        <span class="keyword">while</span>(left &lt;= right)&#123;</span><br><span class="line">            arr[left++] = temp[t++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±ä»¥ä¸Šé€’å½’æ³•çš„å®ç°å¯çŸ¥ï¼šå¤§åŒ–å°æ’åºæ˜¯å¯ä»¥å¹¶å‘è¿›è¡Œçš„ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹å¹¶å‘æ’åºå¦‚ä¸‹ï¼šForkJoinTaskä»»åŠ¡æ’åºï¼š</p>
<p>ForkJoinSortTask.java:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.RecursiveTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public class ForkJoinSortTask extends RecursiveTask&lt;int[]&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] ints;</span><br><span class="line"></span><br><span class="line">    ForkJoinSortTask(<span class="keyword">int</span>[] ints) &#123;</span><br><span class="line">        <span class="keyword">this</span>.ints = ints;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å½’å¹¶æ’åºçš„ç‰¹å¾ï¼šåˆ©ç”¨åˆ†æ²»æ³•ï¼Œå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹åŒæ—¶è¿›è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span>[] compute() &#123;</span><br><span class="line">        <span class="keyword">int</span> len = ints.length;</span><br><span class="line">        <span class="keyword">if</span> (len &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> mid = len / <span class="number">2</span>;</span><br><span class="line">            ForkJoinSortTask leftTask = <span class="keyword">new</span> ForkJoinSortTask ( Arrays.copyOf ( ints, mid) );</span><br><span class="line">            leftTask.fork ();</span><br><span class="line">            ForkJoinSortTask rightTask = <span class="keyword">new</span> ForkJoinSortTask ( Arrays.copyOfRange ( ints, mid, len) );</span><br><span class="line">            rightTask.fork ();</span><br><span class="line">            <span class="keyword">return</span> merge(leftTask.join (), rightTask.join ());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (len != <span class="number">1</span> &amp;&amp; ints[<span class="number">0</span>] &gt;= ints[<span class="number">1</span>]) &#123;</span><br><span class="line">                <span class="keyword">int</span> tmp = ints[<span class="number">1</span>];</span><br><span class="line">                ints[<span class="number">1</span>] = ints[<span class="number">0</span>];</span><br><span class="line">                ints[<span class="number">0</span>] = tmp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ints;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†ä¸¤ä¸ªæœ‰åºçš„æ•°ç»„åˆå¹¶æˆä¸€ä¸ªæœ‰åºæ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] merge(<span class="keyword">int</span>[] leftSorted, <span class="keyword">int</span>[] rightSorted) &#123;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> right = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span>[] merged = <span class="keyword">new</span> <span class="keyword">int</span>[leftSorted.length + rightSorted.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; leftSorted.length + rightSorted.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (left == leftSorted.length) &#123;</span><br><span class="line">                merged[i] = rightSorted[right];</span><br><span class="line">                right++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (right == rightSorted.length) &#123;</span><br><span class="line">                merged[i] = leftSorted[left];</span><br><span class="line">                left++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (leftSorted[left] &lt; rightSorted[right]) &#123;</span><br><span class="line">                merged[i] = leftSorted[left];</span><br><span class="line">                left++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                merged[i] = rightSorted[right];</span><br><span class="line">                right++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> merged;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ForkJoinSort.javaï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinPool;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ForkJoinTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkJoinSort</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX = <span class="number">100000</span>;<span class="comment">//100000ä¸ªæ•°è¿›è¡Œæ’åº</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] ints = <span class="keyword">new</span> <span class="keyword">int</span>[MAX];</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        Random r = <span class="keyword">new</span> Random();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> index = <span class="number">1</span> ; index &lt;= MAX ; index++) &#123;</span><br><span class="line">            ints[index - <span class="number">1</span>] = r.nextInt(<span class="number">10000000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis ();</span><br><span class="line">        ForkJoinPool forkJoinPool = <span class="keyword">new</span> ForkJoinPool (  );</span><br><span class="line">        ForkJoinSortTask forkJoinSortTask = <span class="keyword">new</span> ForkJoinSortTask ( ints );</span><br><span class="line">        <span class="comment">//ForkJoinSortTask forkJoinSortTask = new ForkJoinSortTask ( new int[]&#123;9,8,7,6,5,4,3,2,1&#125;);</span></span><br><span class="line">        ForkJoinTask&lt;<span class="keyword">int</span>[]&gt; forkJoinTask = forkJoinPool.submit ( forkJoinSortTask );</span><br><span class="line">        <span class="keyword">int</span>[] result = forkJoinTask.get ();</span><br><span class="line">        System.out.println( Arrays.toString(result));</span><br><span class="line">        System.out.println ( (System.currentTimeMillis () - start) );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹æ¯”ä»¥ä¸Šä¸¤ç§æ’åºå®ç°ï¼Œæœªä½¿ç”¨å¤šçº¿ç¨‹ï¼Œæ’åº100000ä¸ªéšæœºæ•°å¤§æ¦‚éœ€è¦5ç§’ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹åªéœ€è¦200æ¯«ç§’ä»¥å†…</p>
]]></content>
      <tags>
        <tag>ç®—æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼-ä»£ç†æ¨¡å¼</title>
    <url>/article/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="å®šä¹‰">å®šä¹‰</h3>
<p><strong>ä»£ç†æ¨¡å¼</strong>æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½å¤Ÿæä¾›å¯¹è±¡çš„æ›¿ä»£å“ã€‚ ä»£ç†æ§åˆ¶ç€å¯¹åŸå¯¹è±¡çš„è®¿é—®ï¼Œ å¹¶å…è®¸åœ¨å°†è¯·æ±‚æäº¤ç»™å¯¹è±¡å‰åè¿›è¡Œä¸€äº›å¤„ç†ã€‚</p>
<h3 id="é™æ€ä»£ç†">é™æ€ä»£ç†</h3>
<p>è¿™ç§ä»£ç†æ–¹å¼éœ€è¦ä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡å®ç°ä¸€æ ·çš„æ¥å£ã€‚ä¼˜ç‚¹ï¼šå¯ä»¥åœ¨ä¸ä¿®æ”¹ç›®æ ‡å¯¹è±¡çš„å‰æä¸‹æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚ç¼ºç‚¹ï¼šæ‰©å±•è¢«ä»£ç†ç±»åŠŸèƒ½æ—¶ä¼šäº§ç”Ÿè¿‡å¤šçš„ä»£ç†ç±»ï¼Œå¦‚æœç›®æ ‡æ¥å£ä¿®æ”¹ï¼Œæ‰€æœ‰ç±»åŒ…æ‹¬ä»£ç†ç±»éƒ½è¦ä¿®æ”¹ã€‚</p>
<p>é™æ€ä»£ç†çš„ä¸¤ç§å®ç°æ–¹å¼ï¼š1ã€ç»§æ‰¿ï¼Œ2ã€ç»„åˆ</p>
<p>å…ˆå®šä¹‰ç›®æ ‡ç±»å’Œæ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Flyable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bird</span> <span class="keyword">implements</span> <span class="title">Flyable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(Bird.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info ( <span class="string">"Bird flying"</span> );</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           Thread.sleep ( <span class="keyword">new</span> Random ( ).nextInt (<span class="number">100</span>) );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç»§æ‰¿">ç»§æ‰¿</h4>
<p>é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ¥æ–°å»ºä¸¤ä¸ªä»£ç†ç±»ç»Ÿè®¡æ—¶é—´å’Œè®°å½•Logï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdFlyTime</span> <span class="keyword">extends</span> <span class="title">Bird</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdFlyTime.class );</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis ();</span><br><span class="line">        <span class="keyword">super</span>.fly ();</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis ();</span><br><span class="line">        logger.info ( <span class="string">"Bird flying time: &#123;&#125;"</span>, end - start );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdLog</span> <span class="keyword">extends</span> <span class="title">Bird</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdLog.class );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info ( <span class="string">"Bird fly start..."</span> );</span><br><span class="line">        <span class="keyword">super</span>.fly ();</span><br><span class="line">        logger.info ( <span class="string">"Bird fly end..."</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ç»§æ‰¿ä»£ç†ï¼šå¯çŸ¥ä½¿ç”¨ç»§æ‰¿å®ç°çš„é™æ€ä»£ç†ï¼Œä¸èƒ½åŒæ—¶ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Bird bird = <span class="keyword">new</span> Bird ();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä½¿ç”¨ç»§æ‰¿å®ç°çš„é™æ€ä»£ç†ï¼Œä¸èƒ½åŒæ—¶ä½¿ç”¨</span></span><br><span class="line">    BirdLog birdLog = <span class="keyword">new</span> BirdLog ();</span><br><span class="line">    birdLog.fly ();</span><br><span class="line">    </span><br><span class="line">    BirdFlyTime birdFlyTime = <span class="keyword">new</span> BirdFlyTime ();</span><br><span class="line">    birdFlyTime.fly ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç»„åˆ">ç»„åˆ</h4>
<p>é€šè¿‡ç»„åˆçš„æ–¹å¼æ¥æ–°å»ºä¸¤ä¸ªä»£ç†ç±»ç»Ÿè®¡æ—¶é—´å’Œè®°å½•Logï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdFlyTimeProxy</span> <span class="keyword">implements</span> <span class="title">Flyable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdFlyTimeProxy.class );</span><br><span class="line">    <span class="keyword">private</span> Flyable flyable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BirdFlyTimeProxy</span><span class="params">(Flyable flyable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flyable = flyable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">long</span> start = System.currentTimeMillis ();</span><br><span class="line">       logger.info ( <span class="string">"Bird flying start time: &#123;&#125;"</span>, start );</span><br><span class="line">       flyable.fly ();</span><br><span class="line">       <span class="keyword">long</span> end = System.currentTimeMillis ();</span><br><span class="line">       logger.info ( <span class="string">"Bird flying end time: &#123;&#125;"</span>, end );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdLogProxy</span> <span class="keyword">implements</span> <span class="title">Flyable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdLogProxy.class );</span><br><span class="line">    <span class="keyword">private</span> Flyable flyable;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BirdLogProxy</span><span class="params">(Flyable flyable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flyable = flyable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info ( <span class="string">"Bird fly start..."</span> );</span><br><span class="line">        flyable.fly ();</span><br><span class="line">        logger.info ( <span class="string">"Bird fly end..."</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ç»„åˆä»£ç†ï¼šå¯çŸ¥ä½¿ç”¨ç»„åˆå®ç°çš„é™æ€ä»£ç†å¯ä»¥åŒæ—¶ä½¿ç”¨å¹¶çµæ´»è°ƒæ¢ä»£ç†çš„æ‰§è¡Œé¡ºåº</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Bird bird = <span class="keyword">new</span> Bird ();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä½¿ç”¨ç»„åˆå®ç°çš„é™æ€ä»£ç†å¯ä»¥åŒæ—¶ä½¿ç”¨å¹¶çµæ´»è°ƒæ¢ä»£ç†çš„æ‰§è¡Œé¡ºåº</span></span><br><span class="line">    BirdLogProxy birdLogProxy1 = <span class="keyword">new</span> BirdLogProxy ( bird );</span><br><span class="line">    BirdFlyTimeProxy birdFlyTimeProxy1 = <span class="keyword">new</span> BirdFlyTimeProxy ( birdLogProxy1 );</span><br><span class="line">    birdFlyTimeProxy1.fly ();</span><br><span class="line"></span><br><span class="line">    BirdFlyTimeProxy birdFlyTimeProxy2 = <span class="keyword">new</span> BirdFlyTimeProxy ( bird );</span><br><span class="line">    BirdLogProxy birdLogProxy2 = <span class="keyword">new</span> BirdLogProxy ( birdFlyTimeProxy2 );</span><br><span class="line">    birdLogProxy2.fly ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åŠ¨æ€ä»£ç†">åŠ¨æ€ä»£ç†</h3>
<p>ç›¸å¯¹äºé™æ€ä»£ç†éœ€è¦æ‰‹åŠ¨ä¹¦å†™ä»£ç†ç±»ç„¶åç¼–è¯‘ç”Ÿæˆclassæ–‡ä»¶è½½å…¥JVMè¿è¡Œï¼ŒåŠ¨æ€ä»£ç†æ˜¯åœ¨JVMè¿è¡Œèµ·æ¥ä»¥ååœ¨å†…å­˜ä¸­åŠ¨æ€çš„åˆ›å»ºä»£ç†ç±»classæ–‡ä»¶ï¼ˆå­—èŠ‚æµï¼‰å¹¶è½½å…¥JVMæ‰§è¡Œã€‚</p>
<p>åŠ¨æ€ä»£ç†åˆåˆ†ä¸ºJDKåŠ¨æ€ä»£ç†å’ŒCGLIBåŠ¨æ€ä»£ç†ã€‚</p>
<h4 id="jdkåŠ¨æ€ä»£ç†">JDKåŠ¨æ€ä»£ç†</h4>
<p>è¦ä½¿ç”¨JDKåŠ¨æ€ä»£ç†æœ‰ä¸€ä¸ªå‰æï¼Œè¦æ±‚è¢«ä»£ç†çš„ç›®æ ‡ç±»å¿…é¡»å®ç°æ¥å£ã€‚JDKåŠ¨æ€ä»£ç†å¯ä»¥çœ‹ä½œç»„åˆå‹é™æ€ä»£ç†çš„æ‰©å±•ï¼Œå®ƒå°è£…äº†å…·ä½“çš„è¢«ä»£ç†ç›®æ ‡ç±»ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£InvocationHandlerï¼Œè®©ä»£ç†ç±»å®ç°è¿™ä¸ªæ¥å£å³å¯ï¼Œå®ç°äº†å¯¹æ‰€æœ‰ä¸åŒç›®æ ‡ç±»çš„ä»£ç†åŠŸèƒ½ã€‚</p>
<p>è¿˜æ˜¯ä»¥ä¸Šé¢Flyableæ¥å£+Birdç±»ä¸¾ä¾‹ä½¿ç”¨JDKä»£ç†ã€‚</p>
<p>é¦–å…ˆä»£ç†ç±»éœ€è¦å®ç°InvocationHandleræ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdLogProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdLogProxy.class );</span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BirdLogProxy</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        logger.info ( <span class="string">"Bird fly start..."</span> );</span><br><span class="line">        method.invoke ( object, args);</span><br><span class="line">        logger.info ( <span class="string">"Bird fly end..."</span> );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdFlyTimeProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdFlyTimeProxy.class );</span><br><span class="line">    <span class="keyword">private</span> Object object;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BirdFlyTimeProxy</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.object = object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis ();</span><br><span class="line">        logger.info ( <span class="string">"Bird flying start time: &#123;&#125;"</span>, start );</span><br><span class="line">        method.invoke ( object, args );</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis ();</span><br><span class="line">        logger.info ( <span class="string">"Bird flying end time: &#123;&#125;"</span>, end );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ ¹å…·ä½“çš„ç›®æ ‡ç±»ç»‘å®šï¼Œè°ƒç”¨Proxy.newProxyInstanceå³å¯ç”Ÿæˆä»£ç†ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JDKProxyUsage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Bird bird = <span class="keyword">new</span> Bird ();</span><br><span class="line">        </span><br><span class="line">        BirdLogProxy birdLogProxy = <span class="keyword">new</span> BirdLogProxy ( bird );</span><br><span class="line">        Flyable flyable = (Flyable) Proxy.newProxyInstance ( bird.getClass ().getClassLoader (), bird.getClass ().getInterfaces (), birdLogProxy );</span><br><span class="line">        flyable.fly ();</span><br><span class="line">        </span><br><span class="line">        BirdFlyTimeProxy birdFlyTimeProxy = <span class="keyword">new</span> BirdFlyTimeProxy ( bird );</span><br><span class="line">        flyable = (Flyable) Proxy.newProxyInstance ( bird.getClass ().getClassLoader (), bird.getClass ().getInterfaces (), birdFlyTimeProxy );</span><br><span class="line">        flyable.fly ();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="cglibåŠ¨æ€ä»£ç†">CGLIBåŠ¨æ€ä»£ç†</h4>
<p>CGLIBæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹ä»£ç ç”Ÿæˆç±»åº“ï¼Œå®ƒçš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚ç å¤„ç†æ¡†æ¶ASMï¼Œæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ã€‚CGLIBåŠ¨æ€ä»£ç†å’ŒJDKåŠ¨æ€ä»£ç†çš„åŒºåˆ«æ˜¯ï¼š<strong>CGLIBå¯¹è¢«ä»£ç†çš„ç›®æ ‡ç±»æ²¡æœ‰å¿…é¡»è¦å®ç°æ¥å£çš„è¦æ±‚ï¼Œåªè¦ç›®æ ‡ç±»ä¸æ˜¯finalç±»å³å¯</strong>ï¼Œç”±æ­¤å¯è§CGLIBæ˜¯ä½¿ç”¨ç»§æ‰¿çš„æ–¹å¼æ¥å®ç°ä»£ç†ç±»çš„ã€‚</p>
<p>è¿˜æ˜¯ä»¥ä¸Šé¢Flyableæ¥å£+Birdç±»ä¸¾ä¾‹ä½¿ç”¨CGLIBä»£ç†ã€‚</p>
<p>é¦–å…ˆä»£ç†ç±»éœ€è¦å®ç°MethodInterceptoræ¥å£ï¼ˆæ­¤å¤„ä½¿ç”¨äº†å•ä¾‹æ¨¡å¼ï¼‰ï¼Œé€šè¿‡getProxyæ–¹æ³•å³å¯ç”Ÿæˆä»£ç†ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdLogProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdLogProxy.class );</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BirdLogProxy cglibProxy = <span class="keyword">new</span> BirdLogProxy ();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BirdLogProxy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BirdLogProxy <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cglibProxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (T) Enhancer.create ( clazz, <span class="keyword">this</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        logger.info ( <span class="string">"Bird fly start..."</span> );</span><br><span class="line">        methodProxy.invokeSuper ( o, objects );</span><br><span class="line">        logger.info ( <span class="string">"Bird fly end..."</span> );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BirdFlyTimeProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger ( BirdFlyTimeProxy.class );</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BirdFlyTimeProxy cglibProxy = <span class="keyword">new</span> BirdFlyTimeProxy ();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BirdFlyTimeProxy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BirdFlyTimeProxy <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cglibProxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (T) Enhancer.create ( clazz, <span class="keyword">this</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis ();</span><br><span class="line">        logger.info ( <span class="string">"Bird flying start time: &#123;&#125;"</span>, start );</span><br><span class="line">        methodProxy.invokeSuper ( o, objects );</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis ();</span><br><span class="line">        logger.info ( <span class="string">"Bird flying end time: &#123;&#125;"</span>, end );</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨CGLIBä»£ç†å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Bird bird = BirdLogProxy.getInstance ().getProxy ( Bird.class );</span><br><span class="line">    bird.fly ();</span><br><span class="line"></span><br><span class="line">    bird = BirdFlyTimeProxy.getInstance ().getProxy ( Bird.class );</span><br><span class="line">    bird.fly ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>æ­£ç¡®ä½¿ç”¨volatile</title>
    <url>/article/%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8volatile/</url>
    <content><![CDATA[<h3 id="volatileè¯­ä¹‰">volatileè¯­ä¹‰</h3>
<pre><code>     1. å†…å­˜å¯è§æ€§
        ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†volatileä¿®é¥°çš„å˜é‡çš„å€¼åï¼Œæ–°å€¼å¯¹å¦ä¸€ä¸ªçº¿ç¨‹ç«‹å³å¯è§
        
     2. ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–
        å¯¹volatileä¿®é¥°å¯¹å˜é‡è¿›è¡Œè¯»å†™æ“ä½œçš„å‰åæ’å…¥å†…å­˜å±éšœä»¥è¾¾åˆ°ç¦æ­¢volatileä¿®é¥°çš„å˜é‡å’Œå…¶å‰åå…¶ä»–å˜é‡çš„æŒ‡ä»¤é‡æ’åº
        
     3. ä½¿ç”¨æ—¶çš„è¡¨ç°ï¼š
        å¯¹volatileä¿®é¥°çš„å˜é‡è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå°†çº¿ç¨‹å·¥ä½œå†…å­˜é‡Œçš„å˜é‡å‰¯æœ¬ç½®ä¸ºæ— æ•ˆï¼Œç„¶åä»ä¸»å†…å­˜è¯»å–å¹¶åˆ·æ–°å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬
        å¯¹volatileä¿®é¥°å¯¹å˜é‡è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå°†çº¿ç¨‹å·¥ä½œå†…å­˜é‡Œå¯¹å˜é‡å‰¯æœ¬åˆ·æ–°åˆ°ä¸»å†…å­˜
        
     4. æ³¨æ„äº‹é¡¹ï¼š
        volatileåªèƒ½ä¿è¯å¯è§æ€§å’Œå¯¹æ­¤å˜é‡å•ç‹¬æ“ä½œçš„åŸå­æ€§ï¼Œå½“å¯¹volatileä¿®é¥°çš„å˜é‡æ¶‰åŠåˆ°å¤åˆæ“ä½œæ—¶ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä¹Ÿå°±ä¸èƒ½ä¿è¯å¹¶å‘çš„å®‰å…¨æ€§äº†
        æ¯”å¦‚ï¼š
        private static volatile int count = 0;
                  count++; //ç´¯åŠ æ“ä½œæ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼Œå³ä½¿volatileä¿®é¥°ï¼Œå¤šçº¿ç¨‹æ—¶ä¹Ÿä¸èƒ½ä¿è¯åŸå­æ€§
       
       private static volatile boolean flag = false;
              flag = true; //å½“ä½œæ ‡å¿—ä½ä½¿ç”¨æ—¶ï¼Œä½¿ç”¨volatileå¯ä»¥ä¿è¯å¤šçº¿ç¨‹å¹¶å‘å®‰å…¨æ€§
</code></pre>
<p>å‚è€ƒæ–‡ç« <a href="https://juejin.im/post/5e7771446fb9a07cce7507f2#heading-12" target="_blank" rel="noopener">ã€ç¼–ç¨‹ç„å­¦ã€‘ä¸€ä¸ªå›°æ‰°æˆ‘122å¤©çš„æŠ€æœ¯é—®é¢˜ï¼Œæˆ‘å¥½åƒçŸ¥é“ç­”æ¡ˆäº†</a>ï¼Œä¸ä½¿ç”¨volatileæ—¶ç”±äºJITä¼˜åŒ–ï¼Œä¼šå‡ºç°å¾ˆå¤šè¡¨é¢çœ‹èµ·æ¥è«åå…¶å¦™çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸€å®šè¦æ­£ç¡®ä½¿ç”¨volatileï¼Œä¸è¦ä¾èµ–äºç¼–è¯‘å™¨å’ŒJVMçš„ä¼˜åŒ–æ“ä½œã€‚</p>
<h3 id="ä¸¾ä¾‹è¯´æ˜">ä¸¾ä¾‹è¯´æ˜</h3>
<p>ç¯å¢ƒï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[qiaojian@MacÂ ~Â ]% java -version                                                          [0]</span><br><span class="line">java version "1.8.0_131"</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_131-b11)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.131-b11, mixed mode)</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼Œæ³¨æ„ä¸¤ä¸ªåœ°æ–¹ï¼š</p>
<ol>
<li>è®¾ç½®flagä¸ºtrueä¹‹å‰sleep 2æ¯«ç§’</li>
<li>åœ¨whileå¾ªç¯é‡Œç´¯åŠ è®¡æ•°</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestVolatile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NonVolatile nonVolatile = <span class="keyword">new</span> NonVolatile();</span><br><span class="line">        nonVolatile.start();</span><br><span class="line">        <span class="keyword">while</span> (!nonVolatile.flag) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"FLAG:TRUE ä¸»ç¨‹åºé€€å‡º"</span> + count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NonVolatile</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="comment">//private volatile boolean flag = false;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ç¨‹åºæ‰§è¡Œç»“æœè¿˜ä¾èµ–äºsleepæ—¶é—´</span></span><br><span class="line">                Thread.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            flag = <span class="keyword">true</span>;</span><br><span class="line">            System.out.println(<span class="string">"SET FLAG=TRUE"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘è¿è¡Œä»£ç æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[qiaojian@Mac ~ ]% java TestVolatile                                                      [0]</span><br><span class="line">SET FLAG=TRUE</span><br><span class="line">FLAG:TRUE ä¸»ç¨‹åºé€€å‡º 61475</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬æŠŠsleepæ—¶é—´è®¾ç½®é•¿ä¸€ç‚¹æ¯”å¦‚10æ¯«ç§’</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestVolatile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NonVolatile nonVolatile = <span class="keyword">new</span> NonVolatile();</span><br><span class="line">        nonVolatile.start();</span><br><span class="line">        <span class="keyword">while</span> (!nonVolatile.flag) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"FLAG:TRUE ä¸»ç¨‹åºé€€å‡º"</span> + count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NonVolatile</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="comment">//private volatile boolean flag = false;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ç¨‹åºæ‰§è¡Œç»“æœè¿˜ä¾èµ–äºsleepæ—¶é—´</span></span><br><span class="line">                Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            flag = <span class="keyword">true</span>;</span><br><span class="line">            System.out.println(<span class="string">"SET FLAG=TRUE"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡ç¼–è¯‘è¿è¡Œçœ‹çœ‹æ•ˆæœï¼Œå‘ç°æ­¤æ—¶ä¸»çº¿ç¨‹æ­»å¾ªç¯äº†æœªé€€å‡ºç¨‹åº</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[qiaojian@MacÂ ~Â ]% java TestVolatile                                                      [0]</span><br><span class="line">SET FLAG=TRUE</span><br><span class="line">^C%</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡æ‰§è¡Œï¼Œè¿™æ¬¡åŠ ä¸Šç¦æ­¢JITä¼˜åŒ–é€‰é¡¹ï¼Œå‘ç°ä¸»çº¿ç¨‹å¯ä»¥æ­£å¸¸é€€å‡ºäº†</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[qiaojian@MacÂ ~Â ]% java -Xint TestVolatile                                                [0]</span><br><span class="line">SET FLAG=TRUE</span><br><span class="line">FLAG:TRUE ä¸»ç¨‹åºé€€å‡º 488111</span><br></pre></td></tr></table></figure>
<p>ç”±æ­¤å¯è§ï¼Œsleepæ—¶é—´çš„é•¿çŸ­å¯¹å…±äº«å˜é‡çš„å¯è§æ€§ä¹Ÿæœ‰å½±å“ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å› ä¸ºsleepæ—¶é—´çŸ­ï¼Œwhileå¾ªç¯çŸ­ä¸ä¼šè§¦å‘JITä¼˜åŒ–æ“ä½œã€‚whileå¾ªç¯è¿‡é•¿è¶…è¿‡ä¸€å®šæ¬¡æ•°æ—¶ä¼šè§¦å‘JITä¼˜åŒ–æ“ä½œï¼Œå°†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (!nonVolatile.flag) &#123;</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼˜åŒ–ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!nonVolatile.flag) &#123;</span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    		count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å°†flagå˜é‡ä½¿ç”¨volatileä¿®é¥°ï¼Œä¼šå‘ç°ä¸ç®¡è®¾ç½®flagä¸ºtrueä¹‹å‰sleepå¤šä¹…ï¼Œä¸»çº¿ç¨‹éƒ½å¯ä»¥æ­£å¸¸é€€å‡ºã€‚è¿™å°±æ˜¯volatileå…³é”®å­—å¯¹ç¨‹åºæ­£ç¡®æ€§æ‰€ä½œå‡ºçš„ä¿è¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestVolatile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NonVolatile nonVolatile = <span class="keyword">new</span> NonVolatile();</span><br><span class="line">        nonVolatile.start();</span><br><span class="line">        <span class="keyword">while</span> (!nonVolatile.flag) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"FLAG:TRUE ä¸»ç¨‹åºé€€å‡º"</span> + count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NonVolatile</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//private boolean flag = false;</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ç¨‹åºæ‰§è¡Œç»“æœè¿˜ä¾èµ–äºsleepæ—¶é—´</span></span><br><span class="line">                Thread.sleep(<span class="number">30</span>*<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            flag = <span class="keyword">true</span>;</span><br><span class="line">            System.out.println(<span class="string">"SET FLAG=TRUE"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[qiaojian@MacÂ ~Â ]% java TestVolatile                                                      [0]</span><br><span class="line">SET FLAG=TRUE</span><br><span class="line">FLAG:TRUE ä¸»ç¨‹åºé€€å‡º 1628189977</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>volatile</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼-å·¥å‚æ¨¡å¼</title>
    <url>/article/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p>å·¥å‚æ¨¡å¼åŒ…æ‹¬ï¼šå·¥å‚æ–¹æ³•æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼ï¼Œå¯ä»¥è¯´æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼åŸºç¡€ä¸Šæ¼”å˜è€Œæ¥çš„ã€‚</p>
<hr>
<p>å·¥å‚æ–¹æ³•çš„ä½œç”¨å°±æ˜¯ï¼š</p>
<p>åŸæ¥æˆ‘ä»¬è¦newä¸€ä¸ªäº§å“Aï¼Œåˆ™ç›´æ¥new ProductA(); åˆæ¥ä¸€ä¸ªæ–°éœ€æ±‚è¦newä¸€ä¸ªäº§å“Bï¼Œåˆ™ç›´æ¥new ProductB();  ä¾æ­¤ç±»æ¨â€¦</p>
<p>å·¥å‚çš„ä½œç”¨å°±æ˜¯æä¾›ä¸€ä¸ªå·¥å‚ç±»ï¼Œç”±å·¥å‚ç±»è´Ÿè´£new ProductA()å’Œnew ProductB()ï¼Œè€Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥ç±»å‹å‚æ•°newä¸€ä¸ªå·¥å‚ç±»å°±å¯ä»¥äº†ï¼Œå·¥å‚ç±»ä¼šæ ¹æ®ç±»å‹æ¥newç›¸åº”çš„äº§å“å¹¶è¿”å›ã€‚</p>
<p>æ³¨æ„åœ¨å·¥å‚æ–¹æ³•ä¸­ï¼Œäº§å“Aå’Œäº§å“Bä¸€èˆ¬æ˜¯æ²¡æœ‰å…³è”çš„ã€‚</p>
<p>ç”¨ç±»è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Productæ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ProductA</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductA</span> <span class="keyword">implements</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ProductB</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductB</span> <span class="keyword">implements</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å·¥å‚ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">getProduct</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="string">"A"</span>.equalsIgnoreCase ( type )) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> ProductA ();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"B"</span>.equalsIgnoreCase ( type ) ) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> ProductB ();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>é‚£ä»€ä¹ˆæ˜¯æŠ½è±¡å·¥å‚å‘¢ï¼ŸæŠ½è±¡å·¥å‚è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼šè¦ç”ŸæˆProductAéœ€è¦ç»è¿‡ä¸‰ä¸ªæµç¨‹ï¼šé€‰è´­åŸææ–™ï¼ŒåŠ å·¥åŸææ–™ï¼Œç»„è£…ï¼Œè¦ç”ŸæˆProductBä¹Ÿéœ€è¦ç»è¿‡ä¸‰ä¸ªæµç¨‹ï¼šé€‰è´­åŸææ–™ï¼ŒåŠ å·¥åŸææ–™ï¼Œç»„è£…ï¼Œä½†æ˜¯å„è‡ªçš„æµç¨‹å¤„ç†æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>åŸæ¥çš„åšæ³•æ˜¯ï¼šç›´æ¥åœ¨new Producté‡Œæ·»åŠ å„è‡ªçš„æµç¨‹ï¼ŒProducAå’ŒProductBçš„æµç¨‹å„è‡ªç‹¬ç«‹ï¼Œå®¢æˆ·ç«¯è¦ä½¿ç”¨æ—¶éƒ½æ˜¯å’Œå…·ä½“çš„äº§å“Aæˆ–Bæ‰“äº¤é“ï¼Œç´§è€¦åˆã€‚</p>
<p>æŠ½è±¡å·¥å‚å°±æ˜¯å°†ç”ŸæˆProductAçš„æµç¨‹å°è£…åˆ°ä¸€ä¸ªå·¥å‚ç±»ProductAä¸­ï¼Œå°†ç”ŸæˆProductBçš„æµç¨‹ä¹Ÿå°è£…åˆ°ä¸€ä¸ªå·¥å‚ç±»ProductBä¸­ï¼Œç„¶åå°†ç”Ÿæˆäº§å“çš„æµç¨‹æŠ½è±¡åˆ°å…±åŒçš„æ¥å£Productä¸­ï¼Œè®©ProductAå’ŒProductBå®ç°æ­¤æ¥å£ï¼Œè¿™ä¹ˆåšçš„å‰ææ˜¯å·¥å‚ç”Ÿäº§ä¸åŒäº§å“çš„æµç¨‹æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>ç°åœ¨éœ€è¦ç”Ÿæˆäº§å“çš„å®¢æˆ·ç«¯åªéœ€è¦æä¾›æ¥å£Productå±æ€§ï¼Œå…·ä½“éœ€è¦ç”ŸæˆProductAåˆ™å°†æ­¤æ¥å£å±æ€§å®ä¾‹åŒ–ä¸ºProducAå·¥å‚ï¼Œç”±å…·ä½“å·¥å‚æ¥æ‰§è¡Œå…·ä½“çš„äº§å“æµç¨‹ã€‚</p>
<p>å¦‚æœéœ€è¦æ–°å¢ç”Ÿæˆä¸€ä¸ªäº§å“ProductCï¼Œåªéœ€è¦æ–°å¢å…·ä½“å·¥å‚ç±»ProductCå°±å¯ä»¥äº†ã€‚</p>
<p>ç”¨ç±»è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<p>æ¥ç€ä¸Šé¢å·¥å‚æ–¹æ³•çš„äº§å“ç±»ï¼Œå¢åŠ ä¸‰ä¸ªæµç¨‹å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åŸææ–™ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Material</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç»„è£…æˆçš„æ¨¡å—ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æŠ½è±¡å·¥å‚æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AbstractProductFactory</span> </span>&#123;</span><br><span class="line">   <span class="function">Material <span class="title">buyMaterial</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function">Model <span class="title">process</span><span class="params">(Material material)</span></span>;</span><br><span class="line">   <span class="function">Product <span class="title">assemble</span><span class="params">(Model model)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”Ÿäº§äº§å“Açš„å·¥å‚ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductAFactory</span> <span class="keyword">implements</span> <span class="title">AbstractProductFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Material <span class="title">buyMaterial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Model <span class="title">process</span><span class="params">(Material material)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">assemble</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”Ÿäº§äº§å“Bçš„å·¥å‚ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductBFactory</span> <span class="keyword">implements</span>  <span class="title">AbstractProductFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Material <span class="title">buyMaterial</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Model <span class="title">process</span><span class="params">(Material material)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">assemble</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æŠ½è±¡å·¥å‚çš„ä½¿ç”¨ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UsageApp</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AbstractProductFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UsageApp</span><span class="params">(AbstractProductFactory factory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.factory = factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//UsageAppåˆå§‹åŒ–æ—¶ä¼ å…¥å…·ä½“çš„å·¥å‚ç±»ï¼Œæ­¤æ–¹æ³•å³ç”Ÿäº§å‡ºç›¸åº”çš„äº§å“</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">genProduct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.factory.assemble (</span><br><span class="line">                <span class="keyword">this</span>.factory.process (</span><br><span class="line">                        <span class="keyword">this</span>.factory.buyMaterial ()</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>åŒºåˆ«ï¼šå·¥å‚æ–¹æ³•æ˜¯å¯¹äº§å“çš„æ‰©å±•ï¼ŒæŠ½è±¡å·¥å‚æ˜¯å¯¹ç”Ÿæˆäº§å“çš„å·¥å‚çš„æ‰©å±•</p>
]]></content>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼-æ¨¡æ¿æ–¹æ³•</title>
    <url>/article/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p><strong>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</strong>æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒåœ¨è¶…ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„æ¡†æ¶ï¼Œ å…è®¸å­ç±»åœ¨ä¸ä¿®æ”¹ç»“æ„çš„æƒ…å†µä¸‹é‡å†™ç®—æ³•çš„ç‰¹å®šæ­¥éª¤ã€‚</p>
<p>æœ‰ä¸¤ç§ç±»å‹çš„æ­¥éª¤ï¼š</p>
<ul>
<li><em>æŠ½è±¡æ­¥éª¤</em>å¿…é¡»ç”±å„ä¸ªå­ç±»æ¥å®ç°</li>
<li><em>å¯é€‰æ­¥éª¤</em>å·²æœ‰ä¸€äº›é»˜è®¤å®ç°ï¼Œ ä½†ä»å¯åœ¨éœ€è¦æ—¶è¿›è¡Œé‡å†™</li>
</ul>
<p>ç»§ç»­ä¼˜åŒ–ç­–ç•¥æ¨¡å¼ä¸­çš„æ”¯ä»˜ç­–ç•¥ï¼Œç”±äºä¸åŒçš„æ”¯ä»˜çš„æ€»çš„å¤„ç†è¿‡ç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼šå…ˆæ„é€ å‚æ•°ï¼Œå†å¯¹å‚æ•°è¿›è¡Œç­¾åï¼Œå‘èµ·æ”¯ä»˜è¯·æ±‚ï¼Œæœ€åè§£æè¿”å›ç»“æœã€‚å› æ­¤å¯ä»¥åº”ç”¨æ¨¡æ¿æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»å¦‚ä¸‹ï¼šPay</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Pay</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¨¡æ¿ï¼ˆç®—æ³•æ¡†æ¶ï¼Œè¶…ç±»å®šä¹‰å¥½ï¼Œå­ç±»ä¸å¯ä¿®æ”¹ï¼‰</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exec</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// step1: æ ¹æ®è¾“å…¥å‚æ•°ç»„åˆæ”¯ä»˜è¯·æ±‚éœ€è¦çš„å‚æ•°ï¼Œä¸åŒçš„æ”¯ä»˜ä¼ å…¥çš„å‚æ•°ä¸åŒï¼Œç»„åˆå‡ºæ¥çš„å‚æ•°ä¹Ÿä¸åŒ</span></span><br><span class="line">        Map&lt;String, Object&gt; urlParam = genUrlParam(param);</span><br><span class="line">        <span class="comment">// step2: å¯¹urlå‚æ•°è¿›è¡Œç­¾åï¼Œç­¾åæ–¹æ³•æœ‰å¾ˆå¤šï¼šæ¯”å¦‚RSAï¼ŒMD5ï¼ŒAES...</span></span><br><span class="line">        String sign = genSign(urlParam);</span><br><span class="line">        urlParam.put ( <span class="string">"sign"</span>, sign );</span><br><span class="line">        <span class="comment">// step3: å‘èµ·æ”¯ä»˜è¯·æ±‚ï¼Œæ”¯ä»˜å‘èµ·æ–¹å¼GETï¼ŒPOST</span></span><br><span class="line">        String result = callPayUrl(urlParam);</span><br><span class="line">        <span class="comment">// step4: è§£æè¯·æ±‚ç»“æœå¹¶è¿”å›ï¼Œè¿”å›ç»“æœæœ‰å¾ˆå¤šç±»å‹ï¼šXMLï¼ŒJSONï¼Œè‡ªå®šä¹‰ç»“æ„...</span></span><br><span class="line">        <span class="keyword">return</span> parseResult(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Map&lt;String, Object&gt; <span class="title">genUrlParam</span><span class="params">(Map&lt;String, Object&gt; param)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">genSign</span><span class="params">(Map&lt;String, Object&gt; param)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">callPayUrl</span><span class="params">(Map&lt;String, Object&gt; param)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">parseResult</span><span class="params">(String result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é™¤æ­¤ä»¥å¤–ï¼Œæ¨¡æ¿è¶…ç±»ä¸­è¿˜å¯ä»¥å®šä¹‰é»˜è®¤å®ç°ï¼Œå­ç±»ä¹Ÿå¯ä»¥æ ¹æ®æƒ…å†µè¦†å†™</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨å…·ä½“çš„ç»§æ‰¿ç±»ä¸­å®ç°ç‰¹å®šçš„æ­¥éª¤ä¹Ÿå³å®ç°æŠ½è±¡ç±»ä¸­çš„æŠ½è±¡æ–¹æ³•ã€‚</p>
<p>å®šä¹‰å…·ä½“çš„å®ç°ç±»ä¹‹å¾®ä¿¡æ”¯ä»˜ï¼šWeChatPay</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeChatPay</span> <span class="keyword">extends</span> <span class="title">Pay</span> <span class="keyword">implements</span> <span class="title">PayStrategy</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doPay</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exec ( param );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">genUrlParam</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">genSign</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">callPayUrl</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">parseResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰å…·ä½“çš„å®ç°ç±»ä¹‹æ”¯ä»˜å®æ”¯ä»˜ï¼šALiPay</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ALiPay</span> <span class="keyword">extends</span> <span class="title">Pay</span> <span class="keyword">implements</span> <span class="title">PayStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doPay</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exec ( param );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">genUrlParam</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">genSign</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">callPayUrl</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">parseResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰å…·ä½“çš„å®ç°ç±»ä¹‹é“¶è”æ”¯ä»˜ï¼šUnionPay</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnionPay</span> <span class="keyword">extends</span> <span class="title">Pay</span> <span class="keyword">implements</span> <span class="title">PayStrategy</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doPay</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exec ( param );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">genUrlParam</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">genSign</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">callPayUrl</span><span class="params">(Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">parseResult</span><span class="params">(String result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­ç±»çš„å…·ä½“å®ç°å°±æ²¡å†™äº†ï¼Œæ¨¡æ¿æ–¹æ³•çš„åº”ç”¨å¤§æ¦‚å¦‚æ­¤ã€‚</p>
<p>å¦å¤–ï¼šæŠ½è±¡ç±»æ˜¯å¯ä»¥ä¸åŒ…å«æŠ½è±¡æ–¹æ³•çš„ï¼Œæ­¤æ—¶æŠ½è±¡ç±»ä»ç„¶ä¸èƒ½è¢«å®ä¾‹åŒ–ã€‚å¯ä»¥ç”¨åœ¨æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯é™æ€æ–¹æ³•çš„å·¥å…·ç±»ä¸Šï¼Œæ­¤æ—¶æŠŠè¿™ç§å·¥å…·ç±»å®šä¹‰ä¸ºæŠ½è±¡ç±»ï¼Œå¯ä»¥é˜²æ­¢å®ƒè¢«å®ä¾‹åŒ–ã€‚ä¾‹å¦‚SpringBootæ¡†æ¶ä¸­çš„org.springframework.utilåŒ…ä¸‹çš„å¾ˆå¤šå·¥å…·ç±»å°±æ˜¯è¿™ç§ç”¨æ³•ã€‚</p>
]]></content>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼-è§‚å¯Ÿè€…æ¨¡å¼</title>
    <url>/article/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p>é¦–å…ˆäº†è§£è§‚å¯Ÿè€…æ¨¡å¼å’Œå‘å¸ƒè®¢é˜…æ¨¡å¼çš„åŒºåˆ«ï¼šå‚è€ƒ <a href="https://juejin.im/post/5a14e9edf265da4312808d86" target="_blank" rel="noopener">https://juejin.im/post/5a14e9edf265da4312808d86</a></p>
<p>ç®€å•è¯´å°±æ˜¯ï¼Œè§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œè§‚å¯Ÿè€…Observerå’Œè¢«è§‚å¯Ÿè€…Observableæ˜¯ç´§è€¦åˆçš„ï¼›è€Œå‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­ï¼Œå‘å¸ƒè€…Publisherå’Œè®¢é˜…è€…Subscriberæ˜¯å»è€¦åˆçš„ï¼Œé€šè¿‡ç¬¬ä¸‰æ–¹Topicæˆ–Channelå…³è”ã€‚</p>
<p>è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ã€‚è¿™ä¸ªä¸»é¢˜å¯¹è±¡åœ¨çŠ¶æ€ä¸Šå‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿè¿›è¡Œç›¸åº”çš„ååº”å¤„ç†ã€‚</p>
<p>JDKè‡ªå¸¦å¯¹è§‚å¯Ÿè€…æ¨¡å¼çš„å®ç°ï¼šæä¾›ä¸€ä¸ªè¢«è§‚å¯Ÿè€…ç±»Observableå’Œè§‚å¯Ÿè€…æ¥å£Observerï¼Œè¢«è§‚å¯Ÿè€…ç»´æŠ¤äº†è§‚å¯Ÿè€…åˆ—è¡¨åœ¨çŠ¶æ€æ”¹å˜æ—¶ä¼šéå†é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼ˆå› æ­¤è¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ç´§è€¦åˆï¼‰</p>
<p>Observableï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> Vector&lt;Observer&gt; obs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Construct an Observable with zero Observers. */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Observable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        obs = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="keyword">if</span> (!obs.contains(o)) &#123;</span><br><span class="line">            obs.addElement(o);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">deleteObserver</span><span class="params">(Observer o)</span> </span>&#123;</span><br><span class="line">        obs.removeElement(o);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        notifyObservers(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">(Object arg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * a temporary array buffer, used as a snapshot of the state of</span></span><br><span class="line"><span class="comment">         * current Observers.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Object[] arrLocal;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">/* We don't want the Observer doing callbacks into</span></span><br><span class="line"><span class="comment">             * arbitrary code while holding its own Monitor.</span></span><br><span class="line"><span class="comment">             * The code where we extract each Observable from</span></span><br><span class="line"><span class="comment">             * the Vector and store the state of the Observer</span></span><br><span class="line"><span class="comment">             * needs synchronization, but notifying observers</span></span><br><span class="line"><span class="comment">             * does not (should not).  The worst result of any</span></span><br><span class="line"><span class="comment">             * potential race-condition here is that:</span></span><br><span class="line"><span class="comment">             * 1) a newly-added Observer will miss a</span></span><br><span class="line"><span class="comment">             *   notification in progress</span></span><br><span class="line"><span class="comment">             * 2) a recently unregistered Observer will be</span></span><br><span class="line"><span class="comment">             *   wrongly notified when it doesn't care</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (!changed)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            arrLocal = obs.toArray();</span><br><span class="line">            clearChanged();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = arrLocal.length-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--)</span><br><span class="line">            ((Observer)arrLocal[i]).update(<span class="keyword">this</span>, arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">deleteObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        obs.removeAllElements();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        changed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">clearChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        changed = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">hasChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> changed;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">countObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obs.size();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Observerï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This method is called whenever the observed object is changed. An</span></span><br><span class="line"><span class="comment">     * application calls an &lt;tt&gt;Observable&lt;/tt&gt; object's</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;notifyObservers&lt;/code&gt; method to have all the object's</span></span><br><span class="line"><span class="comment">     * observers notified of the change.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>   o     the observable object.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>   arg   an argument passed to the &lt;code&gt;notifyObservers&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     *                 method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥ä¸¾ä¾‹ä½¿ç”¨JDKè‡ªå¸¦çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼š</p>
<p>é¦–å…ˆç»§æ‰¿Observabeç±»å®ç°è¢«è§‚å¯Ÿè€…é€»è¾‘ï¼šConcreteObservable</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¢«è§‚å¯Ÿè€…ï¼Œè‡ªå®šä¹‰çŠ¶æ€ï¼ŒçŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteObservable</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String data = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeData</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.data.equalsIgnoreCase ( data )) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        setChanged ();</span><br><span class="line">        notifyObservers (data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå®ç°è§‚å¯Ÿè€…æ¥å£Observerï¼Œè¿™å„¿æä¾›ä¸€ä¸ªå®ç°ConcreteObserverï¼Œå®é™…ä¸Šå¯ä»¥æœ‰å¤šä¸ªè§‚å¯Ÿè€…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        System.out.println ( <span class="string">"æ”¶åˆ°"</span> + o.getClass ().getName () + <span class="string">"çš„DATA: "</span> + arg +<span class="string">"å˜åŒ–é€šçŸ¥"</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserveUsage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConcreteObservable observable = <span class="keyword">new</span> ConcreteObservable ();</span><br><span class="line">        Observer observer = <span class="keyword">new</span> ConcreteObserver ();</span><br><span class="line">        observable.addObserver ( observer ); <span class="comment">//å‘è¢«è§‚å¯Ÿè€…æ·»åŠ è§‚å¯Ÿè€…å®ç°ä¸€å¯¹å¤šé€šçŸ¥</span></span><br><span class="line">        observable.changeData ( <span class="string">"FirstMsg"</span> );</span><br><span class="line">        observable.changeData ( <span class="string">"SecondMsg"</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘å¸ƒè®¢é˜…æ¨¡å¼æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„å‡çº§ç‰ˆï¼Œå¯¹äº‹ä»¶å‘å¸ƒæ–¹å’Œäº‹ä»¶è®¢é˜…æ–¹è¿›è¡Œè§£è€¦ã€‚å‘å¸ƒæ–¹å‘å¸ƒäº‹ä»¶ï¼Œè®¢é˜…æ–¹è®¢é˜…äº‹ä»¶ï¼Œå†é€šè¿‡ç¬¬ä¸‰æ–¹å°†å‘å¸ƒçš„äº‹ä»¶é€šçŸ¥åˆ°å®ƒçš„è®¢é˜…è€…ã€‚</p>
<p>JDKä¸­çš„äº‹ä»¶ç›‘å¬å®ç°äº†æ­¤æ¨¡å¼ï¼šæä¾›äº†EventObjectç±»è¡¨ç¤ºå…·ä½“çš„äº‹ä»¶ç±»å‹ï¼Œæä¾›äº†ä¸€ä¸ªç©ºçš„ç›‘å¬å™¨æ¥å£EventListenerï¼Œæ–¹ä¾¿æ‰©å±•ä½¿ç”¨</p>
<p>æˆ‘ä»¬æ¥ä¸¾ä¾‹è¯´æ˜æ€ä¹ˆä½¿ç”¨äº‹ä»¶ç›‘å¬æ¨¡å¼ï¼š</p>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªäº‹ä»¶ç±»å‹åŸºç±»AppEvent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppEvent</span> <span class="keyword">extends</span> <span class="title">EventObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String[] args;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppEvent</span><span class="params">(Object source, String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span> ( source );</span><br><span class="line">        <span class="keyword">this</span>.args = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String[] getArgs() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.args;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰©å±•ä¸¤ä¸ªå…·ä½“çš„äº‹ä»¶ç±»å‹AppReadyEventã€AppStartingEvent</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åº”ç”¨å¯åŠ¨æˆåŠŸREADYäº‹ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppReadyEvent</span> <span class="keyword">extends</span> <span class="title">AppEvent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppReadyEvent</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span> ( <span class="string">"READY_EVENT"</span>, args );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åº”ç”¨å¼€å§‹å¯åŠ¨äº‹ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppStartingEvent</span> <span class="keyword">extends</span> <span class="title">AppEvent</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppStartingEvent</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span> ( <span class="string">"STARTING_EVENT"</span>, args );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ä¸€ä¸ªç›‘å¬å™¨æ¥å£AppListenerå®šä¹‰äº‹ä»¶é€šçŸ¥å¤„ç†åè®®</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppListener</span> &lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">AppEvent</span>&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onAppEvent</span><span class="params">(E event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(Class&lt;? extends AppEvent&gt; eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰©å±•å®ç°ä¸¤ä¸ªå…·ä½“çš„ç›‘å¬å™¨PrepareContextAppListenerã€SendMsgAppListeneråˆ†åˆ«å“åº”ä¸¤ä¸ªäº‹ä»¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç›‘å¬åº”ç”¨å¼€å§‹å¯åŠ¨äº‹ä»¶ï¼Œç”¨äºå‡†å¤‡ä¸Šä¸‹æ–‡</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrepareContextAppListener</span> <span class="keyword">implements</span>  <span class="title">AppListener</span>&lt;<span class="title">AppStartingEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppEvent</span><span class="params">(AppStartingEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.println ( <span class="string">"PREPARE CONTEXTç›‘å¬å™¨ï¼š"</span> + <span class="keyword">this</span>.getClass ().getName ()</span><br><span class="line">                +<span class="string">"\næ”¶åˆ°APP STARTINGäº‹ä»¶ï¼š"</span> + event.getClass ().getName ()</span><br><span class="line">                + <span class="string">"\næ”¶åˆ°äº‹ä»¶å‚æ•°ï¼š"</span> + Arrays.toString (event.getArgs ()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(Class&lt;? extends AppEvent&gt; eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AppStartingEvent.class.isAssignableFrom(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç›‘å¬åº”ç”¨å¯åŠ¨æˆåŠŸäº‹ä»¶ï¼Œç”¨äºé€šçŸ¥æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMsgAppListener</span> <span class="keyword">implements</span> <span class="title">AppListener</span>&lt;<span class="title">AppReadyEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppEvent</span><span class="params">(AppReadyEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.println ( <span class="string">"SEND MSGç›‘å¬å™¨ï¼š"</span> + <span class="keyword">this</span>.getClass ().getName () +</span><br><span class="line">                <span class="string">"\næ”¶åˆ°APP READYäº‹ä»¶ï¼š"</span> + event.getClass ().getName () +</span><br><span class="line">                <span class="string">"\næ”¶åˆ°äº‹ä»¶å‚æ•°ï¼š"</span> + Arrays.toString (event.getArgs ()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(Class&lt;? extends AppEvent&gt; eventType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> AppReadyEvent.class.isAssignableFrom(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ä¸€ä¸ªç¬¬ä¸‰æ–¹å·¥å…·ç±»AppEventMulticasterç”¨äºå°†äº‹ä»¶å’Œç›‘å¬å™¨ç»„åˆèµ·æ¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº‹ä»¶å¹¿æ’­ç±»ï¼šå…³è”äº‹ä»¶å’Œç›‘å¬å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppEventMulticaster</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;AppListener&lt;?&gt;&gt; listeners = <span class="keyword">new</span> HashSet ();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAppListener</span><span class="params">(AppListener&lt;?&gt; listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.listeners.add ( listener );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®äº‹ä»¶ç±»å‹è‡ªåŠ¨é€‰æ‹©ç›¸åº”çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicasterEvent</span><span class="params">(AppEvent event)</span> </span>&#123;</span><br><span class="line">        Iterator var = <span class="keyword">this</span>.getApplicationListeners(event).iterator();</span><br><span class="line">        <span class="keyword">while</span>(var.hasNext()) &#123;</span><br><span class="line">            AppListener&lt;AppEvent&gt; listener = (AppListener)var.next();</span><br><span class="line">            listener.onAppEvent ( event );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»æ‰€æœ‰ç›‘å¬å™¨ä¸­é€‰æ‹©å‡ºç›‘å¬ç‰¹å®šäº‹ä»¶çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Collection&lt;AppListener&lt;?&gt;&gt; getApplicationListeners(AppEvent event) &#123;</span><br><span class="line">        List&lt;AppListener&lt;?&gt;&gt; allListeners = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        Iterator var = listeners.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var.hasNext()) &#123;</span><br><span class="line">            AppListener&lt;?&gt; listener = (AppListener)var.next();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.supportsEvent(listener, event.getClass ())) &#123;</span><br><span class="line">                allListeners.add(listener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> allListeners;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> listener</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">supportsEvent</span><span class="params">(AppListener&lt;?&gt; listener, Class&lt;? extends AppEvent&gt; eventType)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> listener.supportsEventType ( eventType );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œæˆ‘ä»¬æ¥ä½¿ç”¨ç›‘å¬å™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * äº‹ä»¶ç›‘å¬å™¨æ¨¡å¼ ï¼ˆå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventUsage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AppEventMulticaster appEventMulticaster = <span class="keyword">new</span> AppEventMulticaster ();</span><br><span class="line"></span><br><span class="line">        SendMsgAppListener sendMsgAppListener = <span class="keyword">new</span> SendMsgAppListener ();</span><br><span class="line">        appEventMulticaster.addAppListener ( sendMsgAppListener );</span><br><span class="line"></span><br><span class="line">        PrepareContextAppListener prepareContextAppListener = <span class="keyword">new</span> PrepareContextAppListener ();</span><br><span class="line">        appEventMulticaster.addAppListener ( prepareContextAppListener );</span><br><span class="line"></span><br><span class="line">        appEventMulticaster.multicasterEvent ( <span class="keyword">new</span> AppStartingEvent ( <span class="keyword">new</span> String[] &#123;<span class="string">"StaringParam1"</span>, <span class="string">"StaringParam2"</span>&#125; ));</span><br><span class="line">        appEventMulticaster.multicasterEvent ( <span class="keyword">new</span> AppReadyEvent ( <span class="keyword">new</span> String[] &#123;<span class="string">"ReadyParam1"</span>, <span class="string">"ReadyParam2"</span>&#125;  ) );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PREPARE CONTEXTç›‘å¬å™¨ï¼šcom.example.demo.event.PrepareContextAppListener</span><br><span class="line">æ”¶åˆ°APP STARTINGäº‹ä»¶ï¼šcom.example.demo.event.AppStartingEvent</span><br><span class="line">æ”¶åˆ°äº‹ä»¶å‚æ•°ï¼š[StaringParam1, StaringParam2]</span><br><span class="line">SEND MSGç›‘å¬å™¨ï¼šcom.example.demo.event.SendMsgAppListener</span><br><span class="line">æ”¶åˆ°APP READYäº‹ä»¶ï¼šcom.example.demo.event.AppReadyEvent</span><br><span class="line">æ”¶åˆ°äº‹ä»¶å‚æ•°ï¼š[ReadyParam1, ReadyParam2]</span><br></pre></td></tr></table></figure>
<p>å¯è§å¹¿æ’­å‘å¸ƒå…·ä½“çš„äº‹ä»¶ï¼Œç›¸åº”çš„ç›‘å¬å™¨ä¼šæ”¶åˆ°é€šçŸ¥è¿›è¡Œè‡ªå·±çš„é€»è¾‘å¤„ç†</p>
]]></content>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼-ç­–ç•¥æ¨¡å¼</title>
    <url>/article/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p><strong>ç­–ç•¥æ¨¡å¼</strong>æ˜¯å¯¹ç®—æ³•çš„å°è£…ï¼Œå®ƒæŠŠç®—æ³•çš„è´£ä»»å’Œç®—æ³•æœ¬èº«åˆ†å‰²å¼€ï¼Œå§”æ´¾ç»™ä¸åŒçš„å¯¹è±¡ç®¡ç†ã€‚ <strong>ç­–ç•¥æ¨¡å¼</strong>é€šå¸¸æŠŠä¸€ä¸ªç³»åˆ—çš„ç®—æ³•å°è£…åˆ°ä¸€ç³»åˆ—çš„<strong>ç­–ç•¥</strong>ç±»é‡Œé¢ï¼Œä½œä¸ºä¸€ä¸ªæŠ½è±¡<strong>ç­–ç•¥</strong>ç±»çš„å­ç±»ã€‚ ç”¨ä¸€å¥è¯æ¥è¯´ï¼Œå°±æ˜¯â€œå‡†å¤‡ä¸€ç»„ç®—æ³•ï¼Œå¹¶å°†æ¯ä¸€ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥äº’æ¢â€ã€‚</p>
<p>ç­–ç•¥æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š</p>
<ul>
<li>Context: ç¯å¢ƒç±»</li>
<li>Strategy: æŠ½è±¡ç­–ç•¥ç±»</li>
<li>ConcreteStrategy: å…·ä½“ç­–ç•¥ç±»</li>
</ul>
<p>ç°åœ¨æ¥æ ¹æ®è§’è‰²å®ç°ä¸€ä¸ªæ”¯ä»˜ç­–ç•¥ï¼š</p>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ”¯ä»˜æ¥å£ï¼šPayStrategy</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PayStrategy</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">doPay</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰å…·ä½“çš„å®ç°ç±»ä¹‹å¾®ä¿¡æ”¯ä»˜ï¼šWeChatPay</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeChatPay</span> <span class="keyword">implements</span> <span class="title">PayStrategy</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doPay</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"å¾®ä¿¡æ”¯ä»˜"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰å…·ä½“çš„å®ç°ç±»ä¹‹æ”¯ä»˜å®æ”¯ä»˜ï¼šALiPay</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ALiPay</span> <span class="keyword">implements</span> <span class="title">PayStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doPay</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"æ”¯ä»˜å®æ”¯ä»˜"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰å…·ä½“çš„å®ç°ç±»ä¹‹é“¶è”æ”¯ä»˜ï¼šUnionPay</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnionPay</span> <span class="keyword">implements</span> <span class="title">PayStrategy</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doPay</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"é“¶è”æ”¯ä»˜"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰ä¸€ä¸ªä¸Šä¸‹æ–‡ç±»ï¼Œæä¾›ä¸åŒç®—æ³•çš„ç»„åˆå’Œé€‰æ‹©ï¼šPayContext</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;PayType, PayStrategy&gt; payStrategyMap = <span class="keyword">new</span> HashMap&lt;&gt; ( );</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    WeChatPay weChatPay;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ALiPay aLiPay;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UnionPay unionPay;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initStrategyMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.payStrategyMap.put ( PayType.WECHATPAY, weChatPay);</span><br><span class="line">        <span class="keyword">this</span>.payStrategyMap.put ( PayType.ALIPAY, aLiPay);</span><br><span class="line">        <span class="keyword">this</span>.payStrategyMap.put ( PayType.UNIONPAY, unionPay);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doCmd</span><span class="params">(String type, Map&lt;String, Object&gt; param)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.payStrategyMap.get ( PayType.getPayType ( type ) ).doPay ( type, param );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­PayTypeæ˜¯ç±»å‹æšä¸¾ï¼šPayType</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> PayType &#123;</span><br><span class="line">    WECHATPAY(<span class="string">"WECHAT"</span>, <span class="string">"å¾®ä¿¡æ”¯ä»˜"</span>),</span><br><span class="line">    ALIPAY(<span class="string">"ALI"</span>, <span class="string">"æ”¯ä»˜å®æ”¯ä»˜"</span>),</span><br><span class="line">    UNIONPAY(<span class="string">"UNION"</span>, <span class="string">"é“¶è”æ”¯ä»˜"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    PayType(String type, String desc) &#123;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PayType <span class="title">getPayType</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (PayType payType: PayType.values ()</span><br><span class="line">             ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (payType.type.equalsIgnoreCase ( type )) &#123;</span><br><span class="line">                <span class="keyword">return</span> payType;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå®šä¹‰ä¸€ä¸ªcontrollerç±»æ¥ä½¿ç”¨æˆ‘ä»¬çš„æ”¯ä»˜ç­–ç•¥ï¼šPayUsage</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayUsage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PayContext payContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/pay"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">usePay</span><span class="params">(@RequestParam String type)</span> </span>&#123;</span><br><span class="line">    			 <span class="comment">//æµ‹è¯•å‚æ•°null</span></span><br><span class="line">           <span class="keyword">return</span> payContext.doCmd ( type, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¼ ä¸åŒçš„ç±»å‹å‚æ•°è°ƒç”¨æ¥å£ï¼Œå³ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ï¼š</p>
<p>curl localhost/pay?type=wechat è¿”å›å¾®ä¿¡æ”¯ä»˜</p>
<p>curl localhost/pay?type=ali è¿”å›æ”¯ä»˜å®æ”¯ä»˜</p>
<p>curl localhost/pay?type=union è¿”å›é“¶è”æ”¯ä»˜</p>
]]></content>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>è®¾è®¡æ¨¡å¼-è´£ä»»é“¾æ¨¡å¼</title>
    <url>/article/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p>è´£ä»»é“¾æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸ä½ å°†è¯·æ±‚æ²¿ç€å¤„ç†è€…é“¾è¿›è¡Œå‘é€ã€‚ æ”¶åˆ°è¯·æ±‚åï¼Œ å¤„ç†é“¾ä¸Šçš„æ¯ä¸ªå¤„ç†è€…å‡å¯å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼ˆä¿®æ”¹requestï¼Œresponseï¼Œreturnï¼‰ï¼Œ æˆ–å°†å…¶ä¼ é€’ç»™é“¾ä¸Šçš„ä¸‹ä¸ªå¤„ç†è€…ã€‚</p>
<p>servletæ¨¡å—å³æ˜¯ä½¿ç”¨äº†è´£ä»»é“¾æ¨¡å¼æ¥å¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤ã€‚</p>
<p>æˆ‘ä»¬æ¨¡ä»¿servletçš„è¿‡æ»¤é“¾å¤„ç†æ¥ä¸¾ä¾‹è¯´æ˜ï¼š</p>
<p><strong>ç¬¬ä¸€æ­¥</strong></p>
<p>é¦–å…ˆå®šä¹‰è¿‡æ»¤å™¨å¤„ç†æ¥å£ï¼šFilter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Request request, Response response, FilterChain filterChain)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­FilterChainæ˜¯è¿‡æ»¤é“¾æ¥å£ï¼Œè¿‡æ»¤é“¾ç»„åˆæ‰€æœ‰çš„è¿‡æ»¤å™¨å¹¶è¿›è¡Œé¡ºåºè¿‡æ»¤å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterChain</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Request request, Response response)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­Requestæ¥å£ä»£è¡¨è¦å¤„ç†çš„è¯·æ±‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getParameter</span><span class="params">(String var1)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(String key, String value)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­Responseæ¥å£ä»£è¡¨è¦å›å¤çš„å“åº”ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">writeContent</span><span class="params">(String var1)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getContent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå®šä¹‰ä¸€ä¸ªFilterConfigæ¥å£ï¼ŒFilterConfigå’ŒFilteræ˜¯1å¯¹1çš„å…³ç³»ï¼Œç”¨äºå¯¹Filterå‚æ•°è¿›è¡Œå°è£…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: FilterConfig ç®¡ç†å…·ä½“çš„Filterï¼Œä¸ºä¸åŒçš„Filteré…ç½®ä¸ä¸€æ ·çš„å‚æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-03-02 09:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterConfig</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getFilterParameter</span><span class="params">(String var1)</span></span>;</span><br><span class="line">    <span class="function">Filter <span class="title">getFilter</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå®šä¹‰ä¸€ä¸ªServletæ¥å£ï¼Œç”¨äºè¿‡æ»¤å¤„ç†å®Œæˆä¹‹åçš„ä¸šåŠ¡å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: è¿‡æ»¤é“¾å¤„ç†å®Œæˆåäº¤ç»™Servletè¿›è¡Œåç»­å¤„ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2020-03-03 09:39</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">(Request request, Response response)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç¬¬äºŒæ­¥</strong></p>
<p>æˆ‘ä»¬å®ç°ä¸¤ä¸ªå…·ä½“Filterï¼šEnCodingFilterç”¨äºå¯¹è¯·æ±‚ç¼–ç è¿›è¡ŒéªŒè¯ï¼ŒContentTypeFilterç”¨äºå¯¹è¯·æ±‚å†…å®¹ç±»å‹è¿›è¡ŒéªŒè¯ï¼š</p>
<p>EnCodingFilterï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnCodingFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> FilterConfig filterConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡FilterConfigè·å–åˆ°è¿‡æ»¤å™¨å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filterConfig = filterConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Request request, Response response, FilterChain filterChain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. do something</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.filterConfig.getFilterParameter ( <span class="string">"encode"</span> ).equalsIgnoreCase ( request.getParameter ( <span class="string">"encode"</span> ) )) &#123;</span><br><span class="line">            System.out.println ( <span class="string">"ENCODING FILTER CHECKING FAIL"</span> );</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println ( <span class="string">"encode: "</span> + request.getParameter ( <span class="string">"encode"</span> ) + <span class="string">" OK!"</span> );</span><br><span class="line">        response.writeContent ( <span class="string">"ENCODE OK;"</span> );</span><br><span class="line">        <span class="comment">// 2. å‘ä¸‹ä¼ é€’</span></span><br><span class="line">        filterChain.doFilter ( request, response );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ContentTypeFilterï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentTypeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> FilterConfig filterConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡FilterConfigè·å–åˆ°è¿‡æ»¤å™¨å‚æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.filterConfig = filterConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Request request, Response response, FilterChain filterChain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. do something</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.filterConfig.getFilterParameter ( <span class="string">"content-type"</span> ).equalsIgnoreCase ( request.getParameter ( <span class="string">"content-type"</span> ) )) &#123;</span><br><span class="line">            System.out.println ( <span class="string">"CONTENT-TYPE FILTER CHECKING FAIL"</span> );</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println ( <span class="string">"content-type: "</span> + request.getParameter ( <span class="string">"content-type"</span> ) + <span class="string">" OK!"</span> );</span><br><span class="line">        response.writeContent ( <span class="string">"CONTENT-TYPE OK;"</span> );</span><br><span class="line">        <span class="comment">// 2. å‘ä¸‹ä¼ é€’</span></span><br><span class="line">        filterChain.doFilter ( request, response );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç¬¬ä¸‰æ­¥</strong></p>
<p>å®ç°ä¸€ä¸ªå…·ä½“çš„FilterConfigï¼Œä¸€ä¸ªå…·ä½“çš„Filterå¯¹åº”ä¸€ä¸ªFilterConfig</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸€ä¸ªå…·ä½“çš„Filterå¯¹åº”ä¸€ä¸ªAppFilterConfig</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppFilterConfig</span> <span class="keyword">implements</span> <span class="title">FilterConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Filter filter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; parameters = <span class="keyword">new</span> HashMap ();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppFilterConfig</span><span class="params">(Filter filter, Map&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.filter = filter;</span><br><span class="line">       <span class="keyword">this</span>.parameters.putAll ( parameters );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFilterParameter</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parameters.get ( var1 );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Filter <span class="title">getFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç¬¬å››æ­¥</strong></p>
<p>å®ç°ä¸€ä¸ªFilterChainï¼Œä¿å­˜æ‰€æœ‰é…ç½®çš„Filterï¼Œå¹¶è¿›è¡Œè¿‡æ»¤é“¾çš„è°ƒç”¨å¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FilterChain æœ‰åºä¿å­˜æ‰€æœ‰çš„Filterï¼ŒæŒ‰é¡ºåºè°ƒç”¨æ‰€æœ‰çš„Filterè¿›è¡Œè¿‡æ»¤å¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppFilterChain</span> <span class="keyword">implements</span> <span class="title">FilterChain</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AppFilterConfig[] filters = <span class="keyword">new</span> AppFilterConfig[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> Servlet servlet = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setServlet</span><span class="params">(Servlet servlet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servlet = servlet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addFilter</span><span class="params">(AppFilterConfig filterConfig)</span> </span>&#123;</span><br><span class="line">        AppFilterConfig[] newFilters = <span class="keyword">this</span>.filters;</span><br><span class="line">        <span class="keyword">int</span> var3 = newFilters.length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.åˆ¤æ–­filteré‡Œæ˜¯å¦å·²ç»å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">            AppFilterConfig filter = newFilters[var4];</span><br><span class="line">            <span class="keyword">if</span> (filter == filterConfig) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­filteræ•°ç»„æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.n == <span class="keyword">this</span>.filters.length) &#123;</span><br><span class="line">            newFilters = <span class="keyword">new</span> AppFilterConfig[<span class="keyword">this</span>.n + <span class="number">10</span>];</span><br><span class="line">            System.arraycopy(<span class="keyword">this</span>.filters, <span class="number">0</span>, newFilters, <span class="number">0</span>, <span class="keyword">this</span>.n);</span><br><span class="line">            <span class="keyword">this</span>.filters = newFilters;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.æ·»åŠ filter</span></span><br><span class="line">        <span class="keyword">this</span>.filters[<span class="keyword">this</span>.n++] = filterConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.pos &lt; <span class="keyword">this</span>.n) &#123;</span><br><span class="line">            AppFilterConfig filterConfig = <span class="keyword">this</span>.filters[<span class="keyword">this</span>.pos++];</span><br><span class="line">            Filter filter = filterConfig.getFilter ();</span><br><span class="line">            filter.doFilter(request, response, <span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// filter chain å¤„ç†å®Œæ¯•ï¼Œäº¤ç»™ä¸šåŠ¡å¤„ç†</span></span><br><span class="line">            <span class="keyword">this</span>.servlet.service ( request, response );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç¬¬äº”æ­¥</strong></p>
<p>å®ç°ä¸€ä¸ªå…·ä½“çš„ä¸šåŠ¡Servletï¼šAppServlet</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppServlet</span> <span class="keyword">implements</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line">        System.out.println ( <span class="string">"é€šè¿‡FILTER CHAINå¤„ç†ï¼Œè¿›å…¥ä¸šåŠ¡æœå¤„ç†: Response: "</span> + response.getContent () );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç¬¬å…­æ­¥</strong></p>
<p>æä¾›ä¸€ä¸ªå·¥å…·ç±»æ¥ç»„è£…FilterChain</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»„è£…FilterChain</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span>  <span class="class"><span class="keyword">class</span> <span class="title">AppFilterFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppFilterChain <span class="title">createFilterChain</span><span class="params">(Request request, Servlet servlet)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. å®ä¾‹åŒ–FilterChain</span></span><br><span class="line">        AppFilterChain appFilterChain = <span class="keyword">new</span> AppFilterChain ();</span><br><span class="line">        appFilterChain.setServlet ( servlet );</span><br><span class="line">        <span class="comment">// 2. æ·»åŠ å…·ä½“çš„Filterï¼Œæ­¤å¤„æ·»åŠ çš„é¡ºåºå³è¡¨ç¤ºFilterè¢«å¤„ç†çš„é¡ºåº</span></span><br><span class="line">        EnCodingFilter enCodingFilter = <span class="keyword">new</span> EnCodingFilter ();</span><br><span class="line">        Map&lt;String, String&gt; enCodingParams = <span class="keyword">new</span> HashMap&lt;&gt; ( );</span><br><span class="line">        enCodingParams.put ( <span class="string">"encode"</span>, <span class="string">"utf-8"</span> );</span><br><span class="line">        AppFilterConfig appFilterConfig = <span class="keyword">new</span> AppFilterConfig ( enCodingFilter, enCodingParams);</span><br><span class="line">        enCodingFilter.init ( appFilterConfig );</span><br><span class="line">        appFilterChain.addFilter ( appFilterConfig );</span><br><span class="line"></span><br><span class="line">        ContentTypeFilter contentTypeFilter = <span class="keyword">new</span> ContentTypeFilter ();</span><br><span class="line">        Map&lt;String, String&gt; contentTypeParams = <span class="keyword">new</span> HashMap&lt;&gt; ( );</span><br><span class="line">        contentTypeParams.put ( <span class="string">"content-type"</span>, <span class="string">"application/json"</span> );</span><br><span class="line">        appFilterConfig = <span class="keyword">new</span> AppFilterConfig ( contentTypeFilter, contentTypeParams );</span><br><span class="line">        contentTypeFilter.init ( appFilterConfig );</span><br><span class="line">        appFilterChain.addFilter ( appFilterConfig );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> appFilterChain;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ç¬¬ä¸ƒæ­¥</strong></p>
<p>å®ç°ä¸€ä¸ªå…·ä½“çš„è¯·æ±‚ç±»AppRequestå’Œå“åº”ç±»AppResponseï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppRequest</span> <span class="keyword">implements</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; parameters = <span class="keyword">new</span> HashMap&lt;&gt; ( );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.parameters.put ( key, value );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getParameter</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.parameters.get ( var1 );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppResponse</span> <span class="keyword">implements</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="comment">// æ­¤å¤„å†™åˆ°Stringï¼Œæ‰“å°</span></span><br><span class="line">    <span class="comment">// å®é™…çš„HttpServletResponseé€šè¿‡PrintWriterå°†è¿”å›å†…å®¹å†™åˆ°Socket</span></span><br><span class="line">    <span class="keyword">private</span> StringWriter writer = <span class="keyword">new</span> StringWriter (  );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeContent</span><span class="params">(String var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.writer.append ( var1 );</span><br><span class="line">        <span class="keyword">this</span>.content = <span class="keyword">this</span>.writer.toString ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•´ä¸ªè´£ä»»é“¾æ¨¡å¼å®ç°å®Œæˆï¼Œæœ€åæ¥ä½¿ç”¨ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainUsage</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Request request = <span class="keyword">new</span> AppRequest ();</span><br><span class="line">        request.setParameter ( <span class="string">"encode"</span>, <span class="string">"utf-8"</span> );</span><br><span class="line">        request.setParameter ( <span class="string">"content-type"</span>, <span class="string">"application/json"</span> );</span><br><span class="line">        Servlet servlet = <span class="keyword">new</span> AppServlet ();</span><br><span class="line">        Response response = <span class="keyword">new</span> AppResponse ();</span><br><span class="line">        FilterChain filterChain = AppFilterFactory.createFilterChain ( request,  servlet );</span><br><span class="line">        filterChain.doFilter ( request, response );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æä¾›å’Œè¿‡æ»¤å™¨é…ç½®çš„å‚æ•°ä¸€æ ·ï¼Œåˆ™è¿‡æ»¤å™¨å¤„ç†æˆåŠŸï¼Œäº¤ç»™ä¸šåŠ¡å¤„ç†ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">encode: utf-8 OK!</span><br><span class="line">content-type: application/json OK!</span><br><span class="line">é€šè¿‡FILTER CHAINå¤„ç†ï¼Œè¿›å…¥ä¸šåŠ¡æœå¤„ç†: Response: ENCODE OK;CONTENT-TYPE OK;</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹request.setParameter ( â€œencodeâ€, â€œutf-16â€ );æµ‹è¯•ï¼Œç¼–ç è¿‡æ»¤å™¨å¤„ç†ä¸é€šè¿‡ç›´æ¥è¿”å›ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ENCODING FILTER CHECKING FAIL</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹request.setParameter ( â€œcontent-typeâ€, â€œmultipart/form-dataâ€ );æµ‹è¯•ï¼Œå†…å®¹ç±»å‹è¿‡æ»¤å™¨å¤„ç†ä¸é€šè¿‡ç›´æ¥è¿”å›ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">encode: utf-8 OK!</span><br><span class="line">CONTENT-TYPE FILTER CHECKING FAIL</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>é€šè¿‡gRPCæ·»åŠ åˆ é™¤v2rayç”¨æˆ·</title>
    <url>/article/%E9%80%9A%E8%BF%87gRPC%E6%B7%BB%E5%8A%A0%E5%88%A0%E9%99%A4v2ray%E7%94%A8%E6%88%B7/</url>
    <content><![CDATA[<h3 id="ä»€ä¹ˆæ˜¯grpc">ä»€ä¹ˆæ˜¯gRPCï¼Ÿ</h3>
<p>gRPCæ˜¯è°·æ­Œå¼€æºçš„ä¸€ä¸ªè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ˆRemote Process Callï¼‰æ¡†æ¶ï¼ŒgRPCåŸºäºCSæ¨¡å‹ï¼Œä½¿å¾—å®¢æˆ·ç«¯å¯ä»¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡ç«¯çš„æ–¹æ³•ï¼Œä½¿å¾—æ‚¨èƒ½å¤Ÿæ›´å®¹æ˜“åœ°åˆ›å»ºåˆ†å¸ƒå¼åº”ç”¨å’ŒæœåŠ¡ã€‚</p>
<p>gRPCä½¿ç”¨ProtoBuffersä½œä¸ºæ•°æ®åºåˆ—åŒ–ä¼ è¾“å·¥å…·ï¼ŒgRPC-javaä½¿ç”¨nettyä½œä¸ºç½‘ç»œé€šä¿¡åŸºç¡€è®¾æ–½ã€‚</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/20190828141336.png" alt=""></p>
<h3 id="v2rayå¼€æ”¾åŸºäºgrpcçš„apiæ¥å£">V2Rayå¼€æ”¾åŸºäºgRPCçš„APIæ¥å£</h3>
<h4 id="handlerservice">HandlerService</h4>
<p>ä¸€äº›å¯¹äºå…¥ç«™å‡ºç«™ä»£ç†è¿›è¡Œä¿®æ”¹çš„ APIï¼Œå¯ç”¨çš„åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ·»åŠ ä¸€ä¸ªæ–°çš„å…¥ç«™ä»£ç†ï¼›</li>
<li>æ·»åŠ ä¸€ä¸ªæ–°çš„å‡ºç«™ä»£ç†ï¼›</li>
<li>åˆ é™¤ä¸€ä¸ªç°æœ‰çš„å…¥ç«™ä»£ç†ï¼›</li>
<li>åˆ é™¤ä¸€ä¸ªç°æœ‰çš„å‡ºç«™ä»£ç†ï¼›</li>
<li>åœ¨ä¸€ä¸ªå…¥ç«™ä»£ç†ä¸­æ·»åŠ ä¸€ä¸ªç”¨æˆ·ï¼ˆä»…æ”¯æŒ VMessï¼‰ï¼›</li>
<li>åœ¨ä¸€ä¸ªå…¥ç«™ä»£ç†ä¸­åˆ é™¤ä¸€ä¸ªç”¨æˆ·ï¼ˆä»…æ”¯æŒ VMessï¼‰ï¼›</li>
</ul>
<h4 id="loggerservice">LoggerService</h4>
<p>æ”¯æŒå¯¹å†…ç½® Logger çš„é‡å¯ï¼Œå¯é…åˆ logrotate è¿›è¡Œä¸€äº›å¯¹æ—¥å¿—æ–‡ä»¶çš„æ“ä½œã€‚</p>
<h4 id="statsservice">StatsService</h4>
<p>å†…ç½®çš„æ•°æ®ç»Ÿè®¡æœåŠ¡</p>
<h3 id="springboot-é¡¹ç›®é€šè¿‡grpcå‘v2rayæœåŠ¡æ·»åŠ ç”¨æˆ·-åˆ é™¤ç”¨æˆ·">SpringBoot é¡¹ç›®é€šè¿‡gRPCå‘V2RayæœåŠ¡æ·»åŠ ç”¨æˆ·ã€åˆ é™¤ç”¨æˆ·</h3>
<h4 id="v2rayæœåŠ¡configjsoné…ç½®å¼€æ”¾apiæ¥å£">v2rayæœåŠ¡config.jsoné…ç½®å¼€æ”¾apiæ¥å£</h4>
<ul>
<li>ä»githubæ‹‰å»v2rayä»£ç ï¼šgit clone <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a>:v2ray/v2ray-core.git</li>
<li>ç¼–è¯‘v2rayï¼šcd v2ray-core/main; go build -ldflags â€˜-w -sâ€™ -o v2ray</li>
<li>ç¼–è¯‘v2ctlï¼šcd v2ray-core/infra/control/main; go build -ldflags â€˜-w -sâ€™ -o v2ctl</li>
<li>é…ç½®config.jsonï¼Œå¼€æ”¾APIæ¥å£</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"api"</span>: &#123;</span><br><span class="line">        <span class="attr">"services"</span>: [</span><br><span class="line">            <span class="string">"HandlerService"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"tag"</span>: <span class="string">"api"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"inbound"</span>: &#123;</span><br><span class="line">        <span class="attr">"port"</span>: <span class="number">10086</span>,</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</span><br><span class="line">        <span class="attr">"settings"</span>: &#123;</span><br><span class="line">            <span class="attr">"clients"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"alterId"</span>: <span class="number">32</span>,</span><br><span class="line">                    <span class="attr">"id"</span>: <span class="string">"fcecbd2b-3a34-4201-bd3d-7c67d89c26ba"</span>,</span><br><span class="line">                    <span class="attr">"level"</span>: <span class="number">0</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"streamSettings"</span>: &#123;</span><br><span class="line">            <span class="attr">"network"</span>: <span class="string">"tcp"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"tag"</span>: <span class="string">"proxy"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"inboundDetour"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"listen"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">            <span class="attr">"port"</span>: <span class="number">10085</span>,</span><br><span class="line">            <span class="attr">"protocol"</span>: <span class="string">"dokodemo-door"</span>,</span><br><span class="line">            <span class="attr">"settings"</span>: &#123;</span><br><span class="line">                <span class="attr">"address"</span>: <span class="string">"127.0.0.1"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"tag"</span>: <span class="string">"api"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"log"</span>: &#123;</span><br><span class="line">        <span class="attr">"loglevel"</span>: <span class="string">"debug"</span>,</span><br><span class="line">		<span class="attr">"access"</span> : <span class="string">"~/go/src/v2ray-core/log_access.log"</span>,</span><br><span class="line">		<span class="attr">"error"</span> : <span class="string">"~/go/src/v2ray-core/log_error.log"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"outbound"</span>: &#123;</span><br><span class="line">        <span class="attr">"protocol"</span>: <span class="string">"freedom"</span>,</span><br><span class="line">        <span class="attr">"settings"</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"routing"</span>: &#123;</span><br><span class="line">        <span class="attr">"settings"</span>: &#123;</span><br><span class="line">            <span class="attr">"rules"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"inboundTag"</span>: [</span><br><span class="line">                        <span class="string">"api"</span></span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">"outboundTag"</span>: <span class="string">"api"</span>,</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"field"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"strategy"</span>: <span class="string">"rules"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿è¡Œv2rayæœåŠ¡ï¼š./v2ray -config config.json</li>
</ul>
<h4 id="springbooté¡¹ç›®å¼•å…¥grpc">springbooté¡¹ç›®å¼•å…¥gRPC</h4>
<p>å‚è€ƒhttps://github.com/grpc/grpc-java</p>
<p>pom.xml å¼•å…¥grpcä¾èµ–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;io.grpc&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;grpc-netty-shaded&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.23.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;io.grpc&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;grpc-protobuf&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.23.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;io.grpc&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;grpc-stub&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.23.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>å¼•å…¥è‡ªåŠ¨ç”Ÿæˆä»£ç æ’ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;build&gt;</span><br><span class="line">  &lt;extensions&gt;</span><br><span class="line">    &lt;extension&gt;</span><br><span class="line">      &lt;groupId&gt;kr.motd.maven&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;os-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.6.2&lt;/version&gt;</span><br><span class="line">    &lt;/extension&gt;</span><br><span class="line">  &lt;/extensions&gt;</span><br><span class="line">  &lt;plugins&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">      &lt;groupId&gt;org.xolstice.maven.plugins&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;protobuf-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;0.6.1&lt;/version&gt;</span><br><span class="line">      &lt;configuration&gt;</span><br><span class="line">        &lt;protocArtifact&gt;com.google.protobuf:protoc:3.9.0:exe:$&#123;os.detected.classifier&#125;&lt;/protocArtifact&gt;</span><br><span class="line">        &lt;pluginId&gt;grpc-java&lt;/pluginId&gt;</span><br><span class="line">        &lt;pluginArtifact&gt;io.grpc:protoc-gen-grpc-java:1.23.0:exe:$&#123;os.detected.classifier&#125;&lt;/pluginArtifact&gt;</span><br><span class="line">      &lt;/configuration&gt;</span><br><span class="line">      &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">          &lt;goals&gt;</span><br><span class="line">            &lt;goal&gt;compile&lt;/goal&gt;</span><br><span class="line">            &lt;goal&gt;compile-custom&lt;/goal&gt;</span><br><span class="line">          &lt;/goals&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">      &lt;/executions&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">  &lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>
<p>è‡ªåŠ¨ç”Ÿæˆä»£ç æ’ä»¶é»˜è®¤æ ¹æ®src/main/protoç›®å½•ä¸‹çš„protoæ–‡ä»¶æ¥ç”Ÿæˆjavaä»£ç ï¼Œæ”¾åœ¨target/generated-sourcesç›®å½•ä¸‹</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/grpc-2.jpg" alt=""></p>
<h4 id="ç¼–å†™grpc-client-ä»£ç ">ç¼–å†™gRPC client ä»£ç </h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">V2RayCoreService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Logger log = LoggerFactory.getLogger ( V2RayCoreService.class );</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span> ( <span class="string">"$&#123;v2ray.core.host&#125;"</span> )</span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@Value</span> ( <span class="string">"$&#123;v2ray.core.port&#125;"</span> )</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åŒæ­¥è°ƒç”¨stub</span></span><br><span class="line">    <span class="keyword">private</span> HandlerServiceGrpc.HandlerServiceBlockingStub  blockingStub;</span><br><span class="line">    <span class="comment">//å¼‚æ­¥è°ƒç”¨stub</span></span><br><span class="line">    <span class="keyword">private</span> HandlerServiceGrpc.HandlerServiceStub asyncStub;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ManagedChannel <span class="title">channelBuild</span><span class="params">(String host, <span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NettyChannelBuilder.forAddress ( host, port)</span><br><span class="line">                .negotiationType ( NegotiationType.PLAINTEXT ).build ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> HandlerServiceGrpc.<span class="function">HandlerServiceBlockingStub <span class="title">constructBlockingStub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (blockingStub == <span class="keyword">null</span>) &#123;</span><br><span class="line">            blockingStub = HandlerServiceGrpc.newBlockingStub(channelBuild ( host, port ));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> blockingStub;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> HandlerServiceGrpc.<span class="function">HandlerServiceStub <span class="title">constructAsyncStub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (asyncStub == <span class="keyword">null</span>) &#123;</span><br><span class="line">            asyncStub = HandlerServiceGrpc.newStub ( channelBuild ( host, port ) );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> asyncStub;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: åœ¨ä¸€ä¸ªå…¥ç«™ä»£ç†ä¸­æ·»åŠ ä¸€ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="comment">     *      v2RayCoreService.addUser ("proxy",</span></span><br><span class="line"><span class="comment">     *                                      0,</span></span><br><span class="line"><span class="comment">     *                       "test@gmail.com",</span></span><br><span class="line"><span class="comment">     * "4c4893c5-7c8f-03a0-0f86-afc800f2897a",</span></span><br><span class="line"><span class="comment">     *                                     5);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Command.<span class="function">AlterInboundRequest <span class="title">addUser</span><span class="params">(String inBoundTag, <span class="keyword">int</span> userLevel, String userEmail,</span></span></span><br><span class="line"><span class="function"><span class="params">                                               String uuid, <span class="keyword">int</span> alterId)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Headers.SecurityConfig securityConfig = Headers.SecurityConfig.newBuilder()</span><br><span class="line">                .setType ( Headers.SecurityType.AUTO )</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        AccountOuterClass.Account account = AccountOuterClass.Account.newBuilder()</span><br><span class="line">                .setId ( uuid )</span><br><span class="line">                .setAlterId ( alterId  )</span><br><span class="line">                .setSecuritySettings ( securityConfig )</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        UserOuterClass.User user = UserOuterClass.User.newBuilder()</span><br><span class="line">                .setLevel ( userLevel )</span><br><span class="line">                .setEmail ( userEmail )</span><br><span class="line">                .setAccount ( toTypedMessage ( account, <span class="string">"v2ray.core.proxy.vmess.Account"</span> ) )</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        Command.AddUserOperation addUserOperation = Command.AddUserOperation.newBuilder()</span><br><span class="line">                .setUser ( user )</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        TypedMessageOuterClass.TypedMessage operation = toTypedMessage ( addUserOperation,  <span class="string">"v2ray.core.app.proxyman.command.AddUserOperation"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Command.AlterInboundRequest.newBuilder()</span><br><span class="line">                .setTag ( inBoundTag )</span><br><span class="line">                .setOperation ( operation )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: åœ¨ä¸€ä¸ªå…¥ç«™ä»£ç†ä¸­åˆ é™¤ä¸€ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="comment">     * v2RayCoreService.removeUser ( "proxy",</span></span><br><span class="line"><span class="comment">     *                      "test@gmail.com")</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Command.<span class="function">AlterInboundRequest <span class="title">removeUser</span><span class="params">(String inBoundTag, String email)</span> </span>&#123;</span><br><span class="line">        Command.RemoveUserOperation removeUserOperation = Command.RemoveUserOperation.newBuilder()</span><br><span class="line">                .setEmail ( email )</span><br><span class="line">                .build();</span><br><span class="line">        TypedMessageOuterClass.TypedMessage operation = toTypedMessage ( removeUserOperation, <span class="string">"v2ray.core.app.proxyman.command.RemoveUserOperation"</span> );</span><br><span class="line">        <span class="keyword">return</span> Command.AlterInboundRequest.newBuilder()</span><br><span class="line">                .setTag ( inBoundTag )</span><br><span class="line">                .setOperation ( operation )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒæ­¥æ¥å£</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨ç¤ºä¾‹ï¼šæ·»åŠ ç”¨æˆ· </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *            v2RayCoreService.alterInboudBlocking (</span></span><br><span class="line"><span class="comment">     *              v2RayCoreService.addUser ("proxy",</span></span><br><span class="line"><span class="comment">     *                      0,</span></span><br><span class="line"><span class="comment">     *                      "test@gmail.com",</span></span><br><span class="line"><span class="comment">     *                      "4c4893c5-7c8f-03a0-0f86-afc800f2897a",</span></span><br><span class="line"><span class="comment">     *                      5)</span></span><br><span class="line"><span class="comment">     *      );</span></span><br><span class="line"><span class="comment">     * ä½¿ç”¨ç¤ºä¾‹ï¼šåˆ é™¤ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     *           v2RayCoreService.alterInboudBlocking (</span></span><br><span class="line"><span class="comment">     *              v2RayCoreService.removeUser ( "proxy",</span></span><br><span class="line"><span class="comment">     *                      "test@gmail.com")</span></span><br><span class="line"><span class="comment">     *      );</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">alterInboudBlocking</span><span class="params">(Command.AlterInboundRequest alterInboundRequest)</span> </span>&#123;</span><br><span class="line">        constructBlockingStub ().alterInbound ( alterInboundRequest );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼‚æ­¥æ¥å£</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">alterInboundAsync</span><span class="params">(Command.AlterInboundRequest alterInboundRequest)</span> </span>&#123;</span><br><span class="line">        constructAsyncStub ().alterInbound ( alterInboundRequest, <span class="keyword">new</span> StreamObserver&lt;Command.AlterInboundResponse&gt; () &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Command.AlterInboundResponse alterInboundResponse)</span> </span>&#123;</span><br><span class="line">                log.info ( <span class="string">"async alter inbound onNext response &#123;&#125;"</span>, alterInboundResponse );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                log.error ( <span class="string">"async alter inbound error &#123;&#125;"</span>, throwable );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                log.info ( <span class="string">"async alter inbound completed"</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TypedMessageOuterClass.<span class="function">TypedMessage <span class="title">toTypedMessage</span><span class="params">(Message message, String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (message == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> TypedMessageOuterClass.TypedMessage.newBuilder()</span><br><span class="line">                .setType ( type )</span><br><span class="line">                .setValue ( message.toByteString () )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>çŸ¥è¯†ç‚¹</title>
    <url>/article/%E7%9F%A5%E8%AF%86%E7%82%B9/</url>
    <content><![CDATA[<p>[toc]</p>
<h3 id="åŸºç¡€">åŸºç¡€</h3>
<h4 id="è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±"><strong>è‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±</strong></h4>
<p>éƒ¨åˆ†åŸºç¡€æ•°æ®ç±»å‹ä¸å¯¹åº”çš„åŒ…è£…ç±»è¿›è¡Œè¿ç®—æ—¶ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨è¿›è¡Œè½¬æ¢ï¼ˆè£…ç®±ï¼švalueOfï¼Œæ‹†ç®±ï¼šintValueã€floatValueâ€¦ï¼‰</p>
<p>intå¯¹åº”åŒ…è£…ç±»Integerä¼šç¼“å­˜-128ï½127èŒƒå›´çš„æ•´å‹</p>
<p>shortå¯¹åº”åŒ…è£…ç±»Shortä¼šç¼“å­˜-128ï½127èŒƒå›´çš„çŸ­æ•´å‹</p>
<p>longå¯¹åº”åŒ…è£…ç±»Longä¼šç¼“å­˜-128ï½127èŒƒå›´çš„é•¿æ•´å‹</p>
<p>charå¯¹åº”åŒ…è£…ç±»Characterä¼šç¼“å­˜0ï½127èŒƒå›´çš„å­—ç¬¦ï¼ˆjavaçš„charå ä¸¤ä¸ªå­—èŠ‚å­˜çš„æ˜¯unicodeç ï¼Œè¡¨ç¤ºæ•°æ®èŒƒå›´0ï½65525ï¼‰</p>
<p>byteå¯¹åº”åŒ…è£…ç±»Byteä¼šç¼“å­˜-128ï½127èŒƒå›´çš„å­—èŠ‚ï¼Œå³byteæ‰€è¡¨ç¤ºçš„æ•°æ®èŒƒå›´éƒ½ä¼šè¢«ç¼“å­˜</p>
<p>booleanã€floatå’Œdoubleæ²¡æœ‰ç¼“å­˜</p>
<h4 id="é›†åˆ">é›†åˆ</h4>
<h5 id="list">List</h5>
<p>ArrayListä¸LinkedList</p>
<h5 id="map">Map</h5>
<p>HashMapã€LinkedHashMapã€TreeMap</p>
<p>LinkedHashMapï¼šäº†è§£åŸºæœ¬åŸç†ã€å“ªä¸¤ç§æœ‰åºã€å¦‚ä½•ç”¨å®ƒå®ç°LRU</p>
<p>TreeMapï¼šäº†è§£æ•°æ®ç»“æ„ã€äº†è§£å…¶keyå¯¹è±¡ä¸ºä»€ä¹ˆå¿…é¡»è¦å®ç°Compareæ¥å£ã€å¦‚ä½•ç”¨å®ƒå®ç°ä¸€è‡´æ€§å“ˆå¸Œ</p>
<h5 id="treemapå®ç°ä¸€è‡´æ€§hash">TreeMapå®ç°ä¸€è‡´æ€§Hash</h5>
<p>å‚è€ƒ <a href="https://www.cnblogs.com/DengGao/p/6387708.html" target="_blank" rel="noopener">https://www.cnblogs.com/DengGao/p/6387708.html</a></p>
<h5 id="set">Set</h5>
<p>ç”±å¯¹åº”çš„mapå®ç°</p>
<h5 id="threadlocal">ThreadLocal</h5>
<ol>
<li>é­”æ•°</li>
</ol>
<p>é­”æ•°ï¼š0x61c88647 ï¼ˆ32bitæ— ç¬¦å·æ•°ï¼š2654435769ï¼Œ32bitæœ‰ç¬¦å·æ•°ï¼š-1640531527ï¼‰ï¼Œæ˜¯2^32*0.618ï¼ˆé»„é‡‘åˆ†å‰²ç‚¹ï¼‰</p>
<p>ç›®çš„ï¼šä½¿ç”¨æ–æ³¢æ‹‰å¥‘æ•£åˆ—æ³•ï¼Œä½¿å¾—æ•£åˆ—å‡ºçš„å€¼æ›´å‡åŒ€</p>
<ol start="2">
<li>ThreadLocalMap</li>
</ol>
<p>ThreadLocaMapå­˜å‚¨çš„key-valueæ˜¯keyä¸ºThreadLocalå¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œåœ¨ThreadLocalè¢«è®¾ç½®ä¸ºnullåï¼Œåœ¨ä¸‹æ¬¡gcæ—¶ThreadLocalè¢«å›æ”¶æ‰ï¼Œä½†æ˜¯valueè¿˜è¢«çº¿ç¨‹çš„ThreadLocalMapå¼ºå¼•ç”¨ï¼Œå¯¼è‡´å†…å­˜æ³„éœ²ã€‚</p>
<p>ä¸€èˆ¬åœ¨ä½¿ç”¨ThreadLocalæ—¶ä¸€èˆ¬å°†ThreadLocalå®šä¹‰ä¸ºstaticå±æ€§ï¼Œè¿™æ ·ThreadLocalä¸€ç›´å­˜åœ¨ç€å¼ºå¼•ç”¨ï¼Œkeyä¹Ÿä¸èƒ½ä¸ºnullï¼Œç„¶ååœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥æ‰‹åŠ¨è°ƒç”¨removeè¿›è¡Œæ¸…é™¤ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ä¹Ÿè¦æ³¨æ„æ‰‹åŠ¨removeã€‚</p>
<p>â€‹	2.1 ThreadLocalMapåœ¨æ‰©å®¹çš„æ—¶å€™ä¼šå°†entryçš„keyä¸ºnullæ‰€å¯¹åº”çš„valueè®¾ä¸ºnullï¼Œhelp the gcï¼ˆå‡è½»å†…å­˜æ³„éœ²ï¼‰</p>
<p>â€‹    2.2 åœ¨æ¯æ¬¡getã€setæ—¶éƒ½ä¼šæ¸…é™¤keyä¸ºnullæ‰€å¯¹åº”çš„valueä¸ºnullï¼Œå‡è½»å†…å­˜æ³„éœ²</p>
<p>â€‹	2.3 ä¸å†ä½¿ç”¨setè¿›ThreadLocalçš„å€¼åï¼Œè°ƒç”¨ThreadLocalçš„removeæ–¹æ³•æ˜¾å¼åœ°ä»ThreadLocalMapåˆ é™¤æ‰ï¼Œé¿å…å†…å­˜æ³„éœ²</p>
<ol start="3">
<li>
<p>ThreadLocalå’ŒInheritableThreadLocalåŒºåˆ«</p>
<p>3.1 InheritableThreadLocalé‡Œè®¾ç½®çš„å€¼åœ¨å­çº¿ç¨‹å¯ä»¥getåˆ°ï¼ˆåˆ›å»ºå­çº¿ç¨‹æ—¶ä¼šä»çˆ¶çº¿ç¨‹æ‹·è´åˆ°å­çº¿ç¨‹ï¼‰</p>
</li>
<li>
<p>ThreadLocalMapé‡‡ç”¨æ•°ç»„ä¿å­˜Map.Entryï¼Œæ’å…¥æŸ¥æ‰¾å€¼æ—¶é‡‡ç”¨å¼€æ”¾åœ°å€æ³•</p>
</li>
<li>
<p>ç”±äºé‡‡ç”¨å¼€æ”¾åœ°å€æ³•ï¼Œåœ¨hashå†²çªæ˜¯é»˜è®¤æŸ¥æ‰¾ç›¸é‚»ä¸‹ä¸€ä¸ªä½ç½®æ˜¯å¦å¯ç”¨ï¼Œå› æ­¤åœ¨æ¸…é™¤null keyæ—¶ä¼šæœ‰ç‰¹åˆ«çš„ç§»åŠ¨æ“ä½œæ¥ä¿è¯hashçš„é¡ºåºæ­£ç¡®æ€§ï¼ˆå‚è€ƒæ–¹æ³•replaceStaleEntryï¼‰</p>
</li>
<li>
<p>ThreadLocalã€ThreadLocalMapä¹‹é—´å…³ç³»å›¾</p>
</li>
</ol>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/ThreadLocal%E8%A7%A3%E6%9E%90%E5%9B%BE.jpg" alt=""></p>
<h4 id="å¼‚å¸¸">å¼‚å¸¸</h4>
<p>checkedå¼‚å¸¸ï¼šå¿…é¡»è¢«æ•è·æˆ–æŠ›å‡ºï¼Œä¾‹å¦‚IOExceptionã€‚å› æ­¤è¿™ç±»å¼‚å¸¸åœ¨ç¼–å†™ä»£ç æ—¶å°±å¯ä»¥æé†’ç¨‹åºå‘˜ä¼šå‡ºé”™çš„åœ°æ–¹ï¼Œç¨‹åºå‘˜å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©æ•è·æˆ–è€…æŠ›å‡ºã€‚</p>
<p>uncheckedå¼‚å¸¸ï¼šä¾‹å¦‚NPEï¼Œè¿è¡Œæ—¶å¼‚å¸¸ï¼Œä¸éœ€è¦è¢«æ•è·ï¼Œå‡å°‘try-catchï¼Œä»£ç å¯è¯»æ€§å¢å¼º</p>
<p>è‡ªå®šä¹‰å¼‚å¸¸ï¼š</p>
<p>â€‹	ç»§æ‰¿è‡ªExceptionï¼šcheckedå¼‚å¸¸ï¼Œå¿…é¡»è¢«æ•è·æˆ–æŠ›å‡º</p>
<p>â€‹	ç»§æ‰¿è‡ªRuntimeExceptionï¼šuncheckedå¼‚å¸¸ï¼Œä¸éœ€è¦è¢«æ•è·ï¼Œå¦‚æœæŠ›å‡ºå¼‚å¸¸åˆ™é™é»˜æŠ¥é”™</p>
<h4 id="spring">Spring</h4>
<p>beançš„ç”Ÿå‘½å‘¨æœŸ</p>
<p>å¾ªç¯ä¾èµ–é—®é¢˜ï¼š <a href="https://developer.aliyun.com/article/766880" target="_blank" rel="noopener">https://developer.aliyun.com/article/766880</a></p>
<p>spring cloud å…¨å®¶æ¡¶ã€AOPçš„å®ç°ã€springäº‹åŠ¡ä¼ æ’­<br>
å¸¸è§é—®é¢˜</p>
<p>javaåŠ¨æ€ä»£ç†å’ŒcglibåŠ¨æ€ä»£ç†çš„åŒºåˆ«ï¼ˆç»å¸¸ç»“åˆspringä¸€èµ·é—®æ‰€ä»¥å°±æ”¾è¿™é‡Œäº†ï¼‰<br>
å±æ€§æ³¨å…¥å’Œæ„é€ å™¨æ³¨å…¥å“ªç§ä¼šæœ‰å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Ÿ</p>
<p>BeanFactoryä¸FactoryBeançš„åŒºåˆ«</p>
<h4 id="dubboæˆ–å…¶ä»–rpcæ¡†æ¶">Dubboï¼ˆæˆ–å…¶ä»–Rpcæ¡†æ¶ï¼‰</h4>
<p>äº†è§£ä¸€ä¸ªå¸¸ç”¨RPCæ¡†æ¶å¦‚Dubboçš„å®ç°ï¼šæœåŠ¡å‘ç°ã€è·¯ç”±ã€å¼‚æ­¥è°ƒç”¨ã€é™æµé™çº§ã€å¤±è´¥é‡è¯•</p>
<p>å¸¸è§é—®é¢˜</p>
<p>Dubboå¦‚ä½•åšè´Ÿè½½å‡è¡¡ï¼Ÿéšæœºã€è½®è®­ã€åŠ æƒè½®è¯¢ã€åŠ æƒéšæœºã€ä¸€è‡´æ€§hashã€æœ€å°‘æ´»è·ƒ</p>
<h5 id="åŠ æƒè½®è¯¢">åŠ æƒè½®è¯¢</h5>
<h5 id="åŠ æƒéšæœº">åŠ æƒéšæœº</h5>
<ol>
<li>æ ¹æ®æœåŠ¡å™¨çš„æƒé‡è®¡ç®—æ€»çš„æƒé‡å€¼totalWeight</li>
<li>è®¡ç®—æ€»æƒé‡ä¸ºä¸Šé™çš„ä¸€ä¸ªéšæœºå€¼ï¼šrandom.nextInt(totalWeight)</li>
<li>åˆ¤æ–­éšæœºå€¼è½åœ¨æœåŠ¡å™¨æƒé‡å“ªä¸ªåŒºé—´ï¼Œå¹¶è¿”å›ç›¸åº”çš„æœåŠ¡å™¨ä¿¡æ¯</li>
</ol>
<h5 id="ä¸€è‡´æ€§hash">ä¸€è‡´æ€§hash</h5>
<p>hashç¯ã€æœºå™¨æ˜ å°„ã€æ•°æ®æˆ–è°ƒç”¨å‚æ•°æ˜ å°„ã€è™šæ‹ŸèŠ‚ç‚¹</p>
<p>å®ç°ï¼šéœ€æ±‚æœºå™¨hashå€¼åœ¨hashç¯ä¸Šæ’åºï¼Œæ•°æ®æˆ–è°ƒç”¨å‚æ•°hashå€¼åœ¨hashç¯ä¸Šæ‰¾åˆ°æœ€è¿‘èŠ‚ç‚¹</p>
<p>hashå‡½æ•°è¦é€‰æ‹©æ•£åˆ—æ€§èƒ½å¥½çš„</p>
<p>TreeMapå®ç°æ’åºï¼ŒtaiMapè¿”å›å¤§äºç­‰äºæŸä¸ªhashå€¼çš„subMapï¼Œè¿”å›firstKeyå¯¹äºæœ€è¿‘é˜¶æ®µhash</p>
<p>è™šæ‹ŸèŠ‚ç‚¹ï¼šç¡®å®š1ä¸ªçœŸå®èŠ‚ç‚¹å¯¹åº”å¤šå°‘ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œç„¶åç¡®å®šå¯¹åº”è§„åˆ™ï¼ˆæ¯”å¦‚çœŸå®èŠ‚ç‚¹192.168.0.1:1234ï¼Œè™šæ‹ŸèŠ‚ç‚¹5ä¸ªï¼Œå¯¹åº”è§„åˆ™ä¸ºå­—ç¬¦ä¸²æ‹¼æ¥&amp;&amp;VIR0ï½5ï¼Œåˆ™è™šæ‹ŸèŠ‚ç‚¹ä¸º192.168.0.1:1234&amp;&amp;VIR0ã€192.168.0.1:1234&amp;&amp;VIR1ã€192.168.0.1:1234&amp;&amp;VIR2ã€192.168.0.1:1234&amp;&amp;VIR3ã€192.168.0.1:1234&amp;&amp;VIR4ã€192.168.0.1:1234&amp;&amp;VIR5ï¼‰</p>
<h5 id="æœ€å°‘æ´»è·ƒ">æœ€å°‘æ´»è·ƒ</h5>
<ol>
<li>ç»Ÿè®¡æ¯ä¸ªæœåŠ¡å™¨çš„æ´»è·ƒæ•°aciveNumï¼ˆæ¯æ¬¡è°ƒç”¨å‰è‡ªå¢ï¼Œæ¯æ¬¡è°ƒç”¨å®Œæˆåè‡ªå‡ï¼Œæ•°å€¼ä»£è¡¨æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°ä¹Ÿå°±æ˜¯æ´»è·ƒæ•°ï¼Œæ´»è·ƒæ•°è¶Šå°è¯´æ˜æœåŠ¡å™¨è´Ÿè½½è¶Šå°ï¼‰</li>
<li>éå†æ‰¾å‡ºæœ€å°æ´»è·ƒæ•°çš„æœåŠ¡å™¨ï¼Œå¹¶è¿”å›ç›¸åº”æœåŠ¡å™¨çš„ä¿¡æ¯</li>
</ol>
<p>Dubboå¦‚ä½•åšé™æµé™çº§ï¼Ÿè¶…æ—¶ã€æ•…éšœã€é‡è¯•ï¼ˆå¹‚ç­‰æ€§ï¼‰ã€é™çº§ï¼ˆmockï¼‰ã€ç†”æ–­ï¼ˆå¼€ã€å…³ã€åŠå¼€å…³çŠ¶æ€ï¼‰</p>
<h5 id="å¹‚ç­‰æ€§">å¹‚ç­‰æ€§</h5>
<p>â€‹	å®šä¹‰ï¼šç›¸åŒå‚æ•°å¤šæ¬¡è°ƒç”¨æ¥å£å’Œä¸€æ¬¡è°ƒç”¨æ¥å£çš„äº§ç”Ÿæ•ˆæœæ˜¯ä¸€æ ·çš„</p>
<p>â€‹	å®ç°ï¼š</p>
<ol>
<li>
<p>ä¸šåŠ¡å±‚é¢ï¼š</p>
<p>â€‹	ä¸€ï¼š ä½¿ç”¨tokenæœºåˆ¶ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªæ–°çš„token</p>
<p>â€‹	äºŒï¼šçŠ¶æ€æœºï¼Œåªæœ‰å¯¹åº”çš„çŠ¶æ€ä¸‹æ‰å…è®¸æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œå¹¶ä¸”åœ¨æ“ä½œæˆåŠŸåè½¬å…¥ä¸‹ä¸€ä¸ªçŠ¶æ€</p>
<p>â€‹	ä¸‰ï¼š åŠ é”ï¼ˆå¦‚æœ¬åœ°é”ã€åˆ†å¸ƒå¼é”ï¼‰</p>
</li>
<li>
<p>æ•°æ®åº“å±‚é¢ï¼š</p>
<p>â€‹	ä¸€ï¼š æ–°å¢æ“ä½œæ—¶è¿›è¡Œå”¯ä¸€ç´¢å¼•å­—æ®µåˆ¤æ–­</p>
<p>â€‹	äºŒï¼šä¿®æ”¹æ“ä½œæ—¶è¿›è¡Œæ—¶é—´æˆ³æˆ–è€…æ—§å€¼åˆ¤æ–­ï¼ˆä¹è§‚é”ï¼‰</p>
<p>â€‹	ä¸‰ï¼šæ‚²è§‚é”ï¼ˆselect for updateï¼‰</p>
</li>
</ol>
<p>â€‹</p>
<p>Dubboå¦‚ä½•ä¼˜é›…çš„ä¸‹çº¿æœåŠ¡ï¼Ÿ<a href="https://www.cnkirito.moe/dubbo-gracefully-shutdown/" target="_blank" rel="noopener">https://www.cnkirito.moe/dubbo-gracefully-shutdown/</a></p>
<ol>
<li>
<p>JVMæä¾›äº†ä¼˜é›…åœæœºçš„æ¥å£ï¼šRuntime.getRuntime().addShutdownHook</p>
</li>
<li>
<p>Dubboå±‚é¢æ³¨å†Œä¼˜é›…åœæœºæ¥å£ï¼šè¿›è¡ŒæœåŠ¡ä¸‹çº¿å’Œèµ„æºé‡Šæ”¾</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Registry æ³¨é”€</span><br><span class="line">ç­‰å¾… -Ddubbo.service.shutdown.wait ç§’ï¼Œç­‰å¾…æ¶ˆè´¹æ–¹æ”¶åˆ°ä¸‹çº¿é€šçŸ¥</span><br><span class="line">Protocol æ³¨é”€</span><br><span class="line">    DubboProtocol æ³¨é”€</span><br><span class="line">		NettyServer æ³¨é”€</span><br><span class="line">			ç­‰å¾…å¤„ç†ä¸­çš„è¯·æ±‚å®Œæ¯•</span><br><span class="line">            åœæ­¢å‘é€å¿ƒè·³</span><br><span class="line">            å…³é—­ Netty ç›¸å…³èµ„æº</span><br><span class="line">		NettyClient æ³¨é”€</span><br><span class="line">            åœæ­¢å‘é€å¿ƒè·³</span><br><span class="line">            ç­‰å¾…å¤„ç†ä¸­çš„è¯·æ±‚å®Œæ¯•</span><br><span class="line">            å…³é—­ Netty ç›¸å…³èµ„æº</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Dubboå¦‚ä½•å®ç°å¼‚æ­¥è°ƒç”¨çš„ï¼Ÿ</p>
<p>â€‹	1. Futureï¼šè·å–ç»“æœåªèƒ½é˜»å¡è·å–æˆ–è€…è½®è¯¢</p>
<p>â€‹	2. CompletableFutureï¼šå¤šä¸ªå¼‚æ­¥ä¸²è”ã€ç»„åˆæ‰§è¡Œï¼Œå¼‚æ­¥æŒ‡å®šå›è°ƒç»“æœå¤„ç†lambdaç­‰</p>
<h4 id="rocketmqæˆ–å…¶ä»–æ¶ˆæ¯ä¸­é—´ä»¶">RocketMqï¼ˆæˆ–å…¶ä»–æ¶ˆæ¯ä¸­é—´ä»¶ï¼‰</h4>
<p>äº†è§£ä¸€ä¸ªå¸¸ç”¨æ¶ˆæ¯ä¸­é—´ä»¶å¦‚RocketMqçš„å®ç°ï¼šå¦‚ä½•ä¿è¯é«˜å¯ç”¨å’Œé«˜ååã€æ¶ˆæ¯é¡ºåºã€é‡å¤æ¶ˆè´¹ã€äº‹åŠ¡æ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ã€æ­»ä¿¡é˜Ÿåˆ—<br>
å¸¸è§é—®é¢˜</p>
<p>RocketMqå¦‚ä½•ä¿è¯é«˜å¯ç”¨çš„ï¼Ÿ<br>
RocketMqå¦‚ä½•ä¿è¯é«˜ååçš„ï¼Ÿ<br>
RocketMqçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„å—ï¼Ÿ<br>
RocketMqçš„æ¶ˆæ¯å±€éƒ¨é¡ºåºæ˜¯å¦‚ä½•ä¿è¯çš„?<br>
RocketMqäº‹åŠ¡æ¶ˆæ¯çš„å®ç°æœºåˆ¶ï¼Ÿ<br>
RocketMqä¼šæœ‰é‡å¤æ¶ˆè´¹çš„é—®é¢˜å—ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ<br>
RocketMqæ”¯æŒä»€ä¹ˆçº§åˆ«çš„å»¶è¿Ÿæ¶ˆæ¯ï¼Ÿå¦‚ä½•å®ç°çš„ï¼Ÿ<br>
RocketMqæ˜¯æ¨æ¨¡å‹è¿˜æ˜¯æ‹‰æ¨¡å‹ï¼Ÿ<br>
Consumerçš„è´Ÿè½½å‡è¡¡æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p>
<h4 id="redisæˆ–å…¶ä»–ç¼“å­˜ç³»ç»Ÿ">Redisï¼ˆæˆ–å…¶ä»–ç¼“å­˜ç³»ç»Ÿï¼‰</h4>
<p>rediså·¥ä½œæ¨¡å‹ã€redisæŒä¹…åŒ–ã€redisè¿‡æœŸæ·˜æ±°æœºåˆ¶ã€redisåˆ†å¸ƒå¼é›†ç¾¤çš„å¸¸è§å½¢å¼ã€åˆ†å¸ƒå¼é”ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©ã€ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜<br>
å¸¸è§é—®é¢˜</p>
<p>redisæ€§èƒ½ä¸ºä»€ä¹ˆé«˜?<br>
å•çº¿ç¨‹çš„rediså¦‚ä½•åˆ©ç”¨å¤šæ ¸cpuæœºå™¨ï¼Ÿ<br>
redisçš„ç¼“å­˜æ·˜æ±°ç­–ç•¥ï¼Ÿ<br>
rediså¦‚ä½•æŒä¹…åŒ–æ•°æ®ï¼Ÿ<br>
redisæœ‰å“ªå‡ ç§æ•°æ®ç»“æ„ï¼Ÿ<br>
redisé›†ç¾¤æœ‰å“ªå‡ ç§å½¢å¼ï¼Ÿ<br>
æœ‰æµ·é‡keyå’Œvalueéƒ½æ¯”è¾ƒå°çš„æ•°æ®ï¼Œåœ¨redisä¸­å¦‚ä½•å­˜å‚¨æ‰æ›´çœå†…å­˜ï¼Ÿ<br>
å¦‚ä½•ä¿è¯rediså’ŒDBä¸­çš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ<br>
å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€å’Œç¼“å­˜é›ªå´©ï¼Ÿ<br>
å¦‚ä½•ç”¨rediså®ç°åˆ†å¸ƒå¼é”ï¼Ÿ</p>
<h4 id="mysql">Mysql</h4>
<p>äº‹åŠ¡éš”ç¦»çº§åˆ«ã€é”ã€ç´¢å¼•çš„æ•°æ®ç»“æ„ã€èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ã€æœ€å·¦åŒ¹é…åŸåˆ™ã€æŸ¥è¯¢ä¼˜åŒ–ï¼ˆexplainç­‰å‘½ä»¤ï¼‰<br>
æ¨èæ–‡ç« ï¼š<br>
<a href="http://hedengcheng.com/?p=771" target="_blank" rel="noopener">http://hedengcheng.com/?p=771</a><br>
<a href="https://tech.meituan.com/2014/06/30/mysql-index.html" target="_blank" rel="noopener">https://tech.meituan.com/2014/06/30/mysql-index.html</a><br>
<a href="http://hbasefly.com/2017/08/19/mysql-transaction/" target="_blank" rel="noopener">http://hbasefly.com/2017/08/19/mysql-transaction/</a><br>
å¸¸è§é—®é¢˜</p>
<p>Mysql(innondb ä¸‹åŒ) æœ‰å“ªå‡ ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Ÿ<br>
ä¸åŒäº‹åŠ¡éš”ç¦»çº§åˆ«åˆ†åˆ«ä¼šåŠ å“ªäº›é”ï¼Ÿ<br>
mysqlçš„è¡Œé”ã€è¡¨é”ã€é—´éš™é”ã€æ„å‘é”åˆ†åˆ«æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ<br>
è¯´è¯´ä»€ä¹ˆæ˜¯æœ€å·¦åŒ¹é…ï¼Ÿ<br>
å¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ<br>
mysqlç´¢å¼•ä¸ºä»€ä¹ˆç”¨çš„æ˜¯b+ treeè€Œä¸æ˜¯b treeã€çº¢é»‘æ ‘<br>
åˆ†åº“åˆ†è¡¨å¦‚ä½•é€‰æ‹©åˆ†è¡¨é”®<br>
åˆ†åº“åˆ†è¡¨çš„æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢æ—¶ä¸€èˆ¬æ˜¯å¦‚ä½•åšæ’åºçš„ï¼Ÿ<br>
zk</p>
<p>zkå¤§è‡´åŸç†ï¼ˆå¯ä»¥äº†è§£ä¸‹åŸç†ç›¸è¿‘çš„Raftç®—æ³•ï¼‰ã€zkå®ç°åˆ†å¸ƒå¼é”ã€zkåšé›†ç¾¤masteré€‰ä¸¾<br>
å¸¸è§é—®é¢˜</p>
<p>å¦‚ä½•ç”¨zkå®ç°åˆ†å¸ƒå¼é”ï¼Œä¸redisåˆ†å¸ƒå¼é”æœ‰å’Œä¼˜ç¼ºç‚¹</p>
<h4 id="javaä¼ å‚æ–¹å¼">javaä¼ å‚æ–¹å¼</h4>
<ol>
<li>
<p>ç¯å¢ƒå˜é‡</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ SPRING_APPLICATION_JSON=&apos;&#123;&quot;acme&quot;:&#123;&quot;name&quot;:&quot;test&quot;&#125;&#125;&apos; java -jar myapp.jar</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç³»ç»Ÿå˜é‡</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ java -Dspring.application.json=&apos;&#123;&quot;name&quot;:&quot;test&quot;&#125;&apos; -jar myapp.jar</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>å‘½ä»¤è¡Œå‚æ•°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ java -jar myapp.jar --spring.application.json=&apos;&#123;&quot;name&quot;:&quot;test&quot;&#125;&apos;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="qpsä¼°ç®—">QPSä¼°ç®—</h4>
<p>äºŒå…«åŸåˆ™ï¼š80%çš„æµé‡é›†ä¸­åœ¨20%çš„æ—¶é—´é‡Œ</p>
<p>æ¯”å¦‚ï¼šä¸€å¤©çš„PVæ˜¯1000ä¸‡ï¼Œåˆ™å³°å€¼QPSä¸ºï¼š1000ï¼Œ0000 * 0.8 / ï¼ˆ86400*0.2ï¼‰= 460</p>
<p>æ‰€ä»¥æ¥å£çš„QPSéœ€è¦è¾¾åˆ°460</p>
<h4 id="ç”µè„‘éƒ¨ä»¶å¤„ç†æ—¶é—´æ•°é‡çº§å¯¹æ¯”">ç”µè„‘éƒ¨ä»¶å¤„ç†æ—¶é—´æ•°é‡çº§å¯¹æ¯”</h4>
<p>CPUï¼šç§’</p>
<p>å†…å­˜ï¼šåˆ†é’Ÿ</p>
<p>ç£ç›˜ï¼šå¤©/æœˆ</p>
<p>å±€åŸŸç½‘ï¼šå¹´</p>
<p>äº’è”ç½‘ï¼šç™¾å¹´</p>
<h4 id="18-hashmapå¤šçº¿ç¨‹ä¸å®‰å…¨">1.8 HashMapå¤šçº¿ç¨‹ä¸å®‰å…¨</h4>
<p>ä¸¾ä¾‹è¯´æ˜ï¼šåŒæ—¶putä¸¤ä¸ª key1-value1 å’Œkey2-value2æ—¶ï¼Œå¦‚æœkey1å’Œkey2çš„hashå€¼ç›¸åŒï¼Œåˆ™äº§ç”Ÿhashç¢°æ’ï¼Œå°†æ”¾åˆ°åŒä¸€ä¸ªindexä¸‹çš„é“¾è¡¨ä¸Šï¼Œæ­£ç¡®æƒ…å†µæ˜¯ï¼šé“¾è¡¨ä¸Šæœ‰ä¸¤ä¸ªå…ƒç´ ï¼šä¸€ä¸ªæ˜¯key1-value1èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ˜¯key2-value2èŠ‚ç‚¹ã€‚ä½†æ˜¯å¤šçº¿ç¨‹ä¸‹å¯èƒ½å‡ºç°éƒ½å‘åŒä¸€ä¸ªNodeçš„nextå»æ·»åŠ æ–°èŠ‚ç‚¹çš„æƒ…å†µï¼Œæ­¤æ—¶å‰ä¸€ä¸ªæ·»åŠ çš„nodeå°†è¢«åé¢çš„è¦†ç›–ï¼Œå¯¼è‡´å‰ä¸€ä¸ªputçš„key-valueä¸¢å¤±</p>
<h4 id="18-concurrenthashmap-bug">1.8 ConcurrentHashMap Bug</h4>
<p><strong>computeIfAbsent</strong>å‡½æ•°æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™å¦‚æœåœ¨computeFunctioné‡Œæœ‰é€’å½’è°ƒç”¨æˆ–è€…ä¿®æ”¹Mapçš„æ“ä½œï¼Œå°†å¯¼è‡´æ­»å¾ªç¯ã€‚1.9ä¿®å¤äº†æ­¤bugï¼Œä¼šæŠ›å‡ºConcurrentModifyException</p>
<h4 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</h4>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/image-20200416163440212.png" alt=""></p>
<h4 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h4>
<p>â€‹	JDKåŸç”Ÿçº¿ç¨‹æ± ï¼šæ¥æ”¶ä»»åŠ¡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°åï¼Œä¼šå…ˆå°†ä»»åŠ¡æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œåªæœ‰é˜Ÿåˆ—æ»¡äº†åæ‰æ–°åˆ›å»ºçº¿ç¨‹ã€‚è¿™ç§çº¿ç¨‹æ± æ¨¡å‹é€‚åˆå¤„ç†CPUå¯†é›†å‹ä»»åŠ¡ã€‚</p>
<p>â€‹	Tomcat/Jetty/Dubboï¼šè‡ªå»ºçº¿ç¨‹æ± æˆ–è€…æ‰©å±•è‡ªJDKåŸç”Ÿçº¿ç¨‹æ± ï¼šæ¥æ”¶ä»»åŠ¡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°åï¼Œä¼šå…ˆåˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼Œåªæœ‰å½“å‰æ´»è·ƒçº¿ç¨‹è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°åæ‰å°†ä»»åŠ¡æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ã€‚è¿™ç§çº¿ç¨‹æ± æ¨¡å‹é€‚åˆå¤„ç†IOå¯†é›†å‹ä»»åŠ¡ã€‚</p>
<h4 id="jvm"><strong>JVM</strong></h4>
<p>è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼š</p>
<p>JVMä¹‹ç±»åŠ è½½ï¼šjavaè™šæ‹Ÿæœºæ˜¯å­—èŠ‚ç æ‰§è¡Œå¼•æ“ï¼Œæä¾›è·¨å¹³å°ç‰¹æ€§ã€‚è™šæ‹Ÿæœºè¯»å…¥äºŒè¿›åˆ¶å­—èŠ‚ç æµï¼ˆç±»åŠ è½½é˜¶æ®µï¼‰ï¼Œé»˜è®¤æ˜¯åŒäº²å§”æ‰˜åŠ è½½æ¨¡å‹ï¼ŒSPIæ¥å£å®šä¹‰éœ€è¦bootstrapç±»åŠ è½½å™¨å»åŠ è½½ç¬¬ä¸‰æ–¹æ¥å£å®ç°ç±»ï¼Œä½†æ˜¯åŒäº²å§”æ‰˜åŠ è½½æ¨¡å‹é™åˆ¶äº†bootstrapç±»åŠ è½½å™¨ä¸å¯ä»¥åŠ è½½ç”¨æˆ·ç±»ï¼Œå› æ­¤å¼•å…¥äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆé»˜è®¤ä¸ºAppç±»åŠ è½½å™¨ï¼‰ï¼Œå°†ç¬¬ä¸‰æ–¹ç±»åŠ è½½åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨ä¸­å»</p>
<p>JVMä¹‹å†…å­˜æ¨¡å‹ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬äº«çš„å·¥ä½œå†…å­˜ã€æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸»å†…å­˜ã€å¹¶å‘æ§åˆ¶æä¾›è¯­è¨€å±‚é¢çš„volatileã€synchronized</p>
<p>JVMä¹‹å†…å­˜åŒºåŸŸåˆ’åˆ†ï¼šçº¿ç¨‹å…±äº«ï¼šå †å†…å­˜ã€ç›´æ¥å†…å­˜ã€å…ƒæ•°æ®åŒºï¼›çº¿ç¨‹ç‹¬äº«ï¼šçº¿ç¨‹æ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨</p>
<p>JVMä¹‹å†…å­˜ç®¡ç†ï¼š</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/jvm-gc-flags.png" alt=""></p>
<p>â€‹	1. åƒåœ¾å›æ”¶ç®—æ³•ï¼š</p>
<ul>
<li>
<p>å¹´è½»ä»£ï¼š<u>Serial</u>ã€<u>ParNew</u>ã€Parallel Scavengeã€G1</p>
<pre><code>	* Serialç‰¹ç‚¹ï¼šå•çº¿ç¨‹æ”¶é›†ï¼Œé€‚åˆå•CPUåœºæ™¯ï¼Œæ‰§è¡ŒGCæ—¶å®Œå…¨STWï¼Œå¯ä»¥ä¸è€å¹´ä»£CMSæ­é…ä½¿ç”¨
</code></pre>
</li>
<li>
<p>ParNewç‰¹ç‚¹ï¼šå¤šçº¿ç¨‹æ”¶é›†ï¼Œé€‚åˆå¤šCPUåœºæ™¯ï¼Œæ‰§è¡ŒGCæ—¶å®Œå…¨STWï¼Œå…³æ³¨å°½é‡ç¼©çŸ­GCSTWæ—¶é—´ï¼Œå¯ä»¥ä¸è€å¹´ä»£CMSæ­é…ä½¿ç”¨</p>
</li>
<li>
<p>Parallel Scavengeç‰¹ç‚¹ï¼šå¤šçº¿ç¨‹æ”¶é›†ï¼Œé€‚åˆå¤šCPUåœºæ™¯ï¼Œæ‰§è¡ŒGCæ—¶å®Œå…¨STWï¼Œå…³æ³¨ååé‡ä¼˜å…ˆï¼Œå¯ä»¥ä½¿ç”¨è‡ªé€‚åº”ç­–ç•¥è°ƒæ•´å¹´è½»ä»£ã€è€å¹´ä»£å¤§å°</p>
<pre><code>	* G1ç‰¹ç‚¹ï¼šåˆ†ä»£æ”¶é›†ï¼Œå¹´è½»ä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼›å°†å†…å­˜åˆ†æˆå¤§å°ä¸ç­‰çš„Regionï¼Œåªå¯¹éœ€è¦å›æ”¶çš„Regionæ‰§è¡ŒGCï¼Œæé«˜äº†å¹¶å‘ç¨‹åº¦ã€‚ç¼ºç‚¹ï¼šRegionå¤§å°å›ºå®šå¯¹åº”è¿ç»­å¤§å†…å­˜çš„åˆ†é…å®¹æ˜“å¯¼è‡´OOM
</code></pre>
</li>
<li>
<p>è€å¹´ä»£ï¼šSerial Oldã€Parallel Oldã€<u>CMS</u>ã€G1</p>
<ul>
<li>
<p>Serial Oldç‰¹ç‚¹ï¼šSerialçš„è€å¹´ä»£ç‰ˆæœ¬</p>
</li>
<li>
<p>Parallel Oldç‰¹ç‚¹ï¼šParrallel Scavengeçš„è€å¹´ä»£ç‰ˆæœ¬</p>
</li>
<li>
<p>CMSç‰¹ç‚¹ï¼šå°†GCç»†åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œå°†STWçš„æ—¶é—´ç¼©çŸ­ï¼›</p>
<ul>
<li>
<p>åˆå§‹æ ‡è®°ï¼šSTW</p>
</li>
<li>
<p>å¹¶å‘æ ‡è®°ï¼šGCçº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œ</p>
</li>
<li>
<p>é‡æ–°æ ‡è®°ï¼šSTWï¼ˆä¸ºä»€ä¹ˆè¦è¿›è¡Œé‡æ–°æ ‡è®°ï¼Œå› ä¸ºå¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹ä¼šä¿®æ”¹å¯¹è±¡é—´çš„å¼•ç”¨å…³ç³»ï¼Œä¼šå¯¼è‡´æµ®åŠ¨åƒåœ¾çš„äº§ç”Ÿä»¥åŠå¯¹è±¡çš„è¯¯åˆ é™¤ã€‚æµ®åŠ¨åƒåœ¾å¯ä»¥å¿å—ï¼Œä½†å¯¹è±¡çš„è¯¯åˆ é™¤æ˜¯ä¸èƒ½æ¥å—çš„ã€‚æ‰€ä»¥é‡æ–°æ ‡è®°é˜¶æ®µä¸»è¦æ˜¯é˜²æ­¢å¯¹è±¡å¼•ç”¨å…³ç³»å˜åŒ–å¯¼è‡´çš„è¯¯åˆ é™¤ï¼Œå½“ç„¶ä¹Ÿèƒ½å‡å°‘æµ®åŠ¨åƒåœ¾ ã€‚å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/108706654" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/108706654</a></p>
</li>
<li>
<p>å¹¶å‘æ¸…é™¤ï¼šGCçº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼ˆä¼šç»§ç»­äº§ç”Ÿæµ®åŠ¨åƒåœ¾ï¼‰</p>
<p>æé«˜äº†å¹¶å‘åº¦çš„åŒæ—¶ï¼ŒCPUã€å†…å­˜å ç”¨å¢åŠ ï¼Œæä¾›CMSInitiatingOccupancyFractionå‚æ•°è¡¨ç¤ºè€å¹´ä»£ä½¿ç”¨é‡è¾¾åˆ°å¤šå¤§æ¯”ä¾‹å°±è¿›è¡ŒFullGCï¼Œé»˜è®¤ä¸º68%</p>
<p>åŸºäºæ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œå¯¼è‡´å†…å­˜ç¢ç‰‡ï¼Œæä¾›UseCMSCompactAtFullCollectionå‚æ•°è¡¨ç¤ºåœ¨FullGCæ—¶æ‰§è¡Œå†…å­˜ç¢ç‰‡æ•´ç†ï¼Œæé«˜CMSFullGCBeforeCompactionå‚æ•°è¡¨ç¤ºå‡ æ¬¡FullGCåæ‰æ‰§è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ã€‚</p>
</li>
</ul>
</li>
<li>
<p>G1ç‰¹ç‚¹ï¼šåˆ†ä»£æ”¶é›†ï¼Œè€å¹´ä»£ä½¿ç”¨æ ‡è®°æ•´ç†ç®—æ³•ï¼Œæ²¡æœ‰å†…å­˜ç¢ç‰‡ã€‚å¼•å…¥å¯é¢„æµ‹çš„çš„åœé¡¿æ¨¡å‹æ¥é™ä½STWæ—¶é—´ï¼Œæä¾›MaxGCPauseMilliså‚æ•°è®¾ç½®æœ€å¤§GCåœé¡¿æ—¶é—´ä¾›JVMå‚è€ƒã€‚å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/54048685" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/54048685</a></p>
</li>
</ul>
</li>
<li>
<p>Java8 é»˜è®¤GCæ˜¯å¹´è½»ä»£ï¼šParallel Scavenge + è€å¹´ä»£ï¼šSerial Oldï¼›å¯¹åº”çš„JVMå‚æ•°æ˜¯ï¼š-XX:+UseParallelGC</p>
<p>å¯é€šè¿‡å‘½ä»¤æŸ¥è¯¢javaçš„é»˜è®¤GCï¼šjava -XX:+PrintCommandLineFlags -version</p>
<p>å¯é€šè¿‡å‘½ä»¤ï¼šjps -v æŸ¥å‡ºè¿è¡Œä¸­çš„JVMè¿›ç¨‹ï¼Œç„¶åï¼šjinfo -flag UseParallelOldGC pidï¼Œå³å¯çŸ¥é“æ˜¯å¦ä½¿ç”¨è¿™ä¸ªGC</p>
</li>
<li>
<p>G1å¯¹å¤§å†…å­˜æ›´æœ‰ä¼˜åŠ¿ï¼ˆ4æ ¸8Gä»¥ä¸Šï¼‰ï¼Œjava9ä»¥ä¸Šçš„ é»˜è®¤GCæ˜¯G1</p>
</li>
<li>
<p><strong>java10ä»¥å‰FullGCéƒ½æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥è°ƒä¼˜ç›®æ ‡æ˜¯å°½é‡ä¸è¦è§¦å‘FullGC</strong></p>
</li>
<li>
<p>G1æœ€ä½³å®è·µï¼š</p>
<ul>
<li>
<p>è®¾ç½®å †å†…å­˜å¤§å°ï¼šä¸€èˆ¬å°†åˆå§‹å †å’Œæœ€å¤§å †è®¾ç½®ä¸€æ ·ï¼Œé¿å…GCåçš„å†…å­˜é‡æ–°åˆ†é…ã€‚åˆå§‹å †å¤§å°ï¼ˆé»˜è®¤å€¼ä¸ºæœºå™¨å†…å­˜çš„1/64ï¼‰ï¼š -Xmsï¼Œæœ€å¤§å †å¤§å°ï¼ˆé»˜è®¤å€¼ä¸ºæœºå™¨å†…å­˜çš„1/4ï¼‰ï¼š-Xmx</p>
</li>
<li>
<p>ä¸è¦è®¾ç½®å¹´è½»ä»£-Xmnå¤§å°</p>
</li>
<li>
<p>è®¾ç½®STWæœ€å¤§åœé¡¿æ—¶é—´ï¼ˆé»˜è®¤å€¼200msï¼‰ï¼š-XX:MaxGCPauseMillis=n</p>
</li>
<li>
<p>è®¾ç½®å †å†…å­˜å ç”¨ç™¾åˆ†æ¯”è¾¾åˆ°å¤šå°‘æ—¶è§¦å‘ä¸€æ¬¡å¹¶å‘å‘¨æœŸï¼ˆä¸€ä¸ªå¹¶å‘å‘¨æœŸç›¸å½“äºCMSæ•´ä¸ªå‘¨æœŸï¼ŒæœŸé—´è¿›è¡Œçš„GCå«æ··åˆGCï¼‰ï¼Œé»˜è®¤å€¼45ï¼š-XX:InitiatingHeapOccupancyPercent=n</p>
</li>
<li>
<p>è®¾ç½®æ··åˆGCåˆ¤å®šRegionä¸ºåƒåœ¾åˆ†åŒºçš„å­˜æ´»å¯¹è±¡æ¯”ä¾‹é˜ˆå€¼ï¼š-XX:G1MixedGCLiveThresholdPercent=n</p>
</li>
<li>
<p>è®¾ç½®ä¸€ä¸ªå¹¶å‘å‘¨æœŸå†…æœ€å¤šç»å†å‡ æ¬¡ï¼ˆé»˜è®¤8ï¼‰æ··åˆGCï¼š-XX:G1MixedGCCountTarget=n</p>
</li>
<li>
<p>å¢å¤§æ ‡è®°çº¿ç¨‹æ•°é‡ï¼š-XX:ConcGCThreads=n</p>
</li>
<li>
<p>æ‰“å°GCæ—¥å¿—ï¼š</p>
<ul>
<li>æ»šåŠ¨è¾“å‡ºï¼š-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:path-to-gc-log/gc-%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M</li>
<li>æ¯å¤©è¾“å‡ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼š-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:path-to-gc-log/gc-%t.log</li>
</ul>
</li>
<li>
<p>å…³é—­æ˜¾ç¤ºGCï¼š-XX:+DisableExplicitGC</p>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>CMSæœ€ä½³å®è·µï¼š</p>
<ul>
<li>
<p>è®¾ç½®å †å†…å­˜å¤§å°</p>
</li>
<li>
<p>æ‰“å¼€è€å¹´ä»£å†…å­˜ç¢ç‰‡æ•´ç†ï¼š-XX:+UseCMSCompactAtFullCollection</p>
</li>
<li>
<p>åœ¨æ‰“å¼€ç¢ç‰‡æ•´ç†æ—¶è®¾ç½®å¤šå°‘æ¬¡FullGCåè¿›è¡Œä¸€æ¬¡å†…å­˜ç¢ç‰‡æ•´ç†ï¼š -XX:CMSFullGCsBeforeCompaction=n</p>
</li>
<li>
<p>è®¾ç½®è€å¹´ä»£å ç”¨å†…å­˜æ¯”ä¾‹è¾¾åˆ°å¤šå°‘å¼€å§‹è¿›è¡ŒCMS GCï¼ˆé»˜è®¤68%ï¼‰ï¼Œåé¢çš„GCæ˜¯JVMè‡ªå·±å†³å®šçš„ï¼Œè¿™ä¸ªåªæ˜¯ç¬¬ä¸€æ¬¡å¼€å§‹è¿›è¡ŒCMS GCçš„é˜ˆå€¼ï¼š-XX:CMSInitiatingOccupancyFraction=n</p>
</li>
<li>
<p>ä»£ç æ‰§è¡Œæ˜¾ç¤ºGCï¼šSystem.gcæ—¶é»˜è®¤ä¼šæ‰§è¡Œå®Œå…¨STWçš„Full GCï¼Œæ‰“å¼€æ­¤å‚æ•°ä½¿ç”¨CMS GCï¼š-XX:+ExplicitGCInvokesConcurrent</p>
</li>
<li>
<p>å½“CMS GCæ—¶é—´è¿‡é•¿ä¸”æ˜¯å› ä¸ºé‡æ ‡è®°æ—¶é—´è¿‡é•¿ï¼Œå¯ä»¥æ‰“å¼€æ­¤å‚æ•°ï¼Œä½¿å¾—åœ¨é‡æ ‡è®°å‰è¿›è¡Œä¸€æ¬¡YoungGCå‡å°å¹´è½»ä»£å¯¹è±¡å¤§å°ï¼Œå‡å°é‡æ ‡è®°å…¨å±€æ‰«æå¯¹è±¡æ•°ï¼š-XX:+CMSScavengeBeforeRemark</p>
</li>
<li>
<p>JDK8ä»¥å‰çš„ç‰ˆæœ¬ï¼Œæ°¸ä¹…ä»£ä¸ä¼šè‡ªåŠ¨è¢«å›æ”¶ã€‚å½“ç±»åŠ è½½å¸è½½é¢‘ç¹æ—¶ï¼Œæ‰“å¼€æ­¤å‚æ•°å›æ”¶æ— ç”¨çš„ç±»å’Œå¸¸é‡ï¼Œé¿å…æ°¸ä¹…ä»£åŒºOOMï¼ˆJDK8åŠä»¥åä¸ç”¨è®¾ç½®æ­¤å‚æ•°ï¼‰ï¼š-XX:-CMSClassUnloadingEnabled</p>
</li>
<li>
<p>è®¾ç½®å¹¶å‘CMSçº¿ç¨‹æ•°(é»˜è®¤å€¼ï¼šConcGCThreads = (ParallelGCThreads + 3)/4ï¼ŒParallelGCThreads=8+( Processor - 8 ) ( 5/8 ))ï¼š-XX:ConcGCThreads=n</p>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>JVMå‚æ•°è°ƒä¼˜æœ€ä½³å®è·µï¼š</p>
<ul>
<li>
<p>ç¡®å®šç¨‹åºç¨³å®šè¿è¡Œæ—¶æ´»è·ƒæ•°æ®ï¼ˆå¤šæ¬¡FullGCåè€å¹´ä»£å¤§å°ï¼‰å ç”¨çš„å†…å­˜æ€»å¤§å°ï¼šactivity_num</p>
</li>
<li>
<p>è®¾ç½®å †å†…å­˜æ€»å¤§å°ï¼š4 * activity_num ï¼ˆåˆå§‹å †å¤§å°å’Œæœ€å¤§å †å¤§å°è®¾ç½®ä¸€æ ·é¿å…å†…å­˜åˆ†é…ï¼‰</p>
</li>
<li>
<p>YoungGCé¢‘ç¹ï¼šå¢å¤§å¹´è½»ä»£å¤§å°ï¼Œå¹´è½»ä»£æ™‹å‡è€å¹´ä»£åŠ¨æ€ç­–ç•¥ï¼ˆ1ã€æ™‹å‡å¹´é¾„é˜ˆå€¼ï¼šé»˜è®¤15ï¼›2ã€å½“ç´¯ç§¯æŸä¸ªå¹´é¾„çš„å¯¹è±¡å¤§å°è¶…è¿‡survivoråŒºçš„ä¸€åŠæ—¶ï¼Œç›´æ¥æ™‹å‡è€å¹´ä»£ï¼‰</p>
</li>
<li>
<p>FullGCé¢‘ç¹ï¼šåŸå› ï¼š1ã€è€å¹´ä»£ä¸è¶³ï¼›2ã€å…ƒæ•°æ®åŒºé™åˆ¶äº†å¤§å°ä¸”æ–°ç”Ÿæˆç±»é¢‘ç¹å¯¼è‡´é¢‘ç¹FullGCï¼›3ã€å¤§é‡å¹´è½»ä»£æ™‹å‡åˆ°è€å¹´ä»£ä¸”è€å¹´ä»£å­˜ä¸ä¸‹ï¼›4ã€ä¸»åŠ¨æ‰§è¡ŒFullGC</p>
</li>
</ul>
</li>
</ul>
<pre><code>2. å †å†…å­˜åˆ’åˆ†ï¼šå¹´è½»ä»£ï¼ˆedenåŒºï¼Œsurvivor1ã€2åŒºï¼‰ã€è€å¹´ä»£ã€æ°¸ä¹…ä»£ï¼ˆå…ƒæ•°æ®åŒºï¼ŒJDK8ä»¥åå…ƒæ•°æ®åŒºä¸ä½¿ç”¨å †å†…å­˜ï¼Œä½¿ç”¨æœ¬åœ°å†…å­˜ï¼Œä¸”æ ¹æ®åŠ è½½ç±» çš„æ•°é‡åŠ¨æ€è°ƒæ•´å¤§å°ï¼Œä¸éœ€è¦è®¾ç½®å‚æ•°ï¼Œå¦‚æœè®¾ç½®äº†-XX:MaxMetaspaceSize=næ¥é™åˆ¶å…ƒæ•°æ®åŒºçš„æœ€å¤§å†…å­˜ï¼Œåˆ™å¯èƒ½å‡ºç°OOMï¼šMetaspaceï¼‰

3. JVMé»˜è®¤å‚æ•°æŸ¥çœ‹ï¼šjava -XX:+PrintFlagsFinal -version | grep HeapSize
4. å·¥å…·ä½¿ç”¨ï¼š
  	1. æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨æƒ…å†µï¼šjmap -heap pid
  	2. æŸ¥çœ‹å †ä¸­å¯¹è±¡æ•°é‡å’Œå¤§å°ï¼šjmap -histo pid
  	3. ç”Ÿæˆå½“å‰javaè¿›ç¨‹çš„çº¿ç¨‹æ–¹æ³•è°ƒç”¨æ ˆå¿«ç…§ï¼šjstack pid
  	4. ç”Ÿæˆå †å†…å­˜dumpæ–‡ä»¶ï¼šjmap -dump:format=b,file=heap.bin pidï¼Œç„¶åä¼ å›æœ¬åœ°ä½¿ç”¨visualVMåˆ†æ
</code></pre>
<p>java -XX:+PrintCommandLineFlags -version åªæ‰“å°JVMå¯åŠ¨æ—¶æœ‰ä¿®æ”¹çš„å‚æ•°</p>
<p>java -XX:+PrintFlagsInitial -version æ‰“å°JVMæ‰€æœ‰é»˜è®¤çš„åˆå§‹å‚æ•°</p>
<p>java -XX:+PrintFlagsFinal -version æ‰“å°JVMå¯åŠ¨åçš„æœ€ç»ˆè®¾ç½®çš„æ‰€æœ‰å‚æ•°</p>
<h4 id="jvmç›‘æ§">JVMç›‘æ§</h4>
<ol>
<li>
<p>jmxï¼ˆçº¿ä¸Šç¯å¢ƒä¸æ¨èï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-Djava.rmi.server.hostname=127.0.0.1 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=1234 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç™»é™†çº¿ä¸Šæœºå™¨cmd</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">top</span><br><span class="line">jps</span><br><span class="line">jinfo</span><br><span class="line">jstack</span><br><span class="line">jmap</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>arthasï¼ˆæ¨èï¼‰</p>
</li>
</ol>
<h4 id="jvmå‘½ä»¤è¡Œå‚æ•°">JVMå‘½ä»¤è¡Œå‚æ•°</h4>
<p>æ ‡å‡†é€‰é¡¹ï¼š - å¼€å¤´</p>
<p>éæ ‡å‡†é€‰é¡¹ï¼š -Xå¼€å¤´</p>
<p>å¼€å‘é€‰é¡¹ï¼š-XXå¼€å¤´</p>
<p>å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šå€¼çš„ä¸‰ç§æ–¹å¼ï¼š</p>
<p>-XX:+<em>OptionName</em></p>
<p>-XX:-<em>OptionName</em></p>
<p>and -XX:<em>OptionName</em>=</p>
<p>å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šæ•´æ•°å¤§å°æ¯”å¦‚å†…å­˜å¤§å°æ—¶å¯ä»¥åœ¨æ•°å€¼ååŠ ä¸Šåç¼€è¡¨ç¤ºå•ä½å¦‚kã€mã€g</p>
<h4 id="jvmç”Ÿå‘½å‘¨æœŸ">JVMç”Ÿå‘½å‘¨æœŸ</h4>
<ol>
<li>
<p>Launcher</p>
<p>å…¸å‹çš„Launcherï¼šjavaå‘½ä»¤</p>
<p>Launcherçš„ä½œç”¨ï¼š</p>
<ul>
<li>è§£æå‘½ä»¤è¡Œå‚æ•°</li>
<li>å»ºç«‹å †ç©ºé—´ï¼Œè®¾ç½®ç¼–è¯‘æ¨¡å¼ï¼ˆclient æˆ– serverï¼‰</li>
<li>è¯»å–ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œå¦‚CLASSPATH</li>
<li>è¯»å–Main-Class</li>
<li>åˆ›å»ºå¹¶åˆå§‹åŒ–VMï¼ˆJNI_CreateJavaVMï¼‰</li>
<li>åŠ è½½Main-Classï¼ˆCallStaticVoidMethodï¼‰</li>
<li>æ‰§è¡Œå®Œmainæ–¹æ³•åï¼Œæ£€æŸ¥å¹¶æ¸…é™¤å¯èƒ½å‡ºç°çš„pending exceptionsï¼Œç„¶åè¿”å›ç›¸åº”çš„exit status</li>
<li>é”€æ¯VMï¼ˆDestroyJavaVMï¼‰</li>
</ul>
</li>
</ol>
<h5 id="jni_createjavavmæ‰§è¡Œæµç¨‹">JNI_CreateJavaVMæ‰§è¡Œæµç¨‹</h5>
<ol>
<li>1ä¸ªjavaè¿›ç¨‹åªèƒ½åˆ›å»º1ä¸ªVMå®ä¾‹ï¼Œç¡®ä¿ä¸ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹è°ƒç”¨JNI_CreateJavaVMæ–¹æ³•</li>
<li>æ£€æŸ¥æ”¯æŒçš„JNIç‰ˆæœ¬ï¼Œåˆå§‹åŒ–gc loggingè¾“å‡ºæµï¼Œåˆå§‹åŒ–ç”¨åˆ°çš„OSæ¨¡å—å¦‚éšæœºæ•°ç”Ÿæˆå™¨ã€å†…å­˜é¡µç­‰</li>
<li>è§£æä¼ å…¥çš„å‘½ä»¤è¡Œå‚æ•°</li>
<li>æ ¹æ®ä¼ å…¥çš„å‚æ•°è¿›ä¸€æ­¥åˆ›å»ºå’Œåˆå§‹åŒ–ç›¸å…³OSæ¨¡å—ï¼ŒåŠ è½½ç›¸åº”çš„libåº“</li>
<li>gc loggingè¾“å‡ºæµåˆå§‹åŒ–å®Œæˆï¼Œä»£ç†åº“hprofã€jdiåˆå§‹åŒ–å®Œæˆ</li>
<li>åˆå§‹åŒ–çº¿ç¨‹ç›¸å…³æ•°æ®ç»“æ„</li>
<li>åˆå§‹åŒ–å…¨å±€æ•°æ®ç»“æ„å¦‚event logï¼Œsynchronization primitivesç­‰</li>
<li>åˆ›å»ºJava main çº¿ç¨‹ï¼Œåˆå§‹åŒ–Javaçº§åˆ«çš„åŒæ­¥å™¨</li>
<li>åˆå§‹åŒ–å‰©ä½™çš„å…¨å±€æ¨¡å—</li>
<li>åˆå§‹åŒ–VMThreadçº¿ç¨‹ï¼ˆæ‰§è¡ŒVMå…³é”®æ“ä½œçš„çº¿ç¨‹ï¼‰</li>
<li>åŠ è½½Javaç³»ç»Ÿç±»</li>
<li>å¼€å¯Signal Handlerçº¿ç¨‹ç­‰ã€‚å‡†å¤‡å¥½VMç¯å¢ƒäº†ï¼Œæé«˜JNIæœåŠ¡</li>
</ol>
<h5 id="destroyjavavmæ‰§è¡Œæµç¨‹">DestroyJavaVMæ‰§è¡Œæµç¨‹</h5>
<p>Launcherå’ŒVMè‡ªå·±éƒ½å¯ä»¥è°ƒç”¨æ­¤æ–¹æ³•æ¥ç»“æŸVM</p>
<ol>
<li>ç­‰å¾…ç›´åˆ°æœ€åä¸ªnon-daemonçº¿ç¨‹æ‰§è¡Œå®Œæˆï¼ˆSpringbootåº”ç”¨ä¸é€€å‡ºï¼šä½¿ç”¨Asyncæˆ–åˆ›å»ºäº†çº¿ç¨‹æ± éƒ½ä¼šå¯¼è‡´æœ‰non-daemonçº¿ç¨‹å­˜åœ¨è€Œä¸ä¼šé€€å‡ºï¼›å¦å¤–åŒç†ä½¿ç”¨tomcat webserverä¹Ÿä¸ä¼šé€€å‡ºï¼‰</li>
<li>è°ƒç”¨Javaå±‚é¢çš„ä¼˜é›…å…³æœºæ¥å£shutdown hook</li>
<li>è°ƒç”¨finalizers</li>
<li>è°ƒç”¨VMå±‚é¢çš„ä¼˜é›…å…³æœºæ¥å£shutdown hook</li>
<li>å…³é—­å„ç§ç»Ÿè®¡çº¿ç¨‹ã€ä¿¡å·å¤„ç†çº¿ç¨‹ã€GCçº¿ç¨‹ç­‰</li>
<li>é‡Šæ”¾JNIè°ƒç”¨å¤„ç†æ¨¡å—ï¼Œè‡³æ­¤ï¼Œä¸èƒ½å†æ‰§è¡ŒJavaä»£ç </li>
<li>åœæ­¢ç¼–è¯‘çº¿ç¨‹ï¼Œåœæ­¢VMçº¿ç¨‹</li>
<li>é‡Šæ”¾IOã€å†…å­˜èµ„æº</li>
<li>è¿”å›è°ƒç”¨è€…</li>
</ol>
<h5 id="ç±»åŠ è½½">ç±»åŠ è½½</h5>
<p>ç±»åŠ è½½çš„ä½œç”¨ï¼šæ˜ å°„å…¨è·¯å¾„ç±»åæˆ–æ¥å£ååˆ°ç›¸åº”çš„Classå¯¹è±¡</p>
<p>JVMä¼šåœ¨å¯åŠ¨æ—¶é¢„å…ˆåŠ è½½æ ¸å¿ƒç±»å¦‚Objectã€Threadç­‰</p>
<p>VMå’Œç‰¹å®šçš„ClassLoaderç±»ä¸€èµ·é…åˆå®Œæˆç±»çš„åŠ è½½</p>
<p>ç±»åŠ è½½é˜¶æ®µï¼š</p>
<ol>
<li>åŠ è½½é˜¶æ®µï¼šæ ¹æ®ç±»æˆ–æ¥å£åç§°æŸ¥æ‰¾ç¬¦åˆç±»æ–‡ä»¶æ ¼å¼çš„äºŒè¿›åˆ¶æµ</li>
<li>è¿æ¥é˜¶æ®µï¼šæ£€æŸ¥ç±»æ–‡ä»¶æ ¼å¼ï¼Œç»™ç±»é™æ€å­—æ®µèµ‹å€¼ç±»å‹é»˜è®¤å€¼</li>
<li>åˆå§‹åŒ–é˜¶æ®µï¼šå¼€å§‹æ‰§è¡ŒJavaä»£ç ï¼Œå…ˆæ‰§è¡Œé™æ€åˆå§‹åŒ–</li>
</ol>
<p>ä¸€èˆ¬åªæœ‰ä¸»åŠ¨ä½¿ç”¨ç±»çš„æ—¶å€™æ‰ä¼šå‡ºå‘ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–ã€‚</p>
<p>ç±»åŠ è½½å§”æ‰˜æ¨¡å‹ï¼š</p>
<p>Java SEçš„ç±»åŠ è½½é¡ºåºä¾æ¬¡æ˜¯ï¼š the bootstrap class loader, the extension class loader and the system class loader ã€‚</p>
<p>å…¶ä¸­bootstrapæ˜¯JVMå®ç°çš„ç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½bootpathä¸‹çš„ç±»æ¯”å¦‚rt.jaråŒ…</p>
<p>å…¶ä¸­extension class loaderåŠ è½½JREç›®å½•/lib/extä¸‹çš„ç±»ã€‚</p>
<p>å…¶ä¸­system class loaderæ˜¯é»˜è®¤çš„åº”ç”¨ç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½mainå‡½æ•°æ‰€åœ¨ç±»å’Œclasspathä¸‹çš„ç±»ã€‚</p>
<p>ç±»åŠ è½½å™¨å’Œç±»çš„å…¨è·¯å¾„é™å®šåä¸€èµ·å”¯ä¸€ç¡®å®šä¸€ä¸ªç±»ã€‚</p>
<p>JVMä¿è¯ç±»åŠ è½½æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œå› æ­¤ç±»åŠ è½½ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>JVMé”ï¼šjavaå¯¹è±¡é”ï¼šjava monitorï¼Œjavaå¯¹è±¡å¤´ï¼šmark wordï¼ˆé”ä¿¡æ¯ã€gcå¹´é¾„ã€å¯¹è±¡hashcodeï¼‰ã€ç±»æŒ‡é’ˆã€[æ•°ç»„é•¿åº¦]</p>
<p>JVMå†…éƒ¨çº¿ç¨‹ï¼šå•ä¾‹VMThreadã€å•ä¾‹WacherThreadã€å¤šä¸ªGC threadsã€å¤šä¸ªCompiler threadsã€å•ä¾‹Signal Dispatcher Threadã€Finalizerçº¿ç¨‹å’ŒReference Handlerçº¿ç¨‹</p>
<p>C10Kï¼š <a href="http://www.kegel.com/c10k.html" target="_blank" rel="noopener">http://www.kegel.com/c10k.html</a></p>
<p>BIOã€NIOã€Netty</p>
<p>ncã€strace</p>
<h4 id="netty">Netty</h4>
<h5 id="ç‰¹æ€§">ç‰¹æ€§</h5>
<ol>
<li>
<p>IOæ¨¡å‹ï¼ˆLinux epollï¼‰</p>
</li>
<li>
<p>çº¿ç¨‹æ¨¡å‹ï¼ˆreactoræ¨¡å¼ï¼‰ï¼ŒChannelPipeline.addLastæ·»åŠ handleræ—¶å¯ä»¥æä¾›ä¸€ä¸ªå¤„ç†ä¸šåŠ¡çš„çº¿ç¨‹æ± ï¼ˆç±»å‹ï¼šEventExecutorGroupï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨nettyä¹‹å¤–çš„è‡ªå®šä¹‰ä¸šåŠ¡çº¿ç¨‹æ± </p>
<p>åŒºåˆ«ï¼š</p>
<ol>
<li>nettyæä¾›çš„ä¸šåŠ¡çº¿ç¨‹æ± å¯ä»¥ä¿è¯åŒä¸€ä¸ªchannelçš„æ¶ˆæ¯å¯ä»¥é¡ºåºå¤„ç†</li>
<li>è‡ªå®šä¹‰ä¸šåŠ¡çº¿ç¨‹æ± ï¼Œä¸å¯ä»¥ä¿è¯ä»¥ä¸Šçš„é¡ºåºï¼Œæ‰€ä»¥è¦å¤„ç†èµ„æºç«äº‰çš„é—®é¢˜ã€‚</li>
</ol>
</li>
<li>
<p>é«˜æ€§èƒ½é˜Ÿåˆ—æ¡†æ¶Jctoolsï¼ˆç±»ä¼¼Disruptorï¼Œç¯å½¢æ•°ç»„+ç¼“å­˜ä¼ªå…±äº«è§£å†³+CASæ“ä½œï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç¯å½¢æ•°ç»„ï¼šå†…å­˜è¿ç»­åˆ†é…å……åˆ†åˆ©ç”¨ç¼“å­˜</span><br><span class="line">è§£å†³ç¼“å­˜ä¼ªå…±äº«ï¼šå±æ€§ä¹‹é—´æ’å…¥long padingï¼Œç©ºé—´æ¢æ—¶é—´ï¼Œé˜²æ­¢å±æ€§å˜åŒ–ä½¿å¾—ä¸å¿…è¦çš„ç›¸é‚»å±æ€§ç¼“å­˜å¤±æ•ˆ</span><br><span class="line">CASæ“ä½œï¼šMPSCé˜Ÿåˆ—ï¼ˆå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…é˜Ÿåˆ—ï¼‰ï¼Œåœ¨ç”Ÿäº§è€…å…¥é˜Ÿåˆ—æ—¶ï¼Œéœ€è¦æ“ä½œæ•°ç»„ä½¿ç”¨CASæ“ä½œé¿å…é”ç«äº‰</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>é›¶æ‹·è´</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">é›¶æ‹·è´ä¸€èˆ¬å¤§ä¼—æ‰€çŸ¥æ˜¯ Linux ä¸­ä¸€ç§ç”¨äºå‡å°‘åœ¨æ–‡ä»¶ï¼ˆç½‘ç»œï¼‰è¯»å†™è¿‡ç¨‹ä¸­ç”¨æˆ·æ€ä¸å†…æ ¸æ€äº’ç›¸åˆ‡æ¢ï¼Œå†…æ ¸æ€æ•°æ®éœ€è¦ copy åˆ°ç”¨æˆ·æ€çš„ä¼˜åŒ–æ‰‹æ®µã€‚åœ¨ Java çš„ä¸­æ˜¯ä»¥ FileChannel.transferTo æ¥ä½“ç°ã€‚</span><br><span class="line">Netty çš„é›¶æ‹·è´åˆ†ä¸ºä¸¤ç§ï¼š</span><br><span class="line">ä¸€ç§æ˜¯ä½¿ç”¨ FileReigon å°è£…äº† FileChannel.transferTo æ“ä½œä½¿å¾—ç½‘ç»œè¯»å†™æ€§èƒ½å¾—åˆ°ä¼˜åŒ–ï¼ˆåŸºäºæ“ä½œç³»ç»Ÿçš„é›¶æ‹·è´æŠ€æœ¯å®ç°ï¼‰ï¼›</span><br><span class="line">å¦ä¸€ç§æ˜¯ä½¿ç”¨ CompositeByteBuf ä½¿ç”¨å•ä¸ª ByteBuf ä¸€æ ·æ“ä½œå¤šä¸ª ByteBuf è€Œä¸éœ€è¦ä»»ä½• copyï¼Œé€šè¿‡ slice æ–¹æ³•å¯ä»¥è®²å•ä¸ª ByteBuf æ‹†åˆ†ä¸ºå¤šä¸ª ByteBuf æ“ä½œï¼Œä½†æ˜¯å…¶æœ¬è´¨ä¸ºæ“ä½œä¸€ä¸ª copyã€‚æ›´å¤šçš„æ˜¯æŒ‡ä»£ Netty ä¸­å¯¹äºæ•°æ®é«˜æ•ˆç‡æ“ä½œæ–¹å¼ã€‚ä¸å†…æ ¸æ€ç”¨æˆ·æ€åˆ‡æ¢æ— å…³ã€‚</span><br><span class="line">Netty å¯¹äº ByteBuf çš„é›¶æ‹·è´è®©å¤šç§æ•°æ®ç»„åˆæ›´åŠ æ–¹ä¾¿ã€‚é›¶æ‹·è´æœ€å¤šèƒ½å‡å°‘ä¸¤æ¬¡æ— æ„ä¹‰çš„ copy æ“ä½œä¸”å¤§å¹…å‡å°‘å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æä¾›åŸºäºä¼ è¾“å±‚åè®®ï¼ˆTCPã€UDPï¼‰çš„æ”¯æŒå’Œå„ç§é…ç½®</p>
</li>
<li>
<p>æä¾›å„ç§å¼€ç®±å³ç”¨çš„Handler ï¼ˆç¼–è§£ç Codecï¼Œæµåˆ†å‰²LengthFieldBasedFrameDecoderç­‰ï¼Œç©ºé—²æ£€æµ‹IdleStateHandlerï¼Œåºåˆ—åŒ–ï¼‰</p>
</li>
</ol>
<h5 id="epollæƒŠç¾¤">epollæƒŠç¾¤</h5>
<p>â€‹	æƒŠç¾¤ï¼šå¤šä¸ªçº¿ç¨‹ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œåœ¨äº‹ä»¶åˆ°æ¥æ—¶ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¢«å”¤é†’æ¥ç«äº‰äº‹ä»¶çš„å¤„ç†ï¼Œæœ€ååªæœ‰1ä¸ªçº¿ç¨‹æˆåŠŸè·å¾—äº‹ä»¶å¤„ç†ï¼Œå…¶ä»–çº¿ç¨‹åˆå›åˆ°ç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…ä¸‹æ¬¡äº‹ä»¶çš„å‘ç”Ÿã€‚</p>
<p>epoll_waitè®¾è®¡ä¸ºç­‰å¾…å¤šç§ç±»å‹äº‹ä»¶ï¼ˆacceptã€readã€writeã€connectï¼‰çš„å‘ç”Ÿï¼Œacceptäº‹ä»¶åªèƒ½ç”±1ä¸ªçº¿ç¨‹å¤„ç†ï¼Œä½†å…¶ä»–äº‹ä»¶æ¯”å¦‚readäº‹ä»¶æ˜¯å¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹å¤„ç†çš„ï¼Œæ‰€ä»¥å†…æ ¸å¯¹æ­¤ä¸åšå¤„ç†ï¼Œç”±ç”¨æˆ·ç¨‹åºå¤„ç†ã€‚</p>
<p>æ‰€ä»¥åœ¨epoll_waitå¤„ç†acceptäº‹ä»¶æ—¶ä¾ç„¶ä¼šæœ‰æƒŠç¾¤é—®é¢˜ï¼Œnettyè‡ªå·±é™åˆ¶åªæœ‰1ä¸ªbossçº¿ç¨‹æ¥å¤„ç†acceptäº‹ä»¶ï¼Œé¿å…äº†æƒŠç¾¤é—®é¢˜ã€‚</p>
<ul>
<li>accept ä¸ä¼šæœ‰æƒŠç¾¤ï¼Œepoll_wait æ‰ä¼šã€‚</li>
<li>Nginx çš„ accept_mutexï¼Œå¹¶ä¸æ˜¯è§£å†³ accept æƒŠç¾¤é—®é¢˜ï¼Œè€Œæ˜¯è§£å†³ epoll_wait æƒŠç¾¤é—®é¢˜ã€‚</li>
<li>è¯´Nginx è§£å†³äº† epoll_wait æƒŠç¾¤é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸å¯¹çš„ï¼Œå®ƒåªæ˜¯æ§åˆ¶æ˜¯å¦å°†ç›‘å¬å¥—æ¥å­—åŠ å…¥åˆ° epoll ä¸­ã€‚ç›‘å¬å¥—æ¥å­—åªåœ¨ä¸€ä¸ªå­è¿›ç¨‹çš„ epoll ä¸­ï¼Œå½“æ–°çš„è¿æ¥æ¥åˆ°æ—¶ï¼Œå…¶ä»–å­è¿›ç¨‹å½“ç„¶ä¸ä¼šæƒŠé†’äº†ã€‚</li>
</ul>
<p>å‚è€ƒæ–‡ç« https://pureage.info/2015/12/22/thundering-herd.html</p>
<h4 id="springbootå¯åŠ¨æµç¨‹">SpringBootå¯åŠ¨æµç¨‹</h4>
<p>**SpringBoot ç›‘å¬å™¨ï¼š**SpringApplicationRunListeners</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">EventPublishingRunListener ç±»åœ¨SpringBootå¯åŠ¨æ—¶è¯»å–AppClassLoaderåŠ è½½ç›®å½•ä¸‹çš„SpringBootæ¡†æ¶JARåŒ…çš„META-INF/spring.factoriesæ–‡ä»¶å®ä¾‹åŒ–çš„</span><br><span class="line"></span><br><span class="line">EventPublishingRunListenerç±»å®ä¾‹åŒ–çš„æ—¶å€™ä¼šåˆå§‹åŒ–å®ƒçš„ä¸¤ä¸ªå±æ€§ï¼š</span><br><span class="line">åˆå§‹åŒ–äº‹ä»¶å¤šæ’­å™¨ï¼šSimpleApplicationEventMulticaster</span><br><span class="line">å¹¶å‘æ­¤å¤šæ’­å™¨æ·»åŠ å®ç°äº†æ¥å£SpringApplicationRunListenerçš„ç›‘å¬å™¨</span><br><span class="line"></span><br><span class="line">ç„¶åä½¿ç”¨å®ä¾‹åŒ–çš„EventPublishingRunListeneråˆå§‹åŒ–ç±»SpringApplicationRunListenerså¹¶ç”Ÿæˆå…¶å®ä¾‹</span><br><span class="line"></span><br><span class="line">ç±»SpringApplicationRunListenerså®ä¾‹åŒ–åï¼Œè°ƒç”¨å…¶æ–¹æ³•startingï¼Œstartingæ–¹æ³•åˆä¼šè°ƒç”¨å…¶å±æ€§EventPublishingRunListenerçš„startingæ–¹æ³•</span><br><span class="line"></span><br><span class="line">EventPublishingRunListenerçš„startingæ–¹æ³•è°ƒç”¨å…¶å±æ€§åˆå§‹åŒ–äº‹ä»¶å¤šæ’­å™¨çš„multicastEventæ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šéå†åˆå§‹åŒ–EventPublishingRunListeneræ—¶æ·»åŠ çš„ç›‘å¬å™¨ï¼Œé€šçŸ¥ä»–ä»¬äº‹ä»¶</span><br></pre></td></tr></table></figure>
<p><strong>SpringBooté…ç½®ç¯å¢ƒï¼š</strong> ConfigurableEnvironment</p>
<p>**SpringBootåº”ç”¨é…ç½®ä¸Šä¸‹æ–‡ï¼š**ConfigurableApplicationContext</p>
<p><strong>SpringBoot è‡ªåŠ¨åŒ–é…ç½®</strong>ï¼š</p>
<p>spring-boot-xxoo-starterå®é™…ä¸Šæ²¡æœ‰ä»»ä½•javaä»£ç ï¼Œåªæœ‰ä¸ªpomæ–‡ä»¶æŒ‡å®šäº†ä¾èµ–spring-boot-starterï¼Œ</p>
<p>spring-boot-starterä¹Ÿæ²¡æœ‰ä»»ä½•javaä»£ç ï¼Œåªæœ‰ä¸ªpomæ–‡ä»¶æŒ‡å®šäº†ä¾èµ–spring-boot-autoconfigureï¼Œ</p>
<p>è€Œspring-boot-autoconfigureé‡Œåˆ™åŒ…å«äº†æ‰€æœ‰springbootå®˜æ–¹çš„starteråŒ…æ‰€éœ€è¦çš„å¤–éƒ¨ä¾èµ–åŠè‡ªåŠ¨é…ç½®æ–‡ä»¶å’ŒMETA_INF/spring.factories</p>
<p>éå®˜æ–¹çš„starterçš„ç»“æ„å’Œspring-boot-autoconfigureä¸€æ ·åŒ…å«äº†éœ€è¦çš„å¤–éƒ¨ä¾èµ–åŠè‡ªåŠ¨é…ç½®æ–‡ä»¶å’ŒMETA_INF/spring.factories</p>
<p>SpringFactoriesLoaderç±»çš„loadFactoryNamesæ–¹æ³•ï¼Œå…¥å‚ä¸ºfactoryClasså’ŒclassLoaderï¼Œæ ¹æ®æŒ‡å®šçš„classLoaderï¼ŒåŠ è½½è¯¥ç±»åŠ è½½å™¨æœç´¢è·¯å¾„ä¸‹çš„META_INF/spring.factoriesæ–‡ä»¶ï¼Œä¼ å…¥çš„å·¥å‚ç±»ä¸ºæ¥å£ï¼Œè€Œæ–‡ä»¶ä¸­å¯¹åº”çš„ç±»åˆ™æ˜¯æ¥å£çš„å®ç°ç±»ï¼›loadFactoryNamesæ–¹æ³•è¿”å›ç±»åé›†åˆï¼Œæ–¹æ³•è°ƒç”¨æ–¹å¾—åˆ°è¿™äº›é›†åˆåï¼Œå†é€šè¿‡åå°„è·å–è¿™äº›ç±»çš„ç±»å¯¹è±¡ã€æ„é€ æ–¹æ³•ï¼Œæœ€ç»ˆç”Ÿæˆå®ä¾‹</p>
<h4 id="springmvcæ‰§è¡Œæµç¨‹">SpringMVCæ‰§è¡Œæµç¨‹</h4>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/image-20200420163224499.png" alt=""></p>
<h3 id="redis-hyperloglog">Redis-HyperLogLog</h3>
<p><strong>HyperLogLog</strong>ï¼šredis-HyperLogLog ä¸ç²¾ç¡®ï¼ˆ0.81%çš„é”™è¯¯ç‡ï¼‰çš„å»é‡ç»Ÿè®¡ï¼Œæ¯”å¦‚ï¼šç½‘ç«™UVæ•°ã€è®¿é—®IPæ•°ç­‰</p>
<p>åŸç†ï¼šåŸºæ•°ä¼°ç®—ç®—æ³•-ä¼¯åŠªåˆ©å®éªŒ-æ ¹æ®næ¬¡ç‹¬ç«‹å®éªŒï¼šæŠ›æ·ç¡¬å¸é¦–æ¬¡å‡ºç°æ­£é¢ï¼ˆæˆ–åé¢ï¼‰æ‰€éœ€è¦çš„æœ€å¤§æ¬¡æ•°k_maxæ¥ä¼°ç®—å®éªŒçš„æ€»æ¬¡æ•°nï¼š<br>
$$<br>
n = 2^(k_max)<br>
$$<br>
åˆ†æ¡¶å¹³å‡ï¼šå°†ç»Ÿè®¡æ•°æ®åˆ’åˆ†ä¸ºmä¸ªæ¡¶ï¼Œæ¯ä¸ªæ¡¶åˆ†åˆ«ç»Ÿè®¡å„è‡ªçš„k_maxå¹¶èƒ½å¾—åˆ°å„è‡ªçš„åŸºæ•°é¢„ä¼°å€¼ n ï¼Œæœ€ç»ˆå¯¹è¿™äº› n æ±‚è°ƒå’Œå¹³å‡å¾—åˆ°æ•´ä½“çš„åŸºæ•°ä¼°è®¡å€¼ï¼š<br>
$$<br>
n = m * \frac{m}{\sum_{i=1}^{m}{\frac{1}{2^(k_m)}}}<br>
$$</p>
<p>16384=2^14ä¸ªæ¡¶æ•°ç»„ï¼Œæ¯ä¸ªæ¡¶6bitï¼Œä¸€å…±16384*6/8/1024=12KBï¼Œä¸€ä¸ªkeyå ç”¨å†…å­˜12KB</p>
<p>pfadd key valueï¼šå°†valueå–hashç”Ÿæˆ64bitçš„å­—ç¬¦ä¸²ï¼Œå–hashå€¼çš„å‰14ä½æ¥è®¡ç®—æ¡¶æ•°ç»„ä¸‹æ ‡ï¼Œå–hashçš„å50ä½ä¸­é¦–æ¬¡å‡ºç°1çš„ä½æ•°ï¼ˆ0ï½50ä¹‹é—´ï¼Œ6bitå¯å­˜æ”¾åˆ°æ•°å€¼64ï¼Œå› æ­¤å¤Ÿç”¨ï¼‰ï¼Œç„¶åæ”¾å…¥å¯¹åº”çš„æ¡¶ä¸­</p>
<p>pfcount keyï¼šæ ¹æ®ä¼°ç®—å…¬å¼ï¼šä¿®æ­£å› å­ * æ¡¶æ•° * è°ƒå’Œå¹³å‡æ•°ï¼›mä¸ºæ¡¶çš„ä¸ªæ•°16384ï¼Œå¾—åˆ°ä¼°ç®—å€¼<br>
$$<br>
const * m * \frac{m}{\sum_{i=1}^{m}{\frac{1}{2^(k_m)}}}<br>
$$<br>
ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œredisä¸ä¼šç›´æ¥ç”¨16384ä¸ª6bitæ¡¶å­˜å‚¨1ä¸ªHyperLogLogå¯¹è±¡ï¼Œè€Œæ˜¯å…ˆç”¨ç¨€ç–å­˜å‚¨ï¼ˆé’ˆå¯¹è¿ç»­å¤šä¸ªæ¡¶çš„è®¡æ•°ä¸º0è¿›è¡Œå­˜å‚¨ä¼˜åŒ–ï¼Œé’ˆå¯¹è¿ç»­å¤šä¸ªæ¡¶çš„è®¡æ•°éƒ½ä¸ä¸º0ä¸”ç›¸ç­‰ä¹Ÿè¿›è¡Œå­˜å‚¨ä¼˜åŒ–ï¼‰ï¼Œå†ç”¨å¯†é›†å­˜å‚¨ï¼ˆ12Kï¼Œè®¾å®šç¨€ç–å­˜å‚¨è½¬å¯†é›†å­˜å‚¨çš„é˜ˆå€¼ï¼‰çš„æ–¹å¼</p>
<h3 id="å»é‡æ•°æ®ç»“æ„">å»é‡æ•°æ®ç»“æ„</h3>
<p>å¸ƒéš†è¿‡æ»¤å™¨Bloom Filterï¼šå­˜åœ¨åˆ¤æ–­ä¸ç²¾ç¡®ã€ä¸æ”¯æŒåˆ é™¤</p>
<p>åŸç†ï¼šå½“ä¸€ä¸ªå…ƒç´ è¢«åŠ å…¥é›†åˆæ—¶ï¼Œé€šè¿‡Kä¸ª<strong>ç›¸äº’ç‹¬ç«‹</strong>çš„Hashå‡½æ•°å°†è¿™ä¸ªå…ƒç´ æ˜ å°„æˆä¸€ä¸ªä½é˜µåˆ—ï¼ˆBit arrayï¼‰ä¸­çš„Kä¸ªç‚¹ï¼ŒæŠŠå®ƒä»¬ç½®ä¸º1ã€‚</p>
<p>è®¡æ•°å¼å¸ƒéš†è¿‡æ»¤å™¨Counting Bloom Filterï¼šå­˜åœ¨åˆ¤æ–­ä¸ç²¾ç¡®ã€æ”¯æŒåˆ é™¤</p>
<p>åŸç†ï¼šå°†ä½é˜µåˆ—æ‰©å±•æˆbyteé˜µåˆ—ï¼Œç”¨å¤šä½™çš„bitè¦å­˜å‚¨è®¾ç½®ä¸º1çš„è®¡æ•°å™¨ä»¥æ”¯æŒåˆ é™¤æ“ä½œ</p>
<p>å¸ƒè°·é¸Ÿè¿‡æ»¤å™¨Cuckoo Filterï¼šå­˜åœ¨åˆ¤æ–­ç²¾ç¡®ï¼Œæ”¯æŒåˆ é™¤</p>
<p>åŸç†ï¼šæœ‰ä¸¤ä¸ª<strong>ç›¸å…³</strong>çš„hashç®—æ³•å°†æ–°æ¥çš„å…ƒç´ æ˜ å°„åˆ°æ•°ç»„çš„ä¸¤ä¸ªä½ç½®ã€‚å¦‚æœä¸¤ä¸ªä½ç½®ä¸­æœ‰ä¸€ä¸ªä½ç½®ä¸ºç©ºï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠå…ƒç´ æ”¾è¿›å»ï¼›ä½†æ˜¯å¦‚æœè¿™ä¸¤ä¸ªä½ç½®éƒ½æ»¡äº†ï¼Œé‚£ä¹ˆä¼šéšæœºè¸¢èµ°ä¸€ä¸ªï¼Œç„¶åè‡ªå·±éœ¸å è¿™ä¸ªä½ç½®ã€‚</p>
<p>bitmapï¼šå­˜åœ¨åˆ¤æ–­ç²¾ç¡®ï¼Œæ”¯æŒåˆ é™¤</p>
<h3 id="æ—¥å¿—æ¡†æ¶ä½¿ç”¨">æ—¥å¿—æ¡†æ¶ä½¿ç”¨</h3>
<p>é¢å‘ç¨‹åºå‘˜çš„åªæ˜¯æ—¥å¿—é—¨é¢ï¼Œå…·ä½“éœ€è¦å“ªä¸ªæ—¥å¿—æ¡†æ¶ï¼Œé€‰æ‹©ç›¸åº”çš„æ¡¥æ¥å™¨å’Œæ—¥å¿—å®ç°æ¡†æ¶ã€‚</p>
<ol>
<li>åˆšå¼€å§‹ï¼š ç¬¬ä¸‰æ–¹æ—¥å¿—ç³»ç»Ÿï¼šlog4jç­‰</li>
<li>JDKè‡ªå¸¦logï¼š JULï¼ˆJava Util Logï¼‰åŠ å…¥</li>
<li>æ—¥å¿—é—¨é¢JCLï¼ˆJava Common Loggingï¼‰é—®ä¸–ï¼Œå…¶ä»–æ—¥å¿—å®ç°è‡ªå·±æ¡¥æ¥åˆ°JCL(æ¡¥æ¥å™¨)</li>
<li>æ—¥å¿—é—¨é¢SLF4Jé—®ä¸–ï¼ŒåŠ ä¸Šè‡ªå¸¦æ—¥å¿—å®ç°Logbackï¼Œå…¶ä»–æ—¥å¿—å®ç°è‡ªå·±æ¡¥æ¥åˆ°SLF4Jï¼ˆæ¡¥æ¥å™¨ xxx-over-slf4jï¼‰</li>
<li>Log4j2é—®ä¸–ï¼Œè‡ªå¸¦æ—¥å¿—é—¨é¢log4j2-apiï¼ŒåŠ ä¸Šæ—¥å¿—å®ç°log4j2-core</li>
</ol>
<p>è‡³æ­¤ï¼Œæ—¥å¿—é—¨é¢æœ‰ä¸‰ä¸ªäº†ï¼šJCLã€SLF4Jã€log4j2-apiï¼Œæ—¥å¿—å®ç°æœ‰4ä¸ªï¼šJULã€log4jã€logbackã€log4j2-core</p>
<p>ä¸€ä¸ªå­—ï¼šä¹±</p>
<p>å®é™…é¡¹ç›®ä¸­ä½¿ç”¨æ—¥å¿—ï¼Œåº”è¯¥éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p>
<ol>
<li>æ€»æ˜¯ä½¿ç”¨æ—¥å¿—é—¨é¢ï¼šæ¨èSLF4J</li>
<li>åªæ·»åŠ ä¸€ä¸ªæ—¥å¿—å®ç°çš„ä¾èµ–ï¼šæ¨èlog4j2</li>
<li>ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œæœ‰å¿…è¦æ’å‡ºç¬¬ä¸‰æ–¹åº“ä¸­çš„æ—¥å¿—å®ç°ä¾èµ–</li>
<li>æ¯ä¸€ä¸ªæ—¥å¿—çš„å®ç°æ¡†æ¶éƒ½æœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚ä½¿ç”¨slf4jä»¥åï¼Œ<strong>é…ç½®æ–‡ä»¶è¿˜æ˜¯åšæˆæ—¥å¿—å®ç°æ¡†æ¶è‡ªå·±æœ¬èº«çš„é…ç½®æ–‡ä»¶ï¼›æ¯”å¦‚ä½¿ç”¨slf4j+log4j2ï¼Œåˆ™éœ€è¦çš„é…ç½®æ–‡ä»¶ä¸ºlog4j2.xml</strong></li>
</ol>
<p>Spring-booté¡¹ç›®é»˜è®¤ä½¿ç”¨ï¼šSLF4J + logbackï¼Œä¸”æŠŠå…¶ä»–çš„æ—¥å¿—éƒ½æ›¿æ¢æˆäº†slf4j</p>
<p>SpringBooté¡¹ç›®ä½¿ç”¨slf4j+log4j2é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="å•ç‚¹ç™»å½•">å•ç‚¹ç™»å½•</h3>
<h3 id="ç§’æ€å¹³å°è®¾è®¡">ç§’æ€å¹³å°è®¾è®¡</h3>
<p>é—®é¢˜ï¼šé«˜å¹¶å‘ã€è¶…å–ã€æ¶æ„è¯·æ±‚ã€é“¾æ¥æš´éœ²</p>
<p>æ€è·¯ï¼š</p>
<p><strong>åº”å¯¹é«˜å¹¶å‘</strong>ï¼šå¾®æœåŠ¡ã€åˆ†å¸ƒå¼ã€é›†ç¾¤ã€</p>
<p>ç¼“å­˜ç©¿é€ï¼šè¯·æ±‚ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼ˆè§£å†³ï¼š1. ç¼“å­˜ç©ºå€¼å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ 2. bloomfilterå…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨ç„¶åå†èµ°ç¼“å­˜-&gt;DBï¼‰ã€</p>
<p>ç¼“å­˜å‡»ç©¿ï¼šå¤§é‡è¯·æ±‚åŒæ—¶è¯·æ±‚åŒä¸€ä¸ªå¤±æ•ˆçš„keyï¼ˆè§£å†³ï¼šåˆ†å¸ƒå¼é”+å†™ç¼“å­˜ï¼‰ã€</p>
<p>ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶å¤±æ•ˆï¼ˆè§£å†³ï¼šåˆ†å¸ƒå¼é”+å†™ç¼“å­˜ï¼Œè®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ã€æœåŠ¡é™æµé™çº§ï¼‰</p>
<p><strong>åº”å¯¹è¶…å–</strong>ï¼šå¹‚ç­‰æ€§ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€åˆ†å¸ƒå¼é”</p>
<p><strong>æ¶æ„è¯·æ±‚</strong>ï¼šå±è”½ç‰¹å®šuse-agentã€å±è”½é¢‘ç¹è®¿é—®çš„ipï¼ˆguava RateLimiterï¼‰</p>
<p><strong>é“¾æ¥æš´éœ²</strong>ï¼šåŠ¨æ€urlï¼ˆurlåŠ å…¥md5éªŒè¯ï¼‰</p>
<p>å°†è¯·æ±‚å°½é‡æ‹¦æˆªåœ¨ç³»ç»Ÿä¸Šæ¸¸ï¼ˆç”¨æˆ·é¡µé¢-cdnç¼“å­˜-Nginxè´Ÿè½½å‡è¡¡-æœåŠ¡å™¨é›†ç¾¤-Redis-æ¶ˆæ¯é˜Ÿåˆ—-Mysqlï¼‰</p>
<p><strong>ä¸šåŠ¡é€»è¾‘ä¼˜åŒ–</strong>ï¼šè¦å°†ç§’æ€å•†å“å…ˆåŠ å…¥è´­ç‰©è½¦æ‰å¯ä»¥ä¸‹å•ç­‰</p>
<p><strong>å®¹é”™å¤„ç†</strong>ï¼šé™æµã€é™çº§ã€ç†”æ–­</p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/image-20200420170520211.png" alt=""></p>
<h3 id="ç®—æ³•">ç®—æ³•</h3>
<p>å•é“¾è¡¨åè½¬</p>
<p>åŠ¨æ€è§„åˆ’-å®Œå…¨èƒŒåŒ…é—®é¢˜</p>
<h4 id="æ’åº">æ’åº</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å†’æ³¡æ’åºï¼š</span><br><span class="line">&lt;1&gt;.æ¯”è¾ƒç›¸é‚»çš„å…ƒç´ ã€‚å¦‚æœç¬¬ä¸€ä¸ªæ¯”ç¬¬äºŒä¸ªå¤§ï¼Œå°±äº¤æ¢å®ƒä»¬ä¸¤ä¸ªï¼›</span><br><span class="line">&lt;2&gt;.å¯¹æ¯ä¸€å¯¹ç›¸é‚»å…ƒç´ ä½œåŒæ ·çš„å·¥ä½œï¼Œä»å¼€å§‹ç¬¬ä¸€å¯¹åˆ°ç»“å°¾çš„æœ€åä¸€å¯¹ï¼Œè¿™æ ·åœ¨æœ€åçš„å…ƒç´ åº”è¯¥ä¼šæ˜¯æœ€å¤§çš„æ•°ï¼›</span><br><span class="line">&lt;3&gt;.é’ˆå¯¹æ‰€æœ‰çš„å…ƒç´ é‡å¤ä»¥ä¸Šçš„æ­¥éª¤ï¼Œé™¤äº†æœ€åä¸€ä¸ªï¼›</span><br><span class="line">&lt;4&gt;.é‡å¤æ­¥éª¤1~3ï¼Œç›´åˆ°æ’åºå®Œæˆã€‚</span><br><span class="line"></span><br><span class="line">æ”¹è¿›1: è®¾ç½®ä¸€æ ‡å¿—æ€§å˜é‡pos,ç”¨äºè®°å½•æ¯è¶Ÿæ’åºä¸­æœ€åä¸€æ¬¡è¿›è¡Œäº¤æ¢çš„ä½ç½®ã€‚ç”±äºposä½ç½®ä¹‹åçš„è®°å½•å‡å·²äº¤æ¢åˆ°ä½,æ•…åœ¨è¿›è¡Œä¸‹ä¸€è¶Ÿæ’åºæ—¶åªè¦æ‰«æåˆ°posä½ç½®å³å¯ã€‚</span><br><span class="line"></span><br><span class="line">æ”¹è¿›2: ä¼ ç»Ÿå†’æ³¡æ’åºä¸­æ¯ä¸€è¶Ÿæ’åºæ“ä½œåªèƒ½æ‰¾åˆ°ä¸€ä¸ªæœ€å¤§å€¼æˆ–æœ€å°å€¼,æˆ‘ä»¬è€ƒè™‘åˆ©ç”¨åœ¨æ¯è¶Ÿæ’åºä¸­è¿›è¡Œæ­£å‘å’Œåå‘ä¸¤éå†’æ³¡çš„æ–¹æ³•ä¸€æ¬¡å¯ä»¥å¾—åˆ°ä¸¤ä¸ªæœ€ç»ˆå€¼(æœ€å¤§è€…å’Œæœ€å°è€…) , ä»è€Œä½¿æ’åºè¶Ÿæ•°å‡ ä¹å‡å°‘äº†ä¸€åŠã€‚</span><br><span class="line"></span><br><span class="line">æ—¶é—´å¤æ‚åº¦ï¼šO(nÂ²)</span><br><span class="line">ç©ºé—´å¤æ‚åº¦ï¼šO(1) (in-placeï¼Œä¸éœ€è¦é¢å¤–ç©ºé—´)</span><br><span class="line">ç¨³å®šæ’åºï¼šç¨³å®š</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">é€‰æ‹©æ’åºï¼šé¦–å…ˆåœ¨æœªæ’åºåºåˆ—ä¸­æ‰¾åˆ°æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œç„¶åï¼Œå†ä»å‰©ä½™æœªæ’åºå…ƒç´ ä¸­ç»§ç»­å¯»æ‰¾æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œç„¶åæ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å‡æ’åºå®Œæ¯•ã€‚</span><br><span class="line"></span><br><span class="line">æ—¶é—´å¤æ‚åº¦ï¼šO(nÂ²)</span><br><span class="line">ç©ºé—´å¤æ‚åº¦ï¼šO(1) (in-placeï¼Œä¸éœ€è¦é¢å¤–ç©ºé—´)</span><br><span class="line">ç¨³å®šæ’åºï¼šæ¯æ¬¡ä»æœªæ’åºçš„æ•°ä¸­é€‰æ‹©æœ€å°çš„ä¸æœªæ’åºçš„ç¬¬ä¸€ä¸ªäº¤æ¢ï¼Œç ´åäº†ç›¸å¯¹é¡ºåºï¼ˆæ¯”å¦‚æœªæ’åºçš„ç¬¬ä¸€ä¸ªæ˜¯3ï¼Œç¬¬äºŒä¸ªä¹Ÿæ˜¯3ï¼Œç¬¬ä¸‰ä¸ªæ˜¯2ä¹Ÿæ˜¯æœªæ’åºä¸­æœ€å°çš„ï¼Œæ­¤æ—¶äº¤æ¢ç¬¬ä¸‰ä¸ªå’Œç¬¬ä¸€ä¸ªï¼Œä¼šç ´åç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªä¹‹é—´çš„ç›¸å¯¹é¡ºåºï¼‰ï¼Œæ‰€ä»¥ä¸æ˜¯ç¨³å®šçš„æ’åº</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ’å…¥æ’åºï¼šé‡‡ç”¨in-placeåœ¨æ•°ç»„ä¸Šå®ç°ã€‚å…·ä½“ç®—æ³•æè¿°å¦‚ä¸‹ï¼š</span><br><span class="line">1. ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œè¯¥å…ƒç´ å¯ä»¥è®¤ä¸ºå·²ç»è¢«æ’åº</span><br><span class="line">2. å–å‡ºä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å·²ç»æ’åºçš„å…ƒç´ åºåˆ—ä¸­ä»åå‘å‰æ‰«æ</span><br><span class="line">3. å¦‚æœè¯¥å…ƒç´ ï¼ˆå·²æ’åºï¼‰å¤§äºæ–°å…ƒç´ ï¼Œå°†è¯¥å…ƒç´ ç§»åˆ°ä¸‹ä¸€ä½ç½®</span><br><span class="line">4. é‡å¤æ­¥éª¤3ï¼Œç›´åˆ°æ‰¾åˆ°å·²æ’åºçš„å…ƒç´ å°äºæˆ–è€…ç­‰äºæ–°å…ƒç´ çš„ä½ç½®</span><br><span class="line">5. å°†æ–°å…ƒç´ æ’å…¥åˆ°è¯¥ä½ç½®å</span><br><span class="line">6. é‡å¤æ­¥éª¤2~5</span><br><span class="line"></span><br><span class="line">æ”¹è¿›ï¼š äºŒåˆ†æ’å…¥æ’åºï¼šæŸ¥æ‰¾æ’å…¥ä½ç½®æ—¶ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼</span><br><span class="line"></span><br><span class="line">æ—¶é—´å¤æ‚åº¦ï¼šO(nÂ²) ï¼ˆè™½ç„¶å¹³å‡æ—¶é—´å¤æ‚åº¦éƒ½ä¸€æ ·ï¼Œä½†ä¸ä¸€å®šéƒ½ä¸€æ ·å¿«ï¼Œä¸€èˆ¬ï¼šæ’å…¥æ’åºå¿«äºé€‰æ‹©æ’åºå¿«äºå†’æ³¡æ’åºï¼‰</span><br><span class="line">ç©ºé—´å¤æ‚åº¦ï¼šO(1) (in-placeï¼Œä¸éœ€è¦é¢å¤–ç©ºé—´)</span><br><span class="line">ç¨³å®šæ’åºï¼šç¨³å®š</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¸Œå°”æ’åºï¼šæ”¹è¿›çš„æ’å…¥æ’åºï¼Œå¼•å…¥ä¸€ä¸ªå¢é‡åºåˆ—(æ¯”å¦‚ï¼šlength/2, length/2/2, ... ,1)ï¼Œå¢é‡ä¾æ¬¡é€’å‡ï¼Œæ¯æ¬¡ä¾æ®å¢é‡å¯¹åŸæ•°ç»„è¿›è¡Œåˆ†ç»„ç›´æ¥æ’å…¥æ’åºï¼Œå¾…åˆ°å¢é‡ä¸º1æ—¶æœ€åä¸€è¶Ÿæ’å…¥æ’åºåå³å®Œæˆæ•´ä¸ªæ•°ç»„çš„æ’åºã€‚</span><br><span class="line"></span><br><span class="line">æ—¶é—´å¤æ‚åº¦ï¼šO(nlogn)</span><br><span class="line">ç©ºé—´å¤æ‚åº¦ï¼šO(1) (in-placeï¼Œä¸éœ€è¦é¢å¤–ç©ºé—´)</span><br><span class="line">ç¨³å®šæ€§ï¼šåœ¨ä¸åŒçš„åˆ†ç»„ä¸­å¤šæ¬¡æ’å…¥æ’åºå¯¼è‡´ä¸ç¨³å®š</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å½’å¹¶æ’åºï¼šé‡‡ç”¨åˆ†æ²»æ³•ï¼Œå°†å·²æœ‰åºçš„å­åºåˆ—åˆå¹¶ï¼Œå¾—åˆ°å®Œå…¨æœ‰åºçš„åºåˆ—ï¼›ç±»ä¼¼å¢é‡åºåˆ—ï¼ˆlength/2, length/2/2, ... ,1ï¼‰å½“å¢é‡ä¸º1æ—¶çš„åˆ†ç»„è‡ªç„¶æœ‰åºï¼Œç„¶åé€’å½’åˆå¹¶2ï¼Œ4ï¼Œ8é•¿åº¦åˆ†ç»„ï¼Œç”±äºåˆå¹¶çš„ä¸¤ä¸ªåˆ†ç»„å·²ç»æœ‰åºï¼Œåˆå¹¶æ“ä½œå¾ˆç®€å•å¦‚ä¸‹ï¼š</span><br><span class="line">1. ç”³è¯·ç©ºé—´ï¼Œä½¿å…¶å¤§å°ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—ä¹‹å’Œï¼Œè¯¥ç©ºé—´ç”¨æ¥å­˜æ”¾åˆå¹¶åçš„åºåˆ—</span><br><span class="line">2. è®¾å®šä¸¤ä¸ªæŒ‡é’ˆï¼Œæœ€åˆä½ç½®åˆ†åˆ«ä¸ºä¸¤ä¸ªå·²ç»æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®</span><br><span class="line">3. æ¯”è¾ƒä¸¤ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ ï¼Œé€‰æ‹©ç›¸å¯¹å°çš„å…ƒç´ æ”¾å…¥åˆ°åˆå¹¶ç©ºé—´ï¼Œå¹¶ç§»åŠ¨æŒ‡é’ˆåˆ°ä¸‹ä¸€ä½ç½®</span><br><span class="line">4. é‡å¤æ­¥éª¤3ç›´åˆ°æŸä¸€æŒ‡é’ˆåˆ°è¾¾åºåˆ—å°¾</span><br><span class="line">5. å°†å¦ä¸€åºåˆ—å‰©ä¸‹çš„æ‰€æœ‰å…ƒç´ ç›´æ¥å¤åˆ¶åˆ°åˆå¹¶åºåˆ—å°¾</span><br><span class="line"></span><br><span class="line">æ—¶é—´å¤æ‚åº¦ï¼šO(nlogn)</span><br><span class="line">ç©ºé—´å¤æ‚åº¦ï¼šO(n) (éœ€è¦é¢å¤–æ•°ç»„é•¿åº¦çš„ç©ºé—´)</span><br><span class="line">ç¨³å®šæ€§ï¼šç¨³å®š</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å¿«é€Ÿæ’åºï¼šä¹Ÿæ˜¯é‡‡ç”¨åˆ†æ²»æ³•ï¼Œåœ¨å¾…æ’åºçš„æ•°åˆ—ä¸­ï¼Œé¦–å…ˆè¦æ‰¾ä¸€ä¸ªæ•°å­—ä½œä¸ºåŸºå‡†æ•°ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸€èˆ¬é€‰æ‹©ç¬¬1ä¸ªæ•°å­—ä½œä¸ºåŸºå‡†æ•°ï¼ˆå…¶å®é€‰æ‹©ç¬¬å‡ ä¸ªå¹¶æ²¡æœ‰å…³ç³»ï¼‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªå¾…æ’åºçš„æ•°åˆ—ä¸­å°äºåŸºå‡†æ•°çš„å…ƒç´ ç§»åŠ¨åˆ°å¾…æ’åºçš„æ•°åˆ—çš„å·¦è¾¹ï¼ŒæŠŠå¤§äºåŸºå‡†æ•°çš„å…ƒç´ ç§»åŠ¨åˆ°å¾…æ’åºçš„æ•°åˆ—çš„å³è¾¹ã€‚è¿™æ—¶ï¼Œå·¦å³ä¸¤ä¸ªåˆ†åŒºçš„å…ƒç´ å°±ç›¸å¯¹æœ‰åºäº†ï¼›æ¥ç€æŠŠä¸¤ä¸ªåˆ†åŒºçš„å…ƒç´ åˆ†åˆ«æŒ‰ç…§ä¸Šé¢ä¸¤ç§æ–¹æ³•ç»§ç»­å¯¹æ¯ä¸ªåˆ†åŒºæ‰¾å‡ºåŸºå‡†æ•°ï¼Œç„¶åç§»åŠ¨ï¼Œç›´åˆ°å„ä¸ªåˆ†åŒºåªæœ‰ä¸€ä¸ªæ•°æ—¶ä¸ºæ­¢ã€‚</span><br><span class="line">æ¯”å¦‚å¾…æ’åºæ•°ç»„ä¸ºï¼š6 1 2 7 9 3 4 5 10 8</span><br><span class="line">1ã€é€‰å–åŸºå‡†æ•°ï¼š6</span><br><span class="line">2ã€ç„¶åå…ˆä»å³å¾€å·¦æ‰¾ä¸€ä¸ªå°äº 6 çš„æ•°ï¼Œå†ä»å·¦å¾€å³æ‰¾ä¸€ä¸ªå¤§äº 6 çš„æ•°ï¼Œç„¶åäº¤æ¢ä»–ä»¬ã€‚ç›´åˆ°å·¦å³indexç›¸é‡ï¼Œæ­¤æ—¶å†å’ŒåŸºå‡†æ•°äº¤æ¢ï¼Œå¾—åˆ°åºåˆ—ï¼š3 1 2 5 4 6 9 7 10 8</span><br><span class="line">3ã€å†å¯¹åŸºå‡†æ•°6ä¸¤è¾¹çš„åºåˆ—é€’å½’åº”ç”¨ä¸Šè¿°æ–¹æ³•</span><br><span class="line">4ã€æ¯”å¦‚å·¦è¾¹ä»¥3ä¸ºåŸºå‡†æ•°ç»§ç»­è¿›è¡Œæ¯”è¾ƒäº¤æ¢ï¼Œæœ€ç»ˆå¾—åˆ°åºåˆ—ï¼š2 1 3 5 4 6 9 7 10 8</span><br><span class="line">5ã€ç»§ç»­å·¦è¾¹ï¼Œæœ€ç»ˆå¾—åˆ°åºåˆ—ï¼š1 2 3 4 5 6 9 7 10 8</span><br><span class="line">6ã€æ¢å³è¾¹ï¼Œæœ€ç»ˆå¾—åˆ°åºåˆ—ï¼š1 2 3 4 5 6 7 8 9 10</span><br><span class="line">åˆ©ç”¨MapReduceçš„æ€æƒ³å·¦å³ä¸¤è¾¹çš„æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œã€‚</span><br><span class="line"></span><br><span class="line">æ—¶é—´å¤æ‚åº¦ï¼šO(nlogn)</span><br><span class="line">ç©ºé—´å¤æ‚åº¦ï¼šO(n) (in-placeï¼Œä¸éœ€è¦é¢å¤–ç©ºé—´ï¼Œé€’å½’è°ƒç”¨æœ€åéœ€è¦O(n))</span><br><span class="line">ç¨³å®šæ€§ï¼šå·¦å³è·³æ­¥äº¤æ¢å¯¼è‡´ä¸ç¨³å®š</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å †æ’åºï¼š</span><br><span class="line">å †ï¼šæ­¤å¤„åªè®¨è®ºäºŒå‰å †ï¼Œå®ä¸ºä¸€é¢—å®Œå…¨äºŒå‰æ ‘ï¼Œå…·æœ‰ä»¥ä¸‹æ€§è´¨ã€‚</span><br><span class="line"></span><br><span class="line">ä»»æ„èŠ‚ç‚¹å°äºï¼ˆæˆ–å¤§äºï¼‰å®ƒçš„æ‰€æœ‰åè£”ï¼Œæœ€å°å…ƒï¼ˆæˆ–æœ€å¤§å…ƒï¼‰åœ¨å †çš„æ ¹ä¸Šï¼ˆå †åºæ€§ï¼‰ã€‚</span><br><span class="line">å †æ€»æ˜¯ä¸€æ£µå®Œå…¨æ ‘ã€‚å³é™¤äº†æœ€åº•å±‚ï¼Œå…¶ä»–å±‚çš„èŠ‚ç‚¹éƒ½è¢«å…ƒç´ å¡«æ»¡ï¼Œä¸”æœ€åº•å±‚å°½å¯èƒ½åœ°ä»å·¦åˆ°å³å¡«å…¥ã€‚</span><br><span class="line">å°†æ ¹èŠ‚ç‚¹æœ€å¤§çš„å †å«åšæœ€å¤§å †æˆ–å¤§æ ¹å †ï¼Œæ ¹èŠ‚ç‚¹æœ€å°çš„å †å«åšæœ€å°å †æˆ–å°æ ¹å †ã€‚</span><br><span class="line">äºŒå‰å †å¯ä»¥ç”¨æ•°ç»„å®ç°ï¼šä»»æ„èŠ‚ç‚¹ä¸‹æ ‡iï¼Œåˆ™å·¦èŠ‚ç‚¹ä¸‹æ ‡ä¸º2i+1ï¼Œå³èŠ‚ç‚¹ä¸‹æ ‡ä¸º2i+2ï¼Œçˆ¶èŠ‚ç‚¹ä¸‹æ ‡ä¸ºfloor((i-1)/2)</span><br><span class="line"></span><br><span class="line">å †æ’åºï¼š</span><br><span class="line">1. å…ˆå°†æ— åºæ•°ç»„ç»„ç»‡æˆäºŒå‰å †</span><br><span class="line">2. å…ˆå°‡å †é¡¶å…ƒç´ å’Œå·²æ’å¥½å…ƒç´ å‰ä¸€ä½åšäº¤æ¢</span><br><span class="line">3. å°†äº¤æ¢å‰©ä¸‹çš„å…ƒç´ ç»§ç»­è°ƒæ•´æˆäºŒå‰å †</span><br><span class="line">4. é‡å¤2ï½3æ­¥éª¤ï¼Œç›´åˆ°äº¤æ¢å®Œæ¯•ï¼ˆå…±äº¤æ¢len-2æ¬¡ï¼‰</span><br><span class="line">æ—¶é—´å¤æ‚åº¦ï¼šO(nlogn)</span><br><span class="line">ç©ºé—´å¤æ‚åº¦ï¼šO(1) </span><br><span class="line">ç¨³å®šæ€§ï¼šä¸ç¨³å®š</span><br></pre></td></tr></table></figure>
<h4 id="æ­£æ’ç´¢å¼•">æ­£æ’ç´¢å¼•</h4>
<p>æ ¹æ®æ–‡æ¡£IDæ‰¾åˆ°å¯¹åº”çš„æ–‡æ¡£</p>
<h4 id="å€’æ’ç´¢å¼•">å€’æ’ç´¢å¼•</h4>
<p>æ ¹æ®æ–‡æ¡£å†…å®¹çš„åˆ†è¯æ‰¾åˆ°å‡ºç°è¯¥åˆ†è¯çš„æ–‡æ¡£åˆ—è¡¨</p>
<p><img src="https://pic3.zhimg.com/80/v2-e4599b618e270df9b64a75eb77bfb326_1440w.jpg" alt="img"></p>
<p>å›¾ç‰‡æ¥æºåœ°å€:<a href="https://zhuanlan.zhihu.com/p/33671444" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/33671444</a></p>
<ol>
<li>trieæ ‘ï¼ˆå­—å…¸æ ‘ï¼‰ï¼šæ‰¾åˆ°åˆ†è¯å¯¹åº”äº2ä¸­çš„ç´¢å¼•offset</li>
<li>hashmapï¼ˆå†…å­˜ï¼‰æˆ–è€…b-treeï¼ˆç£ç›˜ï¼‰ï¼šæ ¹æ®åˆ†è¯çš„ç´¢å¼•offsetå¿«é€Ÿå®šä½æ‰¾åˆ°æ–‡æ¡£list</li>
<li>æ–‡æ¡£listå¯ä»¥ç”¨skiplistï¼Œæ–¹ä¾¿è¿›è¡Œå¹¶é›†ã€äº¤é›†ç­‰è¿ç®—</li>
<li>æ–‡æ¡£listå…¶å®æ˜¯æ–‡æ¡£IDçš„listï¼Œå¦å¤–å¯ä»¥åŠ å…¥åˆ†è¯çš„å‡ºç°é¢‘ç‡ã€å‡ºç°ä½ç½®ç­‰ä¿¡æ¯ï¼Œç”¨äºå¯¹æœç´¢ç»“æœè¿›è¡Œä¸€ä¸ªæ‰“åˆ†æ’åº</li>
</ol>
<h3 id="é›†ç¾¤ä¸åˆ†å¸ƒå¼">é›†ç¾¤ä¸åˆ†å¸ƒå¼</h3>
<p>é›†ç¾¤ï¼šå¤šå°æœåŠ¡å™¨è¿è¡ŒåŒä¸€ä¸ªæœåŠ¡ï¼Œå¤„ç†åŒä¸€ä»¶äº‹</p>
<p>åˆ†å¸ƒå¼ï¼šå¤šå°æœåŠ¡å™¨å„è‡ªè¿è¡Œä¸åŒçš„æœåŠ¡ï¼Œä¸åŒçš„æœåŠ¡ä¹‹é—´æœ‰ç›¸äº’è°ƒç”¨</p>
<h4 id="åˆ†å¸ƒå¼æŠ€æœ¯">åˆ†å¸ƒå¼æŠ€æœ¯</h4>
<p><strong>åˆæœŸ</strong></p>
<p>å•ä½“åº”ç”¨ï¼šï¼ˆnginx + server + redis + mysqlï¼‰ä¸€å°æœºå™¨</p>
<p><strong>æ•°æ®è¶Šæ¥è¶Šå¤§</strong></p>
<p>å•ä½“åº”ç”¨+åº”ç”¨æ•°æ®åˆ†ç¦»+mysqlä¸»ä»é«˜å¯ç”¨éƒ¨ç½²+redisé›†ç¾¤é«˜å¯ç”¨éƒ¨ç½²ï¼š ï¼ˆnginxï¼‰ + ï¼ˆserverï¼‰+ ï¼ˆredisï¼‰+ ï¼ˆmysqlï¼‰</p>
<p><strong>QPSè¶Šæ¥è¶Šé«˜</strong></p>
<p>é›†ç¾¤åº”ç”¨ï¼š ï¼ˆnginxï¼‰+ è´Ÿè½½å‡è¡¡  + ï¼ˆserversï¼‰+ ï¼ˆredisï¼‰+ ï¼ˆmysqlï¼‰</p>
<p><strong>åº”ç”¨è¶Šæ¥è¶Šå¤æ‚</strong></p>
<p>åº”ç”¨æ‹†åˆ†ï¼šï¼ˆnginxï¼‰+ è´Ÿè½½å‡è¡¡  + ï¼ˆserver1sï¼‰+ ï¼ˆserver2sï¼‰+ ï¼ˆserverâ€¦sï¼‰+ ï¼ˆredisï¼‰+ ï¼ˆmysqlï¼‰</p>
<p>åº”ç”¨æ‹†åˆ†åå°±éœ€è¦ï¼š</p>
<p>è·¨æœåŠ¡è°ƒç”¨ï¼šRPCã€æœåŠ¡ç»Ÿä¸€æ³¨å†Œå’Œå‘ç°ã€è´Ÿè½½å‡è¡¡ã€</p>
<p>æœåŠ¡ç»Ÿä¸€å…¥å£ï¼šç½‘å…³å’Œè·¯ç”±</p>
<p>æœåŠ¡å®¹é”™ï¼šç†”æ–­ã€é™æµã€é™çº§</p>
<p>æœåŠ¡é—´çš„è§£è€¦å’Œå¼‚æ­¥ï¼šæ¶ˆæ¯é˜Ÿåˆ—</p>
<p>åº”ç”¨æ‹†åˆ†åæœåŠ¡è®¾è®¡åŸåˆ™ï¼šæ— çŠ¶æ€ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€åˆ†å¸ƒå¼é”</p>
<p>dubbo = RPC + æœåŠ¡ç»Ÿä¸€æ³¨å†Œå’Œå‘ç° + è½¯è´Ÿè½½å‡è¡¡ + ç›‘æ§</p>
<h4 id="åˆ†å¸ƒå¼ä¸€è‡´æ€§">åˆ†å¸ƒå¼ä¸€è‡´æ€§</h4>
<p>åˆ†å¸ƒå¼ä¸€è‡´æ€§é€šè¿‡å…±è¯†ç®—æ³•æ¥è¾¾æˆ</p>
<p>å…±è¯†ç®—æ³•æœ‰ä¸ªæ‹œå åº­é—®é¢˜</p>
<p>å…±è¯†ç®—æ³•åˆ†ä¸¤ç±»ï¼š</p>
<ul>
<li>
<p><strong>éæ‹œå åº­å®¹é”™ç±»ç®—æ³•</strong>:  Paxosã€Raftï¼ˆ<a href="http://thesecretlivesofdata.com/raft/%EF%BC%89" target="_blank" rel="noopener">http://thesecretlivesofdata.com/raft/ï¼‰</a></p>
</li>
<li>
<p><strong>æ‹œå åº­å®¹é”™ç±»ç®—æ³•</strong>: å®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•PBFTï¼ˆPractical Byzantine Fault Toleranceï¼‰ã€ä»£ç†æ‹œå åº­å®¹é”™ç®—æ³•DBFT(Delegated Byzantine Fault Tolerant)ã€å·¥ä½œé‡è¯æ˜PoWï¼ˆProof of Workï¼‰ã€è‚¡æƒè¯æ˜PoSï¼ˆProof of Stakeï¼‰ã€ä»£ç†è‚¡æƒè¯æ˜DPoSï¼ˆDelegated Proof of Stakeï¼‰</p>
</li>
</ul>
<p>åŒºå—é“¾ã€ç”µå­ç­¾åã€å·¥ä½œé‡è¯æ˜ï¼ˆæ‹œå åº­å®¹é”™ï¼‰ã€å¯†ç å“ˆå¸Œå‡½æ•°ï¼›åˆ†å¸ƒå¼ä¸€è‡´æ€§ã€å»ä¸­å¿ƒåŒ–ã€‘ï¼šsha256ã€Merkle å“ˆå¸Œæ ‘ã€éå¯¹ç§°åŠ å¯†ã€ç­¾åéªŒç­¾</p>
<h4 id="äº‘ä¸Šå®¹ç¾æ¶æ„">äº‘ä¸Šå®¹ç¾æ¶æ„</h4>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E4%BA%91%E4%B8%8A%E5%AE%B9%E7%81%BE%E6%9E%B6%E6%9E%84-%E9%80%9A%E7%94%A8.jpg" alt=""></p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E4%BA%91%E4%B8%8A%E5%AE%B9%E7%81%BE%E6%9E%B6%E6%9E%84-%E5%BC%82%E5%9C%B0%E5%AE%B9%E7%81%BE.jpg" alt=""></p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E4%BA%91%E4%B8%8A%E5%AE%B9%E7%81%BE%E6%9E%B6%E6%9E%84-%E5%90%8C%E5%9F%8E%E5%AE%B9%E7%81%BE.jpg" alt=""></p>
<p><img src="https://qiaojiande-1259482780.cos.ap-chengdu.myqcloud.com/201908/%E4%BA%91%E4%B8%8A%E5%AE%B9%E7%81%BE%E6%9E%B6%E6%9E%84-%E5%90%8C%E5%9F%8E&amp;%E5%BC%82%E5%9C%B0.jpg" alt=""></p>
<h3 id="linkedhashmapå®ç°lruç®—æ³•">LinkedHashMapå®ç°LRUç®—æ³•</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç»§æ‰¿LinkedHashMap</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_CACHE_SIZE;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> cacheSize)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// ä½¿ç”¨æ„é€ æ–¹æ³• public LinkedHashMap(int initialCapacity, float loadFactor, boolean accessOrder)</span></span><br><span class="line">		<span class="comment">// initialCapacityã€loadFactoréƒ½ä¸é‡è¦</span></span><br><span class="line">		<span class="comment">// accessOrderè¦è®¾ç½®ä¸ºtrueï¼ŒæŒ‰è®¿é—®æ’åº</span></span><br><span class="line">		<span class="keyword">super</span>((<span class="keyword">int</span>) Math.ceil(cacheSize / <span class="number">0.75</span>) + <span class="number">1</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);</span><br><span class="line">		MAX_CACHE_SIZE = cacheSize;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry eldest)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// è¶…è¿‡é˜ˆå€¼æ—¶è¿”å›trueï¼Œè¿›è¡ŒLRUæ·˜æ±°</span></span><br><span class="line">		<span class="keyword">return</span> size() &gt; MAX_CACHE_SIZE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="springboot-java-jar-æ‰§è¡ŒåŸç†">Springboot java -jar æ‰§è¡ŒåŸç†</h3>
<p>JVMå®ä¾‹åˆ›å»ºæˆåŠŸåï¼Œåˆ¤æ–­æ‰§è¡Œæ–¹å¼æ˜¯jaræ–¹å¼è¿˜æ˜¯classæ–¹å¼ï¼Œjaræ–¹å¼åˆ™ä¼šè¯»å–jaråŒ…META-INF/MANIFEST.MFæ–‡ä»¶çš„Main-Classä¸»ç±»åï¼Œç„¶ååŠ è½½å¹¶æ‰§è¡Œ</p>
<p>SpringBoot  JaråŒ… Manifestæ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Implementation-Title: webadmin-server</span><br><span class="line">Implementation-Version: 1.0.0</span><br><span class="line">Start-Class: com.App</span><br><span class="line">Spring-Boot-Classes: BOOT-INF/classes/</span><br><span class="line">Spring-Boot-Lib: BOOT-INF/lib/</span><br><span class="line">Build-Jdk-Spec: 1.8</span><br><span class="line">Spring-Boot-Version: 2.1.6.RELEASE</span><br><span class="line">Created-By: Maven Archiver 3.4.0</span><br><span class="line">Main-Class: org.springframework.boot.loader.JarLauncher</span><br></pre></td></tr></table></figure>
<p>å¯çŸ¥Springboot  jaråŒ…æ‰§è¡Œçš„å…¥å£mainå‡½æ•°åœ¨org.springframework.boot.loader.JarLauncherç±»</p>
<p>JarLuancherç±» mainå‡½æ•°è¯»å–jaråŒ…çš„Manifestæ–‡ä»¶æŒ‡å®šçš„Start-Classï¼Œç„¶åæ‰§è¡ŒçœŸæ­£çš„Start-Classç±»çš„mainå‡½æ•°</p>
<h3 id="springmvc-æ‰§è¡Œæµç¨‹">SpringMVC æ‰§è¡Œæµç¨‹</h3>
<ol>
<li>Springå®¹å™¨å¯åŠ¨æ—¶æ³¨å†ŒFilteråˆ°Springå®¹å™¨ï¼Œåˆå§‹åŒ–Filterï¼ˆè°ƒç”¨initæ–¹æ³•ï¼‰ï¼›æ³¨å†ŒInterceptoråˆ°Springå®¹å™¨</li>
<li>webå®¹å™¨ï¼ˆtomcatï¼‰æ¥æ”¶è¯·æ±‚æ—¶ï¼Œé¦–å…ˆè°ƒç”¨servletçš„initæ–¹æ³•ï¼Œæ­¤å¤„åˆ›å»ºWebApplicationContextï¼Œåˆå§‹åŒ–HandlerMappingsã€HandlerAdaptersã€ViewResolversç­‰</li>
<li>åˆ›å»ºFilterChainï¼Œå¹¶å°†FilteråŠ å…¥FilterChain</li>
<li>Filterè¿‡æ»¤é“¾å‰ç½®å¤„ç†</li>
<li>DispatcherServlet.doService</li>
<li>Interceptor.preHandleæ‹¦æˆªå™¨å‰ç½®å¤„ç†</li>
<li>Controllerä¸šåŠ¡å¤„ç†</li>
<li>Interceptor.postHandleæ‹¦æˆªå™¨åç½®å¤„ç†</li>
<li>Interceptor.afterCompletionæ‹¦æˆªå™¨å®Œæˆå¤„ç†</li>
<li>Filterè¿‡æ»¤é“¾åç½®å¤„ç†</li>
</ol>
<h3 id="ç¼“å­˜ä¸€è‡´æ€§åè®®mesi">ç¼“å­˜ä¸€è‡´æ€§åè®®MESI</h3>
<p><a href="https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm" target="_blank" rel="noopener">https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm</a></p>
<h3 id="é«˜æ€§èƒ½é˜Ÿåˆ—disruptor">é«˜æ€§èƒ½é˜Ÿåˆ—Disruptor</h3>
<p>ArrayBlockingQueueï¼Œå…¥é˜Ÿåˆ—å’Œå‡ºé˜Ÿåˆ—éƒ½è¦åŠ é”ã€‚</p>
<p>Disruptorï¼š</p>
<ol>
<li>ä½¿ç”¨ç¯å½¢æ•°ç»„<strong>RingBuffer</strong>+åˆ©ç”¨ç¼“å­˜è¡Œ64KBçš„ç‰¹æ€§ç”¨ç©ºé—´æ¢æ—¶é—´è®©ä¸å˜çš„å€¼å°½é‡ç•™åœ¨ç¼“å­˜ä¸­æä¾›æ•ˆç‡</li>
<li>æ•°ç»„é•¿åº¦ä¸º2çš„næ¬¡æ–¹ï¼Œåˆ©ç”¨ä½è¿ç®—æé«˜æ•ˆç‡</li>
<li>å‡ºé˜Ÿåˆ—å’Œå…¥é˜Ÿåˆ—é€šè¿‡CASæ“ä½œï¼Œé¿å…é”å¼€é”€</li>
</ol>
<h3 id="caffeineæœ¬åœ°ç¼“å­˜">Caffeineæœ¬åœ°ç¼“å­˜</h3>
<p>åŸç†ï¼š</p>
<ol>
<li>Window-TinyLFU</li>
</ol>
<p>LFUï¼šLeast Frequently Used ä¸€æ®µæ—¶é—´å‘¨æœŸå†…æœ€å°‘ä½¿ç”¨ï¼Œæ·˜æ±°æœ€å°‘è®¿é—®é¢‘ç‡çš„æ•°æ®ï¼ˆåŸºäºè®¿é—®é¢‘ç‡ï¼‰</p>
<p>LRUï¼šLeast Recently Used æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œæ·˜æ±°æœ€æ—§çš„æ•°æ®ï¼ˆåŸºäºè®¿é—®æ—¶é—´ï¼‰</p>
<p>Window-TinyLFUï¼šåˆ†æ®µ LRUï¼ˆä¸‰çº§LRUé˜Ÿåˆ—ï¼šEden, Probation, Protected; åº”å¯¹çªå‘æµé‡ï¼‰ + Count-Min Sketchï¼ˆç±»ä¼¼å¸ƒéš†è¿‡æ»¤å™¨ï¼Œé¢‘ç‡ç»Ÿè®¡ï¼‰</p>
<ol start="2">
<li>ä¸‰çº§LRUé˜Ÿåˆ—</li>
<li>è¯»å†™é˜Ÿåˆ—åˆ†å¼€ï¼Œä½¿ç”¨RingBufferä½œä¸ºé˜Ÿåˆ—</li>
<li>è¿‡æœŸç­–ç•¥ï¼š
<ol>
<li>expireAfterWriteï¼šå†™åå¤šä¹…è¿‡æœŸ</li>
<li>expireAfterAccessï¼šæœ€åä¸€æ¬¡è®¿é—®è¿‡åå¤šä¹…è¿‡æœŸ</li>
<li>expireAfterï¼šè‡ªç”±æŒ‡å®šè¿‡æœŸæ—¶é—´</li>
</ol>
</li>
<li>æ›´æ–°ç­–ç•¥ï¼šrefreshAfterWriteï¼šå†™åå¤šä¹…å†æ¬¡è®¿é—®æ—¶ä¼šå»åˆ·æ–°è¯¥ç¼“å­˜</li>
<li>ä»¥ä¸ŠåŸºäºæ—¶é—´çš„ç­–ç•¥éƒ½æ˜¯åŸºäº<strong>æ—¶é—´è½®</strong>å®ç°çš„å»¶æ—¶ä»»åŠ¡</li>
<li>å®æ—¶ç›‘æ§ï¼šrecordStatsï¼Œå‚è€ƒ <a href="https://github.com/ben-manes/caffeine/tree/master/examples/stats-metrics/" target="_blank" rel="noopener">https://github.com/ben-manes/caffeine/tree/master/examples/stats-metrics/</a></li>
<li>æ·˜æ±°ç›‘å¬ï¼šremovalListener</li>
</ol>
<h3 id="javaç±»åŠ è½½ä¸å¸è½½">javaç±»åŠ è½½ä¸å¸è½½</h3>
<ol>
<li>
<p>ç±»åŠ è½½å™¨ï¼šBootstrap ClassLoaderã€ExtClassLoaderã€AppClassLoaderã€è‡ªå®šä¹‰ClassLoader</p>
</li>
<li>
<p>ç±»åŠ è½½é»˜è®¤æ¨¡å‹ï¼šåŒäº²å§”æ‰˜æ¨¡å‹</p>
</li>
<li>
<p>ç³»ç»Ÿç±»åŠ è½½ç”¨æˆ·ç±»ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆSPIæœºåˆ¶å°±ä¼šä½¿ç”¨åˆ°ï¼‰</p>
</li>
<li>
<p>Tomcatç±»åŠ è½½æ¨¡å‹ï¼šCommon ClassLoaderï¼ˆåŠ è½½å„ä¸ªwebappå’Œtomcatå…±åŒä½¿ç”¨çš„classï¼‰ã€Shared ClassLoaderï¼ˆåŠ è½½å„ä¸ªwebappå…±åŒä½¿ç”¨çš„classï¼‰ã€WebApp ClassLoaderï¼ˆåŠ è½½æ¯ä¸ªwebappè‡ªå·±çš„classï¼‰ã€JasperClassLoaderï¼ˆæ¯ä¸ªjspæ–‡ä»¶å¯¹åº”ä¸€ä¸ªJasperClassLoaderï¼‰ã€‚ JSPçƒ­æ›´æ–°å°±æ˜¯é€šè¿‡å¸è½½æ—§çš„JSPæ–‡ä»¶çš„JasperClassLoaderï¼Œåˆ›å»ºæ–°çš„JasperCLassLoaderæ¥åŠ è½½æ›´æ–°åçš„JSPæ–‡ä»¶çš„ã€‚</p>
</li>
<li>
<p>ç±»å¸è½½(GCå›æ”¶ç±»çš„Classå¯¹è±¡)ï¼šå¿…é¡»æ»¡è¶³æ¡ä»¶ï¼š</p>
<ol>
<li>ä¸å­˜åœ¨å¼•ç”¨è¯¥Classå¯¹è±¡çš„å®ä¾‹å¯¹è±¡</li>
<li>è¯¥Classå¯¹è±¡æ²¡åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨</li>
<li>åŠ è½½è¯¥Classå¯¹è±¡çš„ClassLoaderå·²ç»è¢«å›æ”¶</li>
</ol>
<p>ç”±æ­¤å¯è§ç±»å¸è½½æ¡ä»¶æ˜¯å¾ˆè‹›åˆ»çš„ï¼Œå°¤å…¶æ˜¯æ¡ä»¶3ï¼Œå¾ˆå¤šç±»éƒ½æ˜¯AppClassLoaderåŠ è½½çš„ï¼Œè€ŒAppClassLoaderåœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…éƒ½æ˜¯ä¸€ç›´å­˜åœ¨çš„ã€‚åªæœ‰ä¸€äº›ç”±è‡ªå®šä¹‰çš„ClassLoaderåŠ è½½çš„ç±»æ‰æœ‰å¯èƒ½ä¼šè¢«å¸è½½ã€‚è€Œä¸”GCæ—¶é—´ä¸å¯æ§ï¼Œå³ä½¿ä¸‰ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œç±»Classå¯¹è±¡ä¹Ÿä¸ä¸€å®šèƒ½è¢«åŠæ—¶å¸è½½ã€‚</p>
</li>
</ol>
<h3 id="é¢è¯•">é¢è¯•</h3>
<hr>
<ol>
<li>
<p>ç®€å•è‡ªæˆ‘ä»‹ç»</p>
</li>
<li>
<p>é¡¹ç›®ç»éªŒ-ç”¨ä¸¤ä¸‰å¥è¯è¯´æ¸…æ¥šé¡¹ç›®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ¯”å¦‚å…‰é€ŸAPPï¼š</span><br><span class="line">å®¢æˆ·ç«¯ï¼štun2sockï¼ˆå°†appçš„æµé‡å…¨è½¬åˆ°ä»£ç†è½¯ä»¶ä¸Šæ¥ï¼‰</span><br><span class="line">æœåŠ¡ç«¯ï¼šæä¾›çš„æ–¹å¼ï¼šSSï¼ˆåè®®åŠ å¯†æ–¹å¼ï¼‰ã€V2RAY</span><br><span class="line">çº¿è·¯ï¼šè‡ªåŠ¨éƒ¨ç½²ã€è®°æ—¶ã€æµé‡ç»Ÿè®¡ã€é™é€Ÿ</span><br></pre></td></tr></table></figure>
<p>tunæ˜¯æ“ä½œç³»ç»Ÿæ”¯æŒçš„è™šæ‹Ÿç½‘å¡ï¼Œå‚è€ƒ <a href="https://www.cnblogs.com/bakari/p/10450711.html" target="_blank" rel="noopener">https://www.cnblogs.com/bakari/p/10450711.html</a> å’Œ <a href="http://arloor.com/posts/other/android-vpnservice-and-vpn-dev/" target="_blank" rel="noopener">http://arloor.com/posts/other/android-vpnservice-and-vpn-dev/</a></p>
<p>tun2sockè¦åšçš„äº‹å¯ä»¥åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>é€šè¿‡tunç½‘å¡æ‹¿åˆ°æ‰‹æœºçš„æ‰€æœ‰IPæ•°æ®åŒ…</li>
<li>å°†æ•°æ®åŒ…ç”¨sockåè®®å°è£…</li>
<li>å°†å°è£…åçš„æ•°æ®åŒ…å‘é€ç»™ä»£ç†æœåŠ¡å™¨ï¼Œå®Œæˆæ•°æ®çš„è½¬å‘</li>
</ol>
<p>v2ray dnsæ¨¡å—å‚è€ƒ <a href="https://medium.com/@TachyonDevel/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0" target="_blank" rel="noopener">https://medium.com/@TachyonDevel/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0</a></p>
</li>
</ol>
<ol start="3">
<li>
<p>SpringBootä¼˜ç‚¹ã€è‡ªåŠ¨é…ç½®åŸç†ã€å¯åŠ¨æµç¨‹ï¼ˆå¹²äº†ä»€ä¹ˆäº‹ï¼Œç”¨åˆ°äº†ä»€ä¹ˆè®¾è®¡æ¨¡å¼ï¼‰</p>
</li>
<li>
<p>javaé›†åˆã€å¹¶å‘ã€å¤šçº¿ç¨‹ã€JVM</p>
</li>
<li>
<p>netty</p>
</li>
<li>
<p>dubbo vs spring cloudï¼šå„è‡ªç‰¹ç‚¹ï¼ŒåŒºåˆ«ï¼ŒRPCåŸç†ï¼ˆé€šä¿¡æ–¹å¼httpã€tcpï¼Œæ•°æ®åè®®hessionã€jsonã€pbâ€¦ï¼‰</p>
</li>
<li>
<p>æ¶ˆæ¯é˜Ÿåˆ—MQ</p>
</li>
<li>
<p>åˆ†å¸ƒå¼ï¼šä¸€è‡´æ€§åè®®ï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼šä¸¤é˜¶æ®µæäº¤ã€TCCã€paxoã€raftï¼›ä¸€è‡´æ€§HASH</p>
</li>
<li>
<p>mysqlï¼šäº‹åŠ¡çº§åˆ«ã€å»ºè¡¨åŸåˆ™ã€ä¼˜åŒ–æ–¹å¼ã€åˆ†åº“åˆ†è¡¨ã€HAæ–¹æ¡ˆï¼ˆä¸»ä»å¤‡ä»½ï¼Œè¯»å†™åˆ†ç¦»ï¼Œé›†ç¾¤éƒ¨ç½²ï¼‰</p>
</li>
<li>
<p>redisï¼šæ•°æ®ç±»å‹å’Œå„è‡ªåº”ç”¨åœºæ™¯ï¼Œrediså®ç°åˆ†å¸ƒå¼é”ï¼Œrediså†…å­˜50%ï¼Œredis å“¨å…µ å’Œ clusterï¼Œæ·˜æ±°ç­–ç•¥LRUå®ç°</p>
</li>
<li>
<p>æœåŠ¡è¿ç»´å’Œç›‘æ§ï¼ˆé™æµã€é™çº§ã€ç†”æ–­ï¼‰</p>
</li>
<li>
<p>è´Ÿè½½å‡è¡¡æ–¹å¼ï¼ˆåˆ†å±‚ï¼ŒDNSã€DNSæ™ºèƒ½è§£æï¼ŒDNSæ±¡æŸ“ã€DNSSecã€‘â€¦ï¼‰</p>
</li>
<li>
<p>æ¥å£åˆ†ç‰ˆæœ¬æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. åŸŸååˆ†ç‰ˆæœ¬ï¼šv1.api.com  v2.api.com</span><br><span class="line">2. URLåˆ†ç‰ˆæœ¬ï¼š/api/v1/hello  /api/v2/hello</span><br><span class="line">3. å‚æ•°åˆ†ç‰ˆæœ¬ï¼šå‚æ•°åŠ ä¸Šversionå­—æ®µ</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>æ€§èƒ½æµ‹è¯•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//å‚è€ƒ é™ˆçš“åšå®¢ï¼šæ€§èƒ½æµ‹è¯•åº”è¯¥æ€ä¹ˆåš https://coolshell.cn/articles/17381.html</span><br><span class="line">1. å“åº”æ—¶é—´è€ƒé‡ç›®æ ‡ç»¼åˆé€‰æ‹©ï¼šå¹³å‡å€¼ã€ä¸­ä½å€¼ã€TPå€¼ï¼ˆTop Percentileï¼ŒTP50ï¼ŒTP90ï¼ŒTP99ï¼‰</span><br><span class="line">2. ååé‡ï¼ˆQPSï¼‰å¿…é¡»å’Œå“åº”æ—¶é—´æŒ‚é’©ï¼šæ¯”å¦‚TP99å°äº100msæ—¶çš„QPSæ˜¯1000</span><br><span class="line">3. ååé‡ã€å“åº”æ—¶é—´è¿˜å¿…é¡»å’ŒæˆåŠŸç‡æŒ‚é’©ï¼šå…³é”®ç³»ç»ŸæˆåŠŸç‡å¿…é¡»ä¿è¯100%</span><br><span class="line"></span><br><span class="line">//å…·ä½“æ­¥éª¤</span><br><span class="line">1. å®šå¥½å‰ææ¯”å¦‚ï¼šæœºå™¨é…ç½®ï¼Œæ¨¡æ‹Ÿå¹¶å‘è¯·æ±‚æ•°ï¼ˆå¤šå°‘ä¸ªå®¢æˆ·ç«¯å¤šå°‘æ—¶é—´å†…å¤šå°‘ä¸ªè¯·æ±‚ï¼‰ï¼ŒTP99å€¼å¿…é¡»åœ¨100msä»¥å†…ï¼Œå¹³å‡å“åº”æ—¶é—´åœ¨500msä»¥å†…ï¼Œ100%è¯·æ±‚æˆåŠŸ</span><br><span class="line">2. åœ¨1çš„é™åˆ¶ä¸‹æµ‹è¯•ç³»ç»Ÿæ‰¾åˆ°æœ€é«˜QPS</span><br><span class="line">3. ç”¨2çš„æœ€é«˜QPSè¿ç»­å‹æµ‹ç³»ç»Ÿä¸€æ®µæ—¶é—´ï¼Œæ”¶é›†ç³»ç»Ÿçš„æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€IOç­‰ï¼‰ï¼Œåˆ¤æ–­ç³»ç»Ÿçš„ç¨³å®šæ€§</span><br></pre></td></tr></table></figure>
<ul>
<li>æ€§èƒ½æµ‹è¯•å¯ä»¥åœ¨æœ¬æœºåšï¼Œå¾—åˆ°ä¸€ä¸ªåŸºå‡†å€¼ï¼Œå†å’Œç”Ÿäº§ç¯å¢ƒæœºå™¨æµ‹è¯•ä¸€æ¬¡æ•°æ®ä½œå¯¹æ¯”ï¼Œå¤§æ¦‚å¾—åˆ°ä¸€ä¸ªæ€§èƒ½æ¯”å€¼ï¼Œä¸‹æ¬¡æ€§èƒ½ä¼˜åŒ–ç›®æ ‡å°±å¯ä»¥å®šé‡åˆ°æœ¬æœºæµ‹è¯•</li>
<li>ä½¿ç”¨Profileå·¥å…·å®šä½åˆ°æ¯ä¸ªæ–¹æ³•çš„å¤„ç†æ—¶é•¿ï¼Œå¯¹æ–¹æ³•è¿›è¡Œä¼˜åŒ–</li>
<li>å•æœºä¼˜åŒ–æ–¹å¼ï¼šåŠ æœ¬åœ°ç¼“å­˜ã€æœ¬åœ°å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± é…ç½®ã€Redis Clientçº¿ç¨‹æ± é…ç½®ï¼ˆåŒºåˆ†æ˜¯Netty NIOè¿˜æ˜¯BIOï¼ŒNetty NIOåªéœ€è¦å°‘é‡çº¿ç¨‹æ± æ•°é‡ï¼Œè€ŒBIOåªèƒ½å †çº¿ç¨‹æ± æ•°é‡äº†ï¼‰ï¼ŒJDBC Clientçº¿ç¨‹æ± ï¼ˆåŒºåˆ†æ˜¯NIOè¿˜æ˜¯BIOï¼‰é…ç½®</li>
<li>çº¿ç¨‹æ± çš„é…ç½®å‚æ•°: æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€é˜Ÿåˆ—é•¿åº¦çš„è®¾ç½®è¦ç»¼åˆè€ƒè™‘CPUã€å†…å­˜ã€JDBCçº¿ç¨‹æ± ã€REDISçº¿ç¨‹æ± çš„é…ç½®</li>
<li>å†æå‡æ€§èƒ½ï¼Œå°±è¦ä¸Šåˆ†å¸ƒå¼+é›†ç¾¤äº†</li>
</ul>
</li>
<li>
<p>å‹åŠ›æµ‹è¯•</p>
</li>
<li>
<p>æµè§ˆå™¨è®¿é—®www.google.comæ•´ä¸ªæµç¨‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. DNSè§£æã€hostsæ–‡ä»¶ã€DNS Serverã€DNSç¼“å­˜ã€DNSè®°å½•ï¼ˆAã€CNAMEï¼‰DNSè´Ÿè½½å‡è¡¡</span><br><span class="line">2. http vs httpsï¼ˆè¯ä¹¦ï¼Œå•å‘è®¤è¯ã€æµè§ˆå™¨è®¿é—®ç½‘å€éƒ½æ˜¯å•å‘è®¤è¯ã€‘ï¼ŒåŒå‘è®¤è¯ï¼‰</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>è‡ªå·±å®Œæˆçš„æœ€æœ‰æŒ‘æˆ˜æ€§ã€æœ€éš¾å¿˜ã€æœ€æˆåŠŸçš„äº‹</p>
</li>
</ol>
<h3 id="linux-cmd">Linux CMD</h3>
<p>pcstatï¼ˆpage cacheç»Ÿè®¡ï¼‰</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">go get golang.org/x/sys/unix</span><br><span class="line">go get github.com/tobert/pcstat/pcstat</span><br></pre></td></tr></table></figure>
<p>strace</p>
<p>nc</p>
<p>lsof</p>
<p>netstat</p>
<p>tcpdump</p>
<p>pidof</p>
<p>pidstat</p>
<p>sysctl -a ï½œ grep xxoo</p>
<p>ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦é™åˆ¶æŸ¥çœ‹ä¿®æ”¹ï¼š</p>
<p>æŸ¥çœ‹ç³»ç»Ÿé…ç½®é¡¹æ„ä¹‰ï¼šman 5 proc</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 1. ç³»ç»Ÿçº§</span><br><span class="line">ç³»ç»Ÿå†…æ‰€æœ‰è¿›ç¨‹å¯æ‰“å¼€çš„fdæ€»é™åˆ¶ï¼ˆä¸€èˆ¬è®¾ç½®ä¸ºå†…å­˜Kbå¤§å°çš„10%ï¼‰ï¼š/proc/sys/fs/file-max ï¼ˆecho 123456 &gt; /proc/sys/fs/file-maxï¼‰</span><br><span class="line">sysctl fs.file-max</span><br><span class="line">//ç³»ç»Ÿå½“å‰å·²ä½¿ç”¨fdï¼š</span><br><span class="line">sysctl fs.file-nr</span><br><span class="line">cat /proc/sys/fs/file-nr</span><br><span class="line">// 2. è¿›ç¨‹çº§</span><br><span class="line">ulimit -SHn</span><br><span class="line">vim /etc/security/limits.conf</span><br><span class="line">//å•ä¸ªè¿›ç¨‹å¯åˆ†é…çš„æœ€å¤§fdæ•°ç›®</span><br><span class="line">sysctl fs.nr_open</span><br><span class="line">cat /proc/sys/fs/nr_open</span><br><span class="line">// 3. åº”ç”¨çº§</span><br></pre></td></tr></table></figure>
<h3 id="docker-updateå®¹å™¨">docker updateå®¹å™¨</h3>
<p>docker update --restart=no container-name</p>
<p>docker update --restart=always container-name</p>
<h3 id="macæœ¬æœºå‹æµ‹">Macæœ¬æœºå‹æµ‹</h3>
<ol>
<li>
<p>launchctl limit æŸ¥çœ‹æ‰“å¼€æ–‡ä»¶è¿›ç¨‹é™åˆ¶</p>
</li>
<li>
<p>ä¿®æ”¹æ‰“å¼€æ–‡ä»¶è¿›ç¨‹é™åˆ¶ï¼Œè§£å†³too many open files</p>
<p>sudo vim /Library/LaunchDaemons/limit.maxfiles.plist</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>limit.maxfiles<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>launchctl<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>limit<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>maxfiles<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>65536<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">string</span>&gt;</span>65536<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>RunAtLoad<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>ServiceIPC<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">false</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>sudo vim /Library/LaunchDaemons/limit.maxproc.plist</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple/DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">  &lt;plist version=&quot;1.0&quot;&gt;</span><br><span class="line">    &lt;dict&gt;</span><br><span class="line">      &lt;key&gt;Label&lt;/key&gt;</span><br><span class="line">        &lt;string&gt;limit.maxproc&lt;/string&gt;</span><br><span class="line">      &lt;key&gt;ProgramArguments&lt;/key&gt;</span><br><span class="line">        &lt;array&gt;</span><br><span class="line">          &lt;string&gt;launchctl&lt;/string&gt;</span><br><span class="line">          &lt;string&gt;limit&lt;/string&gt;</span><br><span class="line">          &lt;string&gt;maxproc&lt;/string&gt;</span><br><span class="line">          &lt;string&gt;4096&lt;/string&gt;</span><br><span class="line">          &lt;string&gt;4096&lt;/string&gt;</span><br><span class="line">        &lt;/array&gt;</span><br><span class="line">      &lt;key&gt;RunAtLoad&lt;/key&gt;</span><br><span class="line">        &lt;true /&gt;</span><br><span class="line">      &lt;key&gt;ServiceIPC&lt;/key&gt;</span><br><span class="line">        &lt;false /&gt;</span><br><span class="line">    &lt;/dict&gt;</span><br><span class="line">  &lt;/plist&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ç©ºæ¥å£å‹æµ‹åˆ°æœ€é«˜8500QPSçš„å‚æ•°</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[qiaojian@MacÂ DocumentsÂ ]% wrk -t5 -c500 -d30s http://127.0.0.1:9091/hello/test1\?name\=qiaojian</span><br><span class="line">Running 30s test @ http://127.0.0.1:9091/hello/test1?name=qiaojian</span><br><span class="line">  5 threads and 500 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency    59.07ms   35.59ms   1.41s    91.11%</span><br><span class="line">    Req/Sec     1.70k   266.61     2.74k    75.99%</span><br><span class="line">  254568 requests in 30.09s, 31.60MB read</span><br><span class="line">  Socket errors: connect 0, read 246, write 41, timeout 0</span><br><span class="line">Requests/sec:   8459.55</span><br><span class="line">Transfer/sec:      1.05MB</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>ä½¿ç”¨ä¸Šä¸€æ­¥çš„å‚æ•°ä½œä¸ºæœ¬æœºå‹æµ‹çš„åŸºå‡†å‚æ•°å’ŒåŸºå‡†å€¼ï¼Œå»å‹æµ‹å…¶ä»–æ¥å£</li>
</ol>
<h3 id="object-waitnotify">Object Wait/Notify</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. é¦–å…ˆæ¯ä¸ªjavaå¯¹è±¡éƒ½å¯ä»¥å½“ä½œé”ä½¿ç”¨ï¼Œsynchronizedå³æ˜¯åŸºäºjavaå¯¹è±¡å†…ç½®é”monitorçš„</span><br><span class="line">2. Waitè¯­ä¹‰</span><br><span class="line">	 2.1 é¦–å…ˆè°ƒç”¨object.wait()çš„çº¿ç¨‹éœ€è¦è·å–objectå¯¹è±¡çš„monitoré”</span><br><span class="line">	 2.2 object.wait()è°ƒç”¨ä¼šé‡Šæ”¾objectå¯¹è±¡çš„monitoré”ï¼Œå¹¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹è°ƒç”¨notify()çš„å”¤é†’ï¼Œç„¶åé‡æ–°ç«äº‰è·å–objectçš„monitoré”ï¼Œå¦‚æœé‡æ–°è·å–åˆ°é”ï¼Œåˆ™æ¢å¤ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ç»§ç»­å¤„äºé˜»å¡çŠ¶æ€ç­‰å¾…ä¸‹æ¬¡è¢«å”¤é†’</span><br><span class="line">3. Notifyè¯­ä¹‰</span><br><span class="line">	3.1 é¦–å…ˆè°ƒç”¨object.notify()çš„çº¿ç¨‹éœ€è¦è·å–objectå¯¹è±¡çš„monitoré”</span><br><span class="line">	3.2 object.notify()è°ƒç”¨åå¹¶æ‰§è¡Œå®Œsynchronizedä»£ç å—ä¼šé‡Šæ”¾objectå¯¹è±¡çš„monitoré”ï¼Œç„¶åå…¶ä»–é˜»å¡ç­‰å¾…è·å–objectçš„monitoré”çš„çº¿ç¨‹ç«äº‰è·å–é”ï¼Œå…¶ä»–çº¿ç¨‹é‡æ–°ç«äº‰è·å–objectçš„monitoré”ï¼Œå…¶ä¸­åªæœ‰1ä¸ªçº¿ç¨‹æˆåŠŸé‡æ–°è·å–åˆ°é”ï¼Œç„¶åæ¢å¤ç»§ç»­æ‰§è¡Œ</span><br></pre></td></tr></table></figure>
<h3 id="maybatisä¸€çº§ç¼“å­˜ä¸äºŒçº§ç¼“å­˜">Maybatisä¸€çº§ç¼“å­˜ä¸äºŒçº§ç¼“å­˜</h3>
<h4 id="ä¸€çº§ç¼“å­˜">ä¸€çº§ç¼“å­˜</h4>
<ol>
<li>
<p>MyBatisä¸€çº§ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸå’ŒSqlSessionä¸€è‡´ï¼Œé»˜è®¤å¼€å¯ã€‚</p>
</li>
<li>
<p>MyBatisä¸€çº§ç¼“å­˜å†…éƒ¨è®¾è®¡ç®€å•ï¼Œåªæ˜¯ä¸€ä¸ªæ²¡æœ‰å®¹é‡é™å®šçš„HashMapï¼Œåœ¨ç¼“å­˜çš„åŠŸèƒ½æ€§ä¸Šæœ‰æ‰€æ¬ ç¼ºã€‚</p>
</li>
<li>
<p>MyBatisçš„ä¸€çº§ç¼“å­˜æœ€å¤§èŒƒå›´æ˜¯SqlSessionå†…éƒ¨ï¼Œæœ‰å¤šä¸ªSqlSessionæˆ–è€…åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸‹ï¼Œæ•°æ®åº“å†™æ“ä½œä¼šå¼•èµ·è„æ•°æ®ï¼Œå»ºè®®è®¾å®šç¼“å­˜çº§åˆ«ä¸ºStatementã€‚</p>
<ul>
<li>
<p>å…¨å±€å…³é—­ï¼šè®¾ç½® <code>mybatis.configuration.local-cache-scope=statement</code></p>
</li>
<li>
<p>æŒ‡å®š mapper å…³é—­ï¼šåœ¨ <code>mapper.xml</code> çš„æŒ‡å®š statement ä¸Šæ ‡æ³¨ <code>flushCache=&quot;true&quot;</code></p>
</li>
<li>
<p>å¦ç±»çš„åŠæ³•ï¼šåœ¨ statement çš„ SQL ä¸Šæ·»åŠ ä¸€ä¸²éšæœºæ•°(select * from table where #{random} = #{random})</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MyBatis çš„ä¸€çº§ç¼“å­˜é»˜è®¤å¼€å¯ï¼Œå±äº SqlSession ä½œç”¨èŒƒå›´ã€‚åœ¨äº‹åŠ¡å¼€å¯çš„æœŸé—´ï¼ŒåŒæ ·çš„æ•°æ®åº“æŸ¥è¯¢è¯·æ±‚åªä¼šæŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ï¼Œä¹‹åé‡å¤æŸ¥è¯¢ä¼šä»ä¸€çº§ç¼“å­˜ä¸­è·å–ã€‚å½“ä¸å¼€å¯äº‹åŠ¡æ—¶ï¼ŒåŒæ ·çš„å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢éƒ½ä¼šå‘é€æ•°æ®åº“è¯·æ±‚ã€‚</span><br></pre></td></tr></table></figure>
<h4 id="äºŒçº§ç¼“å­˜">äºŒçº§ç¼“å­˜</h4>
<ol>
<li>MyBatisçš„äºŒçº§ç¼“å­˜ç›¸å¯¹äºä¸€çº§ç¼“å­˜æ¥è¯´ï¼Œå®ç°äº†<code>SqlSession</code>ä¹‹é—´ç¼“å­˜æ•°æ®çš„å…±äº«ï¼ŒåŒæ—¶ç²’åº¦æ›´åŠ çš„ç»†ï¼Œèƒ½å¤Ÿåˆ°<code>namespace</code>çº§åˆ«ï¼Œé€šè¿‡Cacheæ¥å£å®ç°ç±»ä¸åŒçš„ç»„åˆï¼Œå¯¹Cacheçš„å¯æ§æ€§ä¹Ÿæ›´å¼ºï¼Œé»˜è®¤æœªå¼€å¯ã€‚</li>
<li>MyBatisåœ¨å¤šè¡¨æŸ¥è¯¢æ—¶ï¼Œæå¤§å¯èƒ½ä¼šå‡ºç°è„æ•°æ®ï¼Œæœ‰è®¾è®¡ä¸Šçš„ç¼ºé™·ï¼Œå®‰å…¨ä½¿ç”¨äºŒçº§ç¼“å­˜çš„æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ã€‚</li>
<li>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç”±äºé»˜è®¤çš„MyBatis Cacheå®ç°éƒ½æ˜¯åŸºäºæœ¬åœ°çš„ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¿…ç„¶ä¼šå‡ºç°è¯»å–åˆ°è„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨é›†ä¸­å¼ç¼“å­˜å°†MyBatisçš„Cacheæ¥å£å®ç°ï¼Œæœ‰ä¸€å®šçš„å¼€å‘æˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨Redisã€Memcachedç­‰åˆ†å¸ƒå¼ç¼“å­˜å¯èƒ½æˆæœ¬æ›´ä½ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´é«˜ã€‚</li>
</ol>
<h3 id="ç¼“å­˜å’Œæ•°æ®åº“ä¸€è‡´æ€§">ç¼“å­˜å’Œæ•°æ®åº“ä¸€è‡´æ€§</h3>
<ol>
<li>
<p>ç»å…¸æ¨¡å‹ï¼šCache Aside Pattern</p>
<p>è¯»ï¼šå…ˆè¯»ç¼“å­˜ï¼Œç¼“å­˜æ²¡æœ‰ï¼Œå†è¯»æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜</p>
<p>å†™ï¼šå…ˆå†™æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</p>
<p>å­˜åœ¨é—®é¢˜ï¼šåˆ é™¤ç¼“å­˜å¤±è´¥ï¼ˆè™½ç„¶å¾ˆå°‘ç¢°åˆ°ï¼‰ï¼Œä¼šå¯¼è‡´ç¼“å­˜çš„æ—§æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ–°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ</p>
<p>è§£å†³æ–¹æ¡ˆï¼š2</p>
</li>
<li>
<p>å†™æ•°æ®æ”¹ä¸ºï¼šå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†ä¿®æ”¹æ•°æ®åº“</p>
<p>å­˜åœ¨é—®é¢˜ï¼šæ•°æ®å‘ç”Ÿäº†å˜æ›´ï¼Œå…ˆåˆ é™¤äº†ç¼“å­˜ï¼Œç„¶åè¦å»ä¿®æ”¹æ•°æ®åº“ï¼Œæ­¤æ—¶è¿˜æ²¡ä¿®æ”¹ã€‚ä¸€ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œå»è¯»ç¼“å­˜ï¼Œå‘ç°ç¼“å­˜ç©ºäº†ï¼Œå»æŸ¥è¯¢æ•°æ®åº“ï¼ŒæŸ¥åˆ°äº†ä¿®æ”¹å‰çš„æ—§æ•°æ®ï¼Œæ”¾åˆ°äº†ç¼“å­˜ä¸­ã€‚éšåæ•°æ®å˜æ›´çš„ç¨‹åºå®Œæˆäº†æ•°æ®åº“çš„ä¿®æ”¹ã€‚æ­¤æ—¶ï¼Œç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®åˆä¸ä¸€è‡´äº†ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š3</p>
</li>
<li>
<p>å°†<strong>è¯»ç¼“å­˜ä¸ºç©ºéœ€è¦è¯»æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜</strong>çš„è¯»æ“ä½œå’Œå†™æ•°æ®çš„æ“ä½œæ”¾åˆ°æœ¬åœ°é˜Ÿåˆ—æˆ–åˆ†å¸ƒå¼é˜Ÿåˆ—æ’é˜Ÿå¹¶é¡ºåºæ‰§è¡Œ</p>
<p>å­˜åœ¨é—®é¢˜ï¼šæ€§èƒ½ç“¶é¢ˆåœ¨é˜Ÿåˆ—ä¸²è¡ŒåŒ–æ‰§è¡Œ</p>
</li>
<li>
<p>å¦‚æœå…è®¸æ•°æ®æš‚æ—¶çš„ä¸ä¸€è‡´ï¼Œå¯ä»¥åœ¨1æˆ–2çš„åŸºç¡€ä¹‹ä¸Šå¢åŠ å®šæ—¶ä»»åŠ¡ï¼šä»DBåˆ·æ–°æ•°æ®åˆ°ç¼“å­˜</p>
</li>
</ol>
<h3 id="http10ä¸20ç‰¹æ€§">HTTP1.0ä¸2.0ç‰¹æ€§</h3>
<h3 id="stream-parallelstream">Stream ParallelStream</h3>
<p>Stream ParallelStreamé»˜è®¤ä½¿ç”¨ForkJoinPoolçº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°ä¸ºCPUæ ¸æ•°</p>
<h3 id="nohup">nohup</h3>
<p>javaè¿›ç¨‹æ¥æ”¶åˆ°SIGHUPï¼ˆkill -1 process-noï¼‰æ—¶ï¼Œè¿›ç¨‹ä¼šé€€å‡ºã€‚nohupå¯åŠ¨å¯ä»¥å±è”½SIGHUPä¿¡å·</p>
<h3 id="linuxæ€§èƒ½åˆ†æ">Linuxæ€§èƒ½åˆ†æ</h3>
<h4 id="cpu">CPU</h4>
<p>ä¸Šä¸‹æ–‡åˆ‡æ¢ã€topã€cpuä½¿ç”¨ç‡100%ã€ä¸å¯ä¸­æ–­è¿›ç¨‹ã€åƒµå°¸è¿›ç¨‹ã€è½¯ä¸­æ–­ã€perfå·¥å…·</p>
<h4 id="å†…å­˜">å†…å­˜</h4>
<p>å†…å­˜bufferä¸cacheã€å†…å­˜æ³„éœ²å®šä½ã€swapå˜é«˜</p>
<h4 id="io">IO</h4>
<p>ç£ç›˜IOä¼˜åŒ–ã€ç‹‚æ‰“æ—¥å¿—ã€C10Kã€C1000Kã€æ€æ ·è¯„ä¼°ç³»ç»Ÿçš„ç½‘ç»œæ€§èƒ½ã€DNSè§£ææ…¢ã€tcpdumpã€DDosæ”»å‡»ã€ç½‘ç»œè¯·æ±‚å»¶è¿Ÿå¤§è§£å†³ã€ç½‘ç»œæ€§èƒ½ä¼˜åŒ–ã€ç½‘ç»œæ”¶å‘åŒ…ç¼“å­˜åŒº</p>
<p>tcpdumpæ•™ç¨‹</p>
<p><a href="https://github.com/mylxsw/growing-up/blob/master/doc/tcpdump%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B.md" target="_blank" rel="noopener">https://github.com/mylxsw/growing-up/blob/master/doc/tcpdumpç®€æ˜æ•™ç¨‹.md</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">åœ¨æœåŠ¡ç«¯è¿›è¡ŒæŠ“åŒ…åˆ†æï¼Œä½¿ç”¨tcpdump</span><br><span class="line"></span><br><span class="line">tcpdump -tttt -s0 -X -vv tcp port 8080 -w captcha.cap</span><br><span class="line">è¿™é‡Œçš„å‚æ•°æ˜¯è¿™æ ·çš„</span><br><span class="line"></span><br><span class="line">-tttt è¾“å‡ºæœ€å¤§ç¨‹åº¦å¯è¯»çš„æ—¶é—´æˆ³</span><br><span class="line">-s0 æŒ‡å®šæ¯ä¸€ä¸ªåŒ…æ•è·çš„é•¿åº¦ï¼Œå•ä½æ˜¯byteï¼Œä½¿ç”¨-s0å¯ä»¥æ•è·æ•´ä¸ªåŒ…çš„å†…å®¹</span><br><span class="line">-X ä»¥hexå’ŒASCIIä¸¤ç§å½¢å¼æ˜¾ç¤ºåŒ…çš„å†…å®¹</span><br><span class="line">-vv æ˜¾ç¤ºæ›´åŠ å¤šçš„åŒ…ä¿¡æ¯</span><br><span class="line">tcp æŒ‡æˆ‘ä»¬åªæ•è·tcpæµé‡</span><br><span class="line">port 8080 æŒ‡æˆ‘ä»¬åªæ•è·ç«¯å£8080çš„æµé‡</span><br><span class="line">-w captcha.cap æŒ‡å®šæ•è·çš„æµé‡ç»“æœè¾“å‡ºåˆ°captcha.capæ–‡ä»¶ï¼Œä¾¿äºåˆ†æä½¿ç”¨</span><br></pre></td></tr></table></figure>
<h4 id="ç»¼åˆ">ç»¼åˆ</h4>
<p>ç³»ç»Ÿç›‘æ§ã€åº”ç”¨ç›‘æ§</p>
<h3 id="time_waitampclose_wait">Time_Wait&amp;Close_Wait</h3>
<p>time_waitæ˜¯æœåŠ¡å™¨å‘èµ·ä¸»åŠ¨å…³é—­è¿æ¥åï¼Œè¿æ¥è¿›å…¥ç­‰å¾…2mslçš„çŠ¶æ€ï¼Œä¹‹åæ‰å…³é—­</p>
<p>time_waitç­‰å¾…2mslåŸå› ï¼š</p>
<ol>
<li>ä¿è¯è¿æ¥è¢«æ­£å¸¸å…³é—­</li>
<li>é˜²æ­¢æ”¶åˆ°æ—§è¿æ¥çš„æ•°æ®åŒ…</li>
</ol>
<p>æœåŠ¡å™¨time_waitçŠ¶æ€è¿æ¥å¤ªå¤šï¼Œè§£å†³åŠæ³•ï¼šè°ƒæ•´æœåŠ¡å™¨é…ç½®å‚æ•°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">é€šè¿‡è°ƒæ•´å†…æ ¸å‚æ•°è§£å†³</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ç¼–è¾‘æ–‡ä»¶ï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"> </span><br><span class="line">ç„¶åæ‰§è¡Œ/sbin/sysctl -pè®©å‚æ•°ç”Ÿæ•ˆã€‚</span><br></pre></td></tr></table></figure>
<p>close_waitæ˜¯æœåŠ¡å™¨æ”¶åˆ°è¢«åŠ¨å…³é—­è¿æ¥åï¼Œè¿æ¥è¿›å…¥ç­‰å¾…åº”ç”¨ç¨‹åºå‘é€finåŒ…å…³é—­è¿æ¥çš„çŠ¶æ€</p>
<p>æœåŠ¡å™¨close_waitçŠ¶æ€è¿æ¥å¤ªå¤šï¼Œè§£å†³åŠæ³•ï¼šæŸ¥çœ‹åº”ç”¨ç¨‹åºä½¿ç”¨socketçš„åœ°æ–¹æ˜¯å¦æ­£ç¡®å…³é—­äº†è¿æ¥</p>
<h3 id="macè®¾ç½®æµ‹è¯•ç¯å¢ƒipè½¬å‘åˆ°æœ¬åœ°">MACè®¾ç½®æµ‹è¯•ç¯å¢ƒIPè½¬å‘åˆ°æœ¬åœ°</h3>
<p>å¼€å‘æµ‹è¯•ä¸­å¯èƒ½ä¼šä½¿ç”¨è¿œç¨‹çš„æœºå™¨åœ°å€å¦‚172.17.5.49ï¼Œç”±äºå…¬å¸å®‰å…¨é™åˆ¶æœ¬åœ°è¿ä¸ä¸Šæˆ–è€…æ­å»ºäº†æœ¬åœ°çš„ç¯å¢ƒä½¿ç”¨ï¼Œæ­¤æ—¶å¯ä»¥æ·»åŠ ç«¯å£è½¬å‘ï¼Œå°†from 127.0.0.1åˆ°172.17.5.49-6379çš„æµé‡è½¬å‘åˆ°127.0.0.1-6379ä¸Šæ¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä¸€ã€ä¿®æ”¹/etc/pf.conf</span><br><span class="line"></span><br><span class="line">åœ¨rdr-anchor &quot;com.apple/*&quot;åæ·»åŠ </span><br><span class="line"> rdr on lo0 inet proto tcp from any to 172.17.5.49 port 6379 -&gt; 127.0.0.1 port 6379</span><br><span class="line"></span><br><span class="line">äºŒã€ä½¿è½¬å‘ç”Ÿæ•ˆ</span><br><span class="line">ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span><br><span class="line">    sudo pfctl -d (è²Œä¼¼æ²¡ç”¨)</span><br><span class="line">    sudo pfctl -f /etc/pf.conf  </span><br><span class="line">    sudo pfctl -e </span><br><span class="line">ä¸‰ã€æŸ¥çœ‹æ‰‹å†Œ man pfctlã€man pf.conf</span><br></pre></td></tr></table></figure>
<h3 id="è®¡ç®—ä¸å­˜å‚¨åˆ†ç¦»">è®¡ç®—ä¸å­˜å‚¨åˆ†ç¦»</h3>
<p><a href="https://juejin.cn/post/6844904055840440333%EF%BC%8C%E9%98%BF%E9%87%8CPolarDB" target="_blank" rel="noopener">https://juejin.cn/post/6844904055840440333ï¼Œé˜¿é‡ŒPolarDB</a></p>
<p><strong>ä»»åŠ¡è°ƒåº¦azkaban</strong></p>
<p><strong>åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªsleuth</strong></p>
<p><strong>å¤§æ•°æ®-hdfs+hive+hbase</strong></p>
<p><strong>æ¶ˆæ¯é˜Ÿåˆ—-kafka-RocketMQ</strong></p>
<p><strong>çº¿ç¨‹æ± TaskDecorator</strong></p>
<h3 id="å¤§æ•°æ®">å¤§æ•°æ®</h3>
<p>![image-20210831162836310](/Users/qiaojian/Library/Application Support/typora-user-images/image-20210831162836310.png)</p>
<p>åº•å±‚åˆ†å¸ƒå¼å­˜å‚¨ï¼šåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFS</p>
<p>èµ„æºåŠ¨æ€è°ƒåº¦å±‚ï¼šyarn</p>
<p>è®¡ç®—ï¼ˆç¦»çº¿ã€å®æ—¶ï¼‰æ¡†æ¶ï¼šMapReduceã€Sparkã€Stormã€Spark-Streamingã€Flink</p>
<p>å°†SQLè½¬æˆMapReduceè®¡ç®—å‡½æ•°ç„¶åæäº¤ç»™hadoopæ‰§è¡Œï¼šHive</p>
<p>å¤§æ•°æ®NOSQLï¼š</p>
<p>åº•å±‚åˆ†å¸ƒå¼å­˜å‚¨ï¼šåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»ŸHDFS</p>
<p>NOSQLæ•°æ®åº“ï¼šHBase</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">æ‰€æœ‰è¿™äº›æŠ€æœ¯åœ¨å®é™…éƒ¨ç½²çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šéƒ¨ç½²åœ¨åŒä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç”±å¾ˆå¤šå°æœåŠ¡å™¨ç»„æˆçš„æœåŠ¡å™¨é›†ç¾¤ä¸­ï¼ŒæŸå°æœåŠ¡å™¨å¯èƒ½è¿è¡Œç€ HDFS çš„ DataNode è¿›ç¨‹ï¼Œè´Ÿè´£ HDFS çš„æ•°æ®å­˜å‚¨ï¼›åŒæ—¶ä¹Ÿè¿è¡Œç€ Yarn çš„ NodeManagerï¼Œè´Ÿè´£è®¡ç®—èµ„æºçš„è°ƒåº¦ç®¡ç†ï¼›è€Œ MapReduceã€Sparkã€Stormã€Flink è¿™äº›æ‰¹å¤„ç†æˆ–è€…æµå¤„ç†å¤§æ•°æ®è®¡ç®—å¼•æ“åˆ™é€šè¿‡ Yarn çš„è°ƒåº¦ï¼Œè¿è¡Œåœ¨ NodeManager çš„å®¹å™¨ï¼ˆcontainerï¼‰é‡Œé¢ã€‚è‡³äº Hiveã€Spark SQL è¿™äº›è¿è¡Œåœ¨ MapReduce æˆ–è€… Spark åŸºç¡€ä¸Šçš„å¤§æ•°æ®ä»“åº“å¼•æ“ï¼Œåœ¨ç»è¿‡è‡ªèº«çš„æ‰§è¡Œå¼•æ“å°† SQL è¯­å¥è§£ææˆ MapReduce æˆ–è€… Spark çš„æ‰§è¡Œè®¡åˆ’ä»¥åï¼Œä¸€æ ·æäº¤ç»™ Yarn å»è°ƒåº¦æ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">è¿™é‡Œç›¸å¯¹æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ HBaseï¼Œä½œä¸ºä¸€ä¸ª NoSQL å­˜å‚¨ç³»ç»Ÿï¼ŒHBase çš„åº”ç”¨åœºæ™¯æ˜¯æ»¡è¶³åœ¨çº¿ä¸šåŠ¡æ•°æ®å­˜å‚¨è®¿é—®éœ€æ±‚ï¼Œé€šå¸¸æ˜¯ OLTPï¼ˆåœ¨çº¿äº‹åŠ¡å¤„ç†ï¼‰ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä¸ºäº†ä¿è¯åœ¨çº¿ä¸šåŠ¡çš„é«˜å¯ç”¨æ€§å’Œèµ„æºç‹¬å æ€§ï¼Œä¸€èˆ¬æ˜¯ç‹¬ç«‹éƒ¨ç½²è‡ªå·±çš„é›†ç¾¤ï¼Œå’Œå‰é¢çš„ Hadoop å¤§æ•°æ®é›†ç¾¤åˆ†ç¦»éƒ¨ç½²ã€‚</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨iperf3å·¥å…·æµ‹è¯•å±€åŸŸç½‘å¸¦å®½">ä½¿ç”¨iperf3å·¥å…·æµ‹è¯•å±€åŸŸç½‘å¸¦å®½</h3>
<h3 id="filter-vs-handlerinterceptor-vs-aspect">Filter vs HandlerInterceptor vs Aspect</h3>
<h3 id="æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹">æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹</h3>
<p>kafkaï¼šé«˜ååé‡ï¼ˆé¡ºåºè¯»å†™ç£ç›˜ã€MMAPå†…å­˜æ˜ å°„æ–‡ä»¶ã€é›¶æ‹·è´ ã€ç”Ÿäº§è€…æ¶ˆè´¹è€…æ‰¹é‡å‘é€sendfileã€GZIPæˆ–Snappyå‹ç¼©ã€å‡å°‘ç½‘ç»œä¼ è¾“æ•°æ®é‡ã€‘ï¼‰</p>
<p>RocketMQï¼šé«˜å¯é æ€§</p>
<table>
<thead>
<tr>
<th>Kafka</th>
<th>RocketMQ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Brokeræ˜¯ä¸ªç‰©ç†æ¦‚å¿µ, Master/Slaveæ˜¯ä¸ªé€»è¾‘æ¦‚å¿µï¼ŒMaster/Slaveæ˜¯é€šè¿‡zookeeperé€‰ä¸¾äº§ç”Ÿçš„ã€‚ä¸€ä¸ªBokerå¯¹åº”ä¸€å°æœºå™¨ã€‚</td>
<td>Brokeræ˜¯ä¸ªé€»è¾‘æ¦‚å¿µ, Master/Slaveæ˜¯ä¸ªç‰©ç†æ¦‚å¿µã€‚Master/Slaveçš„è§’è‰²æ˜¯é€šè¿‡é…ç½®å›ºå®šçš„ã€‚ä¸€ä¸ªMasteræˆ–ä¸€ä¸ªSlaveå¯¹åº”ä¸€å°æœºå™¨ã€‚</td>
</tr>
<tr>
<td>ä½¿ç”¨zookeeperç®¡ç†Topic/queueå’Œç‰©ç†æœºå™¨çš„æ˜ å°„å…³ç³»</td>
<td>ä½¿ç”¨NameServerç®¡ç†Topic/queueå’Œç‰©ç†æœºå™¨çš„æ˜ å°„å…³ç³»</td>
</tr>
<tr>
<td>å¼‚æ­¥åˆ·ç›˜</td>
<td>åŒæ­¥åˆ·ç›˜ï¼Œå¼‚æ­¥åˆ·ç›˜</td>
</tr>
<tr>
<td>åŒæ­¥Replicationï¼Œå¼‚æ­¥Replication</td>
<td>åŒæ­¥Replicationï¼Œå¼‚æ­¥Replication</td>
</tr>
<tr>
<td>å•æœºå†™å…¥TPSçº¦åœ¨ç™¾ä¸‡æ¡/ç§’</td>
<td>å•æœºå†™å…¥TPSå•å®ä¾‹çº¦7ä¸‡æ¡/ç§’</td>
</tr>
<tr>
<td>å•æœºè¶…è¿‡64ä¸ªé˜Ÿåˆ—/åˆ†åŒºï¼ŒLoadä¼šå‘ç”Ÿæ˜æ˜¾çš„é£™é«˜ç°è±¡ï¼Œé˜Ÿåˆ—è¶Šå¤šï¼ŒLoadè¶Šé«˜</td>
<td>å•æœºæ”¯æŒæœ€é«˜5ä¸‡ä¸ªé˜Ÿåˆ—</td>
</tr>
<tr>
<td>0.8ç‰ˆæœ¬åæ¶ˆè´¹ç«¯æ”¯æŒé•¿è½®è®­pull</td>
<td>æ¶ˆè´¹ç«¯é•¿è½®è®­pull</td>
</tr>
<tr>
<td>æ¶ˆè´¹å¤±è´¥ä¸æ”¯æŒé‡è¯•</td>
<td>æ¶ˆè´¹å¤±è´¥æ”¯æŒå®šæ—¶é‡è¯•ï¼Œæ¯æ¬¡é‡è¯•é—´éš”æ—¶é—´é¡ºå»¶</td>
</tr>
<tr>
<td>å•ä¸ªpartitioné‡Œçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„</td>
<td>å•ä¸ªmessage queueé‡Œçš„æ¶ˆæ¯æ˜¯æœ‰åºçš„</td>
</tr>
<tr>
<td>ä¸æ”¯æŒå®šæ—¶æ¶ˆæ¯</td>
<td>æ”¯æŒå®šæ—¶æ¶ˆæ¯</td>
</tr>
<tr>
<td>ä¸æ”¯æŒæ¶ˆæ¯æŸ¥è¯¢</td>
<td>æ”¯æŒæ¶ˆæ¯æŸ¥è¯¢</td>
</tr>
<tr>
<td>ä¸æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡</td>
<td>æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡</td>
</tr>
<tr>
<td>ä¸æ”¯æŒBrokerç«¯çš„æ¶ˆæ¯è¿‡æ»¤</td>
<td>æ”¯æŒBrokerç«¯çš„æ¶ˆæ¯è¿‡æ»¤</td>
</tr>
<tr>
<td>æ¶ˆè´¹å¹¶è¡Œåº¦ä¾èµ–Topicé…ç½®çš„åˆ†åŒºæ•°ï¼Œå¦‚åˆ†åŒºæ•°ä¸º10ï¼Œé‚£ä¹ˆæœ€å¤š10å°æœºå™¨æ¥å¹¶è¡Œæ¶ˆè´¹ï¼Œæ¯å°æœºå™¨åªèƒ½å¼€å¯ä¸€ä¸ªçº¿ç¨‹</td>
<td>é¡ºåºæ¶ˆè´¹æ–¹å¼å¹¶è¡Œåº¦åŒKafkaå®Œå…¨ä¸€è‡´ï¼›ä¹±åºæ–¹å¼å¹¶è¡Œåº¦å–å†³äºConsumerçš„çº¿ç¨‹æ•°ï¼Œå¦‚Topicé…ç½®10ä¸ªé˜Ÿåˆ—ï¼Œ10å°æœºå™¨æ¶ˆè´¹ï¼Œæ¯å°æœºå™¨100ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå¹¶è¡Œåº¦ä¸º1000ï¼›</td>
</tr>
</tbody>
</table>
<p>Kafkaå­˜å‚¨ç»“æ„ï¼šä¸€ä¸ªTopicå¯¹åº”å¤šä¸ªPartitionï¼Œæ¯ä¸ªPartitionä¸€ä¸ªç›®å½•ï¼ŒPartitionç›®å½•ä¸‹ç”±å¤šä¸ªSegmentæ–‡ä»¶å’Œç´¢å¼•ç»„æˆ</p>
<p>RocketMQå­˜å‚¨ç»“æ„ï¼šæ‰€æœ‰Topicçš„æ¶ˆæ¯å†™å…¥CommitLogæ–‡ä»¶ï¼Œå°†Topic/Queueçš„Offsetå†™å…¥å¯¹åº”çš„æ¯ä¸ªConsumerQueueæ–‡ä»¶</p>
<p>![image-20211015174029613](/Users/qiaojian/Library/Application Support/typora-user-images/image-20211015174029613.png)</p>
<p><strong>Spring-Kafkaæä¾›äº†æ¶ˆè´¹å¤±è´¥é‡è¯•æœºåˆ¶å’Œæ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶</strong></p>
<p>Linuxæ–‡ä»¶IOï¼šread/writeï¼ˆé€‚ç”¨åœºæ™¯ï¼šå¯¹å•ä¸ªæ–‡ä»¶ä¸é¢‘ç¹çš„å°‘é‡è¯»å†™ï¼‰ã€mmapï¼ˆé€‚ç”¨åœºæ™¯ï¼šå¯¹å•ä¸ªå¤§æ–‡ä»¶çš„é¢‘ç¹å¤§é‡è¯»å†™ï¼‰ã€sendfileï¼ˆè¿™ä¸ªç³»ç»Ÿè°ƒç”¨å°† <code>mmap()</code> + <code>write()</code> è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨åˆäºŒä¸ºä¸€ï¼›é€‚ç”¨åœºæ™¯ï¼šæ— éœ€ä¿®æ”¹æ–‡ä»¶å†…å®¹ï¼Œä»…ä»…å°†æ–‡ä»¶æ•°æ®å‘é€åˆ°ç½‘ç»œï¼‰ã€spliceï¼ˆåŠŸèƒ½ä¸Šå’Œ <code>sendfile()</code> éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯èƒ½å¤Ÿå®ç°åœ¨ä»»æ„ç±»å‹çš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æ—¶ä¹‹é—´ä¼ è¾“æ•°æ®ï¼›è€Œåœ¨åº•å±‚å®ç°ä¸Šï¼Œ<code>splice()</code>åˆæ¯” <code>sendfile()</code> å°‘äº†ä¸€æ¬¡ CPU æ‹·è´ï¼‰</p>
<p>IOå‚è€ƒæ–‡ç« ï¼š<a href="https://www.jiqizhixin.com/articles/2019-01-21-19%E3%80%81https://zhuanlan.zhihu.com/p/308054212" target="_blank" rel="noopener">https://www.jiqizhixin.com/articles/2019-01-21-19ã€https://zhuanlan.zhihu.com/p/308054212</a></p>
<p>æ–‡ä»¶å­˜å‚¨ç»“æ„ï¼š</p>
<p>B-Treeï¼šæŒ‰é¡µå†™å…¥å­˜åœ¨å†…å­˜ç¢ç‰‡ï¼ŒæŒ‰ç´¢å¼•è¯»å–å†å²æ•°æ®æ€§èƒ½æ›´å¥½ï¼Œæ•°æ®keyåœ¨ç´¢å¼•æ–‡ä»¶ä¸­åªæœ‰ä¸€ä»½èƒ½å¾ˆå¥½çš„æ”¯æŒäº‹åŠ¡</p>
<p>LSM-Treeï¼šå°†éšæœºå†™è½¬åŒ–ä¸ºé¡ºåºå†™ã€‚ç‰ºç‰²äº†éƒ¨åˆ†è¯»æ€§èƒ½ï¼Œä»¥æ­¤æ¥æ¢å–å†™å…¥çš„æœ€å¤§åŒ–æ€§èƒ½ï¼Œç‰¹åˆ«é€‚ç”¨äºè¯»éœ€æ±‚ä½ï¼Œä¼šäº§ç”Ÿå¤§é‡æ’å…¥æ“ä½œçš„åº”ç”¨ç¯å¢ƒã€‚</p>
<p>ä½¿ç”¨å·¥å…·sysbenchæµ‹è¯•æœºå™¨cpuã€å†…å­˜ã€mysqlã€æ–‡ä»¶ioæ€§èƒ½</p>
<p>ç½‘ç»œIOæµ‹è¯•å·¥å…·ï¼šiperf</p>
<p>æ–‡ä»¶IOæµ‹è¯•å·¥å…·ï¼šfio</p>
<h3 id="redis-vs-rocksdb-vs-leveldb">Redis vs RocksDB vs LevelDB</h3>
<h3 id="apache-arrow">Apache Arrow</h3>
<p>é›¶æ‹·è´åºåˆ—åŒ–æ¡†æ¶ï¼Œå¤§æ•°æ®ä¸åŒæœºå™¨é—´åè°ƒåˆä½œæ•°æ®ä¼ è¾“ç»Ÿä¸€æ ¼å¼ï¼šæœ€å¥½çš„åºåˆ—åŒ–å°±æ˜¯æ²¡æœ‰åºåˆ—åŒ–</p>
<h3 id="huffmanç¼–ç ">Huffmanç¼–ç </h3>
<p>åªæœ‰åœ¨æ•°æ®çš„æ¬¡æ•°æˆ–è€…é¢‘ç‡åˆ†å¸ƒä¸å‡åŒ€çš„æ—¶å€™ï¼Œç¼–ç æ‰èƒ½äº§ç”Ÿå‹ç¼©çš„ä½œç”¨ï¼Œè‹¥æ•°æ®åˆ†å¸ƒè¾ƒä¸ºå‡åŒ€ï¼Œåˆ™å‹ç¼©æ•ˆæœä¸æ˜æ˜¾</p>
<h3 id="gitlab-cicd-amp-ansible-playbook-amp-supervisorctl">gitlab ci/cd &amp; ansible-playbook &amp; supervisorctl</h3>
<p>gitlabï¼šä»£ç ä»“åº“</p>
<p>gitlab ci/cdï¼šgitlabæŒç»­é›†æˆ/æŒç»­éƒ¨ç½²</p>
<p>ansibleï¼šè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼ˆæ‰¹é‡è‡ªåŠ¨é…ç½®ã€éƒ¨ç½²ã€è¿è¡Œå‘½ä»¤ï¼‰</p>
<p>Supervisor: è¿›ç¨‹ç®¡ç†</p>
<h3 id="mysqlæµå¼æŸ¥è¯¢">Mysqlæµå¼æŸ¥è¯¢</h3>
<h5 id="mysql-jdbc-streamresulté€šä¿¡åŸç†æµ…æ"><a href="https://segmentfault.com/a/1190000016724645" target="_blank" rel="noopener">MySQL JDBC StreamResulté€šä¿¡åŸç†æµ…æ</a></h5>
<h3 id="springcloudnetflixè¶…æ—¶æ—¶é—´é…ç½®">SpringCloudNetflixè¶…æ—¶æ—¶é—´é…ç½®</h3>
<p>å‚è€ƒï¼š <a href="https://zhongpan.tech/2020/03/23/029-hystrix-ribbon-feign-relationship/" target="_blank" rel="noopener">https://zhongpan.tech/2020/03/23/029-hystrix-ribbon-feign-relationship/</a></p>
<p>Feignè¶…æ—¶é…ç½®ï¼šé’ˆå¯¹ååº•å±‚çš„ç½‘ç»œè¶…æ—¶é…ç½®ï¼Œç²’åº¦å¯ä»¥ç²¾ç¡®åˆ°service</p>
<p>Hystrixè¶…æ—¶é…ç½®ï¼šé’ˆå¯¹å‘½ä»¤æ‰§è¡Œçš„ç†”æ–­è¶…æ—¶é…ç½®ï¼Œç²’åº¦å¯ä»¥ç²¾ç¡®åˆ°method</p>
<p>ribbonè¶…æ—¶é…ç½®ï¼šé’ˆå¯¹è´Ÿè½½å‡è¡¡+é‡è¯•è¶…æ—¶é…ç½®ï¼Œç²’åº¦å¯ä»¥ç²¾ç¡®åˆ°service</p>
<p>è¶…æ—¶è®¾ç½®å‡†åˆ™ï¼šHystrixçš„ç†”æ–­æ˜¯åœ¨ribbonå’Œhttpè¯·æ±‚è¶…æ—¶æˆ–å¤±è´¥è¾¾åˆ°å¤šå¤§æ¯”ä¾‹åè¿›è¡Œçš„æ“ä½œï¼Œæ‰€ä»¥Hystrixçš„ç†”æ–­è¶…æ—¶æ—¶é—´ä¸€å®šè¦å¤§äºribbonå’Œhttpè¯·æ±‚åŠ èµ·æ¥çš„æ€»æ—¶é—´ï¼Œä¸ç„¶è¯·æ±‚è¿˜æ²¡å®ŒæˆHystrixç†”æ–­è¶…æ—¶æ—¶é—´å°±è§¦å‘äº†ç†”æ–­ã€‚</p>
<p>![image-20210810202202141](/Users/qiaojian/Library/Application Support/typora-user-images/image-20210810202202141.png)</p>
<h3 id="linuxåå°è¿è¡Œè¿›ç¨‹">Linuxåå°è¿è¡Œè¿›ç¨‹</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@VM-0-3-centos ~]# shopt | grep huponexit</span><br><span class="line">huponexit      	off</span><br></pre></td></tr></table></figure>
<p>è¿›ç¨‹idï¼špid</p>
<p>è¿›ç¨‹ç»„idï¼špgid ï¼ˆä¸€ç³»åˆ—å‘½ä»¤ç»„åˆåœ¨ä¸€èµ·å½¢æˆè¿›ç¨‹ç»„ï¼‰</p>
<p>çˆ¶è¿›ç¨‹idï¼šppid</p>
<p>ä¼šè¯idï¼šsid ï¼ˆä¼šè¯ç®¡ç†å¤šä¸ªè¿›ç¨‹ç»„ï¼‰</p>
<p>huponexitä¸ºoffæ—¶ï¼Œä¼šè¯<strong>æ­£å¸¸æ³¨é”€é€€å‡º</strong>æ—¶ï¼Œshellåå°è¿è¡Œçš„å­è¿›ç¨‹ä¸ä¼šé€€å‡ºï¼Œè€Œæ˜¯å˜æˆinitè¿›ç¨‹çš„å­è¿›ç¨‹ã€‚ä½†æ˜¯ä¼šè¯å¼‚å¸¸é€€å‡ºæ—¶ï¼Œshellåå°è¿è¡Œçš„å­è¿›ç¨‹è¿˜æ˜¯ä¼šé€€å‡ºã€‚</p>
<p>é¿å…ä¼šè¯é€€å‡ºå­è¿›ç¨‹ä¹Ÿé€€å‡ºçš„æ–¹å¼ï¼šnohupï¼ˆæˆ–è€…setsidã€disownã€()ã€screenã€tmuxï¼‰</p>
<p>nohup command &gt;/dev/null 2&gt;&amp;1 &amp;</p>
<p>å¦å¤–æ³¨æ„ï¼šé»˜è®¤çš„è¾“å…¥è¾“å‡ºéƒ½æ˜¯åˆ›å»ºè¿›ç¨‹çš„ä¼šè¯çš„è¾“å…¥è¾“å‡ºè®¾å¤‡ï¼Œå› æ­¤ä¼šè¯å…³é—­æ—¶ï¼Œç¨‹åºçš„è¾“å…¥è¾“å‡ºä¼šå¼‚å¸¸ï¼Œå› æ­¤å¯åŠ¨å‘½ä»¤ä¸Šè¦è¿›è¡Œè¾“å…¥è¾“å‡ºé‡å®šå‘ï¼ˆä¸€èˆ¬ç¨‹åºæ²¡æœ‰ä½¿ç”¨æ ‡å‡†è¾“å…¥ï¼Œå› æ­¤æŒ‡å®šè¾“å‡ºé‡å®šå‘å³å¯ï¼‰</p>
<p>Linux Cè¯­è¨€å®ç°daemonè¿›ç¨‹ï¼š<a href="https://ixyzero.com/blog/archives/3111.html" target="_blank" rel="noopener">https://ixyzero.com/blog/archives/3111.html</a></p>
<p>Rediså®ç°daemonè¿›ç¨‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">daemonize</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() != <span class="number">0</span>) <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">/* parent exits */</span></span><br><span class="line">    setsid(); <span class="comment">/* create a new session */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Every output goes to /dev/null. If Redis is daemonized but</span></span><br><span class="line"><span class="comment">     * the 'logfile' is set to 'stdout' in the configuration file</span></span><br><span class="line"><span class="comment">     * it will not log at all. */</span></span><br><span class="line">    <span class="keyword">if</span> ((fd = open(<span class="string">"/dev/null"</span>, O_RDWR, <span class="number">0</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        dup2(fd, STDIN_FILENO);</span><br><span class="line">        dup2(fd, STDOUT_FILENO);</span><br><span class="line">        dup2(fd, STDERR_FILENO);</span><br><span class="line">        <span class="keyword">if</span> (fd &gt; STDERR_FILENO) close(fd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tomcaté…ç½®">Tomcaté…ç½®</h3>
<p>![image-20210819151604148](/Users/qiaojian/Library/Application Support/typora-user-images/image-20210819151604148.png)</p>
<p><a href="https://cloud.tencent.com/developer/article/1674556" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1674556</a></p>
<p>Acceptorçº¿ç¨‹ï¼šå¤„ç†acceptäº‹ä»¶ï¼Œå®Œæˆtcpä¸‰æ¬¡æ¡æ‰‹åˆ›å»ºsocketï¼Œç„¶åå°†Socketå°è£…æˆPollerEventäº‹ä»¶æ”¾å…¥ClientPollerçš„äº‹ä»¶é˜Ÿåˆ—</p>
<p>ClientPollerçº¿ç¨‹ï¼šSelectorè½®è®­éå†å¯è¯»å’Œå¯å†™äº‹ä»¶ï¼Œç„¶åå°†å¯è¯»æˆ–å¯å†™çš„Socketä¼ ç»™IOçº¿ç¨‹æ± é‡Œçš„IOçº¿ç¨‹è¿›è¡Œå¤„ç†</p>
<p>IOçº¿ç¨‹æ± ï¼šçœŸæ­£å¤„ç†Socketè¯»å†™ä»¥åŠä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹</p>
<p>BlockPollerçº¿ç¨‹ï¼šç”¨äºå½“IOçº¿ç¨‹çš„Socketæ•°æ®éœ€è¦å¤šæ¬¡è¯»å†™çš„æ—¶å€™ï¼Œç›‘æµ‹æ³¨å†Œåœ¨åŸå§‹ socket ä¸Šçš„è¯»å†™äº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚BlockerPollerä¼šå’ŒIOçº¿ç¨‹è¿›ç¨‹äº¤äº’ï¼Œé˜²æ­¢IOçº¿ç¨‹å¿™ç­‰å¾…æ¶ˆè€—CPU</p>
<h3 id="hikaricpè¿æ¥æ± ">HiKariCPè¿æ¥æ± </h3>
<p>ä¸ºä»€ä¹ˆå¿«ï¼Ÿ</p>
<ol>
<li>
<p>ä½¿ç”¨ç¬¬ä¸‰æ–¹å­—èŠ‚ç ä¿®æ”¹åº“Javassistæ¥ç”ŸæˆåŠ¨æ€ä»£ç†ç±»</p>
</li>
<li>
<p>ConcurrentBag &amp; FastList</p>
</li>
</ol>
<p>ConcurrentBag ï¼šæ— é”è®¾è®¡ã€ThreadLocal ç¼“å­˜ã€  CopyOnWriteArrayListã€SynchronousQueueé˜Ÿåˆ—çªƒå–</p>
<p>FastListï¼šå»é™¤indexæ£€éªŒã€åˆ é™¤modCountç»Ÿè®¡ã€listéå†ç”±åå¾€å‰ã€æ‰©å®¹ä¼˜åŒ–ï¼ˆå®¹é‡å¤Ÿç›´æ¥æ’å…¥ï¼Œå¿…é¡»æ‰©å®¹æ—¶ç›´æ¥æ‰©å®¹ä¸º*2ï¼‰ã€åªå®ç°å¿…è¦çš„æ¥å£</p>
<p><strong>ä¼˜åŒ–</strong>ï¼šæ ¹æ®sqlæ‰§è¡Œå¤æ‚åº¦åˆ†æˆé•¿äº‹åŠ¡å’ŒçŸ­äº‹åŠ¡sqlã€‚é•¿äº‹åŠ¡å’ŒçŸ­äº‹åŠ¡sqlä½¿ç”¨ä¸åŒçš„è¿æ¥æ± ï¼ˆå¤šæ•°æ®æºé…ç½®ï¼‰ã€‚é•¿äº‹åŠ¡çš„è¿æ¥æ± è¿æ¥æ•°å¯ä»¥è®¾ç½®çš„å¤§ä¸€ç‚¹ï¼ŒçŸ­äº‹åŠ¡çš„è¿æ¥æ± è¿æ¥æ•°å¯ä»¥è®¾ç½®çš„å°ä¸€ç‚¹ã€‚</p>
<h3 id="åœ¨bash-shellä¸­æ‰“å¼€æˆ–å…³é—­tcp-udpå¥—æ¥å­—">åœ¨Bash Shellä¸­æ‰“å¼€æˆ–å…³é—­TCP / UDPå¥—æ¥å­—</h3>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦6ï¼Œå…³è”åˆ°Socket tcp wwww.baidu.com 80ï¼Œå¯è¯»å¯å†™</span><br><span class="line">exec 6&lt;&gt; /dev/tcp/www.baidu.com/80</span><br><span class="line">// å‘é€httpè¯·æ±‚</span><br><span class="line">echo -e  &apos;GET /index.html HTTP/1.1\n&apos; &gt;&amp;6</span><br><span class="line">// æ¥æ”¶å“åº”</span><br><span class="line">cat &lt;&amp;6</span><br></pre></td></tr></table></figure>
<h3 id="spring-cloud-åº”ç”¨å¦‚ä½•æ³¨å†Œåˆ°å¤šä¸ªæ³¨å†Œä¸­å¿ƒ">Spring Cloud åº”ç”¨å¦‚ä½•æ³¨å†Œåˆ°å¤šä¸ªæ³¨å†Œä¸­å¿ƒ</h3>
<p><a href="https://cloud.tencent.com/developer/article/1425751" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1425751</a></p>
<h3 id="mysqlå•è¡¨æ•°æ®é‡ä¸è¶…è¿‡500ä¸‡">Mysqlå•è¡¨æ•°æ®é‡ä¸è¶…è¿‡500ä¸‡</h3>
<p>ä¸ºä»€ä¹ˆè¯´å»ºè®®msyqlå•è¡¨æ•°æ®é‡ä¸è¶…è¿‡500ä¸‡ï¼Ÿè¿™å¾—ä»Mysql InnoDBå­˜å‚¨å¼•æ“ç»“æ„è¯´èµ·ã€‚Mysql InnoDBé»˜è®¤é¡µå¤§å°æ˜¯16KBï¼ŒMysql InnoDBçš„æ•°æ®ç»“æ„æ˜¯B-Treeã€‚ä¸€ä¸ªé«˜åº¦ä¸º3çš„B-Treeèƒ½å­˜å‚¨çš„æ•°æ®é‡è®¡ç®—ï¼š</p>
<p>InnoDBé»˜è®¤æ˜¯ä»¥ä¸»é”®å»ºç«‹èšæ—ç´¢å¼•ï¼Œå¶å­ç»“ç‚¹å­˜å‚¨çœŸæ­£çš„æ•°æ®ï¼Œæ ¹èŠ‚ç‚¹å’Œå†…éƒ¨é˜¶æ®µåªå­˜å‚¨ä¸»é”®å’ŒæŒ‡é’ˆã€‚æ‰€ä»¥ï¼š16KBçš„é¡µå­˜å‚¨æ ¹èŠ‚ç‚¹Keyä¸ªæ•°å¤§æ¦‚æ˜¯ï¼š16KB/8Bï¼ˆä¸»é”®å¤§å°ï¼‰+8Bï¼ˆæŒ‡é’ˆå¤§å°ï¼‰+8Bï¼ˆå…¶ä»–å†—ä½™ï¼‰= 666ï¼Œå…¶ä¸­æ¯ä¸ªKeyçš„æŒ‡é’ˆæŒ‡å‘1ä¸ªä¸­é—´ç»“ç‚¹ï¼Œå› æ­¤å¯ä»¥æœ‰666ä¸ªä¸­é—´ç»“ç‚¹ï¼ŒåŒç†æ¯ä¸ªä¸­é—´ç»“ç‚¹é‡Œçš„æ¯ä¸ªKeyçš„æŒ‡é’ˆä¹ŸæŒ‡å‘1ä¸ªå¶å­ç»“ç‚¹ï¼Œå› æ­¤ä¸€å…±æœ‰666*666=443556ä¸ªå¶å­ç»“ç‚¹ã€‚å¶å­ç»“ç‚¹å­˜å‚¨çœŸæ­£çš„è¡Œæ•°æ®å’Œé“¾è¡¨æŒ‡é’ˆï¼ˆæ–¹ä¾¿èŒƒå›´æŸ¥è¯¢ï¼‰ã€‚ä»¥ä¸‹é¢çš„Tableä¸¾ä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `t_ada_app_task` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `task_no` bigint(20) unsigned DEFAULT NULL COMMENT &apos;ä»»åŠ¡å·&apos;,</span><br><span class="line">  `task_name` varchar(100) NOT NULL COMMENT &apos;ä»»åŠ¡å&apos;,</span><br><span class="line">  `user_name` varchar(100) DEFAULT NULL COMMENT &apos;ç”¨æˆ·åç§°&apos;,</span><br><span class="line">  `user_source` int(11) NOT NULL COMMENT &apos;ç”¨æˆ·æ¥æº&apos;,</span><br><span class="line">  `import_time` datetime DEFAULT NULL COMMENT &apos;ä¸ŠæŠ¥æ—¶é—´&apos;,</span><br><span class="line">  `task_status` int(11) NOT NULL DEFAULT &apos;1&apos; COMMENT &apos;è·‘æ•°ä»»åŠ¡çŠ¶æ€ 1ï¼šæŒç»­ 2ï¼šåœæ­¢&apos;,</span><br><span class="line">  `task_type` varchar(100) DEFAULT NULL COMMENT &apos;ä»»åŠ¡ç±»å‹&apos;,</span><br><span class="line">  `remark` varchar(512) DEFAULT NULL COMMENT &apos;å¤‡æ³¨&apos;,</span><br><span class="line">  `org_no` int(10) unsigned DEFAULT NULL COMMENT &apos;æœºæ„å·&apos;,</span><br><span class="line">  `update_time` datetime DEFAULT NULL COMMENT &apos;æ›´æ–°æ—¶é—´&apos;,</span><br><span class="line">  `create_time` datetime NOT NULL COMMENT &apos;åˆ›å»ºæ—¶é—´&apos;,</span><br><span class="line">  PRIMARY KEY (`id`) USING BTREE,</span><br><span class="line">  UNIQUE KEY `uk_data_source_name` (`org_no`,`user_name`) USING BTREE,</span><br><span class="line">) ENGINE=InnoDB  DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªå­—æ®µå ç”¨ç©ºé—´ç›¸åŠ ä¸ºï¼š854+16ï¼ˆpreã€nextæŒ‡é’ˆï¼‰+ 30ï¼ˆå†—ä½™ï¼‰=900Bï¼ˆæ³¨æ„ï¼šç”±æ­¤å¯è§varcharå¾ˆå ç©ºé—´ï¼Œå°½é‡ä¸è¦å®šä¹‰å¤ªå¤§åˆæ— ç”¨çš„varcharå­—æ®µï¼‰ï¼Œå› æ­¤1ä¸ªé¡µå¯ä»¥å­˜å‚¨çš„è¡Œä¸ºï¼š16KB/900B=17ã€‚å› æ­¤ä¸€é¢—é«˜åº¦ä¸º3çš„B-Treeå¶å­ç»“ç‚¹æ€»å…±å¯ä»¥å­˜å‚¨çš„æ•°æ®è¡Œä¸ºï¼š443556*17=750ä¸‡</p>
<h3 id="jmhå‡½æ•°çº§åˆ«æ€§èƒ½æµ‹è¯•">JMHå‡½æ•°çº§åˆ«æ€§èƒ½æµ‹è¯•</h3>
<h3 id="ç²¾å‡†å¹¿å‘ŠæŠ•æ”¾-cookie-mapping">ç²¾å‡†å¹¿å‘ŠæŠ•æ”¾-Cookie-Mapping</h3>
<p>![image-20211108152036486](/Users/qiaojian/Library/Application Support/typora-user-images/image-20211108152036486.png)</p>
<p>â‘ ç”¨æˆ·è®¿é—®æŸä¸ªåª’ä½“ï¼ˆAPPï¼‰çš„é¡µé¢</p>
<p>â‘¡åª’ä½“ï¼ˆAPPï¼‰å‘ADXå‘é€å¹¿å‘Šè¯·æ±‚ï¼ˆæœ‰æ—¶APPä¼šå‘SSPå‘é€è¯·æ±‚ï¼ŒSSPå†å‘ADXå‘é€è¯·æ±‚ï¼‰</p>
<p>â‘¢ADXæ”¶åˆ°è¯·æ±‚åï¼Œå‘å¯¹æ¥çš„DSPåˆ†å‘è¯·æ±‚</p>
<p>â‘£DSPæ”¶åˆ°è¯·æ±‚åï¼Œå¯¹è¯·æ±‚å¸¦ä¸Šçš„ä¿¡æ¯è¿›è¡Œåˆ†æï¼Œç„¶åå‘ADXè¿”å›ç«ä»·ä¿¡æ¯</p>
<p>â‘¤ADXæ ¹æ®DSPè¿”å›çš„ç«ä»·ä¿¡æ¯ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„åˆ¤æ–­ï¼Œå†³å®šå“ªå®¶ç«ä»·æˆåŠŸè·å¾—å¹¿å‘Šæ›å…‰æœºä¼šï¼Œå¹¶å°†åˆ›æ„ç´ æè¿”å›ç»™åª’ä½“ï¼ˆAPPï¼‰</p>
<p>â‘¥åª’ä½“ï¼ˆAPPï¼‰æ”¶åˆ°ADXè¿”å›çš„åˆ›æ„ç´ æä¿¡æ¯åå±•ç°åœ¨ç”¨æˆ·è®¿é—®çš„é¡µé¢ä¸Š</p>
<h3 id="å•æœºå®šæ—¶ä»»åŠ¡">å•æœºå®šæ—¶ä»»åŠ¡</h3>
<p>JDK - Timer-å•çº¿ç¨‹</p>
<p>JDK - ScheduledThreadPoolExecutor-çº¿ç¨‹æ± </p>
<p>Netty - HashedWheelTimer-æ—¶é—´è½®ã€å•çº¿ç¨‹ã€é€‚ç”¨äºå¯¹æ—¶æ•ˆæ€§ä¸é«˜çš„ï¼Œå¯å¿«é€Ÿæ‰§è¡Œçš„ï¼Œå¤§é‡è¿™æ ·çš„â€œå°â€ä»»åŠ¡</p>
<p>Kafka - HashedWheelTimer-æ—¶é—´è½®ï¼Œ1. è§£å†³äº†Nettyæ—¶é—´è½®å¦‚æœé•¿æ—¶é—´æ²¡æœ‰åˆ°æœŸä»»åŠ¡ï¼Œé‚£ä¹ˆä¼šå­˜åœ¨æ—¶é—´è½®ç©ºæ¨è¿›çš„ç°è±¡ï¼ˆå¼•å…¥JDKçš„DelayQueueä¿å­˜æ¯ä¸ªBucketï¼‰ã€‚2. è§£å†³äº†æ—¶é—´è·¨åº¦å¤§çš„é—®é¢˜ï¼ˆå¼•å…¥å±‚çº§æ—¶é—´è½®ç±»ä¼¼æ—¶é’ˆåˆ†é’ˆç§’é’ˆçš„åŠŸèƒ½ï¼‰</p>
<h3 id="è£…é¥°å™¨æ¨¡å¼vsé€‚é…å™¨æ¨¡å¼">è£…é¥°å™¨æ¨¡å¼vsé€‚é…å™¨æ¨¡å¼</h3>
<p>è£…é¥°å™¨æ¨¡å¼ä¸æ”¹å˜è¦è£…é¥°çš„æ¥å£å‚æ•°ï¼šä¾‹å¦‚ï¼šBufferedReaderè£…é¥°Readeræ¥å£ï¼Œå¹¶ä¸ä¿®æ”¹æ¥å£ï¼Œåªåšå¢å¼ºï¼ˆBufferedï¼‰</p>
<p>é€‚é…å™¨æ¨¡å¼ä¼šå°†ä¸åŒçš„è¾“å…¥å‚æ•°é€‚é…åˆ°å¾…é€‚é…åˆ°æ¥å£ï¼šä¾‹å¦‚InputStreamReaderé€‚é…charæ•°ç»„è¾“å…¥åˆ°byteæ•°ç»„è¾“å…¥æ¥å£</p>
<h3 id="æ¨¡ç‰ˆæ–¹æ³•vsç­–ç•¥æ¨¡å¼">æ¨¡ç‰ˆæ–¹æ³•vsç­–ç•¥æ¨¡å¼</h3>
<p>æ¨¡ç‰ˆæ–¹æ³•ï¼šä¸€èˆ¬åœ¨æŠ½è±¡ç±»ä¸­å®šä¹‰å¥½ä¸€ç§ç®—æ³•çš„æ‰§è¡Œæµç¨‹éª¨æ¶ï¼Œå…·ä½“æ¯ä¸ªæ­¥éª¤ç»†èŠ‚ç”±å­ç±»ç»§æ‰¿å®ç°ï¼šä¾‹å¦‚å¾ˆå¤šçš„æŠ½è±¡ç±»AbstractCollectionç­‰</p>
<p>ç­–ç•¥æ¨¡å¼ï¼šä¸åŒçš„ç­–ç•¥å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œä¸åŒç­–ç•¥ä¹‹é—´å¯ä»¥ç›¸äº’æ›¿æ¢ï¼šä¾‹å¦‚ä¸åŒçš„æ¯”è¾ƒæ–¹å¼éƒ½å®ç°Comparatoræ¥å£</p>
<h3 id="dns">DNS</h3>
<h5 id="dnsæ”¾å¤§æ”»å‡»">DNSæ”¾å¤§æ”»å‡»</h5>
<p>DNS æ”¾å¤§å¯åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ”»å‡»è€…ä½¿ç”¨å—æŸçš„ç«¯ç‚¹å°†æœ‰æ¬ºéª—æ€§ IP åœ°å€çš„ <a href="https://www.cloudflare.com/learning/ddos/glossary/user-datagram-protocol-udp/" target="_blank" rel="noopener">UDP</a> æ•°æ®åŒ…å‘é€åˆ° DNS é€’å½’æœåŠ¡å™¨ã€‚æ•°æ®åŒ…ä¸Šçš„æ¬ºéª—æ€§åœ°å€æŒ‡å‘å—å®³è€…çš„çœŸå® IP åœ°å€ã€‚</li>
<li>æ¯ä¸ª UDP æ•°æ®åŒ…éƒ½å‘ DNS è§£æå™¨å‘å‡ºè¯·æ±‚ï¼Œé€šå¸¸ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼ˆä¾‹å¦‚â€œANYâ€ï¼‰ä»¥æ¥æ”¶å°½å¯èƒ½æœ€å¤§çš„å“åº”ã€‚</li>
<li>DNS è§£æå™¨æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå‘æ¬ºéª—æ€§ IP åœ°å€å‘é€è¾ƒå¤§çš„å“åº”ã€‚</li>
<li>ç›®æ ‡çš„ IP åœ°å€æ¥æ”¶å“åº”ï¼Œå…¶å‘¨è¾¹çš„ç½‘ç»œåŸºç¡€è®¾æ–½è¢«å¤§é‡æµé‡æ·¹æ²¡ï¼Œä»è€Œå¯¼è‡´æ‹’ç»æœåŠ¡ã€‚</li>
</ol>
<h5 id="é¢„é˜²dnsæ”¾å¤§æ”»å‡»">é¢„é˜²DNSæ”¾å¤§æ”»å‡»</h5>
<ol>
<li>å‡å°‘å¼€æ”¾DNSè§£æå™¨æ•°ç›®</li>
<li>æºIPåœ°å€éªŒè¯</li>
</ol>
<h5 id="dnsæ³›æ´ªæ”»å‡»">DNSæ³›æ´ªæ”»å‡»</h5>
<p>æ¶æ„æ”»å‡»è€…å‘å…è®¸é€’å½’çš„å¼€æ”¾DNSè§£æå™¨å‘é€å¤§é‡ä¼ªé€ çš„æŸ¥è¯¢è¯·æ±‚ï¼Œè¾¾åˆ°DDosæ•ˆæœ</p>
<h5 id="é¢„é˜²dnsæ³›æ´ªæ”»å‡»">é¢„é˜²DNSæ³›æ´ªæ”»å‡»</h5>
<p>ä¸¢å¼ƒæœªç»è¯·æ±‚æˆ–çªå‘çš„DNSè¯·æ±‚ã€ç™½åå•ã€é»‘åå•ç­‰</p>
<h5 id="dnsåŠ«æŒ">DNSåŠ«æŒ</h5>
<p>åˆ†æœ¬åœ°DNSåŠ«æŒã€è·¯ç”±DNSåŠ«æŒå’Œç›´æ¥æ”»å‡»DNSæœåŠ¡å™¨ï¼Œç›®çš„å°±æ˜¯å‘ç›®æ ‡åŸŸåè§£æè¯·æ±‚è¿”å›é”™è¯¯çš„IPåœ°å€</p>
<h5 id="httpdns">HTTPDNS</h5>
<p>é€šè¿‡ IP ç›´æ¥è¯·æ±‚ HTTP è·å–æœåŠ¡å™¨ A è®°å½•åœ°å€ï¼Œä¸å­˜åœ¨å‘æœ¬åœ°è¿è¥å•†è¯¢é—® domain è§£æè¿‡ç¨‹</p>
<ol>
<li>ä»æ ¹æœ¬ä¸Šé¿å…äº†DNSåŠ«æŒé—®é¢˜</li>
<li>æé«˜åŸŸåè§£ææ•ˆç‡</li>
<li>ç²¾ç¡®å®šä½å®¢æˆ·ç«¯åœ°ç†ä½ç½®ã€è¿è¥å•†ä¿¡æ¯ï¼Œä»è€Œæœ‰æ•ˆæ”¹è¿›è°ƒåº¦ç²¾ç¡®æ€§ã€‚</li>
</ol>
<h3 id="condition-vs-object-waitnotify">Condition vs Object wait/notify</h3>
<p>å‚è€ƒConditon.javaçš„æ³¨é‡Šè¯´æ˜ï¼Œä¸»è¦åŒºåˆ«ä¸¤ç‚¹ï¼š</p>
<ol>
<li>Conditonå¯ä»¥åœ¨ä¸€ä¸ªlockå¯¹è±¡ä¸Šæä¾›å¤šä¸ªConditionç­‰å¾…é˜Ÿåˆ—ï¼Œæ¯”å¦‚ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­å¯ä»¥æŠŠnotFullå’ŒnotEmptyçš„ç­‰å¾…é˜Ÿåˆ—è®¾ç½®ä¸ºåˆ†å¼€çš„ä¸¤ä¸ªï¼Œè€Œä½¿ç”¨Objectçš„wait/notifyåªèƒ½ä½¿ç”¨ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—æ¥é€šçŸ¥notFullå’ŒnotEmptyäº‹ä»¶</li>
<li>Conditonæä¾›äº†è¶…æ—¶waitçš„æ–¹æ³•å’Œå±è”½ä¸­æ–­çš„waitæ–¹æ³•ï¼Œè€ŒObjectçš„wait/notifyæ²¡æœ‰</li>
</ol>
<h3 id="thread-state">Thread State</h3>
<p>NEW</p>
<p>RUNNABLE</p>
<p>BLOCK ï¼ˆsynchronizedï¼‰</p>
<p>WAITING ï¼ˆwaitã€joinã€LockSupport.parkï¼‰</p>
<p>TIMED_WAITINGï¼ˆwait with timeoutã€join with timeoutã€LockSupport.park with timeoutï¼‰</p>
<p>TERMINATED</p>
<p>ReentrantLockæ˜¯åŸºäºAQSå®ç°çš„ï¼ŒAQSåˆæ˜¯åŸºäºLockSupportå®ç°çš„ï¼Œæ‰€ä»¥ReentrantLocké”çš„çŠ¶æ€æ˜¯æ²¡æœ‰Blockçš„ï¼Œåªæœ‰waitingæˆ–timed_waiting</p>
]]></content>
      <tags>
        <tag>é¢è¯•</tag>
      </tags>
  </entry>
</search>
